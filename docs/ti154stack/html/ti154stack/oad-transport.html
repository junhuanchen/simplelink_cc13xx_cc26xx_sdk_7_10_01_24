<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TI 15.4-Stack OAD &mdash; 
SimpleLink™ CC13XX/CC26XX SDK
TI 15.4-Stack User&#39;s Guide
 6.10.01.00 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Turbo OAD Protocol" href="oad-turbo-oad.html" />
    <link rel="prev" title="Flash Layout for On-Chip OAD" href="../oad-secure/flash-layout-on-chip-stack-library.html" />
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug ti154stack oad-transport";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../ti154stack-guide/index-cc13xx_cc26xx.html" class="icon icon-home"> 
SimpleLink™ CC13XX/CC26XX SDK
TI 15.4-Stack User's Guide

          </a>
              <div class="version">
                6.10.01.00
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/quickstart-intro-cc13xx_cc26xx.html">Introduction to the SimpleLink CC13xx/CC26xx SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cc13xx_cc26xx/index-platform.html">SimpleLink Wireless MCU CC13xx and CC26xx Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/tirtos-index-cc13xx_cc26xx.html">TI-RTOS7 (RTOS Kernel) Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../ti154stack-guide/ti154stack-index-cc13xx_cc26xx.html">TI 15.4-Stack</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ti154stack-overview-cc13xx_cc26xx.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="ti154stack-overview-cc13xx_cc26xx.html#architecture-choices">Architecture Choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="ti154stack-overview-cc13xx_cc26xx.html#data-rate-and-phy">Data Rate and PHY</a></li>
<li class="toctree-l2"><a class="reference internal" href="application-overview.html">Application Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="example-applications.html">Example Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="common-user-interface.html">Common User Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="secure-commissioning.html">Secure Commissioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="beacon-mode.html">Beacon Enabled Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="non-beacon-mode.html">Non-Beacon Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="frequency-hopping-mode.html">Frequency-Hopping Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="arib-regulation-type.html">ARIB Regulation Type</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring-stack.html">Configuring Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet-sniffer.html">SmartRF Protocol Packet Sniffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="creating-custom-applications.html">Creating Custom Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cc13xx_cc26xx/fcc-certification.html">FCC Certification Considerations</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../ti154stack-guide/oad-secure-index.html">Over-the-Air Download (OAD)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/intro.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/bim.html">Boot Image Manager (BIM)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/bim-off-chip.html">BIM for Off-Chip OAD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/bim-on-chip-stack-library.html">BIM for On-Chip OAD (Stack Library)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/image-header.html">OAD Image Header</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/ext-flash-image-header.html">OAD External Flash Image Header</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/flash-layout-off-chip.html">Flash Layout for Off-Chip OAD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/flash-layout-on-chip-stack-library.html">Flash Layout for On-Chip OAD</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">TI 15.4-Stack OAD</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#oad-protocol">OAD Protocol</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-architecture">OAD Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-protocol-module">OAD Protocol Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-storage-module">OAD Storage Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-client-module">OAD Client Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-server">OAD Server</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-pause-and-resume">OAD Pause and Resume</a></li>
<li class="toctree-l4"><a class="reference internal" href="#support-for-multiple-oad-files">Support for multiple OAD files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-default-settings">OAD Default Settings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="oad-turbo-oad.html">Turbo OAD Protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/tools.html">OAD Image Tool</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack-guide/sysconfig-index.html">System Configuration (SysConfig)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cc13xx_cc26xx/custom-hardware-cc13xx_cc26xx.html">Custom Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coexistence/coexistence-ieee.html">Wi-Fi Coexistence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/debugging-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/memory-index.html">Memory overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security-tfm/index.html">Security Features of CC13x4 and CC26x4 Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/migration-guide-cc13xx_cc26xx.html">Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-reference.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/references-cc13xx_cc26xx.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/references-cc13xx_cc26xx.html#terms-and-acronyms">Terms and Acronyms</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../ti154stack-guide/index-cc13xx_cc26xx.html">
SimpleLink™ CC13XX/CC26XX SDK
TI 15.4-Stack User's Guide
</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../ti154stack-guide/index-cc13xx_cc26xx.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../ti154stack-guide/ti154stack-index-cc13xx_cc26xx.html">TI 15.4-Stack</a> &raquo;</li>
          <li><a href="../ti154stack-guide/oad-secure-index.html">Over-the-Air Download (OAD)</a> &raquo;</li>
      <li>TI 15.4-Stack OAD</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="ti-15-4-stack-oad">
<span id="oad-process"></span><h1>TI 15.4-Stack OAD<a class="headerlink" href="#ti-15-4-stack-oad" title="Permalink to this headline">¶</a></h1>
<p>This section describes the TI 15.4-Stack specific implementation of OAD. First
the OAD protocol is explained, then the various software modules (OAD client,
OAD storage, etc).</p>
<div class="section" id="oad-protocol">
<span id="sec-oad-protocol"></span><h2>OAD Protocol<a class="headerlink" href="#oad-protocol" title="Permalink to this headline">¶</a></h2>
<p>The OAD protocol is based on the principle that the OAD server initiates the
firmware download process, to which the OAD client then requests OAD FW image
blocks. The OAD client is responsible for requesting image blocks, handling
error conditions, and re-requesting image block when required. Once the OAD
has completed the OAD Client will reset and start running the new image.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If the device is connected to an external debugger when performing an OAD,
the device could potentially not reset properly after a successful OAD.
This is a known issue, however, simply unplugging/replugging or hard resetting
the device will make the device boot properly. Read more about this in
detail in Section <a class="reference internal" href="../oad-secure/bim.html#sec-oad-bim-hib"><span class="std std-ref">Halt In Boot (HIB)</span></a>.</p>
</div>
<div class="section" id="oad-messages">
<span id="sect-oad-profile"></span><h3>OAD Messages<a class="headerlink" href="#oad-messages" title="Permalink to this headline">¶</a></h3>
<p>The OAD Protocol uses requests and responses between the OAD server
(Distributer) and OAD client (Target). The supported messages are described in
<a class="reference internal" href="#tab-oad-protocol-messages"><span class="std std-numref">Table 22.</span></a>.</p>
<table class="docutils align-default" id="tab-oad-protocol-messages">
<caption><span class="caption-number">Table 22. </span><span class="caption-text">OAD Protocol Message Types</span><a class="headerlink" href="#tab-oad-protocol-messages" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 5%" />
<col style="width: 2%" />
<col style="width: 2%" />
<col style="width: 91%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Message</p></th>
<th class="head"><p>Client</p></th>
<th class="head"><p>Server</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>FwVersionReq</p></td>
<td><p>RX</p></td>
<td><p>TX</p></td>
<td><p>Request Firmware version of an OAD client node.</p></td>
</tr>
<tr class="row-odd"><td><p>FwVersionRsp</p></td>
<td><p>TX</p></td>
<td><p>RX</p></td>
<td><p>Response sent from an OAD client node contatining the firmware version currently running. The OAD server uses this information to determine if an update is necessary.</p></td>
</tr>
<tr class="row-even"><td><p>ImgIdentifyReq</p></td>
<td><p>RX</p></td>
<td><p>TX</p></td>
<td><p>Request containing the OAD header of the new FW image sent to a specific OAD client node.</p></td>
</tr>
<tr class="row-odd"><td><p>ImgIdentifyRsp</p></td>
<td><p>TX</p></td>
<td><p>RX</p></td>
<td><p>Response from the OAD client node. If the OAD image header is accepted by the OAD client node then the response will contain a success status, if not it will contain a fail status. The reasons for an OAD client node to send a fail status could include: Invalid image type, Invalid version (client is running a newer version), or Invalid binary size.</p></td>
</tr>
<tr class="row-even"><td><p>SendOadImgBlockReq</p></td>
<td><p>TX</p></td>
<td><p>RX</p></td>
<td><p>If the OAD client node accepts the image header in the ImgIdentifyReq then it will request OAD blocks using the SendOadImgBlockReq. The OAD client will implement a timeout for the SendOadImgBlockRsp and will re-request the OAD block n times if a timeout occurs.</p></td>
</tr>
<tr class="row-odd"><td><p>SendOadImgBlockRsp</p></td>
<td><p>RX</p></td>
<td><p>TX</p></td>
<td><p>The requested OAD block will be sent by the OAD server in a SendOadImgBlockRsp. The SendOadImgBlockReq’s and SendOadImgBlockRsp’s will continue until all blocks have been received by the OAD client. Default OAD_BLOCK_SIZE = 128.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="oad-message-flow">
<h3>OAD Message Flow<a class="headerlink" href="#oad-message-flow" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#fig-oad-protocol-flow"><span class="std std-numref">Figure 90.</span></a> shows the flow of OAD messages throughout the
entire OAD process.</p>
<div class="figure align-center" id="fig-oad-protocol-flow">
<img alt="../_images/fig-oad-protocol-flow.png" src="../_images/fig-oad-protocol-flow.png" />
<p class="caption"><span class="caption-number">Figure 90. </span><span class="caption-text">OAD Protocol Flow Diagram</span><a class="headerlink" href="#fig-oad-protocol-flow" title="Permalink to this image">¶</a></p>
</div>
<p>The following sequence diagrams illustrate the message flow for the various
stages in the OAD. The message flow assumes that the server is a Fully
Functional Device (<a class="reference internal" href="../ti154stack-guide/references-cc13xx_cc26xx.html#term-FFD"><span class="xref std std-term">FFD</span></a>) and the client is a Reduced Functional Device
(<a class="reference internal" href="../ti154stack-guide/references-cc13xx_cc26xx.html#term-RFD"><span class="xref std std-term">RFD</span></a>).</p>
<div class="section" id="fw-version">
<h4>FW Version<a class="headerlink" href="#fw-version" title="Permalink to this headline">¶</a></h4>
<p>The FW version is requested by the application on the server and responded to by
the application on the client. The client will only receive the request when it
sends a Data Request to the server.</p>
<div class="figure align-center" id="id8">
<img alt="../_images/fig-oad-fw-version.png" src="../_images/fig-oad-fw-version.png" />
<p class="caption"><span class="caption-number">Figure 91. </span><span class="caption-text">FwVersionReq and FwVersionRsp</span><a class="headerlink" href="#id8" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="initiating-oad">
<h4>Initiating OAD<a class="headerlink" href="#initiating-oad" title="Permalink to this headline">¶</a></h4>
<p>An OAD is initiated by the OAD server and is accepted by the OAD client. The
client will only receive the request when it sends a Data Request to the server.
The OAD Initiate request will only be accepted by the client if the image header
in the request is valid.</p>
<div class="figure align-center" id="id9">
<img alt="../_images/fig-oad-init.png" src="../_images/fig-oad-init.png" />
<p class="caption"><span class="caption-number">Figure 92. </span><span class="caption-text">OAD process being initiated.</span><a class="headerlink" href="#id9" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="oad-block-transfers">
<h4>OAD Block Transfers<a class="headerlink" href="#oad-block-transfers" title="Permalink to this headline">¶</a></h4>
<p>An OAD client sends a Image Block Request to to OAD server. There are three
possible outcomes of this request:</p>
<blockquote>
<div><ul class="simple">
<li><p>A single block is transfered successfully</p></li>
<li><p>A single block is transfered, but requires multiple poll requests</p></li>
<li><p>A request time-out occurs and the request is retried</p></li>
</ul>
</div></blockquote>
<p><a class="reference internal" href="#fig-oad-block-transfer"><span class="std std-numref">Figure 93.</span></a> illustrates a message flow for a single block
transfer, and assumes no timeouts occur. Block n represent block 0 to the 2nd to
last image block.</p>
<div class="figure align-center" id="fig-oad-block-transfer">
<img alt="../_images/fig-oad-block-transfer.png" src="../_images/fig-oad-block-transfer.png" />
<p class="caption"><span class="caption-number">Figure 93. </span><span class="caption-text">Single Block Transfer.</span><a class="headerlink" href="#fig-oad-block-transfer" title="Permalink to this image">¶</a></p>
</div>
<p><a class="reference internal" href="#fig-oad-block-poll"><span class="std std-numref">Figure 94.</span></a> illustrates a message flow for a single block
transfer, where the OAD server does not retrieve the image block before the
clients Data Request. Block n represent a random block in the image where the
image block is not ready in time for the Data Request.</p>
<div class="figure align-center" id="fig-oad-block-poll">
<img alt="../_images/fig-oad-block-poll.png" src="../_images/fig-oad-block-poll.png" />
<p class="caption"><span class="caption-number">Figure 94. </span><span class="caption-text">Single Block Transer with Multiple Poll Requests.</span><a class="headerlink" href="#fig-oad-block-poll" title="Permalink to this image">¶</a></p>
</div>
<p><a class="reference internal" href="#fig-oad-block-transfer-retry"><span class="std std-numref">Figure 95.</span></a> illustrates a message flow for a single
block transfer, where the OAD clients block request is lost, possibly due to a
queue overflow. Block n represent a random block in the image where the image
block request is lost. The below assumes a maximum of 3 Data Request time-outs.</p>
<div class="figure align-center" id="fig-oad-block-transfer-retry">
<img alt="../_images/fig-oad-block-transfer-retry.png" src="../_images/fig-oad-block-transfer-retry.png" />
<p class="caption"><span class="caption-number">Figure 95. </span><span class="caption-text">Single Block Timeout and is Retried.</span><a class="headerlink" href="#fig-oad-block-transfer-retry" title="Permalink to this image">¶</a></p>
</div>
<p>The downfall here is that the OAD client will continue sending poll requests
for a block response that will not come. This should be considered when choosing
the OAD_BLOCK_REQ_POLL_DELAY. The trade off is that for longer OAD_BLOCK_REQ_POLL_DELAYs the
OAD server will need to queue the block request in the MAC data queue of the
embedded collector for longer. Queuing OAD blocks in the MAC data buffer for
large amounts of time could lead to a queue overflow and further block requests
not being serviced.</p>
</div>
</div>
<div class="section" id="oad-configurable-parameters">
<h3>OAD Configurable Parameters<a class="headerlink" href="#oad-configurable-parameters" title="Permalink to this headline">¶</a></h3>
<p>The following parameters can be configured at compile-time:</p>
<ul class="simple">
<li><p>OAD_BLOCK_REQ_POLL_DELAY: This define is measured in ms and controls the timing on
the OAD client from the sending the Block Request to sending the poll
request for the OAD Block Response. A smaller OAD_BLOCK_REQ_POLL_DELAY decreases
the amount of time the OAD Block is queued in the collector and hence the
chance that the collector will suffer a buffer overflow. However the
collector will take a finite amount of time to retrieve the OAD block, and
queue the OAD Block Response, so care must be taken to make the
OAD_BLOCK_REQ_POLL_DELAY long enough to allow the collector to retrieve the OAD
block after receiving the OAD Block request. It is advisable to make this as
small as possible in large networks where the collector needs to queue
messages for many RFD’s.</p></li>
<li><p>OAD_BLOCK_REQ_RATE: This define is measured in ms. It defines the amount of
time on the OAD client between 1 block request and the next block request.
Reducing this will reduce the time taken to send an OAD. How quickly the OAD
takes to complete is application dependent, severaly power constrained
devices may need large periods between block req to allow the power source
to recover. Other applications may need the OAD to complete quickly, such
as in systems where a service engineer is required to perform the OAD.</p></li>
<li><p>OAD_BLOCK_SIZE: This define also affects the time taken to complete the OAD.
The OAD_BLOCK_SIZE is the number of bytes sent in an OAD Block and can be from
16 to 496B. Care must be taking when setting this to a high value in environments
where noise is a concern, as the chances of a block being corrupted due to an
interferer increases with the size of the block.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Increasing <code class="docutils literal notranslate"><span class="pre">OAD_BLOCK_SIZE</span></code> past 128 on a linux VM may cause
instability.</p>
</div>
</div>
</div>
<div class="section" id="oad-architecture">
<span id="sec-oad-client"></span><h2>OAD Architecture<a class="headerlink" href="#oad-architecture" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="#fig-oad-block-diagram"><span class="std std-numref">Figure 96.</span></a> shows the SW Architecture for the OAD
feature.</p>
<div class="figure align-center" id="fig-oad-block-diagram">
<img alt="../_images/fig-oad-block-diagram.png" src="../_images/fig-oad-block-diagram.png" />
<p class="caption"><span class="caption-number">Figure 96. </span><span class="caption-text">TI 15.4-Stack OAD Block Diagram</span><a class="headerlink" href="#fig-oad-block-diagram" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="modules">
<h3>Modules<a class="headerlink" href="#modules" title="Permalink to this headline">¶</a></h3>
<p>TI 15.4-Stack OAD comprises of the following software modules:</p>
<ul class="simple">
<li><p>OAD Protocol Module</p></li>
<li><p>OAD Storage Module</p></li>
<li><p>OAD Client Module</p></li>
</ul>
<p>The OAD server module is simpler than the OAD client, and does not need to
handle events, error conditions, or retries. The OAD server functionality is
embedded into the existing Linux collector module.</p>
</div>
</div>
<div class="section" id="oad-protocol-module">
<h2>OAD Protocol Module<a class="headerlink" href="#oad-protocol-module" title="Permalink to this headline">¶</a></h2>
<p>The OAD protocol interface provides device independent APIs, data types, and
macros. The Over the Air Download (OAD) protocol module provides protocol
functionality for transferring an OAD image. The APIs in this module serve as an
interface to a TI-RTOS7 application and offers functionality for an OAD messaging
protocol between OAD sever and the OAD client. The module handles the formatting
and parsing of messages.</p>
<div class="section" id="initialization">
<h3>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h3>
<p>In order to use the OAD protocol APIs, the application is required to provide
application specific configuration and callbacks. For the application to process
OAD Messages the following callback table must be provided:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/** @brief OADProtocol callback table</span>
<span class="cm"> *</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">fwVersionReqCb_t</span><span class="w">      </span><span class="n">pfnFwVersionReqCb</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt; Incoming FW Req</span>
<span class="w">    </span><span class="n">fwVersionRspCb_t</span><span class="w">      </span><span class="n">pfnFwVersionRspCb</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt; Incoming FW Version Rsp</span>
<span class="w">    </span><span class="n">oadImgIdentifyReqCb_t</span><span class="w"> </span><span class="n">pfnOadImgIdentifyReqCb</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt; Incoming Image Identify Req</span>
<span class="w">    </span><span class="n">oadImgIdentifyRspCb_t</span><span class="w"> </span><span class="n">pfnOadImgIdentifyRspCb</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt; Incoming Image Identify Rsp</span>
<span class="w">    </span><span class="n">oadBlockReqCb_t</span><span class="w">       </span><span class="n">pfnOadBlockReqCb</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt; Incoming OAD Block Req</span>
<span class="w">    </span><span class="n">oadBlockRspCb_t</span><span class="w">       </span><span class="n">pfnOadBlockRspCb</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt; Incoming OAD Block Rsp</span>
<span class="p">}</span><span class="w"> </span><span class="n">OADProtocol_MsgCBs_t</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>For the OAD module to allocate buffers and send messages the following platform
specific callback must be provided:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/** @brief OADProtocol radio access functions</span>
<span class="cm"> *</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">radioAccessAllocMsg_t</span><span class="w">        </span><span class="n">pfnRadioAccessAllocMsg</span><span class="p">;</span><span class="w">   </span><span class="c1">///&lt; Function for allocating a message buffer</span>
<span class="w">    </span><span class="n">radioAccessPacketSend_t</span><span class="w">      </span><span class="n">pfnRadioAccessPacketSend</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt; Function for sending message over the radio</span>
<span class="p">}</span><span class="w"> </span><span class="n">OADProtocol_RadioAccessFxns_t</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">OADProtocol_init()</span></code> must be called before any other OADProtocol APIs. The
following parametric configuration is passed:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/** @brief RF parameter struct</span>
<span class="cm"> *  RF parameters are used with the OADProtocol_open() and OADProtocol_Params_init() call.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">OADProtocol_RadioAccessFxns_t</span><span class="w">  </span><span class="o">*</span><span class="n">pRadioAccessFxns</span><span class="p">;</span><span class="w">    </span><span class="c1">///&lt; Radio access function table</span>
<span class="w">    </span><span class="n">OADProtocol_MsgCBs_t</span><span class="w">           </span><span class="o">*</span><span class="n">pProtocolMsgCallbacks</span><span class="p">;</span><span class="w">          </span><span class="c1">///&lt; Application Callbacks for pressing packets</span>
<span class="p">}</span><span class="w"> </span><span class="n">OADProtocol_Params_t</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="application-interface">
<h3>Application Interface<a class="headerlink" href="#application-interface" title="Permalink to this headline">¶</a></h3>
<p>The OAD protocol module formats and parses the OAD messages. The following API
are exposed:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/** @brief  Function to initialize the OADProtocol_Params struct to its defaults</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  params      An pointer to RF_Params structure for</span>
<span class="cm"> *                      initialization</span>
<span class="cm"> *</span>
<span class="cm"> *  Defaults values are:</span>
<span class="cm"> *     pRadioAccessFxns     = {0}</span>
<span class="cm"> *      pCallbacks          = {0}</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">OADProtocol_Params_init</span><span class="p">(</span><span class="n">OADProtocol_Params_t</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">);</span><span class="w"></span>

<span class="cm">/** @brief  Function that initializes the Wsn Protocol Task and creates all TI-RTOS objects</span>
<span class="cm"> *</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">OADProtocol_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>

<span class="cm">/** @brief  Function to open the OADProtocol module</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  params      An pointer to RF_Params structure for initialization</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">OADProtocol_open</span><span class="p">(</span><span class="n">OADProtocol_Params_t</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">);</span><span class="w"></span>

<span class="cm">/** @brief  Function to parse OADProtocol packets</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  srcAddr             address of the device that sent the message</span>
<span class="cm"> *  @param  incomingPacket      pointer to packet to be parsed</span>
<span class="cm"> *  @param  packetLen           length of the message</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">OADProtocol_Status_t</span><span class="w"> </span><span class="nf">OADProtocol_ParseIncoming</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pSrcAddr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">incomingPacket</span><span class="p">);</span><span class="w"></span>


<span class="cm">/** @brief  Function to send a FW version request packet</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  dstAddress          Address to send the request to</span>
<span class="cm"> *</span>
<span class="cm"> *  @return                     Status</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">OADProtocol_Status_t</span><span class="w"> </span><span class="nf">OADProtocol_sendFwVersionReq</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pDstAddress</span><span class="p">);</span><span class="w"></span>

<span class="cm">/** @brief  Function to send a FW version response packet</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  dstAddress          Address to send the response to</span>
<span class="cm"> *  @param  fwVersion           Firmware version string to send</span>
<span class="cm"> *</span>
<span class="cm"> *  @return                     Status</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">OADProtocol_Status_t</span><span class="w"> </span><span class="nf">OADProtocol_sendFwVersionRsp</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pDstAddress</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">fwVersion</span><span class="p">);</span><span class="w"></span>

<span class="cm">/** @brief  Function to send an OAD image identify request packet</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  dstAddress          Address to send the request to</span>
<span class="cm"> *  @param  imgId               image ID used for requesting image blocks</span>
<span class="cm"> *  @param  pImgInfoData        Image header</span>
<span class="cm"> *</span>
<span class="cm"> *  @return                     Status</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">OADProtocol_Status_t</span><span class="w"> </span><span class="nf">OADProtocol_sendImgIdentifyReq</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pDstAddress</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">imgId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">pImgInfoData</span><span class="p">);</span><span class="w"></span>

<span class="cm">/** @brief  Function to send an OAD image identify request packet</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  dstAddress          Address to send the response to</span>
<span class="cm"> *  @param  status              status to send</span>
<span class="cm"> *</span>
<span class="cm"> *  @return                     Status</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">OADProtocol_Status_t</span><span class="w"> </span><span class="nf">OADProtocol_sendOadIdentifyImgRsp</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pDstAddress</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">status</span><span class="p">);</span><span class="w"></span>

<span class="cm">/** @brief  Function to send an OAD block request packet</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  dstAddress          Address to send the request to</span>
<span class="cm"> *  @param  imgId               image ID of image blocks</span>
<span class="cm"> *  @param  blockNum            block Number to request</span>
<span class="cm"> *  @param  multiBlockSize      Numer of blocks in the multi Block transfer (0 or 1 for none-multiblock)</span>
<span class="cm"> *</span>
<span class="cm"> *  @return                     Status</span>
<span class="cm"> *</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">OADProtocol_Status_t</span><span class="w"> </span><span class="nf">OADProtocol_sendOadImgBlockReq</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pDstAddress</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">imgId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">blockNum</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">multiBlockSize</span><span class="p">);</span><span class="w"></span>

<span class="cm">/** @brief  Function to send an OAD block response packet</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  dstAddress          Address to send the response to</span>
<span class="cm"> *  @param  imgId               image ID of image blocks</span>
<span class="cm"> *  @param  blockNum            Block number</span>
<span class="cm"> *  @param  block               pointer to image block</span>
<span class="cm"> *</span>
<span class="cm"> *  @return                     Status</span>
<span class="cm"> *</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">OADProtocol_Status_t</span><span class="w"> </span><span class="nf">OADProtocol_sendOadImgBlockRsp</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pDstAddress</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">imgId</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">blockNum</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">block</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="usage">
<h3>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h3>
<p>To use the OAD protocol module to format and parse OAD messages, the application
calls the following APIs:</p>
<blockquote>
<div><ul class="simple">
<li><p>OADProtocol_init(): Initialize the OADProtocol module/task</p></li>
<li><p>OADProtocol_Params_init(): Initialize a OADProtocol_Params structure with
default values. Then change the parameters from non-default values as
needed.</p></li>
<li><p>OADProtocol_open(): Open an instance of the OADProtocol module, passing the
initialized parameters.</p></li>
<li><p>OADProtocol_sendFwRequest(): This is an example of an OAD message that is
formatted and sent.</p></li>
</ul>
</div></blockquote>
<p>The following code example opens OADProtocol, sends a FW version request and
processes the response.:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">OADProtocol_packetCBs_t</span><span class="w"> </span><span class="n">OADProtocolCbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">//Incoming FW Req</span>
<span class="w">  </span><span class="n">fwVersionReqCb</span><span class="p">,</span><span class="w"> </span><span class="c1">//Incoming FW Version Rsp</span>
<span class="w">  </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">//Incoming Image Identify Req</span>
<span class="w">  </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">//Incoming Image Identify Rsp</span>
<span class="w">  </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">//Incoming OAD Block Req</span>
<span class="w">  </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">//Incoming OAD Block Rsp</span>
<span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">fwVersionRspCb</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">srcAddr</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">fwVersionStr</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">//Do something with srcAddr and fwVersionStr</span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">someTaskInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">OADProtocol_init</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">someTaskFxn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Set Default parameters structure</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">OADProtocol_Params_t</span><span class="w"> </span><span class="n">OADProtocol_params</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Initialize and open the Wsn Protocol Task</span>
<span class="w">  </span><span class="n">OADProtocol_Params_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OADProtocol_params</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">OADProtocol_params</span><span class="p">.</span><span class="n">pCallbacks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">OADProtocolCbs</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">OADProtocol_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OADProtocol_params</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">OADProtocol_sendFwVersionReq</span><span class="p">(</span><span class="n">nodeAddress</span><span class="p">);</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="oad-storage-module">
<h2>OAD Storage Module<a class="headerlink" href="#oad-storage-module" title="Permalink to this headline">¶</a></h2>
<p>The OAD storage interface provides device independent APIs, data types, and
macros for storing the OAD image. The OAD storage module calls into oad_target,
which provide the device dependent functionality to write the OAD image into
flash. oad_target contains the support for internal (on-chip) and external
(off-chip) OAD image storage.</p>
<div class="section" id="oad-storage-configuration">
<h3>OAD Storage Configuration<a class="headerlink" href="#oad-storage-configuration" title="Permalink to this headline">¶</a></h3>
<p>The oad_target module can be configured at build time to use on-chip or off-chip
storage by linking or copying in the correct target c file:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">oad_target_external_flash.c</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">oad_target_internal_flash.c</span></code></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For on-chip OAD, the OAD storage module must be built with
<code class="docutils literal notranslate"><span class="pre">FEATURE_OAD_ONCHIP</span></code> defined.</p>
</div>
</div>
<div class="section" id="initilization">
<h3>Initilization<a class="headerlink" href="#initilization" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">OADStorage_init()</span></code> must be called before any other OADTarget APIs.</p>
</div>
<div class="section" id="id5">
<h3>Application Interface<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>The OAD storage module exposes the following API for staring the OAD image:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_init</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Initialise the OAD Target Profile.</span>
<span class="cm"> *</span>
<span class="cm"> * @param   None.</span>
<span class="cm"> *</span>
<span class="cm"> * @return  None.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">OADStorage_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_imgIdentifyRead</span>
<span class="cm"> *</span>
<span class="cm">* @brief   Read Image header and return number of blocks.</span>
<span class="cm"> *</span>
<span class="cm"> * @param   imageType   - image type indicating which image to read</span>
<span class="cm"> * @param   pImgHdr     - pointer to image header data</span>
<span class="cm"> *</span>
<span class="cm"> * @return  Total Blocks if image accepted, 0 if Image invalid</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="nf">OADStorage_imgIdentifyRead</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">imageType</span><span class="p">,</span><span class="w"> </span><span class="n">OADStorage_imgIdentifyPld_t</span><span class="o">*</span><span class="w"> </span><span class="n">pImgId</span><span class="p">);</span><span class="w"></span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_imgIdentifyWrite</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Process the Image Identify Write.  Determine from the received OAD</span>
<span class="cm"> *          Image Header if the Downloaded Image should be acquired.</span>
<span class="cm"> *</span>
<span class="cm"> * @param   pValue     - pointer to data to be written</span>
<span class="cm"> *</span>
<span class="cm">  * @return  Total Blocks if image accepted, 0 if Image rejected</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="nf">OADStorage_imgIdentifyWrite</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">pValue</span><span class="p">);</span><span class="w"></span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_imgBlockRead</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Read Image Block.</span>
<span class="cm"> *</span>
<span class="cm"> * @param   blockNum   - block number to be written</span>
<span class="cm"> * @param   pBlockData - pointer for data to be read</span>
<span class="cm"> *</span>
<span class="cm"> * @return  none</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">OADStorage_Status_t</span><span class="w"> </span><span class="nf">OADStorage_imgBlockRead</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">blockNum</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">pBlockData</span><span class="p">);</span><span class="w"></span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_imgInfoRead</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Read an Image info.</span>
<span class="cm"> *</span>
<span class="cm"> * @param   pimgInfo - pointer for data to be read</span>
<span class="cm"> *</span>
<span class="cm"> * @return  none</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">OADStorage_imgInfoRead</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">pimgInfo</span><span class="p">);</span><span class="w"></span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_imgBlockWrite</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Write Image Block.</span>
<span class="cm"> *</span>
<span class="cm"> * @param   blockNum   - block number to be written</span>
<span class="cm"> * @param   pBlockData - pointer to data to be written</span>
<span class="cm"> * @param   len        - length fo block</span>
<span class="cm"> *</span>
<span class="cm"> * @return  status</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">OADStorage_Status_t</span><span class="w"> </span><span class="nf">OADStorage_imgBlockWrite</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">blockNum</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">pBlockData</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">len</span><span class="p">);</span><span class="w"></span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_eraseImgPage</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Erases an Image page. Note this is only needed if an image</span>
<span class="cm"> *          page has been corrupted typically OADStorage_imgBlockWrite</span>
<span class="cm"> *          pre-erase all pages</span>
<span class="cm"> *</span>
<span class="cm"> * @param  none</span>
<span class="cm"> *</span>
<span class="cm"> * @return  OADStorage_Status_t</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">OADStorage_Status_t</span><span class="w"> </span><span class="nf">OADStorage_eraseImgPage</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">page</span><span class="p">);</span><span class="w"></span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_imgFinalise</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Process the Image Block Write.</span>
<span class="cm"> *</span>
<span class="cm"> * @param  none</span>
<span class="cm"> *</span>
<span class="cm"> * @return  status</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">OADStorage_Status_t</span><span class="w"> </span><span class="nf">OADStorage_imgFinalise</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_createFactoryImageBackup</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   This function creates factory image backup of current running image</span>
<span class="cm"> *</span>
<span class="cm"> * @param   None</span>
<span class="cm"> *</span>
<span class="cm"> * @return  status  OADStorage_Status_Success/OADStorage_FlashError</span>
<span class="cm"> *</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="nf">OADStorage_createFactoryImageBackup</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>
<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_checkFactoryImage</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   This function check if the valid factory image exists on external</span>
<span class="cm"> *          flash</span>
<span class="cm"> *</span>
<span class="cm"> * @param   None</span>
<span class="cm"> *</span>
<span class="cm"> * @return  TRUE If factory image exists on external flash, else FALSE</span>
<span class="cm"> *</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">OADStorage_checkFactoryImage</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_close</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Releases the resource required for OAD stoarage.</span>
<span class="cm"> *</span>
<span class="cm"> * @param  none</span>
<span class="cm"> *</span>
<span class="cm"> * @return none</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">OADStorage_close</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="oad-client-module">
<h2>OAD Client Module<a class="headerlink" href="#oad-client-module" title="Permalink to this headline">¶</a></h2>
<p>The OAD client module has been designed to provide a simple and customizable
implementation for the customer. In its most rudimentary form, this
module is responsible for accepting/rejecting an OAD interaction based
on image header criteria, storing the image in its appropriate location,
and causing a device reset if the download is successful so that the
downloaded application image is run by the <a class="reference internal" href="../ti154stack-guide/references-cc13xx_cc26xx.html#term-BIM"><span class="xref std std-term">BIM</span></a>.</p>
<p>The OAD client module provides a service to process and generate application
events for OAD client functionality.  It is specific to a TI 15.4-Stack
application and houses the code required for the application to act as an OAD
target, reducing the code needing to be added in the application files. The OAD
client uses the services provided by the OAD protocol and OAD storage modules.</p>
<div class="section" id="id6">
<h3>Initialization<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>In order for the OAD client module to process and generate application events it
needs to be initialized with an event handle used to set event masks as they
occur and the applications semaphore that can be used to wake up the
application after an event is set.</p>
<p><code class="docutils literal notranslate"><span class="pre">OADClient_init()</span></code> must be called before the module can process OAD events.
The following parametric configuration is passed:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/** @brief RF parameter struct</span>
<span class="cm"> *  RF parameters are used with the SOADProtocol_open() and SOADProtocol_Params_init() call.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="o">*</span><span class="n">pEvent</span><span class="p">;</span><span class="w">             </span><span class="c1">///&lt; Event handle to post to</span>
<span class="cp">#ifdef OSAL_PORT2TIRTOS</span>
<span class="w">    </span><span class="n">Semaphore_Handle</span><span class="w"> </span><span class="n">eventSem</span><span class="p">;</span><span class="w">    </span><span class="c1">///&lt; Semaphore to post event</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">ICall_Semaphore</span><span class="w"> </span><span class="n">eventSem</span><span class="p">;</span><span class="w">    </span><span class="c1">///&lt; Semaphore to post event</span>
<span class="cp">#endif </span><span class="cm">/*OSAL_PORT2TIRTOS */</span><span class="cp"></span>
<span class="p">}</span><span class="w"> </span><span class="n">OADClient_Params_t</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>Application Interface<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>The OAD Client module formats and parses the OAD messages. The following
API is exposed:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="cm">/** @brief  Function to open the SOADProtocol module</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  params      An pointer to OADClient_Params_t structure for initialization</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">OADClient_open</span><span class="p">(</span><span class="n">OADClient_Params_t</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">);</span><span class="w"></span>

<span class="w"> </span><span class="cm">/** @brief  Function to process OAD events</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  pEvent      Event to process</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">OADClient_processEvent</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="o">*</span><span class="n">pEvent</span><span class="p">);</span><span class="w"></span>

<span class="cm">/** @brief  Function abort OAD</span>
<span class="cm">*</span>
<span class="cm">*  @param  resume      set to true if a auto resume is required</span>
<span class="cm">*/</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">OADClient_abort</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">resume</span><span class="p">);</span><span class="w"></span>

<span class="cm">/** @brief  Function abort OAD</span>
<span class="cm">*</span>
<span class="cm">*  @param  delay      time in ms to start resume</span>
<span class="cm">*/</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">OADClient_resume</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">delay</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="example-function-trace">
<h3>Example Function Trace<a class="headerlink" href="#example-function-trace" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#fig-oad-req-message-flow"><span class="std std-numref">Figure 97.</span></a> shows the typical function flow for an OAD
client to send a message from the application through the OAD client and
OAD protocol modules to the MAC API.</p>
<div class="figure align-center" id="fig-oad-req-message-flow">
<img alt="../_images/fig-oad-req-message-flow.png" src="../_images/fig-oad-req-message-flow.png" />
<p class="caption"><span class="caption-number">Figure 97. </span><span class="caption-text">Block Request message flow.</span><a class="headerlink" href="#fig-oad-req-message-flow" title="Permalink to this image">¶</a></p>
</div>
<p><a class="reference internal" href="#fig-oad-rsp-message-flow"><span class="std std-numref">Figure 98.</span></a> shows the typical function flow for an OAD
client receiving a messge from the OAD server through the OAD protocol module to
the MAC API.</p>
<div class="figure align-center" id="fig-oad-rsp-message-flow">
<img alt="../_images/fig-oad-rsp-message-flow.png" src="../_images/fig-oad-rsp-message-flow.png" />
<p class="caption"><span class="caption-number">Figure 98. </span><span class="caption-text">Block Response processing.</span><a class="headerlink" href="#fig-oad-rsp-message-flow" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="oad-server">
<span id="sec-oad-server"></span><h2>OAD Server<a class="headerlink" href="#oad-server" title="Permalink to this headline">¶</a></h2>
<p>There is no separate tool for the OAD server, OAD server functionality is
provided by the Linux collector application as part of the <a class="reference external" href="http://www.ti.com/tool/ti-15.4-stack-gateway-linux-sdk">TI 15.4-Stack Linux
SDK</a>. When the collector application is built without the <code class="docutils literal notranslate"><span class="pre">IS_HEADLESS</span></code> flag
an interactive command-line interface to the collector application exposes the
following functionality:</p>
<blockquote>
<div><ul class="simple">
<li><p>Devices can be selected</p></li>
<li><p>A firmware file can be selected for transfer</p></li>
<li><p>LED toggle requests can be sent to the selected device</p></li>
<li><p>Version requests can be sent to the selected device</p></li>
<li><p>Firmware update requests can be sent to the selected device</p></li>
</ul>
</div></blockquote>
<p>A typical view of this interface</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TI</span><span class="w"> </span><span class="n">Collector</span><span class="w"></span>
<span class="nl">Nwk</span><span class="p">:</span><span class="w"> </span><span class="n">Started</span><span class="w"></span>
<span class="n">Sensor</span><span class="w"> </span><span class="mh">0x0001</span><span class="o">:</span><span class="w"> </span><span class="n">Temp</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="n">RSSI</span><span class="w"> </span><span class="mi">-18</span><span class="w"></span>
<span class="n">Sensor</span><span class="w"> </span><span class="mh">0x0002</span><span class="o">:</span><span class="w"> </span><span class="n">OAD</span><span class="w"> </span><span class="n">Block</span><span class="w"> </span><span class="mi">211</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">960</span><span class="w"></span>


<span class="nl">Info</span><span class="p">:</span><span class="w"> </span><span class="n">Sending</span><span class="w"> </span><span class="mh">0x0002</span><span class="w"> </span><span class="n">FW</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">Req</span><span class="w"></span>
<span class="nl">cmd</span><span class="p">:</span><span class="w"> </span><span class="n">u</span><span class="w"></span>
</pre></div>
</div>
<p>The available commands are:</p>
<blockquote>
<div><ul class="simple">
<li><p>sxx: Select a device. Example ‘s1’| ‘s0x1234’</p></li>
<li><p>o:   Toggle the permit join</p></li>
<li><p>l:   List devices</p></li>
<li><p>t:   Send an LED toggle request to selected device</p></li>
<li><p>v:   Send a version request to selected device</p></li>
<li><p>u:   Send FW update request to selected device</p></li>
<li><p>d:   Send disassociation request to selected device</p></li>
<li><p>fxx: Set FW file from configured OAD FW dir. Example ‘f sensor_mac_oad_cc13x2lp_app.bin’</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="oad-pause-and-resume">
<span id="sec-oad-pause-and-resume"></span><h2>OAD Pause and Resume<a class="headerlink" href="#oad-pause-and-resume" title="Permalink to this headline">¶</a></h2>
<p>The TI 15.4-Stack OAD feature supports the following robustness features:</p>
<ol class="arabic simple">
<li><p>Timeouts: This is when a the data request for a block response is not
answered. The data request delay from an OAD block request being sent is set
by OAD_BLOCK_REQ_POLL_DELAY ms, it is advised that this be set as short as
possible to avoid unnecessary queueing of data in the co-processor. A
timeout is typically caused by the Linux collector taking too long to read
the OAD Block from the FW Image file (due to CPU load). The number of
timeouts before a retry is set by OAD_MAX_TIMEOUTS.</p></li>
<li><p>Retries: A retry is when the maximum number timeouts has expired before the
OAD Block Response has been received. In his case the OAD Block Request is
resent. The number of retires before an OAD abort is set by OAD_MAX_RETRIES.</p></li>
<li><p>Aborts: The OAD is aborted after there are OAD_MAX_RETRIES block requests with
no response. After an OAD abort the OAD is attempted to be resumed after
OAD_BLOCK_AUTO_RESUME_DELAY ms, if the OAD abort again on the same block number
the OAD is terminated.</p></li>
</ol>
<p>The OAD is aborted if the device orphans, but when the device rejoins an OAD resume
is attempted. If the device is reset / powered off during an OAD the device will
attempt to resume when it rejoins. The block it resumes from is set to the first
block of the page it was aborted from in case the flash page was corrupted by
the power cycle.</p>
</div>
<div class="section" id="support-for-multiple-oad-files">
<h2>Support for multiple OAD files<a class="headerlink" href="#support-for-multiple-oad-files" title="Permalink to this headline">¶</a></h2>
<p>The OAD protocol supports multiple OAD images by using an Image ID that is sent
when the collector initiates the OAD and then in each OAD block request /
response. This ensures that the device always receives a block from the correct
FW image, especially in the case where a device loses power or orphans and it is
not known when it will come back online. When an OAD image file is selected on
the collector it is assigned a new image ID and added to a table, when a block
request is received the image ID in the block request is used to find the
correct FW image file. This guarantees that a device will always get a block from
the correct image, no matter how long it is offline.</p>
</div>
<div class="section" id="oad-default-settings">
<h2>OAD Default Settings<a class="headerlink" href="#oad-default-settings" title="Permalink to this headline">¶</a></h2>
<p>Most OAD settings are defined in <code class="docutils literal notranslate"><span class="pre">oad_client.c</span></code> and <code class="docutils literal notranslate"><span class="pre">oad_config.h</span></code>, and already
discussed in <a class="reference internal" href="#sec-oad-pause-and-resume"><span class="std std-ref">OAD Pause and Resume</span></a>. In addition to this you can override the
<code class="docutils literal notranslate"><span class="pre">OAD_BLOCK_SIZE</span></code> from the default of 128 by defining it in the project options.
Setting this higher than 128 is not advised as this is the setting used during
system testing.</p>
<p>Beacon Mode, Non Beacon Mode and Frequency Hopping network modes are supported.
In Non Beacon Mode and Frequency Hopping the default OAD parameters are:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define OAD_BLOCK_REQ_RATE            200</span>
<span class="cp">#define OAD_BLOCK_REQ_POLL_DELAY      50</span>
<span class="cp">#define OAD_MAX_TIMEOUTS              3</span>
<span class="cp">#define OAD_MAX_RETRIES               3</span>
<span class="cp">#define OAD_BLOCK_AUTO_RESUME_DELAY   5000</span>
</pre></div>
</div>
<p>Under normal conditions the sensor sends a block request every 200ms, with a
typical file of 920 blocks this takes ~3 minutes. In Beacon Mode only one data
request can be sent during 1 beacon interval. The default OAD settings are:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define BEACON_INTERVAL             ((((0x01) &lt;&lt; (CONFIG_MAC_BEACON_ORDER)) * \</span>
<span class="cp">                                      (SYMBOL_DURATION) * (BASE_SUPER_FRAME_DURATION)) / (1000)) </span><span class="c1">// ms</span>
<span class="cp">#define OAD_BLOCK_REQ_RATE            ((BEACON_INTERVAL) - 100)</span>
<span class="cp">#define OAD_BLOCK_REQ_POLL_DELAY      ((BEACON_INTERVAL) - 400)</span>
<span class="cp">#define OAD_MAX_TIMEOUTS              3</span>
<span class="cp">#define OAD_MAX_RETRIES               3</span>
<span class="cp">#define OAD_BLOCK_AUTO_RESUME_DELAY   (CONFIG_MAC_SUPERFRAME_ORDER * 5)</span>
</pre></div>
</div>
<p>Under normal conditions the OAD will take CONFIG_SUPERFRAME_ORDER * 920 seconds.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">sensor_oad</span></code> project has 2 defines related to the OAD feature, defined by
default in the Application/Defines/sensor_oad .opts file:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FEATURE_BLE_OAD</span></code> This includes the OAD linker command file and OAD TI-RTOS7
config file that supports updates through BLE.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FEATURE_NATIVE_OAD</span></code> This includes the TI 15.4-Stack OAD client. This
results in an application that supports the OAD messages needed to receive
an OAD update over the TI 15.4-Stack network.</p></li>
</ul>
<p>Removing the <code class="docutils literal notranslate"><span class="pre">FEATURE_NATIVE_OAD</span></code> symbol will result in an application that is
capable of being updated through a BLE link only. For a TI 15.4-Stack OAD both
<code class="docutils literal notranslate"><span class="pre">FEATURE_BLE_OAD</span></code> and <code class="docutils literal notranslate"><span class="pre">FEATURE_NATIVE_OAD</span></code> should be defined.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../oad-secure/flash-layout-on-chip-stack-library.html" class="btn btn-neutral float-left" title="Flash Layout for On-Chip OAD" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="oad-turbo-oad.html" class="btn btn-neutral float-right" title="Turbo OAD Protocol" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2022, Texas Instruments.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>