<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BIM for On-Chip OAD (Stack Library) &mdash; 
SimpleLink™ CC13XX/CC26XX SDK
TI 15.4-Stack User&#39;s Guide
 6.10.01.00 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OAD Image Header" href="image-header.html" />
    <link rel="prev" title="BIM for Off-Chip OAD" href="bim-off-chip.html" />
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug oad-secure bim-on-chip-stack-library";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../ti154stack-guide/index-cc13xx_cc26xx.html" class="icon icon-home"> 
SimpleLink™ CC13XX/CC26XX SDK
TI 15.4-Stack User's Guide

          </a>
              <div class="version">
                6.10.01.00
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/quickstart-intro-cc13xx_cc26xx.html">Introduction to the SimpleLink CC13xx/CC26xx SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cc13xx_cc26xx/index-platform.html">SimpleLink Wireless MCU CC13xx and CC26xx Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/tirtos-index-cc13xx_cc26xx.html">TI-RTOS7 (RTOS Kernel) Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../ti154stack-guide/ti154stack-index-cc13xx_cc26xx.html">TI 15.4-Stack</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/ti154stack-overview-cc13xx_cc26xx.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/ti154stack-overview-cc13xx_cc26xx.html#architecture-choices">Architecture Choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/ti154stack-overview-cc13xx_cc26xx.html#data-rate-and-phy">Data Rate and PHY</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/application-overview.html">Application Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/example-applications.html">Example Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/common-user-interface.html">Common User Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/secure-commissioning.html">Secure Commissioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/beacon-mode.html">Beacon Enabled Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/non-beacon-mode.html">Non-Beacon Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/frequency-hopping-mode.html">Frequency-Hopping Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/arib-regulation-type.html">ARIB Regulation Type</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/configuring-stack.html">Configuring Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/packet-sniffer.html">SmartRF Protocol Packet Sniffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack/creating-custom-applications.html">Creating Custom Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cc13xx_cc26xx/fcc-certification.html">FCC Certification Considerations</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../ti154stack-guide/oad-secure-index.html">Over-the-Air Download (OAD)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="bim.html">Boot Image Manager (BIM)</a></li>
<li class="toctree-l3"><a class="reference internal" href="bim-off-chip.html">BIM for Off-Chip OAD</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">BIM for On-Chip OAD (Stack Library)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#application-execution-switching-using-validation-bytes-in-flash">Application Execution switching using Validation Bytes in Flash</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="image-header.html">OAD Image Header</a></li>
<li class="toctree-l3"><a class="reference internal" href="ext-flash-image-header.html">OAD External Flash Image Header</a></li>
<li class="toctree-l3"><a class="reference internal" href="flash-layout-off-chip.html">Flash Layout for Off-Chip OAD</a></li>
<li class="toctree-l3"><a class="reference internal" href="flash-layout-on-chip-stack-library.html">Flash Layout for On-Chip OAD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ti154stack/oad-transport.html">TI 15.4-Stack OAD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ti154stack/oad-turbo-oad.html">Turbo OAD Protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="tools.html">OAD Image Tool</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack-guide/sysconfig-index.html">System Configuration (SysConfig)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cc13xx_cc26xx/custom-hardware-cc13xx_cc26xx.html">Custom Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coexistence/coexistence-ieee.html">Wi-Fi Coexistence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/debugging-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/memory-index.html">Memory overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security-tfm/index.html">Security Features of CC13x4 and CC26x4 Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/migration-guide-cc13xx_cc26xx.html">Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack/api-reference.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/references-cc13xx_cc26xx.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/references-cc13xx_cc26xx.html#terms-and-acronyms">Terms and Acronyms</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../ti154stack-guide/index-cc13xx_cc26xx.html">
SimpleLink™ CC13XX/CC26XX SDK
TI 15.4-Stack User's Guide
</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../ti154stack-guide/index-cc13xx_cc26xx.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../ti154stack-guide/ti154stack-index-cc13xx_cc26xx.html">TI 15.4-Stack</a> &raquo;</li>
          <li><a href="../ti154stack-guide/oad-secure-index.html">Over-the-Air Download (OAD)</a> &raquo;</li>
      <li>BIM for On-Chip OAD (Stack Library)</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="bim-for-on-chip-oad-stack-library">
<span id="sec-oad-bim-on-chip-stack-library"></span><h1>BIM for On-Chip OAD (Stack Library)<a class="headerlink" href="#bim-for-on-chip-oad-stack-library" title="Permalink to this headline">¶</a></h1>
<p>This section describes the behavior of the BIM for on-chip OAD where the
combined image approach is used. This approach requires two full application and
stack library pairs on the target device. As with off-chip OAD, it is BIM’s
responsibility to locate which image should be run. In an on-chip OAD system
there are only two image types that can be executed safely:</p>
<blockquote>
<div><ul class="simple">
<li><p>Persistent application (0x00): Permanently resident application that
implements OAD profile</p></li>
<li><p>User application (0x01): OAD upgradeable application that implements OAD
reset service and user functionality</p></li>
</ul>
</div></blockquote>
<p>For more information about OAD image types, refer to the
<a class="reference internal" href="image-header.html#sec-oad-image-header"><span class="std std-ref">OAD Image Header</span></a> section of this chapter. The roles and
responsibilities of each application in an on-chip system is defined in the
<a class="reference internal" href="../ti154stack/oad-transport.html#oad-process"><span class="std std-ref">TI 15.4-Stack OAD</span></a> section.</p>
<p>In summary, the applications are responsible for storing a candidate image in
internal flash, performing all OAD procedures and protocols, updating the Image
Validation flash field in the OAD image header, and resetting the device when
appropriate. The Image Validation field is a shared RAM variable that allows the
application to indicate which image should be selected by the BIM before
resetting. This is described in <a class="reference internal" href="#sect-ram-argument-stack-library"><span class="std std-ref">Application Execution switching using Validation Bytes in Flash</span></a>.</p>
<p>Based on the Image Validation field in the image header, the BIM will decide
which image is most fit to run. The following will
describe the process by which the BIM selects an image.</p>
<div class="figure align-center" id="id5">
<span id="fig-bim-onchip-stack-library-flowchart"></span><a class="reference internal image-reference" href="../_images/bim_sequence_diagram_onchip_stacklib.png"><img alt="../_images/bim_sequence_diagram_onchip_stacklib.png" src="../_images/bim_sequence_diagram_onchip_stacklib.png" style="width: 885.0px; height: 900.0px;" /></a>
<p class="caption"><span class="caption-number">Figure 89. </span><span class="caption-text">Functional Overview of On-chip BIM (stack library)</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
<p>The image above is described in words below. In order to determine which image
is best to run, BIM takes the following measures:</p>
<ol class="arabic">
<li><p>At startup, the BIM checks the Image Validation field in the
<a class="reference internal" href="image-header.html#sec-oad-image-header"><span class="std std-ref">OAD Image Header</span></a>  and sets active flash page or image type based
on <a class="reference internal" href="#sect-ram-argument-stack-library"><span class="std std-ref">Application Execution switching using Validation Bytes in Flash</span></a>. If the Image Validation field is
unset it will default to flash page of 0 and image type of user application.</p></li>
<li><p>BIM checks <code class="docutils literal notranslate"><span class="pre">BIM_ONCHIP_MAX_NUM_SEARCHES</span></code> to make sure the max search
iterations have not been exceeded.</p></li>
<li><p>BIM will now go through every flash page in the internal flash in search for
a valid Image Identification value. This is done in the following way:</p>
<blockquote>
<div><ul class="simple">
<li><p>Read the first 8 bytes and compare to any valid image Identification
value</p></li>
<li><p>If a valid image header is found, BIM will read the entire image header</p></li>
<li><p>If a header is not found, increment the flash page and search again
(jump to step #2)</p></li>
</ul>
<p>This process is repeated until a valid image is found, or the max number of
search iterations is reached.</p>
</div></blockquote>
</li>
<li><p>Checks that the header and BIM version are compatible with the current BIM.</p>
<blockquote>
<div><ul class="simple">
<li><p>If this check fails, increase the flash page number and search again
(jump to step #2). If user application, change image type so that the BIM
boots into to persistent application before searching again.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>If a CRC has not been calculated on the image, calculate one and update CRC
status field.</p>
<blockquote>
<div><ul class="simple">
<li><p>If pending copy (stack image), do not update the CRC field yet, this will
be done after copy</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Check for security.</p>
<blockquote>
<div><ul class="simple">
<li><p>Ensure image is from a trusted peer by running ECDSA sign/verify
algorithm on the image.</p></li>
<li><p>If security check fails, increment the flash page and search again
(jump to step #2)</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default, <code class="docutils literal notranslate"><span class="pre">AUTHENTICATE_PERSISTENT_IMG</span></code> is defined in the BIM
application. This means the BIM will also check the validity of the
persistent application before booting into it.</p>
</div>
</div></blockquote>
</li>
<li><p>Check for a valid CRC and image copy status in image header (0xFE).</p>
<blockquote>
<div><ul class="simple">
<li><p>Copy new user image, calculate CRC to ensure copy succeeded. Update copy
status and CRC status fields accordingly.</p></li>
<li><p>If succeeded, set image type to persistent application and set flash page
number to 0.</p></li>
<li><p>If failed, continue searching.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Continue this process until an image is found or the max iterations (16
unsuccessful download attempts) is    performed.</p>
<blockquote>
<div><ul class="simple">
<li><p>If a valid image is found, jump to it</p></li>
<li><p>If no valid image is found and the max iterations have been performed,
go to low power mode.</p></li>
</ul>
</div></blockquote>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The execution flow described by the text and diagrams above is assuming
security is on. If using an unsecured BIM configuration, the process is the
same with the exception that there is no check for security.</p>
</div>
<div class="section" id="application-execution-switching-using-validation-bytes-in-flash">
<span id="sect-ram-argument-stack-library"></span><h2>Application Execution switching using Validation Bytes in Flash<a class="headerlink" href="#application-execution-switching-using-validation-bytes-in-flash" title="Permalink to this headline">¶</a></h2>
<p>In this scheme, BIM passes the execution based on the number of ‘0’ bits in the
Image Validation field. If the number of ‘0’s bits are odd, it will execute
persistent application and if the count is even it executes the user application.</p>
<p>By default, the Image Validation field in the image header will be set
0xFFFFFFFF. On power up, BIM will pass execution to the user application. When
user application wants to upload a new image, it has to switch the execution to
the persistent application. To do this, the application flips the first available
non-zero bit to ‘0’, starting from LSB in the ‘Image Validation’ field. Doing so
will make the number of ‘0’ bits an odd number. The application should then
perform a reset command.</p>
<p>After reset, the BIM will resume execution and check whether the count of ‘0’
bit is odd or even. Once it finds the odd count in the Image Validation field,
the BIM will run the persistent application image (which is initiated by the user
application). The persistent application will start downloading and the new user
image will be authenticated. If new image downloaded and stored successfully,
the ‘Image Validation’ field will be overwritten again to 0xFFFFFFFF and BIM
will be able to execute the newly downloaded image.</p>
<p>If the authentication or the ‘Image Identify’ command (see <a class="reference internal" href="../ti154stack/oad-transport.html#sect-oad-profile"><span class="std std-ref">OAD Messages</span></a>
for details) fails, user application that is already in flash should be re-
validated. In the persistent app, this is handled by flipping the first
available non-zero bit in the Image Validation field of the existing User
Application OAD Image Header to ‘0’. This makes the number of nonzero bits even.
The board then resets itself again. On startup, the BIM will check again whether
the count of ‘0’ bit is odd or even. This time it will find that the number of
nonzero bits is even, and the BIM executes the user application. This saves the
user application from an unauthorized OAD attempt. The four bytes will allow the
BIM to retry the execution switching process 16 times  between user and
persistent image without turning all bits to ‘0’s(16 unsuccessful downloads).
When all the bits are set to ‘0’s, BIM will always jump to persistent image
forcing the user to upgrade the user application.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="bim-off-chip.html" class="btn btn-neutral float-left" title="BIM for Off-Chip OAD" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="image-header.html" class="btn btn-neutral float-right" title="OAD Image Header" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2022, Texas Instruments.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>