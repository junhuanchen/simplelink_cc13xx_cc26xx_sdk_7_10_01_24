<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BIM for On-Chip OAD (Dual Image) &mdash; 
SimpleLink™ CC13XX/CC26XX SDK
Z-Stack User&#39;s Guide
 7.10.01 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OAD Image Header" href="image-header.html" />
    <link rel="prev" title="BIM for Off-Chip OAD" href="bim-off-chip.html" />
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug oad-secure bim-on-chip-dual-image";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../zigbee-guide/index-cc13xx_cc26xx.html" class="icon icon-home"> 
SimpleLink™ CC13XX/CC26XX SDK
Z-Stack User's Guide

          </a>
              <div class="version">
                7.10.01
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/quickstart-intro-cc13xx_cc26xx.html">Introduction to the SimpleLink CC13xx/CC26xx SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cc13xx_cc26xx/index-platform.html">SimpleLink Wireless MCU CC13xx and CC26xx Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee-guide/tirtos-index.html">TI-RTOS7 (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee/overview.html">SimpleLink CC13xx/CC26xx SDK Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee/developing_zigbee_applications.html">Developing Zigbee Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cc13xx_cc26xx/custom-hardware-cc13xx_cc26xx.html">Custom Hardware</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../zigbee-guide/zigbee-ota-index.html">Zigbee Over-The-Air Firmware Upgrade</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../zigbee/ota_upgrade.html">Z-Stack OTA Upgrade</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../zigbee-guide/oad-secure-index.html">Over-the-Air Download (OAD)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="oad-types.html">OAD Storage &amp; Security</a></li>
<li class="toctree-l3"><a class="reference internal" href="bim.html">Boot Image Manager (BIM)</a></li>
<li class="toctree-l3"><a class="reference internal" href="bim-off-chip.html">BIM for Off-Chip OAD</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">BIM for On-Chip OAD (Dual Image)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#application-execution-switching-using-validation-bytes-in-flash">Application Execution switching using Validation Bytes in Flash</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="image-header.html">OAD Image Header</a></li>
<li class="toctree-l3"><a class="reference internal" href="ext-flash-image-header.html">OAD External Flash Image Header</a></li>
<li class="toctree-l3"><a class="reference internal" href="flash-layout-off-chip.html">Flash Layout for Off-Chip OAD</a></li>
<li class="toctree-l3"><a class="reference internal" href="flash-layout-on-chip-dual-image.html">Flash Layout for On-Chip OAD</a></li>
<li class="toctree-l3"><a class="reference internal" href="tools.html">OAD Image Tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../zigbee-guide/creating-a-production-image.html">Creating a Production Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../zigbee-guide/revert-to-factory.html">Reverting to a Factory Image</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../coexistence/coexistence-ieee.html">Wi-Fi Coexistence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee-guide/debugging-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee/packet_sniffer.html">Packet Sniffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee-guide/sysconfig-index.html">System Configuration (SysConfig)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee-guide/migration_guide.html">Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee-guide/references-cc13xx_cc26xx.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee-guide/glossary.html">Terms and Acronyms</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../zigbee-guide/index-cc13xx_cc26xx.html">
SimpleLink™ CC13XX/CC26XX SDK
Z-Stack User's Guide
</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../zigbee-guide/index-cc13xx_cc26xx.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../zigbee-guide/zigbee-ota-index.html">Zigbee Over-The-Air Firmware Upgrade</a> &raquo;</li>
          <li><a href="../zigbee-guide/oad-secure-index.html">Over-the-Air Download (OAD)</a> &raquo;</li>
      <li>BIM for On-Chip OAD (Dual Image)</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="bim-for-on-chip-oad-dual-image">
<span id="sec-oad-bim-on-chip-dual-image"></span><h1>BIM for On-Chip OAD (Dual Image)<a class="headerlink" href="#bim-for-on-chip-oad-dual-image" title="Permalink to this headline">¶</a></h1>
<p>This section describes the behavior of the BIM for on-chip OAD where the
dual image approach is used. This approach requires two full application and
stack library pairs on the target device. As with off-chip OAD, it is BIM’s
responsibility to locate which image should be run. In an on-chip dual image
OAD system there are only two image areas stored at any moment:</p>
<blockquote>
<div><ul class="simple">
<li><p>Download application (0x00): Where the over-the-air image will be stored</p></li>
<li><p>Active application (0x01): OAD upgradeable application that implements OAD
reset service and user functionality</p></li>
</ul>
</div></blockquote>
<p>For more information about OAD image types, refer to the
<a class="reference internal" href="image-header.html#sec-oad-image-header"><span class="std std-ref">OAD Image Header</span></a> section of this chapter. The memory areas of each
application in an on-chip system is defined in the
<a class="reference internal" href="flash-layout-on-chip-dual-image.html#sect-on-chip-memory-layout-dual-image"><span class="std std-ref">Internal Flash Memory Layout</span></a> section.</p>
<p>Both applications can be responsible for storing a candidate image in
internal flash, performing all OAD procedures and protocols, updating the Image
Validation flash field in the OAD image header, and resetting the device when
appropriate. The Image Validation field is a shared RAM variable that allows the
application to indicate which image should be selected by the BIM before
resetting. This is described in <a class="reference internal" href="#sect-ram-argument-dual-image"><span class="std std-ref">Application Execution switching using Validation Bytes in Flash</span></a>.</p>
<p>Based on the Image Validation field in the image header, the BIM will decide
which image is most fit to run. The following will
describe the process by which the BIM selects an image.</p>
<div class="figure align-center" id="id5">
<span id="fig-bim-onchip-dual-image-flowchart"></span><a class="reference internal image-reference" href="../_images/bim_sequence_diagram_onchip_stacklib.png"><img alt="../_images/bim_sequence_diagram_onchip_stacklib.png" src="../_images/bim_sequence_diagram_onchip_stacklib.png" style="width: 885.0px; height: 900.0px;" /></a>
<p class="caption"><span class="caption-number">Figure 94. </span><span class="caption-text">Functional Overview of On-chip BIM (dual image)</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
<p>The image above is described in words below. In order to determine which image
is best to run, BIM takes the following measures:</p>
<ol class="arabic">
<li><p>At startup, the BIM checks the Image Validation field in the
<a class="reference internal" href="image-header.html#sec-oad-image-header"><span class="std std-ref">OAD Image Header</span></a>  and sets active flash page or image type based
on <a class="reference internal" href="#sect-ram-argument-dual-image"><span class="std std-ref">Application Execution switching using Validation Bytes in Flash</span></a>. If the Image Validation field is
unset it will default to flash page of 0.</p></li>
<li><p>BIM checks <code class="docutils literal notranslate"><span class="pre">BIM_ONCHIP_MAX_NUM_SEARCHES</span></code> to make sure the max search
iterations have not been exceeded.</p></li>
<li><p>BIM will now go through every flash page in the internal flash in search for
a valid Image Identification value. This is done in the following way:</p>
<blockquote>
<div><ul class="simple">
<li><p>Read the first 8 bytes and compare to any valid image Identification
value</p></li>
<li><p>If a valid image header is found, BIM will read the entire image header</p></li>
<li><p>If a header is not found, increment the flash page and search again
(jump to step #2)</p></li>
</ul>
<p>This process is repeated until a valid image is found, or the max number of
search iterations is reached.</p>
</div></blockquote>
</li>
<li><p>Checks that the header and BIM version are compatible with the current BIM.</p>
<blockquote>
<div><ul class="simple">
<li><p>If this check fails, increase the flash page number and search again
(jump to step #2).</p></li>
</ul>
</div></blockquote>
</li>
<li><p>If a CRC has not been calculated on the image, calculate one and update CRC
status field.</p>
<blockquote>
<div><ul class="simple">
<li><p>If pending copy (stack image), do not update the CRC field yet, this will
be done after copy</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Check for security.</p>
<blockquote>
<div><ul class="simple">
<li><p>Ensure image is from a trusted peer by running ECDSA sign/verify
algorithm on the image.</p></li>
<li><p>If security check fails, increment the flash page and search again
(jump to step #2)</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default, <code class="docutils literal notranslate"><span class="pre">BIM_DUAL_ONCHIP_IMAGE</span></code> is defined in the BIM
application. This means the BIM will also check the validity of the
downloaded application before booting into it.</p>
</div>
</div></blockquote>
</li>
<li><p>Check for a valid CRC and image copy status in image header (0xFE).</p>
<blockquote>
<div><ul class="simple">
<li><p>Copy new user image, calculate CRC to ensure copy succeeded. Update copy
status and CRC status fields accordingly.</p></li>
<li><p>If succeeded, set active application and flash page.</p></li>
<li><p>If failed, continue searching.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Continue this process until an image is found or the max iterations (16
unsuccessful download attempts) is performed.</p>
<blockquote>
<div><ul class="simple">
<li><p>If a valid image is found, jump to it</p></li>
<li><p>If no valid image is found and the max iterations have been performed,
go to low power mode.</p></li>
</ul>
</div></blockquote>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The execution flow described by the text and diagrams above is assuming
security is on. If using an unsecured BIM configuration, the process is the
same with the exception that there is no check for security.</p>
</div>
<div class="section" id="application-execution-switching-using-validation-bytes-in-flash">
<span id="sect-ram-argument-dual-image"></span><h2>Application Execution switching using Validation Bytes in Flash<a class="headerlink" href="#application-execution-switching-using-validation-bytes-in-flash" title="Permalink to this headline">¶</a></h2>
<p>In this scheme, BIM passes the execution based on the number of ‘0’ bits in the
Image Validation field. If the number of ‘0’s bits are odd, it will execute
download application and if the count is even it executes the user application.</p>
<p>By default, the Image Validation field in the image header will be set
0xFFFFFFFF. On power up, BIM will pass execution to the active application. When
active application has finished uploading a new image, it has to switch the execution
to the download application. To do this, the application flips the first available
non-zero bit to ‘0’, starting from LSB in the ‘Image Validation’ field. Doing so
will make the number of ‘0’ bits an odd number. The application should then
perform a reset command.</p>
<p>After reset, the BIM will resume execution and check whether the count of ‘0’
bit is odd or even. Once it finds the odd count in the Image Validation field,
the BIM will run the download application image (which is now the new active
application). If new image downloaded and stored successfully, the
‘Image Validation’ field will be overwritten again to 0xFFFFFFFF and BIM will
be able to execute the newly downloaded image.  The old active application area
will become the download application and the new active image will be authenticated.</p>
<p>If the authentication fails, active application that is already in flash should
be re-validated. In the download app, this is handled by flipping the first
available non-zero bit in the Image Validation field of the existing User
Application OAD Image Header to ‘0’. This makes the number of nonzero bits even.
The board then resets itself again. On startup, the BIM will check again whether
the count of ‘0’ bit is odd or even. This time it will find that the number of
nonzero bits is even, and the BIM executes the prior active application. This saves
the user application from an unauthorized OAD attempt. The four bytes will allow the
BIM to retry the execution switching process 16 times between active and
download images without turning all bits to ‘0’s(16 unsuccessful downloads).
When all the bits are set to ‘0’s, BIM will force low power mode.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="bim-off-chip.html" class="btn btn-neutral float-left" title="BIM for Off-Chip OAD" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="image-header.html" class="btn btn-neutral float-right" title="OAD Image Header" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2005-2022, Texas Instruments.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>