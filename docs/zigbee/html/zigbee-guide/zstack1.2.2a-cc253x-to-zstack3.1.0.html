<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Z-Stack 1.2.2a (CC253x) to Z-Stack 3.1.0 &mdash; 
SimpleLink™ CC13XX/CC26XX SDK
Z-Stack User&#39;s Guide
 7.10.01 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Z-Stack 1.2.2a (CC26x0) to Z-Stack 3.1.0" href="zstack1.2.2a-cc26x0-to-zstack3.1.0.html" />
    <link rel="prev" title="Z-Stack 3.0.x to Z-Stack 3.1.0" href="zstack3.0.x-to-zstack3.1.0.html" />
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug zigbee-guide zstack1.2.2a-cc253x-to-zstack3.1.0";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index-cc13xx_cc26xx.html" class="icon icon-home"> 
SimpleLink™ CC13XX/CC26XX SDK
Z-Stack User's Guide

          </a>
              <div class="version">
                7.10.01
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/quickstart-intro-cc13xx_cc26xx.html">Introduction to the SimpleLink CC13xx/CC26xx SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cc13xx_cc26xx/index-platform.html">SimpleLink Wireless MCU CC13xx and CC26xx Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="tirtos-index.html">TI-RTOS7 (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee/overview.html">SimpleLink CC13xx/CC26xx SDK Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee/developing_zigbee_applications.html">Developing Zigbee Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cc13xx_cc26xx/custom-hardware-cc13xx_cc26xx.html">Custom Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="zigbee-ota-index.html">Zigbee Over-The-Air Firmware Upgrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coexistence/coexistence-ieee.html">Wi-Fi Coexistence</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zigbee/packet_sniffer.html">Packet Sniffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="sysconfig-index.html">System Configuration (SysConfig)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="migration_guide.html">Migration Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="migration_guide.html#updating-from-previous-sdks">Updating from previous SDKs</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="migration_guide.html#porting-guides">Porting Guides</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="zstack3.6.0-to-zstack4.3.0.html">Z-Stack 3.6.0+ to Z-Stack 4.3.0</a></li>
<li class="toctree-l4"><a class="reference internal" href="zstack3.4.0-to-zstack3.5.0.html">Z-Stack 3.4.0 to Z-Stack 3.5.0</a></li>
<li class="toctree-l4"><a class="reference internal" href="zstack3.2.0-to-zstack3.3.0.html">Z-Stack 3.2.0 to Z-Stack 3.3.0</a></li>
<li class="toctree-l4"><a class="reference internal" href="zstack3.1.0-to-zstack3.2.0.html">Z-Stack 3.1.0 to Z-Stack 3.2.0</a></li>
<li class="toctree-l4"><a class="reference internal" href="zstack3.0.x-to-zstack3.1.0.html">Z-Stack 3.0.x to Z-Stack 3.1.0</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Z-Stack 1.2.2a (CC253x) to Z-Stack 3.1.0</a></li>
<li class="toctree-l4"><a class="reference internal" href="zstack1.2.2a-cc26x0-to-zstack3.1.0.html">Z-Stack 1.2.2a (CC26x0) to Z-Stack 3.1.0</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="migration_guide.html#migration-guides">Migration Guides</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="references-cc13xx_cc26xx.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Terms and Acronyms</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index-cc13xx_cc26xx.html">
SimpleLink™ CC13XX/CC26XX SDK
Z-Stack User's Guide
</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index-cc13xx_cc26xx.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="migration_guide.html">Migration Guide</a> &raquo;</li>
      <li>Z-Stack 1.2.2a (CC253x) to Z-Stack 3.1.0</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="z-stack-1-2-2a-cc253x-to-z-stack-3-1-0">
<span id="sec-zstack1-2-2a-to-stack3-1-0"></span><h1>Z-Stack 1.2.2a (CC253x) to Z-Stack 3.1.0<a class="headerlink" href="#z-stack-1-2-2a-cc253x-to-z-stack-3-1-0" title="Permalink to this headline">¶</a></h1>
<p>This section will describe a way to migrate a project from Z-Stack 1.2.2a for CC253x to
a Z-Stack 3.1.0 project.</p>
<p>For this guide, <em>SampleLight</em> from Z-Stack 1.2.2a for CC253x will be ported
over to Z-Stack 3.1.0.  The two releases are vastly divergent due to differences
in both device and RTOS support, as is covered in <a class="reference internal" href="cc253x-to-cc26x2.html#cc253x-to-cc26x2"><span class="std std-ref">CC253x to CC13xx or CC26xx</span></a>.
The recommended approach is to start with a Z-Stack 3.1.0 project that contains
the same base application as the porting target project and merge any custom functionality.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Z-Stack HA 1.2.2a is based off of the Zigbee PRO 2012 (r20) specification
whereas Z-Stack 3.x.x follows Zigbee PRO 2015 (r21) and later.  There are several
significant changes between these specifications that greatly affect the behavior of
the Zigbee mesh network, including child aging, enhanced security, BDB
specification, and Green Power as described in the <cite>What’s New in Zigbee 3.0 White Paper &lt;http://www.ti.com/lit/swra615&gt;</cite>.  This section
will only address application-level changes, network configuration changes are
further discussed in <a class="reference internal" href="cc253x-to-cc26x2.html#cc253x-to-cc26x2"><span class="std std-ref">CC253x to CC13xx or CC26xx</span></a>.</p>
</div>
<ol class="arabic">
<li><p>Choose a Z-Stack 3.1.0 example project that contains your target project’s base
functionality.  For reference and use in this example, <em>zc_light</em> from
C:\ti\simplelink_zigbee_sdk_plugin_2_20_00_06\examples\rtos\CC13xx or CC26xx_LAUNCHXL\zstack
is chosen as a starting point.</p></li>
<li><p>Modify the following Z-Stack 3.1.0 example files if any of the corresponding
were added or altered in the Z-Stack 1.2.2a project.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">zcl_samplelight_data.c</span></code> clusters, attributes, or simple descriptors</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">zcl_samplelight.h</span></code> application event definitions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">zcl_samplelight.c</span></code> event loop cases and callbacks</p></li>
</ul>
</li>
<li><p>Do not copy the Z-Stack 1.2.2a <code class="docutils literal notranslate"><span class="pre">OSAL_SampleLight.c</span></code> file and only make changes to the following
lines of the 3.1.0 <code class="docutils literal notranslate"><span class="pre">main.c</span></code></p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;zcl_samplelight.h&quot;</span><span class="cp"></span>

<span class="cm">/* Kick off application */</span><span class="w"></span>
<span class="n">zclSampleLight_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zstack_user0Cfg</span><span class="p">.</span><span class="n">nvFps</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>if the task name has been changed inside of <code class="docutils literal notranslate"><span class="pre">zcl_samplelight.c</span></code></p>
</div></blockquote>
</li>
</ol>
<p>The following items specifically concern <code class="docutils literal notranslate"><span class="pre">zcl_samplelight.c</span></code>:</p>
<ol class="arabic">
<li><p>Note the following differences for which all related code from Z-Stack 1.2.2a should not
be transferred to the Z-Stack 3.1.0 project:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">ZCL_EZMODE</span></code> is no longer used as this functionality is replaced by 3.0 Base Device Behavior</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">ZCL_REPORT</span></code> is deprecated as no longer being optional</p></li>
</ul>
</li>
<li><p>Note the following changes due to the TI-RTOS implementation:</p>
<ul class="simple">
<li><p>ICALL framework used to dispatch messages between Z-Stack and the application</p></li>
<li><p>Semaphores used to post and pend during event callbacks</p></li>
<li><p>Timer handling, i.e</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Timer_setTimeout</span><span class="p">(</span><span class="w"> </span><span class="n">LevelControlClkHandle</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="n">Timer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LevelControlClkStruct</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>versus <code class="code docutils literal notranslate"><span class="pre">osal_start_timerEx(</span> <span class="pre">zclSampleLight_TaskID,</span> <span class="pre">SAMPLELIGHT_LEVEL_CTRL_EVT,</span> <span class="pre">100</span> <span class="pre">);</span></code>.
Due to this and the reasons further provided below, all related code from Z-Stack 1.2.2a should
not be transferred to the Z-Stack 3.1.0 project.  For more information, please refer to
<a class="reference internal" href="tirtos-index.html#sec-tirtos-overview"><span class="std std-ref">TI-RTOS7 (RTOS Kernel) Overview</span></a>.</p>
</li>
<li><p>Separate 3.0 projects are used for each Zigbee device instead of a common application with multiple
configurations, therefore the <code class="docutils literal notranslate"><span class="pre">ZG_BUILD_[COORDINATOR/RTR/ENDDEVICE]_TYPE</span></code> definitions
are necessary</p></li>
<li><p>Green Power is enabled in 3.0, and therefore the following is added:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">gp_endpointInit(zclSampleLight_Entity);</span></code> and <code class="docutils literal notranslate"><span class="pre">app_Green_Power_Init</span></code> inside <code class="docutils literal notranslate"><span class="pre">zclSampleLight_Init</span></code></p></li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">zclSampleLight_process_loop</span></code></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if !defined (DISABLE_GREENPOWER_BASIC_PROXY) &amp;&amp; (ZG_BUILD_RTR_TYPE)</span>
<span class="w">       </span><span class="k">if</span><span class="p">(</span><span class="n">events</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SAMPLEAPP_PROCESS_GP_DATA_SEND_EVT</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">{</span><span class="w"></span>
<span class="w">           </span><span class="n">zcl_gpSendNotification</span><span class="p">();</span><span class="w"></span>
<span class="w">           </span><span class="n">events</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">SAMPLEAPP_PROCESS_GP_DATA_SEND_EVT</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>

<span class="w">       </span><span class="k">if</span><span class="p">(</span><span class="n">events</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SAMPLEAPP_PROCESS_GP_EXPIRE_DUPLICATE_EVT</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">{</span><span class="w"></span>
<span class="w">           </span><span class="n">gp_expireDuplicateFiltering</span><span class="p">();</span><span class="w"></span>
<span class="w">           </span><span class="n">events</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">SAMPLEAPP_PROCESS_GP_EXPIRE_DUPLICATE_EVT</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
</pre></div>
</div>
</li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">zclSampleLight_processZStackMsgs</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if !defined (DISABLE_GREENPOWER_BASIC_PROXY) &amp;&amp; (ZG_BUILD_RTR_TYPE)</span>
<span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="nl">zstackmsg_CmdIDs_GP_DATA_IND</span><span class="p">:</span><span class="w"></span>
<span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">zstackmsg_gpDataInd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pInd</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">pInd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">zstackmsg_gpDataInd_t</span><span class="o">*</span><span class="p">)</span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">gp_processDataIndMsg</span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">pInd</span><span class="o">-&gt;</span><span class="n">Req</span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="nl">zstackmsg_CmdIDs_GP_SECURITY_REQ</span><span class="p">:</span><span class="w"></span>
<span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">zstackmsg_gpSecReq_t</span><span class="w"> </span><span class="o">*</span><span class="n">pInd</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">pInd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">zstackmsg_gpSecReq_t</span><span class="o">*</span><span class="p">)</span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">gp_processSecRecMsg</span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">pInd</span><span class="o">-&gt;</span><span class="n">Req</span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="nl">zstackmsg_CmdIDs_GP_CHECK_ANNCE</span><span class="p">:</span><span class="w"></span>
<span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">zstackmsg_gpCheckAnnounce_t</span><span class="w"> </span><span class="o">*</span><span class="n">pInd</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">pInd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">zstackmsg_gpCheckAnnounce_t</span><span class="o">*</span><span class="p">)</span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">gp_processCheckAnnceMsg</span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">pInd</span><span class="o">-&gt;</span><span class="n">Req</span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Base Device Behavior is added to 3.0 and the following is added as such:</p>
<ul>
<li><p>In <code class="docutils literal notranslate"><span class="pre">zclSampleLight_Init</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined ( BDB_TL_INITIATOR )</span>
<span class="w">   </span><span class="n">touchLinkInitiatorApp_Init</span><span class="p">(</span><span class="n">zclSampleLight_Entity</span><span class="p">);</span><span class="w"></span>
<span class="cp">#elif defined ( BDB_TL_TARGET )</span>
<span class="w">   </span><span class="n">touchLinkTargetApp_Init</span><span class="p">(</span><span class="n">zclSampleLight_Entity</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">zclSampleLight_initParameters</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">zclSampleLight_initParameters</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttributesReq_t</span><span class="w"> </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">bdbCommissioningGroupID</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">BDB_DEFAULT_COMMISSIONING_GROUP_ID</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">bdbPrimaryChannelSet</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="n">BDB_DEFAULT_PRIMARY_CHANNEL_SET</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">bdbScanDuration</span><span class="w">                      </span><span class="o">=</span><span class="w"> </span><span class="n">BDB_DEFAULT_SCAN_DURATION</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">bdbSecondaryChannelSet</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="n">BDB_DEFAULT_SECONDARY_CHANNEL_SET</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">has_bdbCommissioningGroupID</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">has_bdbPrimaryChannelSet</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">has_bdbScanDuration</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">has_bdbSecondaryChannelSet</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="cp">#if (ZG_BUILD_COORDINATOR_TYPE)</span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">has_bdbJoinUsesInstallCodeKey</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">has_bdbTrustCenterNodeJoinTimeout</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">has_bdbTrustCenterRequireKeyExchange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">bdbJoinUsesInstallCodeKey</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">BDB_DEFAULT_JOIN_USES_INSTALL_CODE_KEY</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">bdbTrustCenterNodeJoinTimeout</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">BDB_DEFAULT_TC_NODE_JOIN_TIMEOUT</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">bdbTrustCenterRequireKeyExchange</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">BDB_DEFAULT_TC_REQUIRE_KEY_EXCHANGE</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="cp">#endif</span>
<span class="w"> </span><span class="cp">#if (ZG_BUILD_JOINING_TYPE)</span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">has_bdbTCLinkKeyExchangeAttemptsMax</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">has_bdbTCLinkKeyExchangeMethod</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">bdbTCLinkKeyExchangeAttemptsMax</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">BDB_DEFAULT_TC_LINK_KEY_EXCHANGE_ATTEMPS_MAX</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbSetAttrReq</span><span class="p">.</span><span class="n">bdbTCLinkKeyExchangeMethod</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">BDB_DEFAULT_TC_LINK_KEY_EXCHANGE_METHOD</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="cp">#endif</span>

<span class="w">     </span><span class="n">Zstackapi_bdbSetAttributesReq</span><span class="p">(</span><span class="n">zclSampleLight_Entity</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">zstack_bdbSetAttrReq</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">zclSampleLight_process_loop</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if ZG_BUILD_ENDDEVICE_TYPE</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SAMPLEAPP_END_DEVICE_REJOIN_EVT</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">zstack_bdbZedAttemptRecoverNwkRsp_t</span><span class="w"> </span><span class="n">zstack_bdbZedAttemptRecoverNwkRsp</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="n">Zstackapi_bdbZedAttemptRecoverNwkReq</span><span class="p">(</span><span class="n">zclSampleLight_Entity</span><span class="p">,</span><span class="o">&amp;</span><span class="n">zstack_bdbZedAttemptRecoverNwkRsp</span><span class="p">);</span><span class="w"></span>

<span class="w">     </span><span class="n">events</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">SAMPLEAPP_END_DEVICE_REJOIN_EVT</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
</pre></div>
</div>
</li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">zclSampleLight_processZStackMsgs</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">switch</span><span class="p">(</span><span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">event</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="nl">zstackmsg_CmdIDs_BDB_NOTIFICATION</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">zstackmsg_bdbNotificationInd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pInd</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">pInd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">zstackmsg_bdbNotificationInd_t</span><span class="o">*</span><span class="p">)</span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">zclSampleLight_ProcessCommissioningStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pInd</span><span class="o">-&gt;</span><span class="n">Req</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nl">zstackmsg_CmdIDs_BDB_IDENTIFY_TIME_CB</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">zstackmsg_bdbIdentifyTimeoutInd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pInd</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">pInd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">zstackmsg_bdbIdentifyTimeoutInd_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">uiProcessIdentifyTimeChange</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pInd</span><span class="o">-&gt;</span><span class="n">EndPoint</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nl">zstackmsg_CmdIDs_BDB_BIND_NOTIFICATION_CB</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">zstackmsg_bdbBindNotificationInd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pInd</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">pInd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">zstackmsg_bdbBindNotificationInd_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="n">uiProcessBindNotification</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pInd</span><span class="o">-&gt;</span><span class="n">Req</span><span class="p">));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="cp">#if (ZG_BUILD_JOINING_TYPE)</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nl">zstackmsg_CmdIDs_BDB_CBKE_TC_LINK_KEY_EXCHANGE_IND</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">zstack_bdbCBKETCLinkKeyExchangeAttemptReq_t</span><span class="w"> </span><span class="n">zstack_bdbCBKETCLinkKeyExchangeAttemptReq</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Z3.0 has not defined CBKE yet, so lets attempt default TC Link Key exchange procedure</span>
<span class="cm">     * by reporting CBKE failure.</span>
<span class="cm">     */</span><span class="w"></span>

<span class="w">    </span><span class="n">zstack_bdbCBKETCLinkKeyExchangeAttemptReq</span><span class="p">.</span><span class="n">didSuccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">Zstackapi_bdbCBKETCLinkKeyExchangeAttemptReq</span><span class="p">(</span><span class="n">zclSampleLight_Entity</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                 </span><span class="o">&amp;</span><span class="n">zstack_bdbCBKETCLinkKeyExchangeAttemptReq</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nl">zstackmsg_CmdIDs_BDB_FILTER_NWK_DESCRIPTOR_IND</span><span class="p">:</span><span class="w"></span>

<span class="w">   </span><span class="cm">/*   User logic to remove networks that do not want to join</span>
<span class="cm">    *   Networks to be removed can be released with Zstackapi_bdbNwkDescFreeReq</span>
<span class="cm">    */</span><span class="w"></span>

<span class="w">    </span><span class="n">Zstackapi_bdbFilterNwkDescComplete</span><span class="p">(</span><span class="n">zclSampleLight_Entity</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="cp">#endif</span>

<span class="w">  </span><span class="cp">#ifdef BDB_TL_TARGET</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nl">zstackmsg_CmdIDs_BDB_TOUCHLINK_TARGET_ENABLE_IND</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">zstackmsg_bdbTouchLinkTargetEnableInd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pInd</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">pInd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">zstackmsg_bdbTouchLinkTargetEnableInd_t</span><span class="o">*</span><span class="p">)</span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">uiProcessTouchlinkTargetEnable</span><span class="p">(</span><span class="n">pInd</span><span class="o">-&gt;</span><span class="n">Enable</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="cp">#endif</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">zclSampleLight_ProcessCommissioningStatus(bdbCommissioningModeMsg_t</span> <span class="pre">*bdbCommissioningModeMsg)</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">zclSampleLight_ProcessCommissioningStatus</span><span class="p">(</span><span class="n">bdbCommissioningModeMsg_t</span><span class="w"> </span><span class="o">*</span><span class="n">bdbCommissioningModeMsg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="p">(</span><span class="n">bdbCommissioningModeMsg</span><span class="o">-&gt;</span><span class="n">bdbCommissioningMode</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">BDB_COMMISSIONING_FORMATION</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">bdbCommissioningModeMsg</span><span class="o">-&gt;</span><span class="n">bdbCommissioningStatus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BDB_COMMISSIONING_SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">zstack_bdbStartCommissioningReq_t</span><span class="w"> </span><span class="n">zstack_bdbStartCommissioningReq</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">//After formation, perform nwk steering again plus the remaining commissioning modes that has not been process yet</span>
<span class="w">        </span><span class="n">zstack_bdbStartCommissioningReq</span><span class="p">.</span><span class="n">commissioning_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BDB_COMMISSIONING_MODE_NWK_STEERING</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">bdbCommissioningModeMsg</span><span class="o">-&gt;</span><span class="n">bdbRemainingCommissioningModes</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">Zstackapi_bdbStartCommissioningReq</span><span class="p">(</span><span class="n">zclSampleLight_Entity</span><span class="p">,</span><span class="o">&amp;</span><span class="n">zstack_bdbStartCommissioningReq</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//Want to try other channels?</span>
<span class="w">        </span><span class="c1">//try with bdb_setChannelAttribute</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">BDB_COMMISSIONING_NWK_STEERING</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">bdbCommissioningModeMsg</span><span class="o">-&gt;</span><span class="n">bdbCommissioningStatus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BDB_COMMISSIONING_SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//YOUR JOB:</span>
<span class="w">        </span><span class="c1">//We are on the nwk, what now?</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//See the possible errors for nwk steering procedure</span>
<span class="w">        </span><span class="c1">//No suitable networks found</span>
<span class="w">        </span><span class="c1">//Want to try other channels?</span>
<span class="w">        </span><span class="c1">//try with bdb_setChannelAttribute</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">BDB_COMMISSIONING_FINDING_BINDING</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">bdbCommissioningModeMsg</span><span class="o">-&gt;</span><span class="n">bdbCommissioningStatus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BDB_COMMISSIONING_SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//YOUR JOB:</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//YOUR JOB:</span>
<span class="w">        </span><span class="c1">//retry?, wait for user interaction?</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">BDB_COMMISSIONING_INITIALIZATION</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="c1">//Initialization notification can only be successful. Failure on initialization</span>
<span class="w">      </span><span class="c1">//only happens for ZED and is notified as BDB_COMMISSIONING_PARENT_LOST notification</span>

<span class="w">      </span><span class="c1">//YOUR JOB:</span>
<span class="w">      </span><span class="c1">//We are on a network, what now?</span>

<span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if ZG_BUILD_ENDDEVICE_TYPE</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">BDB_COMMISSIONING_PARENT_LOST</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">bdbCommissioningModeMsg</span><span class="o">-&gt;</span><span class="n">bdbCommissioningStatus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BDB_COMMISSIONING_NETWORK_RESTORED</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//We did recover from losing parent</span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//Parent not found, attempt to rejoin again after a fixed delay</span>
<span class="w">        </span><span class="n">Timer_setTimeout</span><span class="p">(</span><span class="w"> </span><span class="n">EndDeviceRejoinClkHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SAMPLEAPP_END_DEVICE_REJOIN_DELAY</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Timer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EndDeviceRejoinClkStruct</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">UI_UpdateComissioningStatus</span><span class="p">(</span><span class="n">bdbCommissioningModeMsg</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Key events are now handled locally in <code class="docutils literal notranslate"><span class="pre">zclSampleLight_processKey</span></code> instead
of <code class="docutils literal notranslate"><span class="pre">zclSampleLight_HandleKeys</span></code>.  A UART interface is preferred over LCD.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">main.c</span></code> calls the <code class="docutils literal notranslate"><span class="pre">zclSampleLight_task</span></code> function</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">zclSampleLight_task</span><span class="p">(</span><span class="n">NVINTF_nvFuncts_t</span><span class="w"> </span><span class="o">*</span><span class="n">pfnNV</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Save and register the function pointers to the NV drivers</span>
<span class="w">      </span><span class="n">pfnZdlNV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pfnNV</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">zclport_registerNV</span><span class="p">(</span><span class="n">pfnZdlNV</span><span class="p">,</span><span class="w"> </span><span class="n">ZCL_PORT_SCENE_TABLE_NV_ID</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Initialize application</span>
<span class="w">      </span><span class="n">zclSampleLight_initialization</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="c1">// No return from task process</span>
<span class="w">      </span><span class="n">zclSampleLight_process_loop</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>to initialize the application</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">zclSampleLight_initialization</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* Initialize user clocks */</span><span class="w"></span>
<span class="w">        </span><span class="n">zclSampleLight_initializeClocks</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* Initialize keys */</span><span class="w"></span>
<span class="w">        </span><span class="n">Board_Key_initialize</span><span class="p">(</span><span class="n">zclSampleLight_changeKeyCallback</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* Initialize the LEDS */</span><span class="w"></span>
<span class="w">        </span><span class="n">Board_Led_initialize</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Register the current thread as an ICall dispatcher application</span>
<span class="w">        </span><span class="c1">// so that the application can send and receive messages.</span>
<span class="w">        </span><span class="n">ICall_registerApp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zclSampleLight_Entity</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sem</span><span class="p">);</span><span class="w"></span>


<span class="w">        </span><span class="c1">//Initialize stack</span>
<span class="w">        </span><span class="n">zclSampleLight_Init</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>which in-turn initializes the clocks, keys, LEDs, and ICall dispatcher before initializing
the stack.  This is compared with Z-Stack 1.2.2a where all of the above was accomplished
in <code class="docutils literal notranslate"><span class="pre">main</span></code> and <code class="docutils literal notranslate"><span class="pre">zclSampleLight_Init</span></code>.</p>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">zclSampleLight_Init</span></code> registers endpoints using</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//Register Endpoint</span>
<span class="n">zclSampleLightEpDesc</span><span class="p">.</span><span class="n">endPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SAMPLELIGHT_ENDPOINT</span><span class="p">;</span><span class="w"></span>
<span class="n">zclSampleLightEpDesc</span><span class="p">.</span><span class="n">simpleDesc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">zclSampleLight_SimpleDesc</span><span class="p">;</span><span class="w"></span>
<span class="n">zclport_registerEndpoint</span><span class="p">(</span><span class="n">zclSampleLight_Entity</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">zclSampleLightEpDesc</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>instead of</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Register the Simple Descriptor for this application</span>
<span class="n">zclHA_Init</span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="n">zclSampleLight_SimpleDesc</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>and registers applications with</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Register the Application to receive the unprocessed Foundation command/response messages</span>
<span class="n">zclport_registerZclHandleExternal</span><span class="p">(</span><span class="n">zclSampleLight_ProcessIncomingMsg</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>as compared to</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Register the Application to receive the unprocessed Foundation command/response messages</span>
<span class="n">zcl_registerForMsg</span><span class="p">(</span><span class="w"> </span><span class="n">zclSampleLight_TaskID</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">zclSampleLight_process_loop</span></code> is used in place of <code class="docutils literal notranslate"><span class="pre">zclSampleLight_event_loop</span></code> and uses
ICall to receive messages instead of <code class="docutils literal notranslate"><span class="pre">SYS_EVENT_MSG</span></code> events and <code class="docutils literal notranslate"><span class="pre">osal_msg_receive</span></code></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ICall_ServiceEnum</span><span class="w"> </span><span class="n">stackid</span><span class="p">;</span><span class="w"></span>
<span class="n">ICall_EntityID</span><span class="w"> </span><span class="n">dest</span><span class="p">;</span><span class="w"></span>
<span class="n">zstackmsg_genericReq_t</span><span class="w"> </span><span class="o">*</span><span class="n">pMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>

<span class="cm">/* Wait for response message */</span><span class="w"></span>
<span class="k">if</span><span class="p">(</span><span class="n">ICall_wait</span><span class="p">(</span><span class="n">ICALL_TIMEOUT_FOREVER</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ICALL_ERRNO_SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Retrieve the response message */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ICall_fetchServiceMsg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stackid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pMsg</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="o">==</span><span class="w"> </span><span class="n">ICALL_ERRNO_SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">stackid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ICALL_SERVICE_CLASS_ZSTACK</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">dest</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">zclSampleLight_Entity</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">pMsg</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">zclSampleLight_processZStackMsgs</span><span class="p">(</span><span class="n">pMsg</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="c1">// Free any separately allocated memory</span>
<span class="w">                </span><span class="n">Zstackapi_freeIndMsg</span><span class="p">(</span><span class="n">pMsg</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pMsg</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">ICall_freeMsg</span><span class="p">(</span><span class="n">pMsg</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">//**EVENT HANDLING NOT SHOWN**</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">zclSampleLight_processZStackMsgs</span></code> and <code class="docutils literal notranslate"><span class="pre">zclSampleLight_processAfIncomingMsgInd</span></code>
is used in place of <code class="docutils literal notranslate"><span class="pre">zclSampleLight_ProcessIncomingMsg</span></code></p>
<ul>
<li><p>In <code class="docutils literal notranslate"><span class="pre">zclSampleLight_processZStackMsgs</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">switch</span><span class="p">(</span><span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">event</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//**OTHER CASES NOT SHOWN**</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">zstackmsg_CmdIDs_AF_INCOMING_MSG_IND</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Process incoming data messages</span>
<span class="w">        </span><span class="n">zstackmsg_afIncomingMsgInd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pInd</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">pInd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">zstackmsg_afIncomingMsgInd_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">zclSampleLight_processAfIncomingMsgInd</span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">pInd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Structure type <code class="docutils literal notranslate"><span class="pre">zclIncomingMsg_t</span></code> has been renamed <code class="docutils literal notranslate"><span class="pre">zclIncoming_t</span></code></p></li>
<li><p>Add any other Z-Stack 1.2.2a application changes to the Z-Stack 3.1.0 file if not
pertaining to the items listed above.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Difference comparison software is recommended for discerning all differences
between software stacks.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="zstack3.0.x-to-zstack3.1.0.html" class="btn btn-neutral float-left" title="Z-Stack 3.0.x to Z-Stack 3.1.0" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="zstack1.2.2a-cc26x0-to-zstack3.1.0.html" class="btn btn-neutral float-right" title="Z-Stack 1.2.2a (CC26x0) to Z-Stack 3.1.0" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2005-2022, Texas Instruments.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>