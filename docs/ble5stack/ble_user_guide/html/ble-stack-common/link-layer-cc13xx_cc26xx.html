<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Link Layer (LL) &mdash; 
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User&#39;s Guide
 2.02.08.01 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Channel Selection Algorithm #2" href="../ble-stack-5.x/channel-selection-algorithm-number-two.html" />
    <link rel="prev" title="Logical Link Control and Adaptation Layer Protocol (L2CAP)" href="l2cap.html" />
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug ble-stack-common link-layer-cc13xx_cc26xx";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html" class="icon icon-home"> 
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User's Guide

          </a>
              <div class="version">
                2.02.08.01
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/disclaimer.html">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/quickstart-intro-cc13xx_cc26xx.html">Introduction to the SimpleLink CC13xx/CC26xx SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/ble5-quick-start.html">TI BLE5-Stack Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/platform-cc13xx_cc26xx.html">The CC13xx or CC26xx SDK Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/tirtos-index-cc13xx_cc26xx.html">TI-RTOS7 (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/freertos-index.html">FreeRTOS (RTOS Kernel) Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../ble-stack-5.x-guide/ble-stack-5-index-cc13xx_cc26xx.html">BLE5-Stack</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x/overview-cc13xx_cc26xx.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x/gap-cc13xx_cc26xx.html">Generic Access Profile (GAP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x/gatt.html">Generic Attribute Profile (GATT)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x/gatt.html#gap-gatt-service-ggs">GAP GATT Service (GGS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x/gatt.html#generic-attribute-profile-service-gatt-service">Generic Attribute Profile Service (GATT Service)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x/gatt.html#gattservapp-module">GATTServApp Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x/gapbondmngr-cc13xx_cc26xx.html">GAP Bond Manager and LE Secure Connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x/privacy.html">Privacy</a></li>
<li class="toctree-l2"><a class="reference internal" href="l2cap.html">Logical Link Control and Adaptation Layer Protocol (L2CAP)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Link Layer (LL)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#link-layer-primary-task">Link Layer Primary Task</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#central-role">Central Role</a></li>
<li class="toctree-l4"><a class="reference internal" href="#peripheral-role">Peripheral Role</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connection-fairness">Connection Fairness</a></li>
<li class="toctree-l4"><a class="reference internal" href="#primary-task-user-configuration">Primary Task User Configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#link-layer-secondary-task">Link Layer Secondary Task</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#secondary-task-user-configuration">Secondary Task User Configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#link-layer-control-packet-buffer">Link Layer Control Packet Buffer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#link-layer-buffers">Link Layer Buffers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#tx-queues">TX Queues</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rx-queues">RX Queues</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#le-data-length-extension-dle">LE Data Length Extension (DLE)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#dle-update-procedure-and-definitions">DLE Update Procedure and Definitions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#default-application-dle-behavior">Default Application DLE Behavior</a></li>
<li class="toctree-l4"><a class="reference internal" href="#utilizing-dle-in-the-application">Utilizing DLE in the Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#disabling-dle-at-runtime">Disabling DLE at Runtime</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interoperability-with-legacy-peers">Interoperability with Legacy Peers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ram-considerations-when-using-dle">RAM Considerations when using DLE</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#connections-design">32 Connections Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tx-power-backoff-table-for-cc13x2p-devices">TX Power Backoff Table for CC13x2P Devices</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x/channel-selection-algorithm-number-two.html">Channel Selection Algorithm #2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x/hci.html">Host Controller Interface (HCI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x/phy.html">Physical Layer (PHY)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x/stack-configuration-cc13xx_cc26xx.html">Stack Configurations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html">Developing a Bluetooth LE Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coexistence/coexistence.html">Coexistence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/localization-index-cc13xx_cc26xx.html">RTLS Toolbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-mesh/index.html">Bluetooth Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/u-stack-index-cc13xx_cc26xx.html">Micro BLE Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sensor-controller/sensor-controller.html">Sensor Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/debugging-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/memory-index.html">Memory Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="npi-index.html">Network Processor Interface (NPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble5-oad-index-cc13xx_cc26xx.html">TI Over-the-Air Download (OAD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble5-oad-index-mcuboot.html">MCUBoot Over-the-Air Download (OAD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security-tfm/index.html">Security Features of CC13x4 and CC26x4 Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/sysconfig-index-cc13xx_cc26xx.html">System Configuration Tool (SysConfig)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/migration-cc13xx_cc26xx.html">Porting Guide and Migration Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13xx_cc26xx.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html">Terms and Definitions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html">
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User's Guide
</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../ble-stack-5.x-guide/ble-stack-5-index-cc13xx_cc26xx.html">BLE5-Stack</a> &raquo;</li>
      <li>Link Layer (LL)</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="link-layer-ll">
<span id="link-layer"></span><h1>Link Layer (LL)<a class="headerlink" href="#link-layer-ll" title="Permalink to this headline">¶</a></h1>
<p>The link layer is the interface to the physical layer (PHY) and it controls
the RF state of the device. In BLE, there are 5 states a device can be in.</p>
<blockquote>
<div><ul class="simple">
<li><p>Standby</p></li>
<li><p>Advertising</p></li>
<li><p>Scanning</p></li>
<li><p>Initiating</p></li>
<li><p>Connected</p></li>
</ul>
</div></blockquote>
<p>Since LL controls the RF state of the device, it means that it is also
responsible for the scheduling (For example: <a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html#term-Anchor-Point"><span class="xref std std-term">Anchor Point</span></a>),
physical channel to be on and length of the packets.</p>
<p>There are six events that scheduler needs to take care of. These are:</p>
<blockquote>
<div><ul class="simple">
<li><p>Initiating</p></li>
<li><p>Advertising</p></li>
<li><p>Scanning</p></li>
<li><p>Periodic Advertising</p></li>
<li><p>Periodic Scanning</p></li>
<li><p>Connection</p></li>
</ul>
</div></blockquote>
<p>In the TI BLE5-Stack, we categorize those events into primary and secondary
tasks. Only connection events are a primary task. The rest are secondary tasks.</p>
<p>By default, when there is a timing conflict between a primary task and secondary task,
the LL will prioritize the primary task and push the secondary task
to a later time. However, if the application layer specifies that the secondary
task has higher priority than the primary task and the primary task has not
reached half of its supervision timeout or entered connection establishment phase,
the LL will prioritize the secondary task over the primary task.</p>
<div class="section" id="link-layer-primary-task">
<span id="sec-ll-primary-tasks"></span><h2>Link Layer Primary Task<a class="headerlink" href="#link-layer-primary-task" title="Permalink to this headline">¶</a></h2>
<p>When devices enter connection state, they are either central or peripheral
devices.</p>
<div class="section" id="central-role">
<span id="sec-ll-central-role"></span><h3>Central Role<a class="headerlink" href="#central-role" title="Permalink to this headline">¶</a></h3>
<p>The central device has full control over anchor points, therefore,
it is possible to avoid timing conflicts.</p>
<p>In our BLE5-Stack, as a central device, there are 2 options for the LL scheduler to
form anchor points.</p>
<blockquote>
<div><ul class="simple">
<li><p>The anchor points are formed randomly with no restriction on timing. This
is the case for all our out of box examples.</p></li>
<li><p>The anchor points will be formed after previous connection event with 5ms guard time. This
is achieved when you modify it through Sysconfig –&gt; Advanced Setting –&gt;
Extended Stack Settings –&gt; Guard Time.</p></li>
</ul>
</div></blockquote>
<p>Using the second option, we can achieve one central device maintaining
connection with 32 peripheral devices. For more information, please refer to
<a class="reference internal" href="#sec-32-connections"><span class="std std-ref">32 Connections Design</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>TI BLE5-Stack will not move the anchor points after connection parameter
updates if using the same set of connection parameters.</p>
</div>
<p>However, there is also a chance for central role to have timing conflicts when
managing multiple connections, thus in TI BLE5-Stack we implemented a connection
fairness mechanism to handle this. For more information, please refer to <a class="reference internal" href="#sec-connection-fairness"><span class="std std-ref">Connection Fairness</span></a>.</p>
</div>
<div class="section" id="peripheral-role">
<span id="sec-ll-peripheral-role"></span><h3>Peripheral Role<a class="headerlink" href="#peripheral-role" title="Permalink to this headline">¶</a></h3>
<p>Since the peripheral device has little to no control over anchor points,
we use the connection fairness mechanism to handle any potential timing conflicts.</p>
</div>
<div class="section" id="connection-fairness">
<span id="sec-connection-fairness"></span><h3>Connection Fairness<a class="headerlink" href="#connection-fairness" title="Permalink to this headline">¶</a></h3>
<p>Connection fairness is implemented in the LL to make sure that each connection
has an equal number of scheduled opportunities to transmit if the priorities
are the same.</p>
<p>Before going into the detail, we need to understand how the LL determines whether
there will be collisions among connections.</p>
<p>For each connection, the LL will calculate the minimum time required for the
whole connection event (<code class="docutils literal notranslate"><span class="pre">connMinLength</span></code>) based on the following parameters:</p>
<blockquote>
<div><ul class="simple">
<li><p>A single event which means it assumes there is no <a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html#term-MD"><span class="xref std std-term">MD</span></a> in the same connection
event.</p></li>
<li><p>Phy used in the connection.</p></li>
<li><p>If PDU size is specified by application layer, then BLE5-Stack will take that into
calculation. Otherwise, the Max PDU size is taken into account if users do not
specify PDU size for the specific connection.</p></li>
<li><p>The processing time for the radio core and BLE5-Stack which is set to 500us.</p></li>
</ul>
</div></blockquote>
<p>Before each connection happens, the LL will sort all the connections based on
the future start time and calculate the time difference(<code class="docutils literal notranslate"><span class="pre">ConnDiff</span></code>) between
two next connection events. Then do a comparison between <code class="docutils literal notranslate"><span class="pre">ConnDiff</span></code> and
<code class="docutils literal notranslate"><span class="pre">connMinLength</span></code>.  If <code class="docutils literal notranslate"><span class="pre">ConnDiff</span></code> is smaller than/equal to
<code class="docutils literal notranslate"><span class="pre">connMinLength</span></code>, then LL will conclude there is collision.</p>
<img alt="../_images/ditaa-5e5c006b6e6885a0ba02bc19c830f720c2a644ea.png" src="../_images/ditaa-5e5c006b6e6885a0ba02bc19c830f720c2a644ea.png" />
<p>If there is no collision between connection 1 and connection 2, then
connection 1 will be selected and scheduled to send out with connection cut
off time(<code class="docutils literal notranslate"><span class="pre">connMaxLength</span></code>) set to one of the following:</p>
<ol class="arabic simple">
<li><p>95% of the connection interval of the selected connection if the selected
connection has the highest priority.</p></li>
<li><p>95% of the connection interval of the selected connection if the connection
interval of the selected connection is smaller than time difference between
selected connection and the highest priority connection.</p></li>
<li><p>Time difference between selected connection and the highest priority
connection.</p></li>
</ol>
<p>If there is collision between connection 1 and connection 2, then LL will
start looking into the priority between these two connections. This is when
connection fairness comes into play. Connection fairness takes the following
factors into consideration and the list below is in order of priorities from
high to low:</p>
<blockquote>
<div><ul>
<li><p>Connection reaches half of its supervision time-out.</p></li>
<li><p>Connection is in the establishment phase, which means the first 6 connection
events.</p></li>
<li><p>Connection is in a instant. For example: connection parameter update,
channel map update or phy update.</p></li>
<li><p>Connection priority, which can be configured from application layer.</p></li>
<li><p>Connection with higher miss count.</p></li>
<li><p>Connection with earliest start time.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Miss count here only represents the number of missed connection events
caused by running connection fairness algorithm. The miss count will be reset
to 0 if the connection event is scheduled and the peer device meets at the
connection event.
If the connection is chosen to be scheduled by LL but the peer device disappeared
from the connection, then the miss count will not be incremented.
This ensures the miss count of other connections that currently are
in conflicts will eventually be higher and get to be scheduled(if not
reaching half of its supervision timeout already).</p>
</div>
</li>
</ul>
</div></blockquote>
<p>After sorting out the priority between connection 1 and connection 2, if we
assume that connection 2 has higher priority over connection 1 due to the above
reasons, then LL will remove connection 1 from its queue and the miss count
for connection 1 will be incremented by 1. Afterwards, LL will continue to find
out whether there is collision between connection 2 and connection 3.</p>
<img alt="../_images/ditaa-9345ee0c3a2bc8fb10fe781ce31c4f1d09eea0fc.png" src="../_images/ditaa-9345ee0c3a2bc8fb10fe781ce31c4f1d09eea0fc.png" />
</div>
<div class="section" id="primary-task-user-configuration">
<span id="sec-ll-primary-task-user-config"></span><h3>Primary Task User Configuration<a class="headerlink" href="#primary-task-user-configuration" title="Permalink to this headline">¶</a></h3>
<p>Previously we mentioned that there are certain parameters that users
can set to affect how LL treats connections.</p>
<p>You can do it by configuring per connection after it has been formed
or all the connections made afterwards.</p>
<div class="section" id="configuration-per-connection">
<h4>Configuration per Connection<a class="headerlink" href="#configuration-per-connection" title="Permalink to this headline">¶</a></h4>
<p>To achieve this, you can use <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#gafafdf0429af264dba5844a326b713867">HCI_EXT_SetQOSParameters()</a>.
By using this function, you can specify priority and the max/min
connection length for specific connection.</p>
<p>One of the input for <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#gafafdf0429af264dba5844a326b713867">HCI_EXT_SetQOSParameters()</a> is taskHandle,
which in this case is the connection handle.
That also means you can change the connection priority, max/min
connection length on the fly.</p>
<p>The parameters of interest for this function are as following and
you can find more information regarding the valid range/options/units
by looking at <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#gafafdf0429af264dba5844a326b713867">HCI_EXT_SetQOSParameters()</a>.</p>
<blockquote>
<div><table class="docutils align-default" id="id2">
<caption><span class="caption-number">Table 16. </span><span class="caption-text">HCI_EXT_SetQOSParameters Parameter Type Descriptions</span><a class="headerlink" href="#id2" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 38%" />
<col style="width: 62%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>LL_QOS_TYPE_PRIORITY</p></td>
<td><p>Task priority</p></td>
</tr>
<tr class="row-odd"><td><p>LL_QOS_TYPE_CONN_MIN_LENGTH</p></td>
<td><p>Minimum time required for the connection</p></td>
</tr>
<tr class="row-even"><td><p>LL_QOS_TYPE_CONN_MAX_LENGTH</p></td>
<td><p>Maximum time required for the connection</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#gafafdf0429af264dba5844a326b713867">HCI_EXT_SetQOSParameters()</a> can only be used for an already
made connection.</p>
</div>
</div>
<div class="section" id="configuration-for-all-subsequent-connections">
<h4>Configuration for all Subsequent Connections<a class="headerlink" href="#configuration-for-all-subsequent-connections" title="Permalink to this headline">¶</a></h4>
<p>If you do not want to deal with all the extra parameters other than
connection priority, then you can use
<a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#ga0665ccc36bdc37537e933839c8452f40">HCI_EXT_SetQOSDefaultParameters()</a>. By default, the priority for all
the connections is <code class="docutils literal notranslate"><span class="pre">LL_QOS_MEDIUM_PRIORITY</span></code>. To change that you can do the
following. All the connections that are made after this call will have the new
priority other than default.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-number">Listing 149. </span><span class="caption-text">Change priority to low for the new connections</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">HCI_EXT_SetQOSDefaultParameters</span><span class="p">(</span><span class="n">LL_QOS_LOW_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="n">LL_QOS_TYPE_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="n">LL_QOS_CONN_TASK_TYPE</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#ga0665ccc36bdc37537e933839c8452f40">HCI_EXT_SetQOSDefaultParameters()</a> can only be used before
wanted connections are formed. It can not be used to change priority
for already formed connections and can not be used to specify priority for
a certain connection.</p>
</div>
</div>
</div>
</div>
<div class="section" id="link-layer-secondary-task">
<span id="sec-ll-secondary-tasks"></span><h2>Link Layer Secondary Task<a class="headerlink" href="#link-layer-secondary-task" title="Permalink to this headline">¶</a></h2>
<p>By default, link layer schedules the secondary tasks in a round robin fashion,
which means there is no priority among the secondary tasks.</p>
<p>The link layer executes these tasks in a pre-defined order: Initiating –&gt;
Advertising –&gt; Scanning –&gt; Periodic Advertising –&gt; Periodic Scanning. Each
task will get its time and will be executed eventually.</p>
<p>In certain cases, if all the connections use up the radio time, the secondary
tasks might be starved. To avoid this, we can configure the priority of
secondary tasks to make sure that they get the radio time.</p>
<p>Following is the logic that BLE5-Stack Link Layer uses when choosing between
primary task and secondary task.</p>
<img alt="../_images/ditaa-61579ec6aeabcfeb601d51585292e3a1705a2506.png" src="../_images/ditaa-61579ec6aeabcfeb601d51585292e3a1705a2506.png" />
<div class="section" id="secondary-task-user-configuration">
<span id="sec-ll-secondary-task-user-config"></span><h3>Secondary Task User Configuration<a class="headerlink" href="#secondary-task-user-configuration" title="Permalink to this headline">¶</a></h3>
<p>Due to the potential secondary tasks starvation, the BLE5-Stack allows
application layer to set priority for secondary task when users see fit.</p>
<p>When a secondary task has conflict with primary task, the link layer will
compare the priorities between chosen primary task and chosen secondary task.</p>
<p>If the chosen secondary task has higher priority than chosen primary task,
then the secondary task will be scheduled. However, if the connection has reached
half of its supervision time-out or the connection has just entered the connection
establishment phase, then the primary task will be scheduled instead, no matter
what the result of priority comparison is. The secondary task will continue to the
next round of selection when the scheduler does a comparison again.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Care must be taken when setting secondary tasks with higher priority than
primary task. When secondary tasks have higher priority than primary
tasks, the LL will skip connection events when there is timing conflict,
and this might lead to the starvation of the connection and/or link update
procedure failures (ex. Connection parameter update/Phy Update…etc).
Therefore, it is recommended to:</p>
<ol class="arabic simple">
<li><p>Only make secondary tasks with higher priority than primary task
for <strong>a short period of time</strong> in order to avoid the aforementioned
problems.</p></li>
<li><p>Only make secondary tasks with higher priority than primary task
<strong>after all the link update processes have completed</strong>.</p></li>
</ol>
</div>
<div class="section" id="configuration-per-secondary-task">
<h4>Configuration per Secondary Task<a class="headerlink" href="#configuration-per-secondary-task" title="Permalink to this headline">¶</a></h4>
<p>To achieve this, you can use <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#gafafdf0429af264dba5844a326b713867">HCI_EXT_SetQOSParameters()</a>.
By using this function, you can specify priority for specific secondary tasks.</p>
<p>For example, since a peripheral device can have multiple advertising sets
(multiple secondary tasks that are advertising) and each advertising set has its
own handle, you can specify the priority for each advertising set by using
<a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#gafafdf0429af264dba5844a326b713867">HCI_EXT_SetQOSParameters()</a>.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-number">Listing 150. </span><span class="caption-text">Change priority to high for advertising</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="c1">// Advertising handle</span>
<span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">uint8</span><span class="w"> </span><span class="n">advHandle</span><span class="p">;</span><span class="w"></span>

<span class="w"> </span><span class="n">GapAdv_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Application_advCallback</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">advParams1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">advHandle</span><span class="p">);</span><span class="w"></span>

<span class="w"> </span><span class="n">HCI_EXT_SetQOSParameters</span><span class="p">(</span><span class="n">LL_QOS_ADV_TASK_TYPE</span><span class="p">,</span><span class="w"> </span><span class="n">LL_QOS_TYPE_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="n">LL_QOS_HIGH_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="n">advHandle</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>For scanning and initiating phase, since each device can only be in one
scanner or initiating role, there is no handle assigned to those tasks.
Therefore, when using <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#gafafdf0429af264dba5844a326b713867">HCI_EXT_SetQOSParameters()</a> for scan and
initiator, we need to use a dummy handle for this.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-number">Listing 151. </span><span class="caption-text">Change priority to high for scanning</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="c1">// Scanning dummy handle</span>
<span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">uint8</span><span class="w"> </span><span class="n">scanDummyHandle</span><span class="p">;</span><span class="w"></span>

<span class="w"> </span><span class="n">scanDummyHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"></span>

<span class="w"> </span><span class="n">HCI_EXT_SetQOSParameters</span><span class="p">(</span><span class="n">LL_QOS_SCN_TASK_TYPE</span><span class="p">,</span><span class="w"> </span><span class="n">LL_QOS_TYPE_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="n">LL_QOS_HIGH_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="n">scanDummyHandle</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="configuration-for-all-secondary-tasks">
<h4>Configuration for All Secondary Tasks<a class="headerlink" href="#configuration-for-all-secondary-tasks" title="Permalink to this headline">¶</a></h4>
<p>If you want to set all the same secondary tasks with a default priority, you
can us <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#ga0665ccc36bdc37537e933839c8452f40">HCI_EXT_SetQOSDefaultParameters()</a>.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-number">Listing 152. </span><span class="caption-text">Change priority to low for all the advertising set</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">HCI_EXT_SetQOSDefaultParameters</span><span class="p">(</span><span class="n">LL_QOS_LOW_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="n">LL_QOS_TYPE_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="n">LL_QOS_ADV_TASK_TYPE</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#ga0665ccc36bdc37537e933839c8452f40">HCI_EXT_SetQOSDefaultParameters()</a> can only be used before
the secondary tasks start. It can not be used to change priority
for already started secondary tasks and can not be used to specify priority
for a certain secondary task handle.</p>
</div>
</div>
</div>
</div>
<div class="section" id="link-layer-control-packet-buffer">
<span id="sec-ll-control-packet-buffer"></span><h2>Link Layer Control Packet Buffer<a class="headerlink" href="#link-layer-control-packet-buffer" title="Permalink to this headline">¶</a></h2>
<p>In the BLE5-Stack, there is a separate buffer for control packets.
When a connection is established, a few link layer control packets
are automatically placed in the link layer control packet queue by the BLE5-Stack
such as Version Exchange, Feature Exchange, etc. The BLE5-Stack can only store 4
link layer control packets at any given time, therefore, if users use any
APIs that triggers control procedures under <code class="docutils literal notranslate"><span class="pre">GAP_LINK_ESTABLISHED_EVENT</span></code>,
the BLE5-Stack will most likely encounter an overflow of the TX queue which leads
to unexpected behavior.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The best practice is to wait for 3-4 connection events
to trigger a control procedure such as PHY Update, ChannelMap Update, etc.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>APIs that trigger control procedures include but are not limited to Version Exchange,
Feature Exchanges, ChannelMap Update, PHY Update, Connection parameters Update, etc.</p>
</div>
<p>Following illustrates how this can be achieved:</p>
<div class="figure align-default" id="id7">
<p class="plantuml">
<img src="../_images/plantuml-8f83651339b7103bb396fc4b627b6e4e8f217861.png" alt=" &#64;startuml

 participant CenApp as &quot;Central Application&quot;
 participant CenStack as &quot;Central BLE STACK&quot;
 participant PerStack as &quot;Peripheral BLE STACK&quot;
 participant PerApp as &quot;Peripheral Application&quot;

 CenStack --&gt; PerStack: Connection Indication Packet
 ...
 ... Establish Connection Successfully ...
 ...

 CenStack -&gt; CenApp: GAP_LINK_ESTABLISHED_EVENT
 CenApp -&gt; CenStack: Register Connection Event Callback\nand start a static counter
 PerStack -&gt; PerApp: GAP_LINK_ESTABLISHED_EVENT
 PerApp -&gt; PerStack: Register Connection Event Callback\nand start a static counter

 group Central Static Counter Reaches 3 or More
     CenApp -&gt; CenStack: Issue HCI_LE_SetHostChanClassificationCmd\nto update current channelmap
     CenStack -&gt; CenStack: Add ChannelMap Update\nto the control packet queue
     CenStack --&gt; PerStack: Start ChannelMap update procedure
 end

 group Peripheral Static Counter Reaches 3 or More
     PerApp -&gt; PerStack: Issue HCI_LE_SetPhyCmd\nto update current PHY
     PerStack -&gt; PerStack: Add Phy Update\nto the control packet queue
     PerStack --&gt; CenStack: Start Phy update procedure
 end

 &#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 94. </span><span class="caption-text">Trigger Control Procedure With Delay</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="link-layer-buffers">
<span id="sec-ll-buffers"></span><h2>Link Layer Buffers<a class="headerlink" href="#link-layer-buffers" title="Permalink to this headline">¶</a></h2>
<p>The link layer is responsible for low level sending and receiving data.
Inside the link layer there are two queues: one for transmiting, and one for
receiving.
Dynamic memory is used to allocate the buffers that are part of the queues.
The relative sizes of these queues are dependent on settings in the stack.
This section will describe these queues, how they affect heap utilization, and how
to configure them.</p>
<div class="section" id="tx-queues">
<h3>TX Queues<a class="headerlink" href="#tx-queues" title="Permalink to this headline">¶</a></h3>
<p>To send data, the higher level host protocol (e.g. GATT, SM) dynamically
allocates and populates the memory for the transmit buffer, and passes this to
the Controller through L2CAP (see <a class="reference internal" href="l2cap.html#sec-l2cap"><span class="std std-ref">Logical Link Control and Adaptation Layer Protocol (L2CAP)</span></a>). The maximum number of
buffers that can be allocated is controlled by <code class="docutils literal notranslate"><span class="pre">MAX_NUM_PDU</span></code> and the size of
each buffer is controlled by <code class="docutils literal notranslate"><span class="pre">MAX_PDU_SIZE</span></code>. See the graphic below for an
illustration of the TX queue.</p>
<p>The data queue structure itself is allocated in the initialization of the
Link Layer, but the data is allocated on the fly by the host depending
on the needs the application</p>
<blockquote>
<div><img alt="../_images/ditaa-dc2b85021a43a84e71a99fc3e57be8a9e106c9d4.png" id="fig-ll-tx-queue" src="../_images/ditaa-dc2b85021a43a84e71a99fc3e57be8a9e106c9d4.png" />
</div></blockquote>
<p>It is important to remember that the maximum number of packets that the host
is allowed to queue up in the controller is <code class="docutils literal notranslate"><span class="pre">MAX_NUM_PDU</span></code>, but due to
fragmentation, these packets may be split up across multiple queue entries.</p>
<p>If fragmentation is needed, the original host packet will be split across
subsequent link layer PDUs. These link layer fragments are allocated from the
heap as needed depending on the TX PDU size and the amount of data to send.</p>
<p>At the extreme, with a very large host MTU (e.g. 255) and a small link layer
PDU (e.g. 27), the single host packet may be split across 10 link layer packets.
For a short time both the fragments and the original packet will exist in
memory. After the fragments are created and queued, the original packet will be
freed. The fragments are freed as they are sent.</p>
<p>See <a class="reference internal" href="#le-data-length-extension"><span class="std std-ref">LE Data Length Extension (DLE)</span></a> for more information.</p>
</div>
<div class="section" id="rx-queues">
<h3>RX Queues<a class="headerlink" href="#rx-queues" title="Permalink to this headline">¶</a></h3>
<p>Unlike the TX chain, in RX the data is coming from the peer device and thus is
an unknown quantity in terms of size until it is received. In order to be
prepared for this, the controller will pre-allocate the RX queue starting on
initialization based on the default settings for RX pdu size. (See
<a class="reference internal" href="#le-data-length-extension"><span class="std std-ref">LE Data Length Extension (DLE)</span></a> for more info). This allocation is done on init,
and the buffers are re-sized if the data length accepted by the controller
changed.</p>
<blockquote>
<div><img alt="../_images/ditaa-84fd07a281d17b4831835e6d9271a93003216cd1.png" id="fig-ll-rx-queue" src="../_images/ditaa-84fd07a281d17b4831835e6d9271a93003216cd1.png" />
</div></blockquote>
<p>The number of RX buffers in the chained queue is set by
<code class="docutils literal notranslate"><span class="pre">NUM_RX_DATA_ENTRIES</span></code> (4) and cannot be modified. The size of each buffer is
allocated based on the max PDU size, and reallocated if changed by DLE
procedures (see <a class="reference internal" href="#le-data-length-extension"><span class="std std-ref">LE Data Length Extension (DLE)</span></a>).</p>
</div>
</div>
<div class="section" id="le-data-length-extension-dle">
<span id="le-data-length-extension"></span><h2>LE Data Length Extension (DLE)<a class="headerlink" href="#le-data-length-extension-dle" title="Permalink to this headline">¶</a></h2>
<p>The data length extension feature allows the LE controller to send
data channel packet data units (PDUs) with payloads of up to 251
bytes of application data, while in the connected state.
Furthermore, a new PDU size can be negotiated by either side at any
time during a connection.</p>
<p>Previously, the controller’s largest data
channel payload was 27 bytes. This Feature increases the data rate by around
250% when compared to Bluetooth Core Specification Versions 4.0 and 4.1
devices (if both devices support extended packet length and are
configured properly).</p>
<p>The CC13xx or CC26xx has Data Length Extension enabled by default - allowing
peer devices to utilize this feature with no application overhead.</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="#sec-data-length-update-procedure"><span class="std std-ref">DLE Update Procedure and Definitions</span></a></p></li>
<li><p><a class="reference internal" href="#initial-values"><span class="std std-ref">Default Application DLE Behavior</span></a></p></li>
<li><p><a class="reference internal" href="#sec-using-dle-at-runtime"><span class="std std-ref">Utilizing DLE in the Application</span></a></p></li>
<li><p><a class="reference internal" href="#sec-disabling-data-length-ext-at-run-time"><span class="std std-ref">Disabling DLE at Runtime</span></a></p></li>
<li><p><a class="reference internal" href="#sec-interoperability-with-peers"><span class="std std-ref">Interoperability with Legacy Peers</span></a></p></li>
<li><p><a class="reference internal" href="#sec-ram-considerations-dle"><span class="std std-ref">RAM Considerations when using DLE</span></a></p></li>
</ul>
</div></blockquote>
<div class="section" id="dle-update-procedure-and-definitions">
<span id="sec-data-length-update-procedure"></span><h3>DLE Update Procedure and Definitions<a class="headerlink" href="#dle-update-procedure-and-definitions" title="Permalink to this headline">¶</a></h3>
<p>This section describes what is done from a controller perspective during
a connection as well as terminology.</p>
<p>Once a connection is formed, the controller will behave in one of
two possible ways:</p>
<blockquote>
<div><ul>
<li><p>If prior to the connection, the suggested PDU size and time are set
to the defaults for both TX and RX (27B, 328 us) then the CC13xx or CC26xx
will not initiate a data length exchange (i.e. a <code class="docutils literal notranslate"><span class="pre">LL_LENGTH_REQ</span></code>
will not be sent).</p>
<p>If the peer device sends a <code class="docutils literal notranslate"><span class="pre">LL_LENGTH_REQ</span></code> then the controller
of the device will send a  <code class="docutils literal notranslate"><span class="pre">LL_LENGTH_RSP</span></code> corresponding to the
default sizes of 4.0 devices autonomously.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See <a class="reference internal" href="#sec-disabling-data-length-ext-at-run-time"><span class="std std-ref">Disabling DLE at Runtime</span></a> for
information on how to modify this behavior.</p>
</div>
</li>
<li><p>If prior to the connection, the PDU size or the maximum time for RX or
TX are not default, then the LE controller of the device will
use the <code class="docutils literal notranslate"><span class="pre">LL_LENGTH_REQ</span></code> and <code class="docutils literal notranslate"><span class="pre">LL_LENGTH_RSP</span></code> control PDUs to
negotiate a larger payload size for data channel PDUs.</p>
<p>A data length update may be initiated by the host or performed
autonomously by the controller. Either the central or the peripheral
can initiate the procedure.</p>
</li>
</ul>
</div></blockquote>
<p>After the data length update procedure is complete, both controllers
select a new data length based on two parameters: PDU size and time.
The largest size supported by both local and remote controller is
selected; time is taken into account to support different data
rates. These parameters are defined below:</p>
<ul>
<li><p>PDU size</p>
<blockquote>
<div><p>The largest application data payload size supported by the
controller. This size does not include packet overhead, such as
access address or preamble.</p>
</div></blockquote>
</li>
<li><p>Time</p>
<blockquote>
<div><p>The maximum number of microseconds that the device takes to
transmit or receive a PDU at the PHY rate. This parameter uses
units of microseconds (us).</p>
</div></blockquote>
</li>
</ul>
<p>Each direction has a PDU size and time; in other words there is a
Receive PDU size/time and a separate Transmit PDU size/time. A device
can only influence a peer’s Receive PDU size/time by adjusting it’s
own Transmit PDU size/time via the DLE Update Procedure.</p>
<p>Reference ([Vol 6], Part B, Section 5.1.9) of the <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>
for more information about the data length update procedure.</p>
<p>Reference ([Vol 6], Part B, Section 4.5.10) of the <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>
for information on the valid ranges for data PDU length and
timing parameters.</p>
</div>
<div class="section" id="default-application-dle-behavior">
<span id="initial-values"></span><h3>Default Application DLE Behavior<a class="headerlink" href="#default-application-dle-behavior" title="Permalink to this headline">¶</a></h3>
<p>This section describes the default behavior of the CC13xx or CC26xx
due to the feature being enabled by default.</p>
<p>The controller defaults to using TX PDU sizes compatible with 4.0 and
4.1 devices. It uses 27 bytes as its initial maximum PDU size, and 328
us as the maximum PDU transmit time.</p>
<p>On the RX PDU size and time, the controller
defaults to the maximum PDU size and the maximum PDU receive time for
a LE Data Packet Length Extension enabled device. In other words,
the RX PDU size will be 251, and the RX PDU receive time will be 2120 us.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As mentioned in <a class="reference internal" href="#sec-data-length-update-procedure"><span class="std std-ref">DLE Update Procedure and Definitions</span></a>, by default
a <code class="docutils literal notranslate"><span class="pre">LL_LENGTH_REQ</span></code> control packet will be sent due
to the RX max PDU size and max PDU receive time not being default 4.0
PDU sizes and timings.</p>
</div>
</div>
<div class="section" id="utilizing-dle-in-the-application">
<span id="sec-using-dle-at-runtime"></span><h3>Utilizing DLE in the Application<a class="headerlink" href="#utilizing-dle-in-the-application" title="Permalink to this headline">¶</a></h3>
<p>This section describes how the application can influence
the controller to use DLE for transmission of data at runtime.</p>
<p>The application can update the data length in two ways.</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>the application can set the initial connection TX PDU size
or time to cause the controller to request the peer’s RX PDU size
and time to change for every connection.</p></li>
<li><p>the controller can initialize the connection with the default
values of 27 octets and 328 us, then dynamically negotiate
the data length at a later time in the connection using HCI commands.</p></li>
</ol>
</div></blockquote>
<p>For maximum throughput, high layer protocols such as the BLE host
should also use a larger PDU size (see <a class="reference internal" href="../ble-stack-5.x/gatt.html#maximum-transmission-unit-mtu"><span class="std std-ref">Maximum Transmission Unit (MTU)</span></a>).
See <a class="reference internal" href="#sec-ll-buffers"><span class="std std-ref">Link Layer Buffers</span></a> for more information how the link layer manages
buffers and PDUs.</p>
<p>The following HCI commands can be used to interact with the
controller related to the data length extension feature:</p>
<ul class="simple">
<li><p>LE Read Suggested Default Data Length Command (<a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#gaec617ade902119b1cb23e4c1dc35acdf">HCI_LE_ReadSuggestedDefaultDataLenCmd()</a>)</p></li>
<li><p>LE Write Suggested Default Data Length Command (<a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#gaee60ea41f67b959589e696984356a30e">HCI_LE_WriteSuggestedDefaultDataLenCmd()</a>)</p></li>
<li><p>LE Read Maximum Data Length Command (<a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#ga76d88fd2ee34027ecd370b9659e81922">HCI_LE_ReadMaxDataLenCmd()</a>)</p></li>
<li><p>LE Set Data Length Command (<a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#gae69c8fd7434c02abe3cf504cbe37db21">HCI_LE_SetDataLenCmd()</a>)</p></li>
</ul>
<p>The above commands may generate:</p>
<ul class="simple">
<li><p>LE Data Length Change Event</p></li>
</ul>
<p>For example, to dynamically change the TX PDU size and timing, the
command <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#gae69c8fd7434c02abe3cf504cbe37db21">HCI_LE_SetDataLenCmd()</a> during a connection. This
will cause the LE controller to negotiate with the peer’s LE controller
to adjust it’s RX PDU size and timing as described in <a class="reference internal" href="#sec-data-length-update-procedure"><span class="std std-ref">DLE Update Procedure and Definitions</span></a>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">cxnHandle</span><span class="p">;</span><span class="w"> </span><span class="c1">//Request max supported size</span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="n">requestedPDUSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">251</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="n">requestedTxTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2120</span><span class="p">;</span><span class="w"></span>

<span class="n">GAPRole_GetParameter</span><span class="p">(</span><span class="n">GAPROLE_CONNHANDLE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cxnHandle</span><span class="p">);</span><span class="w"> </span><span class="c1">//This API is documented in hci.h</span>

<span class="n">HCI_LE_SetDataLenCmd</span><span class="p">(</span><span class="n">cxnHandle</span><span class="p">,</span><span class="w"> </span><span class="n">requestedPDUSize</span><span class="p">,</span><span class="w"> </span><span class="n">requestedTxTime</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For more information about these HCI commands and their fields, see the
LE Controller Commands and Events sections ([Vol 2], Part E, Section
7.7-7.8) of the <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>. Additionally, the APIs for these commands
are documented under <a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13xx_cc26xx.html#ble-api-reference"><span class="std std-ref">BLE Stack API Reference</span></a>.</p>
</div>
<p>Assuming the central device sends the LL_LENGTH_REQ first, then the following
shows the sequence of how the BLE5-Stack handles the packets and sends notification
to the application layer.</p>
<p class="plantuml">
<img src="../_images/plantuml-be29e2663b9dcee33eba9d19096afeae94ff7720.png" alt="&#64;startuml
participant CenApp as &quot;Central Application&quot;
participant CenStack as &quot;Central BLE STACK&quot;
participant PerStack as &quot;Peripheral BLE STACK&quot;
participant PerApp as &quot;Peripheral Application&quot;

CenApp -&gt; CenStack : Change default data length
CenStack --&gt; PerStack : LL_LENGTH_REQ

note over PerStack
  Update its supported payload
  length based on the LL_LENGTH_REQ
  and its ability.
end note

CenStack &lt;-- PerStack : LL_LENGTH_RSP
PerStack -&gt; PerApp : HCI_BLE_DATA_LENGTH_CHANGE_EVENT

note right
  Peripheral application
  layer might get the
  notification from BLE STACK
  before the LL_LENGTH_RSP
  is received by Central
  device.
end note

note over CenStack
  Update its supported payload
  length based on the LL_LENGTH_RSP.
end note

CenApp &lt;- CenStack : HCI_BLE_DATA_LENGTH_CHANGE_EVENT

&#64;enduml"/>
</p>
</div>
<div class="section" id="disabling-dle-at-runtime">
<span id="sec-disabling-data-length-ext-at-run-time"></span><h3>Disabling DLE at Runtime<a class="headerlink" href="#disabling-dle-at-runtime" title="Permalink to this headline">¶</a></h3>
<p>This section describes how to disable the DLE feature at runtime.</p>
<p>There are two main steps to disable this feature, the first is
modifying the controller PDU sizes directly, and the second is
modifying the features the controller supports. Both steps must
be taken to completely remove DLE.</p>
<p>As discussed in <a class="reference internal" href="#initial-values"><span class="std std-ref">Default Application DLE Behavior</span></a>, the LE controller initially uses packet length
values compatible with 4.0 and 4.1 devices in new connections for TX.
The controller will automatically attempt to
negotiate the data length at the beginning of every new
connection. To disable this feature, add <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#ga22b6dd11d3edd80aeb2f2518577aee56">HCI_EXT_SetMaxDataLenCmd()</a>
to the application:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#define APP_TX_PDU_SIZE 27</span>
<span class="linenos">2</span><span class="cp">#define APP_RX_PDU_SIZE 27</span>
<span class="linenos">3</span><span class="cp">#define APP_TX_TIME 328</span>
<span class="linenos">4</span><span class="cp">#define APP_RX_TIME 328</span>
<span class="linenos">5</span>
<span class="linenos">6</span><span class="c1">//This API is documented in hci.h</span>
<span class="linenos">7</span><span class="n">HCI_EXT_SetMaxDataLenCmd</span><span class="p">(</span><span class="n">APP_TX_PDU_SIZE</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="n">APP_TX_TIME</span><span class="p">,</span><span class="w"></span>
<span class="linenos">8</span><span class="w">   </span><span class="n">APP_RX_PDU_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">APP_RX_TIME</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Once a connection is formed, the peer device may request
features supported by CC13xx or CC26xx and attempt to negotiate a new
PDU size/time. This can be prevented by also utilizing the following
vendor specific command <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#ga040091db19b02697911fb043179070fc">HCI_EXT_SetLocalSupportedFeaturesCmd()</a>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="c1">// featSet is an array of bytes representing features supported</span>
<span class="linenos">2</span><span class="c1">// of the Device. Clear DLE Feature bit</span>
<span class="linenos">3</span><span class="n">CLR_FEATURE_FLAG</span><span class="p">(</span><span class="w"> </span><span class="n">featSet</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">LL_FEATURE_DATA_PACKET_LENGTH_EXTENSION</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="linenos">4</span><span class="n">HCI_EXT_SetLocalSupportedFeaturesCmd</span><span class="p">(</span><span class="w"> </span><span class="n">featSet</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Both <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#ga22b6dd11d3edd80aeb2f2518577aee56">HCI_EXT_SetMaxDataLenCmd()</a> and <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#ga040091db19b02697911fb043179070fc">HCI_EXT_SetLocalSupportedFeaturesCmd()</a>
should be called prior to forming a connection.</p>
</div>
<div class="section" id="interoperability-with-legacy-peers">
<span id="sec-interoperability-with-peers"></span><h3>Interoperability with Legacy Peers<a class="headerlink" href="#interoperability-with-legacy-peers" title="Permalink to this headline">¶</a></h3>
<p>Legacy Bluetooth Core Specification Versions 4.0 and 4.1 peer Hosts
or Controllers may run into interoperability issues. These may manifest
in the Link Layer or Controller Command Collisions, among other issues.</p>
<p>An example of these collisions can be seen in the following:</p>
<div class="figure align-center" id="id8">
<span id="dle-older-peer-diagram"></span><p class="plantuml">
<img src="../_images/plantuml-360c9955d94a0bc928f328aa39d40008de2d4583.png" alt="&#64;startuml
hide footbox


participant Central
participant Peripheral

  == Connection Established ==

  group Connection Event 1
     Central -&gt; Peripheral: LL_FEATURE_REQ
        note right: Central requests Peripheral features

     Peripheral -&gt; Central: Empty Packet
  end

  group Connection Event 2
     Central -&gt; Peripheral: Empty Packet

     Peripheral -&gt; Central: LL_FEATURE_RSP
        note right: Peripheral informs central of supported features
  end

  group Connection Event 3
     Central -&gt; Peripheral: Empty Packet

     Peripheral -&gt; Central: LL_LENGTH_REQ
        note right: Peripheral wishes to negotiate DLE
  end

  group Connection Event 4
     Central -&gt; Peripheral: LL_ENC_REQ
        note right: Central wishes to start encryption

     Peripheral -&gt; Central: Empty Packet
  end

  ...

  group Connection Events Until Termination
     Central -&gt; Peripheral: Empty Packet

     Peripheral -&gt; Central: Empty Packet
  end

  ...

  == Connection Terminated ==

&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 95. </span><span class="caption-text">Example collision from an older peer due to DLE.</span><a class="headerlink" href="#id8" title="Permalink to this image">¶</a></p>
</div>
<p><a class="reference internal" href="#dle-older-peer-diagram"><span class="std std-numref">Figure 95.</span></a> shows one way an older
central device may behave when communicating with a
DLE supporting peripheral. The connection terminates due to
the central failing to respond to the peripheral’s DLE request.
Central expected a response to the encryption request,
thus never responding to the DLE request.</p>
<p>To support these older peers, it is recommended to
completely disable the feature as outlined in
<a class="reference internal" href="#sec-disabling-data-length-ext-at-run-time"><span class="std std-ref">Disabling DLE at Runtime</span></a>.</p>
</div>
<div class="section" id="ram-considerations-when-using-dle">
<span id="sec-ram-considerations-dle"></span><h3>RAM Considerations when using DLE<a class="headerlink" href="#ram-considerations-when-using-dle" title="Permalink to this headline">¶</a></h3>
<p>This section describes the how DLE impacts the BLE5-Stack’s HEAP
memory usage.</p>
<p>The BLE5-Stack utilizes the heap for all dynamic memory
allocations. This includes both the Transmit and Receive Buffers used in the
controller. (Covered in <a class="reference internal" href="#sec-ll-buffers"><span class="std std-ref">Link Layer Buffers</span></a>).</p>
<p>It is important to understand that the transmit buffers
are allocated based on the respective PDU sizes negotiated for
each connection; while the receive buffers are only negotiated by max
PDU size among all the connections and the 4 receive buffers are shared
among all the connections. TX buffers are allocated at runtime and the total
is limited by <code class="docutils literal notranslate"><span class="pre">MAX_NUM_PDU</span></code>. The size of TX data is enforced by the MTU size of higher
level protocols such as GATT or L2CAP, however if applicable, the link
layer will fragment this based on the negotiated PDU.</p>
<p>For the TX case, large host MTU packets and small controller PDU results in
the most heap memory being used. For example when using the smallest LL PDU (27)
and the largest ATT_MTU (255) a single host packet will be fragmented into 10
controller packets. The equation below uses 14 for
<code class="docutils literal notranslate"><span class="pre">sizeof(dataEntry_t)</span> <span class="pre">+</span> <span class="pre">LL_PKT_HDR_LEN</span> <span class="pre">+</span> <span class="pre">LL_PKT_MIC_LEN</span></code>.
An estimation of the memory consumed can be shown below:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>number of packets = ceil(Host Packet Size/ LL PDU Size)
total mem of fragments = (number of packets) * (sizeof(dataEntry_t) + LL_PKT_HDR_LEN + LL_PKT_MIC_LEN + packet size)
max memory = (total mem of fragments) * MAX_NUM_PDU
</pre></div>
</div>
<p>In the worst case scenario, this could mean about 3280 bytes of heap
used  per connection when the host packets are 255B, the controller PDU is 27,
and MAX_NUM_PDU is set to 8. This also assumes that the application is filling
every TX PDU continually.</p>
<p>In the receive case, there are only <code class="docutils literal notranslate"><span class="pre">NUM_RX_DATA_ENTRIES</span></code> (4) queue entries
allocated at initialization time. The queue depth is fixed and not modifable.
However, the PDU buffers will be reallocated if the TX PDU size changes due to
a data length update.</p>
<p>An estimation for the memory consumed can be shown below:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>max memory = (connEffectiveMaxRxOctets + LL_PKT_MIC_LEN + LINK_SUFFIX_SIZE) * NUM_RX_DATA_ENTRIES
</pre></div>
</div>
<p>In the worst case scenario where a large RX PDU is used this could result in
1040 bytes of heap used for all the connections.</p>
<p>See <a class="reference internal" href="#sec-ll-buffers"><span class="std std-ref">Link Layer Buffers</span></a> for more information about the LL TX and RX data
queues.</p>
<p>To prevent HEAP exhaustion or other issues in the rest of the application
the developer should choose the PDU size for both RX and TX, as well
as limit the max number of connections to meet the demands of the
application.</p>
<p>To modify the size of the both the RX and TX buffers - the vendor
specific command <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#ga22b6dd11d3edd80aeb2f2518577aee56">HCI_EXT_SetMaxDataLenCmd()</a> can be used.
This must be used prior to establishing the connection.</p>
<p>To modify the number of connections, see <a class="reference internal" href="../ble-stack-5.x/stack-configuration-cc13xx_cc26xx.html#stack-features-configuration"><span class="std std-ref">Stack Configurations</span></a>
for details.</p>
</div>
</div>
<div class="section" id="connections-design">
<span id="sec-32-connections"></span><h2>32 Connections Design<a class="headerlink" href="#connections-design" title="Permalink to this headline">¶</a></h2>
<p>In our BLE5-Stack using CC13xx or CC26xx, we can achieve 32 connections running out of
box simple_central project. To enable this functionality,
<code class="docutils literal notranslate"><span class="pre">EXTENDED_STACK_SETTINGS</span></code> should be set to <code class="docutils literal notranslate"><span class="pre">MASTER_GUARD_TIME_ENABLE</span></code>.
Using, SysConfig set RF STACKS &gt; BLE &gt; Advanced Settings &gt; Extended Stack Settings
to “Guard Time”.</p>
<p>For detailed information for those defines please check <a class="reference internal" href="../ble-stack-5.x/stack-configuration-cc13xx_cc26xx.html#appconfigurablefeatures"><span class="std std-ref">Bluetooth Low Energy Application Configuration Parameters</span></a>.</p>
<p>Since the connection guard time is set to 5ms, the corresponding minimum
connection interval for 32 connections has to be larger than 160ms.</p>
<p>When enabling 32 connections, during initialization, the BLE5-Stack uses ~32k
heap. All the connections share 4 RX buffers, assuming using the maximum PDU
size with the overhead, the extra heap will be ~3k when reaches 32 connections.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When using DMM together with out of box simple_central, the
simple_central might not be able to support 32 connections due to
restricted time slots, CPU power and memory…etc</p>
</div>
</div>
<div class="section" id="tx-power-backoff-table-for-cc13x2p-devices">
<span id="sec-cc1352p-2-max-tx-power-for-each-channel"></span><h2>TX Power Backoff Table for CC13x2P Devices<a class="headerlink" href="#tx-power-backoff-table-for-cc13x2p-devices" title="Permalink to this headline">¶</a></h2>
<p>The CC13x2P product family has the capability to increase the TX power by
configuring a high dBm gain, up to a defined limit. However, some side band
channels may be susceptible to power leakage, which may cause the device to
exceed its permitted maximum TX power. In practice, this means that a device
can end up violating the FCC requirements for TX power on some frequencies. To
counter this behavior, and safely keep the TX power within its required limits,
a table of backoff values for the TX power is used. This means that for all the
available PHYs and channels, as illustrated in the table below, it is possible
to map out the actual maximum values that will be used for a device.</p>
<table class="docutils align-default" id="id9">
<caption><span class="caption-number">Table 17. </span><span class="caption-text">TX Power Backoff Values</span><a class="headerlink" href="#id9" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head" rowspan="2"><p>Channel</p></th>
<th class="head" colspan="3"><p>Max Value</p></th>
</tr>
<tr class="row-even"><th class="head"><p>1M PHY</p></th>
<th class="head"><p>2M PHY</p></th>
<th class="head"><p>Coded PHY</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>0</p></td>
<td><p>20 dBm</p></td>
<td><p>20 dBm</p></td>
<td><p>20 dBm</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>20 dBm</p></td>
<td><p>20 dBm</p></td>
<td><p>20 dBm</p></td>
</tr>
<tr class="row-odd"><td><p>…</p></td>
<td><p>…</p></td>
<td><p>…</p></td>
<td><p>…</p></td>
</tr>
<tr class="row-even"><td><p>39</p></td>
<td><p>14 dBm</p></td>
<td><p>20 dBm</p></td>
<td><p>20 dBm</p></td>
</tr>
</tbody>
</table>
<p>When changing TX gain for an RF command, the new gain will be validated against
this backoff table. If the gain exceeds the table entry corresponding to the
PHY and channel used for the RF command, the TX power will backoff (i.e. be
reduced) to the lower value in the table. The backoff table is defined in
<code class="docutils literal notranslate"><span class="pre">ble_user_config.c</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Tx Power Backoff Values (txPwrBackoff1MPhy, txPwrBackoff2MPhy, txPwrBackoffCoded)</span>
<span class="k">const</span><span class="w"> </span><span class="n">txPwrBackoffVal_t</span><span class="w"> </span><span class="n">TxPowerBackoffTable</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="n">HCI_EXT_TX_POWER_20_DBM</span><span class="p">,</span><span class="n">HCI_EXT_TX_POWER_20_DBM</span><span class="p">,</span><span class="n">HCI_EXT_TX_POWER_20_DBM</span><span class="p">},</span><span class="w">   </span><span class="c1">//max tx power for channel 0</span>
<span class="w">   </span><span class="p">{</span><span class="n">HCI_EXT_TX_POWER_20_DBM</span><span class="p">,</span><span class="n">HCI_EXT_TX_POWER_20_DBM</span><span class="p">,</span><span class="n">HCI_EXT_TX_POWER_20_DBM</span><span class="p">},</span><span class="w">   </span><span class="c1">//max tx power for channel 1</span>
<span class="w">   </span><span class="p">...</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="n">HCI_EXT_TX_POWER_14_DBM</span><span class="p">,</span><span class="n">HCI_EXT_TX_POWER_20_DBM</span><span class="p">,</span><span class="n">HCI_EXT_TX_POWER_20_DBM</span><span class="p">}</span><span class="w">    </span><span class="c1">//max tx power for channel 39</span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>In addition to the use case of countering any power leakage in the side band
channels, the backoff table also maps out all the remaining channels for
increased customization. This is for flexibility in other use cases (e.g.
custom board design) where it could prove useful to have control over custom
TX power limits.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This feature is only supported for CC13x2P devices.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="l2cap.html" class="btn btn-neutral float-left" title="Logical Link Control and Adaptation Layer Protocol (L2CAP)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../ble-stack-5.x/channel-selection-algorithm-number-two.html" class="btn btn-neutral float-right" title="Channel Selection Algorithm #2" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2010-2022, Texas Instruments.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>