<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GAP Bond Manager and LE Secure Connections &mdash; 
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User&#39;s Guide
 2.02.08.01 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Privacy" href="privacy.html" />
    <link rel="prev" title="Generic Attribute Profile (GATT)" href="gatt.html" />
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug ble-stack-5.x gapbondmngr-cc13xx_cc26xx";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html" class="icon icon-home"> 
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User's Guide

          </a>
              <div class="version">
                2.02.08.01
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/disclaimer.html">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/quickstart-intro-cc13xx_cc26xx.html">Introduction to the SimpleLink CC13xx/CC26xx SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/ble5-quick-start.html">TI BLE5-Stack Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/platform-cc13xx_cc26xx.html">The CC13xx or CC26xx SDK Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/tirtos-index-cc13xx_cc26xx.html">TI-RTOS7 (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/freertos-index.html">FreeRTOS (RTOS Kernel) Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../ble-stack-5.x-guide/ble-stack-5-index-cc13xx_cc26xx.html">BLE5-Stack</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview-cc13xx_cc26xx.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="gap-cc13xx_cc26xx.html">Generic Access Profile (GAP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="gatt.html">Generic Attribute Profile (GATT)</a></li>
<li class="toctree-l2"><a class="reference internal" href="gatt.html#gap-gatt-service-ggs">GAP GATT Service (GGS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="gatt.html#generic-attribute-profile-service-gatt-service">Generic Attribute Profile Service (GATT Service)</a></li>
<li class="toctree-l2"><a class="reference internal" href="gatt.html#gattservapp-module">GATTServApp Module</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">GAP Bond Manager and LE Secure Connections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#security-modes-in-a-bluetooth-le-connection">Security Modes in a Bluetooth LE Connection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#selection-of-pairing-method">Selection of Pairing Method</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-gapbondmgr">Using GAPBondMgr</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gapbondmgr-examples-for-different-pairing-methods">GAPBondMgr Examples for Different Pairing Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#disabling-pairing">Disabling Pairing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enabling-pairing">Enabling Pairing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#le-secure-connections">LE Secure Connections</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lesc-limitations-recommendations">LESC Limitations &amp; Recommendations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#authentication-pairing-only">Authentication Pairing Only</a></li>
<li class="toctree-l4"><a class="reference internal" href="#just-works-pairing">Just Works Pairing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#passcode-entry">Passcode Entry</a></li>
<li class="toctree-l4"><a class="reference internal" href="#numeric-comparison">Numeric Comparison</a></li>
<li class="toctree-l4"><a class="reference internal" href="#out-of-band-pairing">Out of Band Pairing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#gapbondmgr-examples-for-manipulating-bonding">GAPBondMgr Examples for Manipulating Bonding</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#enable-bonding">Enable Bonding</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extract-bonding-information">Extract Bonding Information</a></li>
<li class="toctree-l4"><a class="reference internal" href="#import-bonding-information">Import Bonding Information</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#gapbondmgr-and-snv">GAPBondMgr and SNV</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gapbondmgr-and-service-change-indication">GAPBondMgr and Service Change Indication</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#background">Background</a></li>
<li class="toctree-l4"><a class="reference internal" href="#send-service-change-indications">Send Service Change Indications</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pairing-and-encryption-without-gapbondmgr">Pairing and Encryption without GAPBondMgr</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="privacy.html">Privacy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-common/l2cap.html">Logical Link Control and Adaptation Layer Protocol (L2CAP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-common/link-layer-cc13xx_cc26xx.html">Link Layer (LL)</a></li>
<li class="toctree-l2"><a class="reference internal" href="channel-selection-algorithm-number-two.html">Channel Selection Algorithm #2</a></li>
<li class="toctree-l2"><a class="reference internal" href="hci.html">Host Controller Interface (HCI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="phy.html">Physical Layer (PHY)</a></li>
<li class="toctree-l2"><a class="reference internal" href="stack-configuration-cc13xx_cc26xx.html">Stack Configurations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html">Developing a Bluetooth LE Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coexistence/coexistence.html">Coexistence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/localization-index-cc13xx_cc26xx.html">RTLS Toolbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-mesh/index.html">Bluetooth Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/u-stack-index-cc13xx_cc26xx.html">Micro BLE Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sensor-controller/sensor-controller.html">Sensor Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/debugging-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/memory-index.html">Memory Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-common/npi-index.html">Network Processor Interface (NPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble5-oad-index-cc13xx_cc26xx.html">TI Over-the-Air Download (OAD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble5-oad-index-mcuboot.html">MCUBoot Over-the-Air Download (OAD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security-tfm/index.html">Security Features of CC13x4 and CC26x4 Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/sysconfig-index-cc13xx_cc26xx.html">System Configuration Tool (SysConfig)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/migration-cc13xx_cc26xx.html">Porting Guide and Migration Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13xx_cc26xx.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html">Terms and Definitions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html">
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User's Guide
</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../ble-stack-5.x-guide/ble-stack-5-index-cc13xx_cc26xx.html">BLE5-Stack</a> &raquo;</li>
      <li>GAP Bond Manager and LE Secure Connections</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="gap-bond-manager-and-le-secure-connections">
<span id="id2"></span><h1>GAP Bond Manager and LE Secure Connections<a class="headerlink" href="#gap-bond-manager-and-le-secure-connections" title="Permalink to this headline">¶</a></h1>
<p>The GAP Bond Manager (GAPBondMgr) is a configurable module that offloads most of the Pairing &amp;
Bonding security mechanisms associated with the Security Manager (SM) protocol from the application.
The GAPBongMgr executes in the protocol stack task’s context. <a class="reference internal" href="#gap-bond-manager-terminology"><span class="std std-numref">Table 7.</span></a> lists the terminology.</p>
<span id="gap-bond-manager-terminology"></span><table class="docutils align-default" id="id8">
<caption><span class="caption-number">Table 7. </span><span class="caption-text">GAP Bond Manager Terminology</span><a class="headerlink" href="#id8" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 24%" />
<col style="width: 76%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Term</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Pairing</p></td>
<td><p>The process of generating &amp; exchanging keys. Not to be confused
with forming or establishing a BLE connection between two devices</p></td>
</tr>
<tr class="row-odd"><td><p>Encryption</p></td>
<td><p>Data is encrypted after pairing, or re-encryption (a subsequent
connection where keys are looked up from nonvolatile memory).</p></td>
</tr>
<tr class="row-even"><td><p>Association</p></td>
<td><p>The pairing method used based on the I/O Capabilities of both
devices. For LE devices, Just Works, Numeric Comparison,
Passkey Entry and Out-Of-Band are supported.</p></td>
</tr>
<tr class="row-odd"><td><p>Authentication</p></td>
<td><p>The pairing process using an association method that supports
MITM (Man in the Middle) protection.</p></td>
</tr>
<tr class="row-even"><td><p>Bonding</p></td>
<td><p>Storing the keys generated during the pairing process in
nonvolatile memory to use for the next encryption sequence.</p></td>
</tr>
<tr class="row-odd"><td><p>Authorization</p></td>
<td><p>An additional application level verification in addition to
authentication.</p></td>
</tr>
<tr class="row-even"><td><p>OOB</p></td>
<td><p>Out of Band. Pairing keys are not exchanged over the air, but
rather over some other source such as serial port or NFC. This
also provides MITM protection.</p></td>
</tr>
<tr class="row-odd"><td><p>MITM</p></td>
<td><p>Man in the Middle protection. MITM provides authentication
during the pairing process which helps prevent a malicious
attacker from impersonating the peer device during the key
exchange.</p></td>
</tr>
<tr class="row-even"><td><p>Just Works</p></td>
<td><p>Unauthenticated pairing association method where keys are
exchanged without MITM protection.</p></td>
</tr>
</tbody>
</table>
<p>The general process that the GAPBondMgr uses is as follows:</p>
<p>1. The pairing process: exchange keys through the methods described in
<a class="reference internal" href="#selection-of-pairing-method"><span class="std std-ref">Selection of Pairing Method</span></a>.</p>
<ol class="arabic simple" start="2">
<li><p>The encryption process: Encrypt the link using keys Step 1.</p></li>
</ol>
<p>3. The bonding process: store keys in secure flash (Simple Non Volatile memory,
<a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html#term-SNV"><span class="xref std std-term">SNV</span></a>).</p>
<ol class="arabic simple" start="4">
<li><p>Reconnecting: Use the keys stored in SNV to encrypt the link.</p></li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Performing all of these steps is not necessary. For example,
two devices may choose to pair but not bond.</p>
</div>
<div class="section" id="security-modes-in-a-bluetooth-le-connection">
<h2>Security Modes in a Bluetooth LE Connection<a class="headerlink" href="#security-modes-in-a-bluetooth-le-connection" title="Permalink to this headline">¶</a></h2>
<p>The Generic Access Protocol (GAP) layer defines two security modes, along with
several security levels per mode.</p>
<p><strong>Security Mode 1</strong> enforces security by means of encryption, and contains
four levels:</p>
<blockquote>
<div><ul class="simple">
<li><p>Level 1: No Security (No authentication and no encryption)</p></li>
<li><p>Level 2: Unauthenticated pairing with encryption</p></li>
<li><p>Level 3: Authenticated pairing with AES-CCM encryption</p></li>
<li><p>Level 4: Authenticated LE Secure Connections pairing with encryption
using Elliptic Curve Diffie-Hellman P-256 (ECDH) and AES-CCM encryption.</p></li>
</ul>
</div></blockquote>
<p><strong>Security Mode 2</strong> enforces security by means of data signing, and contains
two levels:</p>
<blockquote>
<div><ul class="simple">
<li><p>Level 1: Unauthenticated pairing with data signing</p></li>
<li><p>Level 2: Authenticated pairing with data signing</p></li>
</ul>
</div></blockquote>
<p>A connection is always established in Security Mode 1, level 1 and can later
be upgraded to any other security level.
The pairing method chosen determines the actual security mode and level
achievable. As discussed in <a class="reference internal" href="#selection-of-pairing-method"><span class="std std-ref">Selection of Pairing Method</span></a>, the pairing
method is selected based on the capabilities of the devices in the connection.</p>
<p>When configured to do so, the BLE5-Stack allows to achieve all the security modes
and levels presented, including security mode 1 level 4.</p>
<p>Additional details regarding this topic can be found in [Vol 3], Part C,
section §10 of the <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>.</p>
</div>
<div class="section" id="selection-of-pairing-method">
<span id="id3"></span><h2>Selection of Pairing Method<a class="headerlink" href="#selection-of-pairing-method" title="Permalink to this headline">¶</a></h2>
<p>Bluetooth Core Specification Version 4.2 added support for the <em>LE Secure Connections</em>
feature to enable additional strength to the BLE pairing process. For a detailed
description of the algorithms used for <em>LE Secure Connections</em>, see the
<strong>Security Architecture</strong> section ([Vol 1], Part A, Section 5.1) of the <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>.
The previous pairing methods used in the Bluetooth Core Specification Versions 4.1
and 4.0 are still available, and are now defined as <em>LE Legacy Pairing</em>.
The main difference is that <em>Secure Connection</em> uses Elliptic Curve Diffie-Hellman (ECDH)
cryptography, while LE Legacy Pairing does not.</p>
<p>There are four types of pairing methods which are referred to as “Association Models” in the core
specification. Each pairing method is described in detail
in <a class="reference internal" href="#gapbondmgr-examples-for-different-pairing-modes"><span class="std std-ref">GAPBondMgr Examples for Different Pairing Methods</span></a>.</p>
<ul class="simple">
<li><p>Just Works (LE Secure Connections or LE Legacy)</p></li>
<li><p>Passkey Entry (LE Secure Connections or LE Legacy)</p></li>
<li><p>Numeric Comparison (LE Secure Connections)</p></li>
<li><p>Out Of Band (LE Secure Connections or LE Legacy)</p></li>
</ul>
<p>Which pairing method is selected, and whether or not pairing will succeed
depends on the following parameters from both peer devices during the pairing process:</p>
<ul class="simple">
<li><p>Out Of Band (OOB) set / not set</p></li>
<li><p>Man In The Middle (MITM) set / not set</p></li>
<li><p>Input/Output (IO) Capabilities</p></li>
<li><p>LE Secure Connections supported / not supported</p></li>
</ul>
<p>The GAPBondMgr parameters, as they map to the table parameters below are listed
here. For more information on these parameters, see <a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13xx_cc26xx.html#ble-api-reference"><span class="std std-ref">BLE Stack API Reference</span></a>
(GAPBondMgr section).</p>
<ul>
<li><p><a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr___params.html#ga0a4c3787199b3116d1e9812ef69db419">GAPBOND_OOB_ENABLED</a>: Out of band (OOB) set / not set</p></li>
<li><p><a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr___params.html#gaea6e3f468650f820c43ceb197aaa7d17">GAPBOND_MITM_PROTECTION</a>: Man in the middle (MITM) set / not set</p></li>
<li><p><a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr___params.html#gaa177361a4c710ead875395d56e87dfbc">GAPBOND_IO_CAPABILITIES</a>: Input/Output (IO) Capabilities</p></li>
<li><p><a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr___params.html#ga2c634d3c1a070888ceb1ae1423da2f5e">GAPBOND_SECURE_CONNECTION</a>: LE Secure connections supported / not
supported</p>
<p>Beyond what the <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a> defines, this parameter also affects whether or not
pairing succeeds, as described in <a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13xx_cc26xx.html#ble-api-reference"><span class="std std-ref">BLE Stack API Reference</span></a> (GAPBondMgr
section).</p>
</li>
</ul>
<p>The tables below are from the <strong>Selecting Key Generation Method</strong> section
([Vol 3], Part H, Section 2.3.5.1) of the <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>. Use these tables to
determine which pairing mode is selected for any set of parameters.</p>
<p>If both devices support LE Secure Connections, use
<a class="reference internal" href="#gappbondmgr-secur-connection-parameters"><span class="std std-numref">Table 8.</span></a> to decide upon the next step.</p>
<span id="gappbondmgr-secur-connection-parameters"></span><table class="docutils align-default" id="id9">
<caption><span class="caption-number">Table 8. </span><span class="caption-text">GAPBondMgr parameters when LE Secure Connections is supported by both devices</span><a class="headerlink" href="#id9" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 23%" />
<col style="width: 18%" />
<col style="width: 20%" />
<col style="width: 18%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>Initiator OOB Set</p></th>
<th class="head"><p>Initiator OOB Not Set</p></th>
<th class="head"><p>Initiator MITM Set</p></th>
<th class="head"><p>Initiator MITM Not Set</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Responder OOB Set</strong></p></td>
<td><p>Use OOB</p></td>
<td><p>Use OOB</p></td>
<td colspan="2" rowspan="2"></td>
</tr>
<tr class="row-odd"><td><p><strong>Responder OOB Not Set</strong></p></td>
<td><p>Use OOB</p></td>
<td><p>Check MITM</p></td>
</tr>
<tr class="row-even"><td><p><strong>Responder MITN Set</strong></p></td>
<td colspan="2" rowspan="2"></td>
<td><p>Use IO Capabilities</p></td>
<td><p>Use IO Capabilities</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Responder MITN Not Set</strong></p></td>
<td><p>Use IO Capabilities</p></td>
<td><p>Use Just Works</p></td>
</tr>
</tbody>
</table>
<p>If at least one device does <strong>not</strong> support LE Secure Connections, use
<a class="reference internal" href="#gappbondmgr-no-secur-connection-parameters"><span class="std std-numref">Table 9.</span></a> to decide upon the next step.</p>
<span id="gappbondmgr-no-secur-connection-parameters"></span><table class="docutils align-default" id="id10">
<caption><span class="caption-number">Table 9. </span><span class="caption-text">GAPBondMgr parameters when LE Secure Connections is <strong>not</strong> supported by one or both devices.</span><a class="headerlink" href="#id10" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 23%" />
<col style="width: 18%" />
<col style="width: 20%" />
<col style="width: 18%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>Initiator OOB Set</p></th>
<th class="head"><p>Initiator OOB Not Set</p></th>
<th class="head"><p>Initiator MITM Set</p></th>
<th class="head"><p>Initiator MITM Not Set</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Responder OOB Set</strong></p></td>
<td><p>Use OOB</p></td>
<td><p>Check MITM</p></td>
<td colspan="2" rowspan="2"></td>
</tr>
<tr class="row-odd"><td><p><strong>Responder OOB Not Set</strong></p></td>
<td><p>Check MITM</p></td>
<td><p>Check MITM</p></td>
</tr>
<tr class="row-even"><td><p><strong>Responder MITN Set</strong></p></td>
<td colspan="2" rowspan="2"></td>
<td><p>Use IO Capabilities</p></td>
<td><p>Use IO Capabilities</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Responder MITN Not Set</strong></p></td>
<td><p>Use IO Capabilities</p></td>
<td><p>Use Just Works</p></td>
</tr>
</tbody>
</table>
<p>If, based on one of the previous tables, IO capabilities are to be used to
determine the association model, use <a class="reference internal" href="#gappbondmgr-io-capabilities-parameters"><span class="std std-numref">Table 10.</span></a></p>
<span id="gappbondmgr-io-capabilities-parameters"></span><table class="docutils align-default" id="id11">
<caption><span class="caption-number">Table 10. </span><span class="caption-text">GAPBondMgr parameters with IO capabilities</span><a class="headerlink" href="#id11" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 14%" />
<col style="width: 19%" />
<col style="width: 19%" />
<col style="width: 19%" />
<col style="width: 12%" />
<col style="width: 19%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head" rowspan="2"><p>Responder</p></th>
<th class="head" colspan="5"><p>Initiator</p></th>
</tr>
<tr class="row-even"><th class="head"><p>Display Only</p></th>
<th class="head"><p>Display YesNo</p></th>
<th class="head"><p>Keyboard Only</p></th>
<th class="head"><p>NoInput NoOutput</p></th>
<th class="head"><p>Keyboard Display</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p><strong>Display Only</strong></p></td>
<td><p>Just Works
Unauthenticated</p></td>
<td><p>Just Works
Unauthenticated</p></td>
<td><p>Passkey Entry:
Responder displays,
Initiator inputs
Authenticated</p></td>
<td><p>Just Works
Unauthenticated</p></td>
<td><p>Passkey Entry:
Responder displays,
Initiator inputs
Authenticated</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p><strong>Display YesNo</strong></p></td>
<td rowspan="2"><p>Just Works
Unauthenticated</p></td>
<td><p>Just Works
(For LE Legacy Pairing)
Unauthenticated</p></td>
<td rowspan="2"><p>Passkey Entry:
Responder displays,
Initiator inputs
Authenticated</p></td>
<td rowspan="2"><p>Just Works
Unauthenticated</p></td>
<td><p>Passkey Entry
(For LE Legacy Pairing)
Responder displays
Initiator inputs
Authenticated</p></td>
</tr>
<tr class="row-odd"><td><p>Numeric Comparison
(For LE Secure Connections)
Authenticated</p></td>
<td><p>Numeric Comparison
(For LE Secure Connections)
Authenticated</p></td>
</tr>
<tr class="row-even"><td><p><strong>Keyboard Only</strong></p></td>
<td><p>Passkey Entry:
Initiator displays,
Responder inputs
Authenticated</p></td>
<td><p>Passkey Entry:
Initiator displays,
Responder inputs
Authenticated</p></td>
<td><p>Passkey Entry:
Initiator displays,
Responder inputs
Authenticated</p></td>
<td><p>Just Works
Unauthenticated</p></td>
<td><p>Passkey Entry:
Initiator displays,
Responder inputs
Authenticated</p></td>
</tr>
<tr class="row-odd"><td><p><strong>NoInput NoOutput</strong></p></td>
<td><p>Just Works
Unauthenticated</p></td>
<td><p>Just Works
Unauthenticated</p></td>
<td><p>Just Works
Unauthenticated</p></td>
<td><p>Just Works
Unauthenticated</p></td>
<td><p>Just Works
Unauthenticated</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p><strong>Keyboard Display</strong></p></td>
<td rowspan="2"><p>Passkey Entry:
Initiator displays,
Responder inputs
Authenticated</p></td>
<td><p>Passkey Entry
(For LE Legacy Pairing)
Initiator displays
Responder inputs
Authenticated</p></td>
<td rowspan="2"><p>Passkey Entry:
Responder displays,
Initiator inputs
Authenticated</p></td>
<td rowspan="2"><p>Just Works
Unauthenticated</p></td>
<td><p>Passkey Entry
(For LE Legacy Pairing)
Initiator displays
Responder inputs
Authenticated</p></td>
</tr>
<tr class="row-odd"><td><p>Numeric Comparison
(For LE Secure Connections)
Authenticated</p></td>
<td><p>Numeric Comparison
(For LE Secure Connections)
Authenticated</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="using-gapbondmgr">
<h2>Using GAPBondMgr<a class="headerlink" href="#using-gapbondmgr" title="Permalink to this headline">¶</a></h2>
<p>This section describes what the application must do to configure, start, and use
the GAPBondMgr. The GAPBondMgr is defined in <code class="docutils literal notranslate"><span class="pre">gapbondmgr.c</span></code> and <code class="docutils literal notranslate"><span class="pre">gapbondmgr.h</span></code>.
<a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13xx_cc26xx.html#ble-api-reference"><span class="std std-ref">BLE Stack API Reference</span></a> (GAPBondMgr section) describes the full API including
commands, configurable parameters, events, and callbacks.</p>
<p>The general steps to use the GAPBondMgr module are as follows:</p>
<p>1. Configure the stack to include GAPBondMgr functionality by defining the
following in <code class="docutils literal notranslate"><span class="pre">build_config.opt</span></code> in the stack project:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-DGAP_BOND_MGR</span></code></p></li>
</ul>
</div></blockquote>
<p>2. If using LE Secure Connections, the PDU size must be &gt;= 69. This can be set by
defining the following preprocessor symbol in the application
project: <code class="docutils literal notranslate"><span class="pre">MAX_PDU_SIZE=69</span></code>. Also, the minimum heap size that can be used with
LE Secure Connections is 3690. (See <a class="reference internal" href="../ble-stack-common/ram_allocation-cc13xx_cc26xx.html#dynamic-memory-allocation"><span class="std std-ref">Dynamic Memory Allocation</span></a> for heap size
management.)</p>
<p>3. Configure the GAPBondMgr by initializing its parameters as desired. GAPBondMgr
configuration parameters are not persistent and must be configured after the device
is reset. See <a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13xx_cc26xx.html#ble-api-reference"><span class="std std-ref">BLE Stack API Reference</span></a> (GAPBondMgr section) for a complete list of
parameters with functionality described. There are examples of this for the various
pairing/bonding modes in <a class="reference internal" href="#gapbondmgr-examples-for-different-pairing-modes"><span class="std std-ref">GAPBondMgr Examples for Different Pairing Methods</span></a>.</p>
<p>4. Register application callbacks with the GAPBondMgr, so that the application
can communicate with the GAPBondMgr and be notified of events.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Register with bond manager after starting device</span>
<span class="n">GAPBondMgr_Register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bondmanager_callbacks</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>Here <code class="docutils literal notranslate"><span class="pre">bondmanager_callbacks</span></code> is defined as a structure containing the
GAPBondMgr Callbacks. A passcode callback function is mandatory.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Bond Manager Callbacks</span>
<span class="k">static</span><span class="w"> </span><span class="n">gapBondCBs_t</span><span class="w"> </span><span class="n">bondMgrCBs</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">SimpleCentral_passcodeCb</span><span class="p">,</span><span class="w"> </span><span class="c1">// Passcode callback</span>
<span class="w">  </span><span class="n">SimpleCentral_pairStateCb</span><span class="w"> </span><span class="c1">// Pairing/Bonding state Callback</span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>5. Once the GAPBondMgr is configured, it operates mostly autonomously from the
perspective of the application. When a connection is established, the GAPBondMgr
manages pairing and bonding depending on the configuration parameters set
during initialization. It also communicates with the application as needed
through the defined callbacks.</p>
<p>A few parameters can be set and functions can be called asynchronously at any time from
the application. See <a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13xx_cc26xx.html#ble-api-reference"><span class="std std-ref">BLE Stack API Reference</span></a> (GAPBondMgr section) for more
information.</p>
<p>Most communication between the GAPBondMgr and the application at this point
occurs through the callbacks which were registered in Step 5.
<a class="reference internal" href="#gapbondmgr-flow-diagram"><span class="std std-numref">Figure 82.</span></a> is a flow diagram example of the GAPBondMgr
notifying the application that pairing has been completed. The same method
occurs for various other events and will be expanded upon in the following section.</p>
<div class="figure align-center" id="id12">
<span id="gapbondmgr-flow-diagram"></span><p class="plantuml">
<img src="../_images/plantuml-bf14786892004a9387ee905d842630d020583326.png" alt="&#64;startuml
  participant Application
  participant Gapbondmgr as &quot;GAPBondMgr&quot;
  participant BLEStack as &quot;BLE Stack&quot;

  BLEStack -&gt; Gapbondmgr : GAP_AUTHENTICATION_\nCOMPLETE_EVENT
  Gapbondmgr -&gt; Application : Pairing state callback
  Application-&gt; Application : SimpleCentral_pairStateCb
  Application-&gt; Application : SimpleCentral_enqueueMsg
  Application-&gt; Application : SimpleCentral_processAppMsg
  rnote over &quot;Application&quot;
    SC_EVT_PAIR_STATE
  end note
  Application-&gt; Application : SimpleCentral_processPairState
  rnote over &quot;Application&quot;
    GAPBOND_PAIRING_STATE_COMPLETE
  end note

&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 82. </span><span class="caption-text">GapBondMgr Callback Example.</span><a class="headerlink" href="#id12" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="gapbondmgr-examples-for-different-pairing-methods">
<span id="gapbondmgr-examples-for-different-pairing-modes"></span><h2>GAPBondMgr Examples for Different Pairing Methods<a class="headerlink" href="#gapbondmgr-examples-for-different-pairing-methods" title="Permalink to this headline">¶</a></h2>
<p>This section provides message diagrams for the types of security
that can be implemented. These modes assume acceptable I/O
capabilities are available for the security mode, and that the
selection of whether or not to support LE Secure Connections allows for
the pairing method. See the <a class="reference internal" href="#selection-of-pairing-method"><span class="std std-ref">Selection of Pairing Method</span></a> on how these
parameters affect pairing. These examples only consider the pairing aspect.
Bonding can be added to each type of pairing in the same manner and
is shown in the next section.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>The code snippets here are not complete functioning
examples, and are only intended for illustration purposes.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is not allowed to set MITM to TRUE while IO capability is
set to GAPBOND_IO_CAP_NO_INPUT_NO_OUTPUT since these two conflict
each other.</p>
</div>
<div class="section" id="disabling-pairing">
<h3>Disabling Pairing<a class="headerlink" href="#disabling-pairing" title="Permalink to this headline">¶</a></h3>
<p>With pairing mode set to <code class="docutils literal notranslate"><span class="pre">GAPBOND_PAIRING_MODE_NO_PAIRING</span></code>, the BLE stack
automatically rejects any attempt at pairing.
Configure the GAPBondMgr as follows to disable pairing:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Pairing is not allowed</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">pairMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPBOND_PAIRING_MODE_NO_PAIRING</span><span class="p">;</span><span class="w"></span>
<span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_PAIRING_MODE</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pairMode</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="enabling-pairing">
<h3>Enabling Pairing<a class="headerlink" href="#enabling-pairing" title="Permalink to this headline">¶</a></h3>
<p>To start or allow the pairing process after a connection is formed, the GAPBondMgr can be
configured to automatically request pairing or wait for pairing request from the
peer device. The actual behavior depends on the device’s GAP role (Central or Peripheral)
and the setting of the GAPBondMgr pairing mode (<code class="docutils literal notranslate"><span class="pre">GAPBOND_PAIRING_MODE</span></code>).</p>
<p>To initiate the pairing process on Peripheral role devices, <code class="docutils literal notranslate"><span class="pre">GAPBOND_PAIRING_MODE_INITIATE</span></code> will
send a Slave Security Request shortly after the GAPBondMgr is informed that the connection is formed.
For Central role devices, <code class="docutils literal notranslate"><span class="pre">GAPBOND_PAIRING_MODE_INITIATE</span></code> will send a Pairing Request or request
the Link Layer to encrypt the link if the device has previously paired/bonded:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Initiate pairing request</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">pairMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPBOND_PAIRING_MODE_INITIATE</span><span class="p">;</span><span class="w"></span>
<span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_PAIRING_MODE</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pairMode</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The Peripheral can be configured to wait for a <em>Pairing Request</em> from the Central when the pairing mode
is set to <code class="docutils literal notranslate"><span class="pre">GAPBOND_PAIRING_MODE_WAIT_FOR_REQ</span></code>. When this pairing mode is selected, the GAPBondMgr will
automatically respond with a <em>Pairing Response</em> based on other GAPBondMgr configured parameters.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Wait for a pairing request</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">pairMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPBOND_PAIRING_MODE_WAIT_FOR_REQ</span><span class="p">;</span><span class="w"></span>
<span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_PAIRING_MODE</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pairMode</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>When pairing with smartphone Central devices, it is recommended to use <code class="docutils literal notranslate"><span class="pre">GAPBOND_PAIRING_MODE_WAIT_FOR_REQ</span></code>
as undefined behavior may occur when a Slave Security Request is sent by the Peripheral. Both iOS
and Android will initiate pairing when the peripheral responds with an <em>Insufficient Authentication</em> error
response when a GATT secure characteristic is accessed.</p>
</div>
<p>Pairing can also be enabled by utilizing <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#ga15379572e5d31e014e84e5457d4b1633">GAPBondMgr_Pair()</a>. This API can be used to start the pairing
process when pairing is not started automatically by the GAPBondMgr. For more information, please refer to
<a class="reference internal" href="#pairing-and-encryption-without-gapbondmgr"><span class="std std-ref">Pairing and Encryption without GAPBondMgr</span></a></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">bStatus_t</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPBondMgr_Pair</span><span class="p">(</span><span class="n">connHandle</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="le-secure-connections">
<span id="lesc-intro"></span><h3>LE Secure Connections<a class="headerlink" href="#le-secure-connections" title="Permalink to this headline">¶</a></h3>
<p>LE Secure Connections is enabled by default in BLE5-Stack. If you don’t want to use
LE Secure Connections, set the <code class="docutils literal notranslate"><span class="pre">GAPBOND_SECURE_CONNECTION</span></code> variable
to <code class="docutils literal notranslate"><span class="pre">GAPBOND_SECURE_CONNECTION_NONE</span></code> during the GAPBondMgr initialization.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">gapbondSecure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPBOND_SECURE_CONNECTION_NONE</span><span class="p">;</span><span class="w"></span>
<span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_SECURE_CONNECTION</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gapbondSecure</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>It is important when trying to decipher over-the-air sniffer logs with LE Secure
Connections enabled, you need to use a specific “debug” key as defined by Vol 3
Part H section 2.3.5.6.1 of the <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>. In the BLE5-Stack, this key is
enabled using SysConfig, by checking ‘ECC Debug Keys’ under BLE, Bond Manager (see
<a class="reference internal" href="../sysconfig/ble5-sysconfig.html#bond-manager-configurations"><span class="std std-ref">Bond Manager Configurations</span></a>).
When either the initiating or non-initiating device uses this specific debug
key, it enables over-the-air sniffer equipment that supports LE Secure Connections to
determine the <a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html#term-LTK"><span class="xref std std-term">LTK</span></a> and therefore monitor/decrypt encrypted traffic throughout
the connection.</p>
</div>
<div class="section" id="lesc-limitations-recommendations">
<h3>LESC Limitations &amp; Recommendations<a class="headerlink" href="#lesc-limitations-recommendations" title="Permalink to this headline">¶</a></h3>
<p>LE Secure Connections uses an ECDH public-private key pair as part of the
pairing process. See <a class="reference internal" href="#selection-of-pairing-method"><span class="std std-ref">Selection of Pairing Method</span></a> and the <em>LE Secure
Connections Pairing Phase 2</em> section of the <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a> for more information
about how these keys and how they are used in the pairing process.</p>
<p>To summarize, as part of LESC pairing Phase 1 each device will generate its own
ECDH public-private key pair. As part of LESC pairing Phase 2 each device will
compute the Diffie-Hellman (DH) Key based on the public keys that are exchanged.</p>
<p>ECC public-private and DH key generation is implemented by the ECDH
TI-RTOS7 driver for the Private Key Accelerator (PKA) on the CC13xx or CC26xx. These
routines are <strong>blocking</strong> by nature and take around <strong>136.5ms</strong> to execute.
During LESC pairing, the ECDH driver will be accessed twice by the link
layer (LL) once to generate the public/private key pair and again to generate
the DH key. This means the stack OSAL tasks will be blocked for
around <strong>136.5ms</strong> twice during pairing. However, the user application task
will be able to run at this time.</p>
<p>Because of this, TI recommends the following when using LESC:</p>
<ul class="simple">
<li><p>Supervision timeout &gt;= <strong>140ms</strong></p></li>
</ul>
<p>To alleviate the amount of blocking required, the user application can
generate the public-private key pair ahead of the pairing process, or it can
define when the keys should be recycled by using the following parameters of
the GapBondMgr. These options are mutually exclusive, as generation of keys
by the application bypasses the recycle parameter. To truly minimize the
affect of ECC on the BLE connection, perform ECC before any connections
are established.</p>
<ul class="simple">
<li><p><a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr___params.html#ga446563bfbb29df64b2c4fa1ecd3563ee">GAPBOND_ECC_KEYS</a></p></li>
<li><p><a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr___params.html#ga237ea455f08591067d72aca90498a567">GAPBOND_ECCKEY_REGEN_POLICY</a></p></li>
</ul>
</div>
<div class="section" id="authentication-pairing-only">
<span id="id4"></span><h3>Authentication Pairing Only<a class="headerlink" href="#authentication-pairing-only" title="Permalink to this headline">¶</a></h3>
<p>For users that want the pairing method results in a key generation that provides Authenticated MITM protection only,
they can achieve that by doing the following.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">ioCap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPBOND_IO_CAP_KEYBOARD_DISPLAY</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">mitm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">authenPairingOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>

<span class="c1">// Only certain combinations of IO capability will result</span>
<span class="c1">// authenticad pairing mode. Here we use GAPBOND_IO_CAP_KEYBOARD_DISPLAY</span>
<span class="c1">// as code example to make sure whichever IO capability other than NoInput</span>
<span class="c1">// NoOutput the peer device has will result in an authenticated link</span>
<span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_IO_CAPABILITIES</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ioCap</span><span class="p">);</span><span class="w"></span>

<span class="c1">// For authenticated pairing, MITM has to be set to TRUE</span>
<span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="w"> </span><span class="n">GAPBOND_MITM_PROTECTION</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mitm</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Enable authentication only pairing</span>
<span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="w"> </span><span class="n">GAPBOND_AUTHEN_PAIRING_ONLY</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">authenPairingOnly</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Upon setting <cite>GAPBOND_AUTHEN_PAIRING_ONLY</cite> to true, if the peer device’s IO
capability can not result in authenticated link, the BLE5-Stack will
reject the pairing and return error code <cite>SMP_PAIRING_FAILED_AUTH_REQ</cite>.</p>
<div class="figure align-center" id="id13">
<span id="gap-authentication-only-fig"></span><p class="plantuml">
<img src="../_images/plantuml-c289894d662d49150c8c9a429a4ad86596bd1971.png" alt=" &#64;startuml

  participant Application
  participant Gapbondmgr as &quot;GAPBondMgr&quot;
  participant BLEStack as &quot;BLE Stack&quot;

  BLEStack -&gt; Gapbondmgr : GAP_LINK_ESTABLISHED_EVENT
  Gapbondmgr -&gt; BLEStack : GAPBondMgr_LinkEst()
  Gapbondmgr -&gt; BLEStack : GAP_Authenticate()
  BLEStack --&gt;] : Pairing req
  Gapbondmgr -&gt; Application : Pairing state callback
  rnote over Application
  GAPBOND_PAIRING_
  STATE_STARTED
  end note
  BLEStack &lt;--] : Pairing rsp
    rnote over BLEStack
      Base on the IO capability, MITM, OOB setting of both devices,
      STACK needs to sort out whether this results to Just Work pairing.
    end note

  group if the pairing method (Just Work) can not fulfill Authentication MITM protection

    BLEStack --&gt;] : End pairing
    BLEStack -&gt; Gapbondmgr : GAP_AUTHENTICATION_\nCOMPLETE_EVENT
    Gapbondmgr -&gt; Application : Pairing state callback
    rnote over Application
      GAPBOND_PAIRING_STATE_COMPLETE
      SMP_PAIRING_FAILED_AUTH_REQ
    end note
  end
&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 83. </span><span class="caption-text">Authentication Only Pairing.</span><a class="headerlink" href="#id13" title="Permalink to this image">¶</a></p>
</div>
<p>For more information regarding which pairing mode results authenticated link, please refer <a class="reference internal" href="#gappbondmgr-io-capabilities-parameters"><span class="std std-numref">Table 10.</span></a></p>
</div>
<div class="section" id="just-works-pairing">
<h3>Just Works Pairing<a class="headerlink" href="#just-works-pairing" title="Permalink to this headline">¶</a></h3>
<p>Just Works pairing allows encryption without man in the middle (MITM)
authentication and is vulnerable to MITM attacks. Just Works pairing can be LE
Legacy or LE Secure Connections pairing. The GAPBondMgr does not need any
additional input from the application for Just Works pairing.
Configure the GAPBondMgr for Just Works pairing as follows.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">mitm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span><span class="w"></span>
<span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="w"> </span><span class="n">GAPBOND_MITM_PROTECTION</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mitm</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p><a class="reference internal" href="#gap-justworks-fig"><span class="std std-numref">Figure 84.</span></a> describes the interaction between the GAPBondMgr and
the application for Just Works pairing. As shown, the application receives
a <code class="docutils literal notranslate"><span class="pre">GAPBOND_PAIRING_STATE_STARTED</span></code> event once the pairing request has been sent,
and a <code class="docutils literal notranslate"><span class="pre">GAPBOND_PAIRING_STATE_COMPLETE</span></code> event once the pairing process has been
completed. At this time, the link is encrypted.</p>
<div class="figure align-center" id="id14">
<span id="gap-justworks-fig"></span><p class="plantuml">
<img src="../_images/plantuml-71a8d6166875665e5d903d5f11c4f34d3efe9f28.png" alt=" &#64;startuml

  participant Application
  participant Gapbondmgr as &quot;GAPBondMgr&quot;
  participant BLEStack as &quot;BLE Stack&quot;

  BLEStack -&gt; Gapbondmgr : GAP_LINK_ESTABLISHED_EVENT
  Gapbondmgr -&gt; BLEStack : GAPBondMgr_LinkEst()
  Gapbondmgr -&gt; BLEStack : GAP_Authenticate()
  BLEStack --&gt;] : Pairing req
  Gapbondmgr -&gt; Application : Pairing state callback
  rnote over Application
  GAPBOND_PAIRING_
  STATE_STARTED
  end note

  BLEStack --&gt;] : Encryption req
  BLEStack &lt;--] : Encryption rsp
  BLEStack -&gt; Gapbondmgr : GAP_AUTHENTICATION_\nCOMPLETE_EVENT
  Gapbondmgr -&gt; Application : Pairing state callback
  rnote over Application
  GAPBOND_PAIRING_
  STATE_COMPLETE
  end note
&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 84. </span><span class="caption-text">Just Works Pairing.</span><a class="headerlink" href="#id14" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="passcode-entry">
<h3>Passcode Entry<a class="headerlink" href="#passcode-entry" title="Permalink to this headline">¶</a></h3>
<p>Passkey entry is a type of authenticated pairing that can prevent man in the
middle (MITM) attacks. It can be used with either LE Legacy pairing or Secure
Connections pairing. In this pairing method, one device displays a 6-digit
passcode, and the other device enters the passcode. As described in
<a class="reference internal" href="#selection-of-pairing-method"><span class="std std-ref">Selection of Pairing Method</span></a>, the IO capabilities decide which device
performs which role. The passcode callback registered with the GAPBondMgr when
it was started is used to enter or display the passcode. The following is an
example of initiating Passcode Entry pairing where the passcode is displayed.</p>
<ol class="arabic simple">
<li><p>Define passcode callback</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id15">
<span id="gapbondmgr-define-passcode-cb"></span><div class="code-block-caption"><span class="caption-number">Listing 112. </span><span class="caption-text">Define passcode callback.</span><a class="headerlink" href="#id15" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Bond Manager Callbacks</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">gapBondCBs_t</span><span class="w"> </span><span class="n">bondMgrCBs</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">SimpleCentral_passcodeCb</span><span class="p">,</span><span class="w"> </span><span class="c1">// Passcode callback</span>
<span class="w">      </span><span class="n">SimpleCentral_pairStateCb</span><span class="w"> </span><span class="c1">// Pairing/Bonding state Callback</span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="cm">/*********************************************************************</span>
<span class="cm">     * @fn      SimpleCentral_passcodeCb</span>
<span class="cm">     *</span>
<span class="cm">     * @brief   Passcode callback.</span>
<span class="cm">     *</span>
<span class="cm">     * @return  none</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SimpleCentral_passcodeCb</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">deviceAddr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">connHandle</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">uiInputs</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">uiOutputs</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">numComparison</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">pData</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Allocate space for the passcode event.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ICall_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))))</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">pData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uiOutputs</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Enqueue the event.</span>
<span class="w">        </span><span class="n">SimpleCentral_enqueueMsg</span><span class="p">(</span><span class="n">SC_EVT_PASSCODE_NEEDED</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">pData</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<ol class="arabic simple" start="2">
<li><p>Configure GAPBondMgr</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-number">Listing 113. </span><span class="caption-text">Configure GAPBondMgr for MITM.</span><a class="headerlink" href="#id16" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pairMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPBOND_PAIRING_MODE_INITIATE</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">mitm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_PAIRING_MODE</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pairMode</span><span class="p">);</span><span class="w"></span>
<span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_MITM_PROTECTION</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mitm</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<ol class="arabic simple" start="3">
<li><p>Process passcode callback and send the response to the stack.</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id17">
<span id="gapbondmgr-process-passcode"></span><div class="code-block-caption"><span class="caption-number">Listing 114. </span><span class="caption-text">Process passcode and send the response.</span><a class="headerlink" href="#id17" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//! BLE Default Passcode</span>
<span class="cp">#define B_APP_DEFAULT_PASSCODE                    123456</span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      SimpleCentral_processPasscode</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Process the Passcode request.</span>
<span class="cm"> *</span>
<span class="cm"> * @return  none</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SimpleCentral_processPasscode</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">connHandle</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">uiOutputs</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Display passcode to user</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uiOutputs</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Display_printf</span><span class="p">(</span><span class="n">dispHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SC_ROW_CUR_CONN</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Passcode: %d&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">B_APP_DEFAULT_PASSCODE</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Send passcode response</span>
<span class="w">  </span><span class="n">GAPBondMgr_PasscodeRsp</span><span class="p">(</span><span class="n">connHandle</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">,</span><span class="w"> </span><span class="n">B_APP_DEFAULT_PASSCODE</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>Depending on the <code class="docutils literal notranslate"><span class="pre">uiInputs</span></code> and <code class="docutils literal notranslate"><span class="pre">uiOutputs</span></code> returned from the GAPBondMgr,
the passcode must either be displayed or entered. The passcode is
then sent to the GAPBondMgr using <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#gab38535f42c53c94f2dced0609e574765">GAPBondMgr_PasscodeRsp()</a>, so that
pairing can continue. In this case, the password is statically set to 123456.
In a real product, the password will likely be randomly generated, and the
device must expose a way for the user to enter the passcode, then send it to the
GAPBondMgr using <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#gab38535f42c53c94f2dced0609e574765">GAPBondMgr_PasscodeRsp()</a>. An example interaction
between the GAPBondMgr and the application is shown in
<a class="reference internal" href="#gapbondmgr-exchange-passcode"><span class="std std-numref">Figure 85.</span></a>.</p>
<div class="figure align-center" id="id18">
<span id="gapbondmgr-exchange-passcode"></span><p class="plantuml">
<img src="../_images/plantuml-6ecc2ed56bf9645de6385945bd5a49aaaca98ed6.png" alt=" &#64;startuml
  participant Application
  participant Gapbondmgr as &quot;GAPBondMgr&quot;
  participant BLEStack as &quot;BLE Stack&quot;

  BLEStack -&gt; Gapbondmgr : GAP_LINK_ESTABLISHED_EVENT
  Gapbondmgr -&gt; BLEStack : GAPBondMgr_LinkEst()
  Gapbondmgr -&gt; BLEStack : GAP_Authenticate()
  BLEStack --&gt;] : Pairing req
  Gapbondmgr -&gt; Application : Pairing state callback

  rnote over Application
  GAPBOND_PAIRING_
  STATE_STARTED
  end note

  BLEStack -&gt; Gapbondmgr : GAP_PASSKEY_NEEDED_\nEVENT
  Gapbondmgr -&gt; Application : Passcode callback
  [--&gt; Application : Enter or display\npasscode
  Application -&gt; Gapbondmgr : GAPBondMgr_PasscodeRsp()
  Gapbondmgr -&gt; BLEStack : GAP_PasscodeUpdate()
  BLEStack --&gt;] : Encryption req
  BLEStack &lt;--] : Encryption rsp
  BLEStack -&gt; Gapbondmgr : GAP_AUTHENTICATION_\nCOMPLETE_EVENT
  Gapbondmgr -&gt; Application : Pairing state callback

  rnote over Application
  GAPBOND_PAIRING_
  STATE_COMPLETE
  end note
&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 85. </span><span class="caption-text">Interaction Between the GAPBondMgr and the Application when exchanging a passcode.</span><a class="headerlink" href="#id18" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="numeric-comparison">
<h3>Numeric Comparison<a class="headerlink" href="#numeric-comparison" title="Permalink to this headline">¶</a></h3>
<p>Numeric comparison is a type of authenticated pairing that protects
from MITM attacks. It is only possible as a LE Secure Connections
pairing; not LE legacy. For numeric comparison pairing, both devices
display a 6-digit code. Each device must then indicate, through a
button press or some other Yes-No input, whether the codes match.
The passcode callback registered with the GAPBondMgr when it was
started is used to display the 6-digit code. The following is an
example of initiating Numeric Comparison pairing where the passcode
is displayed. The IO capabilities must be set appropriately to
select numeric comparison (that is, Display/Yes-No on both sides).</p>
<ol class="arabic simple">
<li><p>Define passcode callback to display code.</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id19">
<span id="gapbondmgr-define-passcode"></span><div class="code-block-caption"><span class="caption-number">Listing 115. </span><span class="caption-text">Define passcode callback to display code.</span><a class="headerlink" href="#id19" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// Bond Manager Callbacks</span>
<span class="linenos"> 2</span><span class="k">static</span><span class="w"> </span><span class="n">gapBondCBs_t</span><span class="w"> </span><span class="n">bondMgrCBs</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos"> 3</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">  </span><span class="n">SimpleCentral_passcodeCb</span><span class="p">,</span><span class="w"> </span><span class="c1">// Passcode callback</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="n">SimpleCentral_pairStateCb</span><span class="w"> </span><span class="c1">// Pairing/Bonding state Callback</span>
<span class="linenos"> 6</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SimpleCentral_passcodeCb</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">deviceAddr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">connHandle</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">uiInputs</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">uiOutputs</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">numComparison</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 9</span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">  </span><span class="n">gapPasskeyNeededEvent_t</span><span class="w"> </span><span class="o">*</span><span class="n">pData</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">  </span><span class="c1">// Allocate space for the passcode event.</span>
<span class="linenos">13</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ICall_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gapPasskeyNeededEvent_t</span><span class="p">))))</span><span class="w"></span>
<span class="linenos">14</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">pData</span><span class="o">-&gt;</span><span class="n">deviceAddr</span><span class="p">,</span><span class="w"> </span><span class="n">deviceAddr</span><span class="p">,</span><span class="w"> </span><span class="n">B_ADDR_LEN</span><span class="p">);</span><span class="w"></span>
<span class="linenos">16</span><span class="w">    </span><span class="n">pData</span><span class="o">-&gt;</span><span class="n">connectionHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connHandle</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="n">pData</span><span class="o">-&gt;</span><span class="n">numComparison</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numComparison</span><span class="p">;</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="c1">// Enqueue the event.</span>
<span class="linenos">20</span><span class="w">    </span><span class="n">SimpleCentral_enqueueMsg</span><span class="p">(</span><span class="n">SC_EVT_PASSCODE_NEEDED</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">pData</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<ol class="arabic simple" start="2">
<li><p>Configure GAPBondMgr</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id20">
<span id="gapbondmgr-authenticate-configure"></span><div class="code-block-caption"><span class="caption-number">Listing 116. </span><span class="caption-text">Configure GAPBondMgr For LE Secure Connections + Authentication.</span><a class="headerlink" href="#id20" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pairMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPBOND_PAIRING_MODE_WAIT_FOR_REQ</span><span class="p">;</span><span class="w"></span>
<span class="linenos">2</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">scMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPBOND_SECURE_CONNECTION_ONLY</span><span class="p">;</span><span class="w"></span>
<span class="linenos">3</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">mitm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="linenos">4</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">ioCap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPBOND_IO_CAP_DISPLAY_YES_NO</span><span class="p">;</span><span class="w"></span>
<span class="linenos">5</span>
<span class="linenos">6</span><span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_IO_CAPABILITIES</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ioCap</span><span class="p">);</span><span class="w"></span>
<span class="linenos">7</span><span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_PAIRING_MODE</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pairMode</span><span class="p">);</span><span class="w"></span>
<span class="linenos">8</span><span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_MITM_PROTECTION</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mitm</span><span class="p">);</span><span class="w"></span>
<span class="linenos">9</span><span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_SECURE_CONNECTION</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">scMode</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<ol class="arabic simple" start="3">
<li><p>Process passcode callback and display code.</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id21">
<span id="gapbondmgr-authenticate-process"></span><div class="code-block-caption"><span class="caption-number">Listing 117. </span><span class="caption-text">Process passcode callback and display code.</span><a class="headerlink" href="#id21" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SimpleCentral_processPasscode</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">connHandle</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">                                            </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">uiOutputs</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">    </span><span class="c1">// Display passcode to user</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uiOutputs</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">      </span><span class="n">Display_printf</span><span class="p">(</span><span class="n">dispHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SC_ROW_CUR_CONN</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Passcode: %d&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">                     </span><span class="n">B_APP_DEFAULT_PASSCODE</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="w">    </span><span class="c1">// Send passcode response</span>
<span class="linenos">12</span><span class="w">    </span><span class="n">GAPBondMgr_PasscodeRsp</span><span class="p">(</span><span class="n">connHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">,</span><span class="w"> </span><span class="n">B_APP_DEFAULT_PASSCODE</span><span class="p">);</span><span class="w"></span>
<span class="linenos">13</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<ol class="arabic simple" start="4">
<li><p>Accept Yes-No input from user and send response to GAPBondMgr.</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id22">
<span id="gapbondmgr-authenticate-accept"></span><div class="code-block-caption"><span class="caption-number">Listing 118. </span><span class="caption-text">Accept Yes-No input from user and send response to GAPBondMgr.</span><a class="headerlink" href="#id22" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keys</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KEY_RIGHT</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2</span><span class="p">{</span><span class="w"></span>
<span class="linenos">3</span><span class="w">  </span><span class="c1">//Send response to indicate that code matches</span>
<span class="linenos">4</span><span class="w">  </span><span class="n">GAPBondMgr_PasscodeRsp</span><span class="p">(</span><span class="n">connHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">);</span><span class="w"></span>
<span class="linenos">5</span><span class="w">  </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="linenos">6</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>In this case, the third parameter of GAPBondMgr_PasscodeRsp, which
usually accepts a passcode, is overloaded to send TRUE to the stack to
indicate that the codes match and to continue with pairing. The process of
numeric comparison is illustrated in <a class="reference internal" href="#numeric-comparison-fig"><span class="std std-numref">Figure 86.</span></a></p>
<div class="figure align-center" id="id23">
<span id="numeric-comparison-fig"></span><p class="plantuml">
<img src="../_images/plantuml-5934f3ee2028ae934884e3f876da2a0be791be5a.png" alt=" &#64;startuml
  participant Application
  participant Gapbondmgr as &quot;GAPBondMgr&quot;
  participant BLEStack as &quot;BLE Stack&quot;

  BLEStack -&gt; Gapbondmgr : GAP_LINK_ESTABLISHED_EVENT
  Gapbondmgr -&gt; BLEStack : GAPBondMgr_LinkEst()
  Gapbondmgr -&gt; BLEStack : GAP_Authenticate()
  BLEStack --&gt;] : Pairing req
  Gapbondmgr -&gt; Application : Pairing state callback
  rnote over Application
  GAPBOND_PAIRING_
  STATE_STARTED
  end note

  BLEStack -&gt; Gapbondmgr : GAP_PASSKEY_\nNEEDED_EVENT
  Gapbondmgr -&gt; Application : Passcode callback

  [&lt;-- Application : Display code
  [--&gt; Application : Codes match

  Application -&gt; Gapbondmgr : GAPBondMgr_PasscodeRsp()
  Gapbondmgr -&gt; BLEStack : GAP_PasscodeUpdate()

  BLEStack --&gt;] : Encryption req
  BLEStack &lt;--] : Encryption rsp
  BLEStack -&gt; Gapbondmgr : GAP_AUTHENTICATION_\nCOMPLETE_EVENT
  Gapbondmgr -&gt; Application : Pairing state callback
  rnote over Application
  GAPBOND_PAIRING_
  STATE_COMPLETE
  end note
&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 86. </span><span class="caption-text">Numeric Comparison.</span><a class="headerlink" href="#id23" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="out-of-band-pairing">
<h3>Out of Band Pairing<a class="headerlink" href="#out-of-band-pairing" title="Permalink to this headline">¶</a></h3>
<p>Out of Band is a feature that allows two devices to send authentication
information over a communication channel that is out of the band of the device,
e.g. by NFC. The purpose is to allow two devices with no input or output
capabilities to create an authenticated pairing. This happens by sending three
authentication parameters: device address, random number and confirm value.</p>
<p>The main purpose of OOB authentication is to protect against MITM attacks. The
idea is to generate a key on one device. (This can be the initiator or the
responder.) Then the OOB data is communicated to the other device by some other
means of communication than BLE.</p>
<p>The OOB data is generated at runtime. This can be done using elliptic-curve
cryptography (ECC) or not. In this example we will use ECC to generate a key. To
generate OOB data with a central application such as Simple Central follow these
steps:</p>
<ol class="arabic simple">
<li><p>Create gapBondOOBData_t variables, one for the local OOB data and one for the
remote device’s data:</p></li>
</ol>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// This is needed for the device that generates OOB data</span>
<span class="n">gapBondOOBData_t</span><span class="w"> </span><span class="n">localOobData</span><span class="p">;</span><span class="w"></span>
<span class="c1">// This is needed to store the OOB data this device receives</span>
<span class="n">gapBondOOBData_t</span><span class="w"> </span><span class="n">remoteOobData</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Define the pair state callback</p></li>
</ol>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// Bond Manager Callbacks</span>
<span class="linenos"> 2</span><span class="k">static</span><span class="w"> </span><span class="n">gapBondCBs_t</span><span class="w"> </span><span class="n">bondMgrCBs</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos"> 3</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 4</span><span class="n">SimpleCentral_passcodeCb</span><span class="p">,</span><span class="w"> </span><span class="c1">// Passcode callback</span>
<span class="linenos"> 5</span><span class="n">SimpleCentral_pairStateCb</span><span class="w"> </span><span class="c1">// Pairing/Bonding state Callback</span>
<span class="linenos"> 6</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="cm">/*********************************************************************</span>
<span class="linenos"> 9</span><span class="cm"> * @fn      SimpleCentral_pairStateCb</span>
<span class="linenos">10</span><span class="cm"> *</span>
<span class="linenos">11</span><span class="cm"> * @brief   Pairing state callback.</span>
<span class="linenos">12</span><span class="cm"> *</span>
<span class="linenos">13</span><span class="cm"> * @return  none</span>
<span class="linenos">14</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">15</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SimpleCentral_pairStateCb</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">connHandle</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"></span>
<span class="linenos">16</span><span class="p">{</span><span class="w"></span>
<span class="linenos">17</span><span class="w">  </span><span class="n">scPairStateData_t</span><span class="w"> </span><span class="o">*</span><span class="n">pData</span><span class="p">;</span><span class="w"></span>
<span class="linenos">18</span><span class="w">  </span><span class="c1">// Allocate space for the event data.</span>
<span class="linenos">19</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ICall_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">scPairStateData_t</span><span class="p">))))</span><span class="w"></span>
<span class="linenos">20</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="n">pData</span><span class="o">-&gt;</span><span class="n">connHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connHandle</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="w">    </span><span class="n">pData</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="w">    </span><span class="c1">// Queue the event.</span>
<span class="linenos">24</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">SimpleCentral_enqueueMsg</span><span class="p">(</span><span class="n">SC_EVT_PAIR_STATE</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">pData</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="linenos">25</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">26</span><span class="w">      </span><span class="n">ICall_free</span><span class="p">(</span><span class="n">pData</span><span class="p">);</span><span class="w"></span>
<span class="linenos">27</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">28</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">29</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic" start="3">
<li><p>To generate OOB data with ECC keys, you need to call <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#ga72329566d29b215c8883fb6e920b3b45">GAPBondMgr_GenerateEccKeys()</a>
prior to <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#ga58c6878a22868d20beeed56d55f65791">GAPBondMgr_SCGetLocalOOBParameters()</a>.
After calling <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#ga72329566d29b215c8883fb6e920b3b45">GAPBondMgr_GenerateEccKeys()</a>, once the ECC keys are ready,
the BLE5-Stack will send <code class="xref c c-type docutils literal notranslate"><span class="pre">GAPBOND_GENERATE_ECC_DONE</span></code>
event to application and the event should be processed under pair state callback.</p>
<p>Then application can call <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#ga58c6878a22868d20beeed56d55f65791">GAPBondMgr_SCGetLocalOOBParameters()</a> to obtain
OOB data which is generated using the ECC Keys. The OOB data can then be extracted.
The example code below illustrate how to extract the OOB data.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#ga72329566d29b215c8883fb6e920b3b45">GAPBondMgr_GenerateEccKeys()</a> and <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#ga58c6878a22868d20beeed56d55f65791">GAPBondMgr_SCGetLocalOOBParameters()</a>
can be called either before and after the connection is established.
But these need to be called before the pairing started.
In this case, we call both functions before the connection is established.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-number">Listing 119. </span><span class="caption-text"><strong>SimpleCentral_init</strong> Generate ECC keys.</span><a class="headerlink" href="#id24" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="c1">// Generate ECC Keys</span>
<span class="linenos">2</span><span class="n">GAPBondMgr_GenerateEccKeys</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-number">Listing 120. </span><span class="caption-text"><strong>SimpleCentral_processPairState::GAPBOND_GENERATE_ECC_DONE</strong> Generate OOB data after ECC keys are ready.</span><a class="headerlink" href="#id25" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="cm">/*********************************************************************</span>
<span class="linenos"> 2</span><span class="cm">  * @fn      SimpleCentral_processPairState</span>
<span class="linenos"> 3</span><span class="cm">  *</span>
<span class="linenos"> 4</span><span class="cm">  * @brief   Process the new paring state.</span>
<span class="linenos"> 5</span><span class="cm">  *</span>
<span class="linenos"> 6</span><span class="cm">  * @return  none</span>
<span class="linenos"> 7</span><span class="cm">  */</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SimpleCentral_processPairState</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">                                            </span><span class="n">scPairStateData_t</span><span class="o">*</span><span class="w"> </span><span class="n">pPairData</span><span class="p">)</span><span class="w"></span>
<span class="linenos">10</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">   </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pPairData</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">   </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pairMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GAPBOND_GENERATE_ECC_DONE</span><span class="p">)</span><span class="w"></span>
<span class="linenos">14</span><span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="linenos">16</span><span class="w">     </span><span class="p">{</span><span class="w"></span>
<span class="linenos">17</span><span class="w">         </span><span class="n">GAPBondMgr_SCGetLocalOOBParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">localOobData</span><span class="p">);</span><span class="w"></span>
<span class="linenos">18</span><span class="w">         </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span><span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">KEYLEN</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">20</span><span class="w">         </span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="w">           </span><span class="n">Display_printf</span><span class="p">(</span><span class="n">dispHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SC_ROW_CUR_CONN</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;OOB data confirm[%d]: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">localOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">22</span><span class="w">           </span><span class="n">Display_printf</span><span class="p">(</span><span class="n">dispHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SC_ROW_CUR_CONN</span><span class="o">+</span><span class="n">KEYLEN</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;OOB data rand[%d]: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">localOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">23</span><span class="w">         </span><span class="p">}</span><span class="w"></span>
<span class="linenos">24</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">25</span><span class="w">     </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span><span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="linenos">27</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#ga72329566d29b215c8883fb6e920b3b45">GAPBondMgr_GenerateEccKeys()</a> is not called before <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#ga58c6878a22868d20beeed56d55f65791">GAPBondMgr_SCGetLocalOOBParameters()</a>,
the OOB data will be generated without ECC.</p>
</div>
</li>
<li><p>After the OOB data is generated, the device needs to send it over to the peer device
using any other medium for example NFC or wired solutions(E.g. UART, SPI, LIN, CAN…etc).
The device which has received the OOB data (not the one that generated it)
should set the GAPBOND_OOB_ENABLED parameter to true. If both devices have
generated and shared their OOB data both should set the flag. In this case we
will only set the flag on the peripheral device.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">oobEnabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>

<span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_OOB_ENABLED</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oobEnabled</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>Perform OOB communication, i.e. communicate the data in localOobData to the
responder device. For simplicity, in this example the central device will
display the data thus it can be hard coded on the peripheral device.</p>
<div class="figure align-center" id="id26">
<img alt="../_images/display_oob.png" src="../_images/display_oob.png" />
<p class="caption"><span class="caption-number">Figure 87. </span><span class="caption-text">The central device displays the OOB data.</span><a class="headerlink" href="#id26" title="Permalink to this image">¶</a></p>
</div>
</li>
</ol>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-number">Listing 121. </span><span class="caption-text"><strong>SimplePeripheral_processGapMessage::GAP_DEVICE_INIT_DONE_EVENT</strong> The OOB data is hard coded on the peripheral device.</span><a class="headerlink" href="#id27" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">oobEnabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 2</span><span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_OOB_ENABLED</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oobEnabled</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 3</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">204</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 4</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">29</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 5</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">240</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">154</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">141</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">132</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">41</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">156</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">106</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">91</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">230</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">88</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">117</span><span class="p">;</span><span class="w"></span>
<span class="linenos">18</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">confirm</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">104</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">56</span><span class="p">;</span><span class="w"></span>
<span class="linenos">20</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">242</span><span class="p">;</span><span class="w"></span>
<span class="linenos">21</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">38</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">152</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">189</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">78</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">164</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">36</span><span class="p">;</span><span class="w"></span>
<span class="linenos">27</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">153</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">82</span><span class="p">;</span><span class="w"></span>
<span class="linenos">29</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">167</span><span class="p">;</span><span class="w"></span>
<span class="linenos">30</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">190</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">140</span><span class="p">;</span><span class="w"></span>
<span class="linenos">32</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">235</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">207</span><span class="p">;</span><span class="w"></span>
<span class="linenos">34</span><span class="n">remoteOobData</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">93</span><span class="p">;</span><span class="w"></span>
<span class="linenos">35</span><span class="n">GAPBondMgr_SCSetRemoteOOBParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">remoteOobData</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
<p>The process of aforementioned OOB pairing example is
illustrated in <a class="reference internal" href="#oob-pairing-fig"><span class="std std-numref">Figure 88.</span></a></p>
<div class="figure align-center" id="id28">
<span id="oob-pairing-fig"></span><p class="plantuml">
<img src="../_images/plantuml-b655224283ece1b9203a221dedeb6e6ef811cd11.png" alt="&#64;startuml

    participant cen_app as &quot;Central\nApplication&quot;
    participant cen_gapbondmgr as &quot;Central\nGapbondmgr&quot;
    participant cen_blestack as &quot;Central\nBLE-Stack&quot;

    participant per_blestack as &quot;Peripheral\nBLE-Stack&quot;
    participant per_gapbondmgr as &quot;Peripheral\nGapbondmgr&quot;
    participant per_app as &quot;Peripheral\nApplication&quot;

    cen_app -&gt; cen_gapbondmgr : Generate ECC keys
    cen_gapbondmgr -&gt; cen_blestack : Generate ECC keys

    ==ECC Keys are ready ==
    cen_gapbondmgr -&gt; cen_app : Pairing state callback
    rnote over cen_app
      GAPBOND_GENERATE_
      ECC_DONE
    end note

    cen_app -&gt; cen_gapbondmgr : Get local OOB parameters
    cen_gapbondmgr -&gt; cen_blestack : Compute confirm and rand values
    cen_app -&gt; per_app : Sending OOB data through either NFC or other wired protocol

    == Once peripheral receives OOB data ==
    per_app -&gt; per_app : Set GAPBOND_OOB_ENABLED to true

    == After connection has established ==

    cen_gapbondmgr -&gt; cen_blestack : GAPBondMgr_LinkEst()
    cen_gapbondmgr -&gt; cen_blestack : GAP_Authenticate()
    cen_blestack --&gt; per_blestack : Pairing req
    per_blestack --&gt; cen_blestack : Pairing rsp
    cen_gapbondmgr -&gt; cen_app : Pairing state callback

    rnote over cen_app
    GAPBOND_PAIRING_
    STATE_STARTED
    end note

    per_gapbondmgr -&gt; per_app : Pairing state callback
    rnote over per_app
    GAPBOND_PAIRING_
    STATE_STARTED
    end note

    cen_blestack --&gt; per_blestack : Encryption req
    cen_blestack &lt;-- per_blestack : Encryption rsp
    cen_blestack -&gt; cen_gapbondmgr : GAP_AUTHENTICATION_\nCOMPLETE_EVENT
    cen_gapbondmgr -&gt; cen_app : Pairing state callback
    per_blestack -&gt; per_gapbondmgr : GAP_AUTHENTICATION_\nCOMPLETE_EVENT
    per_gapbondmgr -&gt; per_app : Pairing state callback
    rnote over cen_app
      GAPBOND_PAIRING_
      STATE_COMPLETE
    end note

    rnote over per_app
      GAPBOND_PAIRING_
      STATE_COMPLETE
    end note
&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 88. </span><span class="caption-text">Out of Band Pairing</span><a class="headerlink" href="#id28" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="gapbondmgr-examples-for-manipulating-bonding">
<h2>GAPBondMgr Examples for Manipulating Bonding<a class="headerlink" href="#gapbondmgr-examples-for-manipulating-bonding" title="Permalink to this headline">¶</a></h2>
<p>GAPBondMgr offers various functions to help users to:</p>
<ol class="arabic simple">
<li><p>Enable bonding</p></li>
<li><p>Extract bonding information</p></li>
<li><p>Import bonding information to NV</p></li>
</ol>
<div class="section" id="enable-bonding">
<h3>Enable Bonding<a class="headerlink" href="#enable-bonding" title="Permalink to this headline">¶</a></h3>
<p>Bonding can enabled or disabled for any type of pairing through the
<code class="docutils literal notranslate"><span class="pre">GAPBOND_BONDING_ENABLED</span></code> parameter, and occurs after the pairing
process is complete. To enable bonding, configure the GAPBondMgr as
follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">bonding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_BONDING_ENABLED</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bonding</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>With bonding enabled, the GAPBondMgr stores the long-term key
transferred during the pairing process to SNV. See <a class="reference internal" href="#gapbondmgr-and-snv"><span class="std std-ref">GAPBondMgr and SNV</span></a> for more information.
After this is completed, the application is notified
through the <code class="xref c c-type docutils literal notranslate"><span class="pre">GAPBOND_PAIRING_STATE_COMPLETE</span></code> event.
<code class="xref c c-type docutils literal notranslate"><span class="pre">GAPBOND_PAIRING_STATE_BOND_SAVED</span></code> is only passed to the application pair
state callback when initially connecting, pairing, and bonding. For
future connections to a bonded device, the security keys are loaded from
flash, thus skipping the pairing process. In this case, only
<code class="xref c c-type docutils literal notranslate"><span class="pre">GAPBOND_PAIRING_STATE_BONDED</span></code> is passed to the application pair state callback.
This is illustrated in <a class="reference internal" href="#gapbondmgr-example-bonding"><span class="std std-numref">Figure 89.</span></a></p>
<div class="figure align-center" id="id29">
<span id="gapbondmgr-example-bonding"></span><p class="plantuml">
<img src="../_images/plantuml-630f962ae215212e09434ceec9cb2bdc64eabc11.png" alt=" &#64;startuml

  participant Application
  participant Gapbondmgr as &quot;GAPBondMgr&quot;
  participant BLEStack as &quot;BLE Stack&quot;

  BLEStack -&gt; Gapbondmgr : GAP_LINK_ESTABLISHED_EVENT
  Gapbondmgr -&gt; BLEStack : GAPBondMgr_LinkEst()
  Gapbondmgr -&gt; BLEStack : GAP_Authenticate
  BLEStack --&gt;] : Pairing req
  Gapbondmgr -&gt; Application : Pairing state callback
  rnote over Application
  GAPBOND_PAIRING_
  STATE_STARTED
  end note

  == This section will vary depending on the pairing type.\nSee above examples for more information. ==

  BLEStack --&gt;] : Encryption req
  BLEStack &lt;--] : Encryption rsp
  BLEStack -&gt; Gapbondmgr : GAP_AUTHENTICATION_\nCOMPLETE_EVENT

  rnote over Gapbondmgr
  Save bond info in SNV
  end note

  Gapbondmgr -&gt; Application : Pairing state callback
  rnote over Application
  GAPBOND_PAIRING_
  STATE_COMPLETE
  end note

  rnote over Application
  GAPBOND_PAIRING_
  STATE_BOND_SAVED
  end note

  == Eventually the connection may be terminated and re-established. ==

  BLEStack -&gt; Gapbondmgr : GAP_LINK_ESTABLISHED_EVENT
  Gapbondmgr -&gt; BLEStack : GAPBondMgr_LinkEst()

  rnote over Gapbondmgr
  Read bond info from SNV.
  end note

  Gapbondmgr -&gt; BLEStack : GAP_Bond()
  BLEStack --&gt;] : Encryption req
  BLEStack &lt;--] : Encryption rsp
  BLEStack -&gt; Gapbondmgr : GAP_BOND_COMPLETE_\nEVENT
  Gapbondmgr -&gt; Application : Pairing state callback
  rnote over Application
  GAPBOND_PAIRING_
  STATE_BONDED
  end note


&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 89. </span><span class="caption-text">GAPBondMgr Example With Bonding Enabled.</span><a class="headerlink" href="#id29" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="extract-bonding-information">
<span id="id5"></span><h3>Extract Bonding Information<a class="headerlink" href="#extract-bonding-information" title="Permalink to this headline">¶</a></h3>
<p>After bonding, the local device can extract the bonding information
saved in NV using <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#gaff83c663db700153fc3021e226e2854b">gapBondMgrReadBondRec()</a>. To successfully
extract the bonding information, application will need to input the
peer device’s address type and the peer device’s address. Those information
are provided from the BLE5-Stack to the application when the link is established.</p>
<p>Following are the code snippet to extract the aforementioned parameters.</p>
<div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-number">Listing 122. </span><span class="caption-text"><strong>SimplePeripheral_processGapMessage::GAP_LINK_ESTABLISHED_EVENT</strong> Extract peer device address and address type.</span><a class="headerlink" href="#id30" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// LOCAL VARIABLES</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="c1">// Array to save peer device&#39;s address</span>
<span class="linenos"> 4</span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">peerDeviceAddr</span><span class="p">[</span><span class="n">B_ADDR_LEN</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="c1">// enum to store peer device&#39;s address type</span>
<span class="linenos"> 7</span><span class="k">static</span><span class="w"> </span><span class="n">GAP_Peer_Addr_Types_t</span><span class="w"> </span><span class="n">pPeerAddrType</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SimplePeripheral_processGapMessage</span><span class="p">(</span><span class="n">gapEventHdr_t</span><span class="w"> </span><span class="o">*</span><span class="n">pMsg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">10</span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">  </span><span class="k">switch</span><span class="p">(</span><span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span><span class="w"></span>
<span class="linenos">12</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">GAP_LINK_ESTABLISHED_EVENT</span><span class="p">:</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">      </span><span class="n">gapEstLinkReqEvent_t</span><span class="w"> </span><span class="o">*</span><span class="n">pPkt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gapEstLinkReqEvent_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pPkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="linenos">18</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="w">        </span><span class="c1">// Copy Peer&#39;s addr</span>
<span class="linenos">21</span><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">peerDeviceAddr</span><span class="p">,</span><span class="w"> </span><span class="n">pPkt</span><span class="o">-&gt;</span><span class="n">devAddr</span><span class="p">,</span><span class="w"> </span><span class="n">B_ADDR_LEN</span><span class="p">);</span><span class="w"></span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w">        </span><span class="c1">// Copy Peer&#39;s addrType</span>
<span class="linenos">24</span><span class="w">        </span><span class="n">pPeerAddrType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GAP_Peer_Addr_Types_t</span><span class="p">)(</span><span class="n">pPkt</span><span class="o">-&gt;</span><span class="n">devAddrType</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MASK_ADDRTYPE_ID</span><span class="p">);</span><span class="w"></span>
<span class="linenos">25</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">      </span><span class="c1">//...</span>
<span class="linenos">28</span><span class="w">      </span><span class="c1">//...</span>
</pre></div>
</div>
</div>
<p>Once extracting the needed parameters, we can call <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#gaff83c663db700153fc3021e226e2854b">gapBondMgrReadBondRec()</a>
by using the following code snippet.</p>
<div class="literal-block-wrapper docutils container" id="id31">
<div class="code-block-caption"><span class="caption-number">Listing 123. </span><span class="caption-text">Extract bonding information</span><a class="headerlink" href="#id31" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// Parameters needed for storing bonding information.</span>
<span class="linenos"> 2</span><span class="k">static</span><span class="w"> </span><span class="n">gapBondRec_t</span><span class="w"> </span><span class="n">pSavedBondRec</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 3</span><span class="k">static</span><span class="w"> </span><span class="n">gapBondLTK_t</span><span class="w"> </span><span class="n">pLocalLtk</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 4</span><span class="k">static</span><span class="w"> </span><span class="n">gapBondLTK_t</span><span class="w"> </span><span class="n">pPeerLtk</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 5</span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pPeerIRK</span><span class="p">[</span><span class="n">KEYLEN</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 6</span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pPeerSRK</span><span class="p">[</span><span class="n">KEYLEN</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 7</span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">pPeerSignCount</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="k">static</span><span class="w"> </span><span class="n">gapBondCharCfg_t</span><span class="w"> </span><span class="n">charCfg</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">readStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FAILURE</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="n">readStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gapBondMgrReadBondRec</span><span class="p">(</span><span class="n">pPeerAddrType</span><span class="p">,</span><span class="w"></span>
<span class="linenos">13</span><span class="w">                                   </span><span class="n">peerDeviceAddr</span><span class="p">,</span><span class="w"></span>
<span class="linenos">14</span><span class="w">                                   </span><span class="o">&amp;</span><span class="n">pSavedBondRec</span><span class="p">,</span><span class="w"></span>
<span class="linenos">15</span><span class="w">                                   </span><span class="o">&amp;</span><span class="n">pLocalLtk</span><span class="p">,</span><span class="w"></span>
<span class="linenos">16</span><span class="w">                                   </span><span class="o">&amp;</span><span class="n">pPeerLtk</span><span class="p">,</span><span class="w"></span>
<span class="linenos">17</span><span class="w">                                   </span><span class="n">pPeerIRK</span><span class="p">,</span><span class="w"></span>
<span class="linenos">18</span><span class="w">                                   </span><span class="n">pPeerSRK</span><span class="p">,</span><span class="w"></span>
<span class="linenos">19</span><span class="w">                                   </span><span class="n">pPeerSignCount</span><span class="p">,</span><span class="w"></span>
<span class="linenos">20</span><span class="w">                                   </span><span class="o">&amp;</span><span class="n">charCfg</span><span class="p">);</span><span class="w"></span>
<span class="linenos">21</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">readStatus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="linenos">22</span><span class="p">{</span><span class="w"></span>
<span class="linenos">23</span><span class="w">  </span><span class="c1">// If read success, then export the data</span>
<span class="linenos">24</span><span class="w">  </span><span class="c1">// Here we will print it out for later use.</span>
<span class="linenos">25</span><span class="w">  </span><span class="c1">// For the print, we added the following defines</span>
<span class="linenos">26</span><span class="w">  </span><span class="c1">// Please consider your own example and modify as needed</span>
<span class="linenos">27</span><span class="w">  </span><span class="c1">// #define SP_ROW_DEBUG_BondLog  (TBM_ROW_APP + 9)</span>
<span class="linenos">28</span><span class="w">  </span><span class="c1">// #define SP_ROW_DEBUG_PeerAddr (TBM_ROW_APP + 10)</span>
<span class="linenos">29</span><span class="w">  </span><span class="c1">// #define SP_ROW_DEBUG_LocalLTK (TBM_ROW_APP + 16)</span>
<span class="linenos">30</span><span class="w">  </span><span class="c1">// #define SP_ROW_DEBUG_PeerIRK  (TBM_ROW_APP + 40)</span>
<span class="linenos">31</span><span class="w">  </span><span class="c1">// #define SP_ROW_DEBUG_PeerSRK  (TBM_ROW_APP + 56)</span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="w">  </span><span class="n">Display_printf</span><span class="p">(</span><span class="n">dispHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SP_ROW_DEBUG_PeerAddr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos">34</span><span class="w">                 </span><span class="s">&quot;Peer Device Addr = [0x%02x, 0x%02x, 0x%02x, 0x%02x, 0x%02x, 0x%02x];&quot;</span><span class="p">,</span><span class="w"></span>
<span class="linenos">35</span><span class="w">                 </span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"></span>
<span class="linenos">36</span><span class="w">                 </span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"></span>
<span class="linenos">37</span><span class="w">                 </span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"></span>
<span class="linenos">38</span><span class="w">                 </span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"></span>
<span class="linenos">39</span><span class="w">                 </span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"></span>
<span class="linenos">40</span><span class="w">                 </span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="w">  </span><span class="n">Display_printf</span><span class="p">(</span><span class="n">dispHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SP_ROW_DEBUG_PeerAddr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Peer Device AddrType = 0x%02x; stateFlag = 0x%02x;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addrType</span><span class="p">,</span><span class="w"> </span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">stateFlags</span><span class="p">);</span><span class="w"></span>
<span class="linenos">43</span><span class="w">  </span><span class="n">Display_printf</span><span class="p">(</span><span class="n">dispHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SP_ROW_DEBUG_PeerAddr</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Local Device eDiv = 0x%02x; keySize = 0x%02x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">div</span><span class="p">,</span><span class="w"> </span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">keySize</span><span class="p">);</span><span class="w"></span>
<span class="linenos">44</span><span class="w">  </span><span class="n">Display_printf</span><span class="p">(</span><span class="n">dispHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SP_ROW_DEBUG_PeerAddr</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;peer Device SignCount = 0x%08x;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pPeerSignCount</span><span class="p">);</span><span class="w"></span>
<span class="linenos">45</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">KEYLEN</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">46</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">47</span><span class="w">      </span><span class="n">Display_printf</span><span class="p">(</span><span class="n">dispHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SP_ROW_DEBUG_LocalLTK</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Local Device LTK[%d]= 0x%02x;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">48</span><span class="w">      </span><span class="n">Display_printf</span><span class="p">(</span><span class="n">dispHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SP_ROW_DEBUG_PeerIRK</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Peer Device IRK[%d]= 0x%02x;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">pPeerIRK</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">49</span><span class="w">      </span><span class="n">Display_printf</span><span class="p">(</span><span class="n">dispHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SP_ROW_DEBUG_PeerSRK</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Peer Device SRK[%d]= 0x%02x;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">pPeerSRK</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">50</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">51</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">B_RANDOM_NUM_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">52</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">53</span><span class="w">      </span><span class="n">Display_printf</span><span class="p">(</span><span class="n">dispHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SP_ROW_DEBUG_LocalLTK</span><span class="o">+</span><span class="mi">16</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Local Device rand[%d]= 0x%02x;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">54</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">55</span>
<span class="linenos">56</span><span class="w">  </span><span class="n">Display_printf</span><span class="p">(</span><span class="n">dispHandle</span><span class="p">,</span><span class="w"> </span><span class="n">SP_ROW_DEBUG_PeerSRK</span><span class="o">+</span><span class="mi">16</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Charcfg attrHandle = 0x%04x; value = 0x%02x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">charCfg</span><span class="p">.</span><span class="n">attrHandle</span><span class="p">,</span><span class="w"> </span><span class="n">charCfg</span><span class="p">.</span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="linenos">57</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="docutils literal notranslate"><span class="pre">pPeerLtk</span></code> struct is not needed when extracting and importing bonds
to another device. Therefore, we are not printing it out as the content
of <code class="docutils literal notranslate"><span class="pre">pPeerLtk</span></code> is 0.</p>
</div>
<p>Here is the printout content using the code snippet.</p>
<blockquote>
<div><div class="figure align-center">
<img alt="../_images/bond_read_content.png" src="../_images/bond_read_content.png" />
</div>
</div></blockquote>
</div>
<div class="section" id="import-bonding-information">
<h3>Import Bonding Information<a class="headerlink" href="#import-bonding-information" title="Permalink to this headline">¶</a></h3>
<p>The bond import feature is useful when for example, there are multiple
Bluetooth LE devices as peripheral and one mobile phone as central,
and you would like the phone to go through
the pairing process only once but is able to establish an encrypted link
with any other peripheral nodes.</p>
<p>The following content illustrates such usecase.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here we assume device A and device B have the same secondary address.
The device address can be configured by either using <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#gaea8af8b8d0099e813cde1e30b864a0a7">HCI_EXT_SetBDADDRCmd()</a>
or through SysConfig tool –&gt; Device Configuration –&gt; Configure BLE Address.</p>
</div>
<p>After extracting bonding information from device A and transfer the information
to device B, we can then add those information into NV for device B by using
<a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#gab36e5dd569942e6260517c73ea7042cf">gapBondMgrImportBond()</a>.</p>
<div class="literal-block-wrapper docutils container" id="id32">
<div class="code-block-caption"><span class="caption-number">Listing 124. </span><span class="caption-text"><strong>SimplePeripheral_init</strong> Import bonding information</span><a class="headerlink" href="#id32" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// Make sure the device B has the same BD address as device A</span>
<span class="linenos"> 2</span><span class="c1">// For example, if the device A&#39;s address is the following</span>
<span class="linenos"> 3</span><span class="c1">// Then use HCI_EXT_SetBDADDRCmd to change the device B&#39;s address</span>
<span class="linenos"> 4</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">bondImportTestAddr</span><span class="p">[</span><span class="n">B_ADDR_LEN</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x12</span><span class="p">,</span><span class="w"> </span><span class="mh">0x34</span><span class="p">,</span><span class="w"> </span><span class="mh">0x45</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFE</span><span class="p">,</span><span class="w"> </span><span class="mh">0xCA</span><span class="p">,</span><span class="w"> </span><span class="mh">0x98</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 5</span><span class="c1">// Change device&#39;s address</span>
<span class="linenos"> 6</span><span class="n">HCI_EXT_SetBDADDRCmd</span><span class="p">(</span><span class="n">bondImportTestAddr</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="c1">// Import Bond here</span>
<span class="linenos"> 9</span><span class="c1">// Hardcode the bonding information from the printout</span>
<span class="linenos">10</span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xf5</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xda</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x31</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xb0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x6f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">addrType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PEER_ADDRTYPE_PUBLIC_OR_PUBLIC_ID</span><span class="p">;</span><span class="w"></span>
<span class="linenos">18</span><span class="n">pSavedBondRec</span><span class="p">.</span><span class="n">stateFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1c</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0xa8</span><span class="p">;</span><span class="w"></span>
<span class="linenos">21</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x82</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x09</span><span class="p">;</span><span class="w"></span>
<span class="linenos">23</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x19</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x65</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x01</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0xbc</span><span class="p">;</span><span class="w"></span>
<span class="linenos">27</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x58</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x49</span><span class="p">;</span><span class="w"></span>
<span class="linenos">29</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x28</span><span class="p">;</span><span class="w"></span>
<span class="linenos">30</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x31</span><span class="p">;</span><span class="w"></span>
<span class="linenos">31</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0xac</span><span class="p">;</span><span class="w"></span>
<span class="linenos">32</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x50</span><span class="p">;</span><span class="w"></span>
<span class="linenos">34</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x6f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">35</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0xd2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">38</span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">keySize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x10</span><span class="p">;</span><span class="w"></span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="n">pPeerLtk</span><span class="p">.</span><span class="n">div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">41</span><span class="n">pPeerLtk</span><span class="p">.</span><span class="n">keySize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">42</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="linenos">43</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">B_RANDOM_NUM_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">44</span><span class="p">{</span><span class="w"></span>
<span class="linenos">45</span><span class="w">    </span><span class="n">pLocalLtk</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">46</span><span class="w">    </span><span class="n">pPeerLtk</span><span class="p">.</span><span class="n">rand</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">47</span><span class="p">}</span><span class="w"></span>
<span class="linenos">48</span>
<span class="linenos">49</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">KEYLEN</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">50</span><span class="p">{</span><span class="w"></span>
<span class="linenos">51</span><span class="w">    </span><span class="n">pPeerIRK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">52</span><span class="w">    </span><span class="n">pPeerLtk</span><span class="p">.</span><span class="n">LTK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">53</span><span class="p">}</span><span class="w"></span>
<span class="linenos">54</span>
<span class="linenos">55</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0xab</span><span class="p">;</span><span class="w"></span>
<span class="linenos">56</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x31</span><span class="p">;</span><span class="w"></span>
<span class="linenos">57</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x78</span><span class="p">;</span><span class="w"></span>
<span class="linenos">58</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0xe5</span><span class="p">;</span><span class="w"></span>
<span class="linenos">59</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x5a</span><span class="p">;</span><span class="w"></span>
<span class="linenos">60</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x33</span><span class="p">;</span><span class="w"></span>
<span class="linenos">61</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0xf6</span><span class="p">;</span><span class="w"></span>
<span class="linenos">62</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0xe9</span><span class="p">;</span><span class="w"></span>
<span class="linenos">63</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x1b</span><span class="p">;</span><span class="w"></span>
<span class="linenos">64</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="p">;</span><span class="w"></span>
<span class="linenos">65</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0xeb</span><span class="p">;</span><span class="w"></span>
<span class="linenos">66</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0xae</span><span class="p">;</span><span class="w"></span>
<span class="linenos">67</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x25</span><span class="p">;</span><span class="w"></span>
<span class="linenos">68</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0xd4</span><span class="p">;</span><span class="w"></span>
<span class="linenos">69</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x1d</span><span class="p">;</span><span class="w"></span>
<span class="linenos">70</span><span class="n">pPeerSRK</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="mh">0x19</span><span class="p">;</span><span class="w"></span>
<span class="linenos">71</span>
<span class="linenos">72</span><span class="n">pPeerSignCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">73</span><span class="n">charCfg</span><span class="p">.</span><span class="n">attrHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">;</span><span class="w"></span>
<span class="linenos">74</span><span class="n">charCfg</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xff</span><span class="p">;</span><span class="w"></span>
<span class="linenos">75</span>
<span class="linenos">76</span><span class="n">gapBondMgrImportBond</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSavedBondRec</span><span class="p">,</span><span class="w"></span>
<span class="linenos">77</span><span class="w">                     </span><span class="o">&amp;</span><span class="n">pLocalLtk</span><span class="p">,</span><span class="w"></span>
<span class="linenos">78</span><span class="w">                     </span><span class="o">&amp;</span><span class="n">pPeerLtk</span><span class="p">,</span><span class="w"></span>
<span class="linenos">79</span><span class="w">                     </span><span class="n">pPeerIRK</span><span class="p">,</span><span class="w"></span>
<span class="linenos">80</span><span class="w">                     </span><span class="n">pPeerSRK</span><span class="p">,</span><span class="w"></span>
<span class="linenos">81</span><span class="w">                     </span><span class="n">pPeerSignCount</span><span class="p">,</span><span class="w"></span>
<span class="linenos">82</span><span class="w">                     </span><span class="o">&amp;</span><span class="n">charCfg</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>The bonding import can be called at anytime, but for the demo purpose,
we added the code under application_init. Therefore when device B connects
with the central device that has paired with device A, the link between
device B and central will be encrypted without going through the
pairing process again.</p>
<p><a class="reference internal" href="#gapbondmgr-example-extract-import-bond"><span class="std std-numref">Figure 90.</span></a> illustrates the whole process of
enable bonding, extract bonding information and import bonding
information.</p>
<div class="figure align-center" id="id33">
<span id="gapbondmgr-example-extract-import-bond"></span><p class="plantuml">
<img src="../_images/plantuml-8dbfd49943f13685ac377a8fdcd89421b2d4dd52.png" alt=" &#64;startuml

  participant perA as &quot;Peripheral A&quot;
  participant cen as &quot;Central&quot;
  participant perB as &quot;Peripheral B&quot;

  cen --&gt; perA : GAP_LINK_ESTABLISHED_EVENT
  cen --&gt; perA : Pairing Req
  perA --&gt; cen : Pairing Rsp

  == Depending on the combination of pairing req and pairing rsp, a type of pairing\nwill be selected. See above examples for more information. ==

  cen -&gt; cen : Pairing state callback
  rnote over cen
    GAPBOND_PAIRING_
    STATE_STARTED
  end note

  perA -&gt; perA : Pairing state callback
  rnote over perA
    GAPBOND_PAIRING_
    STATE_STARTED
  end note

  cen --&gt; perA : Encryption req
  perA --&gt; cen : Encryption rsp

  ...
  ... Both central and peripheral A will save the bond info in NV ...
  ...


  rnote over cen
    GAPBOND_PAIRING_
    STATE_COMPLETE
  end note

  rnote over perA
    GAPBOND_PAIRING_
    STATE_COMPLETE
  end note

  rnote over cen
    GAPBOND_PAIRING_
    STATE_BOND_SAVED
  end note

  rnote over perA
    GAPBOND_PAIRING_
    STATE_BOND_SAVED
  end note

  perA -&gt; perA : Extract bonding information\nusing gapBondMgrReadBondRec

  ...
  ... Central can now terminate the link with Peripheral A ...
  ...

  perA -&gt; perB : Transfer the bonding information through other wired/wireless protocols.\nFor example: LIN, CAN or SPI...etc

  perB -&gt; perB : Save the bonding information to NV \nby using gapBondMgrImportBond
  cen --&gt; perB : GAP_LINK_ESTABLISHED_EVENT

  cen --&gt; perB : Encryption req
  perB --&gt; cen : Encryption rsp

  ...
  ... Now the central and Peripheral B has an encrypted link \nwithout going through pairing process ...
  ...

&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 90. </span><span class="caption-text">GAPBondMgr Example With Extracting and Importing Bonding Information.</span><a class="headerlink" href="#id33" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="gapbondmgr-and-snv">
<span id="id6"></span><h2>GAPBondMgr and SNV<a class="headerlink" href="#gapbondmgr-and-snv" title="Permalink to this headline">¶</a></h2>
<p>This section describes how the GAPBondMgr uses the SNV flash area
for storing bonding information. For more information on SNV itself,
see <a class="reference internal" href="../ble-stack-common/flash_memory-cc13xx_cc26xx.html#flash"><span class="std std-ref">Flash</span></a>. The amount of bonds that can be stored
is set by the <code class="docutils literal notranslate"><span class="pre">GAP_BONDINGS_MAX</span></code> definition, which is set to 10 by default in
gapbondmgr.h, which can be modified as needed by the application.
The functionality of the GAPBondMgr when there are no
more available bonds varies based on whether the “least recently
used” scheme is enabled. See <a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13xx_cc26xx.html#ble-api-reference"><span class="std std-ref">BLE Stack API Reference</span></a> (GAPBondMgr section) for
more information on the <code class="docutils literal notranslate"><span class="pre">GAPBOND_LRU_BOND_REPLACEMENT</span></code> parameter. If this
parameter is set to false, it is not possible to add any more bonds without
manually deleting a bond. If the parameter is set to true, the least
recently used bond is deleted to make room for the new bond.</p>
<p>The following components comprise one bonding entry:</p>
<ol class="arabic simple">
<li><p><strong>Bond Record:</strong> this consists of the peer’s address, address type,
privacy reconnection address, and state flags. This comprises 8
bytes and is defined as such:</p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Structure of NV data for the connected device&#39;s address information</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Peer&#39;s address</span>
<span class="cm">   *</span>
<span class="cm">   * If identity information exists for this bond, this will be an</span>
<span class="cm">   * identity address</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w">               </span><span class="n">addr</span><span class="p">[</span><span class="n">B_ADDR_LEN</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Peer&#39;s address type</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="n">GAP_Peer_Addr_Types_t</span><span class="w"> </span><span class="n">addrType</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * State flags of bond</span>
<span class="cm">   *</span>
<span class="cm">   * @ref GAP_BONDED_STATE_FLAGS</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w">               </span><span class="n">stateFlags</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">gapBondRec_t</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p><strong>Client Characteristic Configurations (CCC):</strong> the amount of CCCs stored
in each entry are set by the <code class="docutils literal notranslate"><span class="pre">GAP_CHAR_CFG_MAX</span></code> define. This is
set to 4 by default. Each CCC is comprised of 4-bytes and is
defined as follows:</p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Structure of NV data for the connected device&#39;s characteristic configuration</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">uint16</span><span class="w"> </span><span class="n">attrHandle</span><span class="p">;</span><span class="w">  </span><span class="c1">// attribute handle</span>
<span class="w">  </span><span class="n">uint8</span><span class="w">  </span><span class="n">value</span><span class="p">;</span><span class="w">       </span><span class="c1">// attribute value for this device</span>
<span class="p">}</span><span class="w"> </span><span class="n">gapBondCharCfg_t</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p><strong>Local Long Term Key (LTK) info:</strong> this stores the local device’s
encryption information. This comprises 28 bytes and is composed
as such:</p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">uint8</span><span class="w">   </span><span class="n">LTK</span><span class="p">[</span><span class="n">KEYLEN</span><span class="p">];</span><span class="w">              </span><span class="c1">// Long Term Key (LTK)</span>
<span class="w">  </span><span class="n">uint16</span><span class="w">  </span><span class="n">div</span><span class="p">;</span><span class="w">  </span><span class="c1">//lint -e754        // LTK eDiv</span>
<span class="w">  </span><span class="n">uint8</span><span class="w">   </span><span class="n">rand</span><span class="p">[</span><span class="n">B_RANDOM_NUM_SIZE</span><span class="p">];</span><span class="w">  </span><span class="c1">// LTK random number</span>
<span class="w">  </span><span class="n">uint8</span><span class="w">   </span><span class="n">keySize</span><span class="p">;</span><span class="w">                  </span><span class="c1">// LTK key size</span>
<span class="p">}</span><span class="w"> </span><span class="n">gapBondLTK_t</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p><strong>Peer Device Long Term Key Info:</strong> this stores the peer
device’s encryption information. This is also a gapBondLTK_t and
comprises 28 bytes.</p></li>
<li><p><strong>Peer Device Identity Resolving Key (IRK):</strong> this stores the <a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html#term-IRK"><span class="xref std std-term">IRK</span></a>
generated during pairing. This is a 16-byte array.</p></li>
<li><p><strong>Peer Device Connection Signature Resolving Key (CSRK):</strong>
this stores the <a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html#term-CSRK"><span class="xref std std-term">CSRK</span></a> generated during pairing. This is a 16-byte array.</p></li>
<li><p><strong>Peer Device Sign counter:</strong> this stores the sign counter generated
during pairing. This is a 4-byte word.</p></li>
</ol>
<div class="section" id="increasing-number-of-bonding-entries">
<h3>Increasing Number of Bonding Entries<a class="headerlink" href="#increasing-number-of-bonding-entries" title="Permalink to this headline">¶</a></h3>
<p>The amount of bonds that can be stored is set by the <code class="docutils literal notranslate"><span class="pre">GAP_BONDINGS_MAX</span></code>
definition, which is set to 10 by default in gapbondmgr.h. However, due to the
structure of SNV, if a <code class="docutils literal notranslate"><span class="pre">GAP_BONDINGS_MAX</span></code> value of more than 13 is needed,
then there are some additional required changes to support storage of the larger
number of bonds:</p>
<ol class="arabic">
<li><p>Modify <code class="docutils literal notranslate"><span class="pre">GAP_BONDINGS_MAX</span></code> to the desired maximum number of bonding entries
to store before requiring deletion of old bonds. The value of
<code class="docutils literal notranslate"><span class="pre">GAP_BONDINGS_MAX</span></code> should not exceed 32.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If scanning or connection initiation on 2M PHY is used, then the
maximum number of bonds that can be saved in NV is 21.</p>
</div>
</li>
<li><p>In the file <code class="docutils literal notranslate"><span class="pre">bcomdef.h</span></code>, modify the start and end ranges of Bonding NV
Items, GATT Configuration NV Items, and Customer NV Items. This is done by
modifying BLE_NVID_GAP_BOND_END, BLE_NVID_GATT_CFG_START,
BLE_NVID_GATT_CFG_END, BLE_NVID_CUST_START, and BLE_NVID_CUST_END. The
modifications must follow these rules:</p>
<ul class="simple">
<li><p><strong>For GAP:</strong> (BLE_NVID_GAP_BOND_END - BLE_NVID_GAP_BOND_START) &gt;=
GAP_BONDINGS_MAX*6</p></li>
<li><p><strong>For GATT:</strong> (BLE_NVID_GATT_CFG_END - BLE_NVID_GATT_CFG_START) &gt;=
GAP_BONDINGS_MAX.</p></li>
<li><p>No overlap can exist between any of the ranges.</p></li>
<li><p>All indexes are 1 Byte values and so should not exceed 0xFF or 255.</p></li>
</ul>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Any change in the bonding configuration, such as increasing the max number of
bonding entries, must be followed by a full erase of the NV. Since there is
no API in the stack for doing this, the erase must be performed using a
programming tool such as CCS or Uniflash.</p>
</div>
</div>
</div>
<div class="section" id="gapbondmgr-and-service-change-indication">
<h2>GAPBondMgr and Service Change Indication<a class="headerlink" href="#gapbondmgr-and-service-change-indication" title="Permalink to this headline">¶</a></h2>
<div class="section" id="background">
<h3>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h3>
<p>Commonly used mobile phones implement Attribute Caching. As its name
suggests, this mechanism allows the GATT client - i.e. the phone - to
cache the attribute handles. Upon consecutive connections with paired and
bonded devices, the cached attribute handles are used instead of
rediscovering the whole GATT table. This saves time and energy.</p>
<p>However, if the GATT server changes the attributes handles
- typically after a firmware update through an OAD - the cached GATT table
is not correct anymore. This may lead the phone to not be aware of certain
services or attributes. This inconsistency can lead to issues with your
application as the old attribute handles may point to different attributes.</p>
<p>The solution consists in leveraging the standard Generic Attribute Service,
especially the characteristic called Service Changed. Through this service,
the client is made aware of the GATT table changes and can rediscover it.</p>
</div>
<div class="section" id="send-service-change-indications">
<h3>Send Service Change Indications<a class="headerlink" href="#send-service-change-indications" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Add the predefines: <code class="docutils literal notranslate"><span class="pre">GAP_BOND_MGR</span></code> and <code class="docutils literal notranslate"><span class="pre">DV41_FEATURES=L2CAP_COC_CFG</span></code> in
<code class="docutils literal notranslate"><span class="pre">Project</span></code> → <code class="docutils literal notranslate"><span class="pre">Proporties</span></code> → <code class="docutils literal notranslate"><span class="pre">Arm</span> <span class="pre">Compiler</span></code> → <code class="docutils literal notranslate"><span class="pre">Predefined</span> <span class="pre">Symbols</span></code>.</p></li>
<li><p>Use function GAPBondMgr_ServiceChangeInd() as following</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="nl">GAP_LINK_ESTABLISHED_EVENT</span><span class="p">:</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">gapEstLinkReqEvent_t</span><span class="w"> </span><span class="o">*</span><span class="n">pPkt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gapEstLinkReqEvent_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Display the amount of current connections</span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">numActive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linkDB_NumActive</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pPkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Add connection to list and start RSSI</span>
<span class="w">    </span><span class="n">UserApp_addConn</span><span class="p">(</span><span class="n">pPkt</span><span class="o">-&gt;</span><span class="n">connectionHandle</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">GAPBondMgr_ServiceChangeInd</span><span class="p">(</span><span class="n">pPkt</span><span class="o">-&gt;</span><span class="n">connectionHandle</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The code snippet presented sends a service change indication every time a
connection is established. This is not required nor recommended.
Instead, a flag could be set in NV memory to track whether GATT table has
changed since last boot. That way, a service change indication could be
sent only when required.</p>
</div>
</div>
</div>
<div class="section" id="pairing-and-encryption-without-gapbondmgr">
<span id="id7"></span><h2>Pairing and Encryption without GAPBondMgr<a class="headerlink" href="#pairing-and-encryption-without-gapbondmgr" title="Permalink to this headline">¶</a></h2>
<p>Even though GAPBondMgr can offload most of the Pairing &amp;
Bonding mechanisms from the application, the start of pairing process
will be controlled by the BLE5-Stack. For applications that want to control
the start of the pairing process, the following modification will be needed.</p>
<ol class="arabic">
<li><p><strong>Set GAPBOND_PAIRING_MODE to GAPBOND_PAIRING_MODE_WAIT_FOR_REQ</strong>: This
can be acheived by either using SysConfig tool or add the following
to application.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pairMode</span><span class="w">                </span><span class="o">=</span><span class="w">    </span><span class="n">GAPBOND_PAIRING_MODE_WAIT_FOR_REQ</span><span class="p">;</span><span class="w"></span>
<span class="n">GAPBondMgr_SetParameter</span><span class="p">(</span><span class="n">GAPBOND_PAIRING_MODE</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pairMode</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>After connection has been established, the application must invoke the API <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#gac3dd9a10f8873d7f6b7685d69f80ae73">GAPBondMgr_FindAddr()</a>
to figure out whether the connected devices has been paired and bonded or not.</p></li>
<li><p><strong>If the peer device is not bonded, call</strong> <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#ga15379572e5d31e014e84e5457d4b1633">GAPBondMgr_Pair()</a>: Then the pairing process
will be started.</p></li>
<li><p><strong>If the peer device is already bonded, then application can call</strong> <a class="reference external" href="../../doxygen/ble/html/group___g_a_p_bond_mgr.html#gaff83c663db700153fc3021e226e2854b">gapBondMgrReadBondRec()</a>
to extract the bonding information. Refer to <a class="reference internal" href="#extract-bonding-information"><span class="std std-ref">Extract Bonding Information</span></a> for
more information.</p></li>
<li><p><strong>Once the bonding information is available, call</strong> <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#ga7adc8363162be8c0e8777fbed5322b91">HCI_LE_StartEncyptCmd()</a> to start
the encryption process.</p></li>
</ol>
<div class="figure align-center" id="id34">
<span id="no-gapbondmgr-example"></span><p class="plantuml">
<img src="../_images/plantuml-c44f440b64d24c7519e7f1dff2d554d79018fe52.png" alt=" &#64;startuml

  participant cen as &quot;Central&quot;
  participant per as &quot;Peripheral&quot;

  cen --&gt; per : Send connection indication packet
    ...
    ... Connection established ...
    ...
  cen -&gt; cen : Use GAPBondMgr_FindAddr to figure out\nwhether the peer device is paired and bonded.

  group if (GAPBondMgr_FindAddr() == SUCCESS)
    ...
    ... It means this peer device is already paired and bonded ...
    ...
    cen -&gt; cen : Use gapBondMgrReadBondRec to\nextract bond recode
    rnote over cen
      When the bonding information is ready
    end note
    cen -&gt; cen : Use HCI_LE_StartEncyptCmd to start encryption\nprocess.

    cen --&gt; per : Encryption req
    per --&gt; cen : Encryption rsp

    ...
    ... Now the central and Peripheral has an encrypted link \nwithout going through pairing process again...
    ...
  end

  group if (GAPBondMgr_FindAddr() 1= SUCCESS)
    ...
    ... It means this peer device is not bonded ...
    ...

    cen -&gt; cen : Use GAPBondMgr_Pair to start pairing process.
    cen --&gt; per : Pairing Req
    per --&gt; cen : Pairing Rsp

    cen --&gt; per : Encryption req
    per --&gt; cen : Encryption rsp

    ...
    ... Now the central and Peripheral has an encrypted link ...
    ...
  end

&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 91. </span><span class="caption-text">Pairing and Encryption Example Without Using GAPBondMgr.</span><a class="headerlink" href="#id34" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="gatt.html" class="btn btn-neutral float-left" title="Generic Attribute Profile (GATT)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="privacy.html" class="btn btn-neutral float-right" title="Privacy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2010-2022, Texas Instruments.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>