<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Optimizing Bluetooth Low Energy Stack Memory Usage &mdash; 
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User&#39;s Guide
 2.02.08.01 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Coexistence" href="../coexistence/coexistence.html" />
    <link rel="prev" title="Clock accuracies and Bluetooth LE" href="custom-hardware-cc13xx_cc26xx-ble.html" />
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug ble-stack-5.x optimization-cc13xx_cc26xx";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html" class="icon icon-home"> 
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User's Guide

          </a>
              <div class="version">
                2.02.08.01
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/disclaimer.html">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/quickstart-intro-cc13xx_cc26xx.html">Introduction to the SimpleLink CC13xx/CC26xx SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/ble5-quick-start.html">TI BLE5-Stack Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/platform-cc13xx_cc26xx.html">The CC13xx or CC26xx SDK Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/tirtos-index-cc13xx_cc26xx.html">TI-RTOS7 (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/freertos-index.html">FreeRTOS (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble-stack-5-index-cc13xx_cc26xx.html">BLE5-Stack</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html">Developing a Bluetooth LE Application</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html#application-layer">Application Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html#memory-management">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html#compiler-and-linker-options">Compiler and Linker Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html#production-test-mode-and-direct-test-mode">Production Test Mode and Direct Test Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html#bluetooth-le-network-processor">Bluetooth LE Network Processor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html#running-the-sdk-on-custom-hardware">Running the SDK on Custom Hardware</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html#optimizing-memory-usage">Optimizing Memory Usage</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Optimizing Bluetooth Low Energy Stack Memory Usage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#flash-optimization">Flash optimization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ram-optimization">RAM optimization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#decrease-flash-consumption-of-the-examples-project">Decrease flash consumption of the examples project</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../coexistence/coexistence.html">Coexistence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/localization-index-cc13xx_cc26xx.html">RTLS Toolbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-mesh/index.html">Bluetooth Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/u-stack-index-cc13xx_cc26xx.html">Micro BLE Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sensor-controller/sensor-controller.html">Sensor Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/debugging-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/memory-index.html">Memory Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-common/npi-index.html">Network Processor Interface (NPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble5-oad-index-cc13xx_cc26xx.html">TI Over-the-Air Download (OAD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble5-oad-index-mcuboot.html">MCUBoot Over-the-Air Download (OAD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security-tfm/index.html">Security Features of CC13x4 and CC26x4 Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/sysconfig-index-cc13xx_cc26xx.html">System Configuration Tool (SysConfig)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/migration-cc13xx_cc26xx.html">Porting Guide and Migration Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13xx_cc26xx.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html">Terms and Definitions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html">
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User's Guide
</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html">Developing a Bluetooth LE Application</a> &raquo;</li>
      <li>Optimizing Bluetooth Low Energy Stack Memory Usage</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="optimizing-bluetooth-low-energy-stack-memory-usage">
<span id="optimizing-ble-memory-usage"></span><h1>Optimizing Bluetooth Low Energy Stack Memory Usage<a class="headerlink" href="#optimizing-bluetooth-low-energy-stack-memory-usage" title="Permalink to this headline">¶</a></h1>
<p>Configuration of the Bluetooth Low Energy protocol stack is
essential for maximizing the amount of RAM and flash memory
available for the application. Refer to <a class="reference internal" href="stack-configuration-cc13xx_cc26xx.html#stack-features-configuration"><span class="std std-ref">Stack Configurations</span></a>
to configure parameters that impact runtime RAM usage, such as the maximum
allowable size and number of PDUs. The TI Bluetooth Low Energy
protocol stack is implemented to use a small RAM footprint, and
allow the application to control the behavior of the stack by using
the runtime ICall heap. For example, an application that only sends
one GATT notification per connection event must store only one PDU
in the heap, whereas as an application that must send multiple
notifications must enqueue multiple PDUs in the heap.</p>
<p>To increase the available flash memory allocated to the application
project, minimize the flash usage of the protocol stack by including
only Bluetooth Low Energy features required to implement the defined
role of the device. The available protocol stack configurable
features are described in <a class="reference internal" href="stack-configuration-cc13xx_cc26xx.html#stack-features-configuration"><span class="std std-ref">Stack Configurations</span></a>.
Adding additional features to the protocol stack has the net effect
of reducing the amount of flash memory to the application.</p>
<div class="section" id="flash-optimization">
<h2>Flash optimization<a class="headerlink" href="#flash-optimization" title="Permalink to this headline">¶</a></h2>
<p>The following tips may be useful for reducing the footprint of the BLE5-Stack.
In general, there is a feature vs. flash footprint trade-off. Each of the
improvements below offer a cost in terms of feature removal.</p>
<ul class="simple">
<li><p>Verify that your application uses the <em>optimize for flash size</em> compiler
optimization settings (default for TI projects).</p></li>
<li><p>Use only one page of SNV.</p></li>
<li><p>Remove or exclude debug DISPLAY, Two button menu or other unused drivers from
your project.</p></li>
<li><p>Use the stack library options defined in <code class="docutils literal notranslate"><span class="pre">build_config.opt</span></code> to pull in
the smallest part possible of the library for the given use case. In general,
this means a library that implements only one role (e.g. peripheral) with no
additional features enabled (i.e. L2CAP CoC). See
<a class="reference internal" href="stack-configuration-cc13xx_cc26xx.html#stack-features-configuration"><span class="std std-ref">Stack Configurations</span></a>.</p></li>
<li><p>Remove HAL Asserts by removing the <code class="docutils literal notranslate"><span class="pre">EXT_HAL_ASSERT</span></code> define</p></li>
</ul>
</div>
<div class="section" id="ram-optimization">
<h2>RAM optimization<a class="headerlink" href="#ram-optimization" title="Permalink to this headline">¶</a></h2>
<p>The following tips may be useful for reducing the RAM footprint of the BLE5-Stack.
It is important to remember that often removing RAM results in reduced
throughput or features, the tradeoffs listed below should be evaluated
carefully.</p>
<ul>
<li><p>If using L2CAP CoC, reference <a class="reference internal" href="../ble-stack-common/l2cap.html#l2cap-ram"><span class="std std-ref">RAM Considerations</span></a> for defines that may configure
L2CAP CoC functionality and their RAM implications</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">MAX_NUM_PDU</span></code> and <code class="docutils literal notranslate"><span class="pre">MAX_PDU_SIZE</span></code> to reduce the amount of packets
that can be queued up by the stack at a time. This will reduce heap
consumption.</p></li>
<li><p>Disable LE Secure Connections pairing if not needed. See <a class="reference internal" href="gapbondmngr-cc13xx_cc26xx.html#lesc-intro"><span class="std std-ref">LE Secure Connections</span></a>
on how to do this. This will save
<code class="docutils literal notranslate"><span class="pre">ECCROMCC26XX_NIST_P256_WORKZONE_LEN_IN_BYTES</span></code> during pairing.
Removing LESC also removes the requirement of having <code class="docutils literal notranslate"><span class="pre">MAX_PDU_SIZE</span></code> set to
69, this can be overriden in <code class="docutils literal notranslate"><span class="pre">ble_user_config.h</span></code> to as low as 27.</p></li>
<li><p>The LE Data Length Extension feature will default to an RX size of 251.
If the peer device also supports DLE and a <code class="docutils literal notranslate"><span class="pre">connMaxRxOctets</span></code> value is
negotiated &gt; 27 (default) then the controller will allocate
connMaxRxOctets*4. 4 is the number of receive buffers in the
controller and is a fixed parameter of the stack. However, connMaxRxOctets
can be limited by either disabling Data Length Extension or limiting the
max of TX and RX octets. Trimming the values of TX and RX is covered in
<a class="reference internal" href="../ble-stack-common/link-layer-cc13xx_cc26xx.html#sec-ram-considerations-dle"><span class="std std-ref">RAM Considerations when using DLE</span></a>.</p></li>
<li><p>Carefully set <code class="docutils literal notranslate"><span class="pre">MAX_NUM_BLE_CONNS</span></code>. This define has a large affect on the
amount of dynamic memory used by the stack. Below is a list of structures
that the stack will alloc on initialization based on number of Connections.
Each structure is multiplied by <code class="docutils literal notranslate"><span class="pre">MAX_NUM_BLE_CONNS</span></code>.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sizeof(linkDBItem_t)</span></code> : Link data base entry for each connection</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sizeof(</span> <span class="pre">l2capChannel_t</span> <span class="pre">)</span></code> : At least one signaling channel for each connection</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sizeOfLlConnState</span></code> : Structure to hold connection state</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sizeOfAllExtConnParam</span></code>: Structure to hold connection parameters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sizeof(dataQ_t)</span></code> : Each connection’s TX data queue</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">linkParam_t</span></code> : Central and Peripheral parameters for each connection</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">llCte_t</span></code> : CTE for each connection if RTLS is used</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ble5OpCmd_t</span></code> : Radio operation command for connection</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Check for heap failures by checking <code class="docutils literal notranslate"><span class="pre">heapmgrMemFail</span></code> from
<a class="reference internal" href="../ble-stack-5.x-guide/debugging-index.html#sec-heap-debugging"><span class="std std-ref">Debugging Common Heap Issues</span></a>. If heap failures are occurring, attempt to tune
stack build configuration using the features and defines above.
See <a class="reference internal" href="stack-configuration-cc13xx_cc26xx.html#stack-features-configuration"><span class="std std-ref">Stack Configurations</span></a> for options that can be configured
in the stack.</p></li>
<li><p>If heap failures still  occur after optimizing the BLE-Stack build,
the size of the heap can be increased by reducing the size of static
allocation. Static allocation (.bss, .data) includes globally defined
buffers, runtime task stacks, and other structures that are instantiated
without the use of malloc.</p>
<blockquote>
<div><ul class="simple">
<li><p>Trim task stack sizes by inspecting them using Task –&gt; Detailed view in
<a class="reference internal" href="../ble-stack-5.x-guide/debugging-index.html#sec-rov"><span class="std std-ref">TI-RTOS Object Viewer</span></a>. If there is unused space their size can be decreased.</p></li>
<li><p>The system stack can be reduced in a similar way, its usage is shown
under HWI –&gt; Module view in ROV. Changing the system stack size is
covered in <a class="reference internal" href="../ble-stack-common/ram_allocation-cc13xx_cc26xx.html#sec-memory-management-system-stack"><span class="std std-ref">System Stack</span></a>.</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The above RAM estimations may vary by release, and are not an exhaustive
list. It is intended as a way to allow the developer to profile the RAM
requirements based on the desired settings. The best way to estimate RAM
usage is to measure it in the field using the techniques covered in
<a class="reference internal" href="../ble-stack-5.x-guide/debugging-index.html#sec-heap-debugging"><span class="std std-ref">Debugging Common Heap Issues</span></a></p>
</div>
<p>See <a class="reference internal" href="../ble-stack-5.x-guide/debugging-index.html#development-and-debugging-check-system-flash-and-ram-usage-with-map-file"><span class="std std-ref">Check System Flash and RAM Usage With Map File</span></a> for
the procedure to check the size of the configured protocol stack.</p>
</div>
<div class="section" id="decrease-flash-consumption-of-the-examples-project">
<h2>Decrease flash consumption of the examples project<a class="headerlink" href="#decrease-flash-consumption-of-the-examples-project" title="Permalink to this headline">¶</a></h2>
<p>The guidelines provided here are based on the simple_peripheral example
but can be adapted to any example.</p>
<div class="section" id="remove-the-two-buttons-menu-and-display">
<h3>Remove the two buttons menu and display<a class="headerlink" href="#remove-the-two-buttons-menu-and-display" title="Permalink to this headline">¶</a></h3>
<p>By removing the two_btn_menu and the display from your project,
you can significantly increase the remaining memory available
on the device. The guidelines are provided for the simple_peripheral
project but this is possible for all examples that use TBM and display.</p>
<p>Here are the guidelines:</p>
<ol class="arabic">
<li><p>Import the simple_peripheral project</p></li>
<li><p>Change the IO Capabilities (used for pairing/bonding) of your device.
Using SysConfig, go to <code class="docutils literal notranslate"><span class="pre">BLE</span></code> &gt; <code class="docutils literal notranslate"><span class="pre">Bond</span> <span class="pre">Manager</span></code> &gt; <code class="docutils literal notranslate"><span class="pre">IO</span> <span class="pre">Capabilities</span></code>.
Change <code class="docutils literal notranslate"><span class="pre">IO</span> <span class="pre">Capabilities</span></code> in <em>No Display or Input Device</em></p>
<div class="figure align-center" id="id2">
<span id="fig-sysconfig-change-ble-io-capabilities-png"></span><img alt="../_images/SysConfig_Change_BLE_IO_capabilities.png" src="../_images/SysConfig_Change_BLE_IO_capabilities.png" />
<p class="caption"><span class="caption-number">Figure 121. </span><span class="caption-text">Change the IO capabilities of your device</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
</li>
<li><p>Modify <code class="docutils literal notranslate"><span class="pre">main.c</span></code>, <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code> and <code class="docutils literal notranslate"><span class="pre">simple_peripheral.h</span></code>
in order to not use the tbm (<em>two buttons menu</em>) and the display:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">main.c</span></code></p>
<ul>
<li><p>remove the #include of <code class="docutils literal notranslate"><span class="pre">Display.h</span></code></p></li>
<li><p>remove the (extern) declaration of <code class="docutils literal notranslate"><span class="pre">dispHandle</span></code></p></li>
<li><p>modify the <code class="docutils literal notranslate"><span class="pre">AssertHandler()</span></code> function in order to only spinlock</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code></p>
<ul>
<li><p>remove the #include of <code class="docutils literal notranslate"><span class="pre">Display.h</span></code>, <code class="docutils literal notranslate"><span class="pre">board_key.h</span></code>,
<code class="docutils literal notranslate"><span class="pre">two_btn_menu.h</span></code>, <code class="docutils literal notranslate"><span class="pre">simple_peripheral_menu.h</span></code></p></li>
<li><p>remove the declaration of <code class="docutils literal notranslate"><span class="pre">dispHandle</span></code> and all the code
using it (especially the calls to <code class="docutils literal notranslate"><span class="pre">Display_printf()</span></code>,
<code class="docutils literal notranslate"><span class="pre">Display_clearLine()</span></code> and <code class="docutils literal notranslate"><span class="pre">Display_clearLines()</span></code>)</p></li>
<li><p>remove the functions <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_keyChangeHandler()</span></code>,
<code class="docutils literal notranslate"><span class="pre">SimplePeripheral_handleKeys()</span></code> and
<code class="docutils literal notranslate"><span class="pre">SimplePeripheral_menuSwitchCb()</span></code>. Remove their call too.</p></li>
<li><p>remove all the calls to <code class="docutils literal notranslate"><span class="pre">tbm_initTwoBtnMenu()</span></code>,
<code class="docutils literal notranslate"><span class="pre">tbm_setItemStatus()</span></code>, <code class="docutils literal notranslate"><span class="pre">tbm_goTo()</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">simple_peripheral.h</span></code></p>
<ul>
<li><p>remove the declaration of the functions
<code class="docutils literal notranslate"><span class="pre">SimplePeripheral_doSelectConn()</span></code>,
<code class="docutils literal notranslate"><span class="pre">SimplePeripheral_doAutoConnect()</span></code> and
<code class="docutils literal notranslate"><span class="pre">SimplePeripheral_doSetConnPhy()</span></code></p></li>
</ul>
</li>
</ul>
<div class="toggle docutils container">
<div class="header docutils container">
<p>Here are the diff files (based on SDK 4.10), click the arrow
to see all the changes:</p>
</div>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">main.c</span></code></p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">index e8fb465..0616489 100644</span>
<span class="gu">@@ -73,8 +73,6 @@</span>
 icall_userCfg_t user0Cfg = BLE_USER_CFG;
 #endif // USE_DEFAULT_USER_CFG
 
<span class="gd">-#include &lt;ti/display/Display.h&gt;</span>
<span class="gd">-</span>
 /*******************************************************************************
  * MACROS
  */
<span class="gu">@@ -101,8 +99,6 @@ icall_userCfg_t user0Cfg = BLE_USER_CFG;</span>
 
 extern void AssertHandler(uint8 assertCause, uint8 assertSubcause);
 
<span class="gd">-extern Display_Handle dispHandle;</span>
<span class="gd">-</span>
 /*******************************************************************************
  * @fn          Main
  *
<span class="gu">@@ -199,60 +195,7 @@ int main()</span>
  */
 void AssertHandler(uint8 assertCause, uint8 assertSubcause)
 {
<span class="gd">-  // Open the display if the app has not already done so</span>
<span class="gd">-  if ( !dispHandle )</span>
<span class="gd">-  {</span>
<span class="gd">-    dispHandle = Display_open(Display_Type_ANY, NULL);</span>
<span class="gd">-  }</span>
<span class="gd">-</span>
<span class="gd">-  Display_print0(dispHandle, 0, 0, &quot;&gt;&gt;&gt;STACK ASSERT&quot;);</span>
<span class="gd">-</span>
<span class="gd">-  // check the assert cause</span>
<span class="gd">-  switch (assertCause)</span>
<span class="gd">-  {</span>
<span class="gd">-    case HAL_ASSERT_CAUSE_OUT_OF_MEMORY:</span>
<span class="gd">-      Display_print0(dispHandle, 0, 0, &quot;***ERROR***&quot;);</span>
<span class="gd">-      Display_print0(dispHandle, 2, 0, &quot;&gt;&gt; OUT OF MEMORY!&quot;);</span>
<span class="gd">-      break;</span>
<span class="gd">-</span>
<span class="gd">-    case HAL_ASSERT_CAUSE_INTERNAL_ERROR:</span>
<span class="gd">-      // check the subcause</span>
<span class="gd">-      if (assertSubcause == HAL_ASSERT_SUBCAUSE_FW_INERNAL_ERROR)</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_print0(dispHandle, 0, 0, &quot;***ERROR***&quot;);</span>
<span class="gd">-        Display_print0(dispHandle, 2, 0, &quot;&gt;&gt; INTERNAL FW ERROR!&quot;);</span>
<span class="gd">-      }</span>
<span class="gd">-      else</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_print0(dispHandle, 0, 0, &quot;***ERROR***&quot;);</span>
<span class="gd">-        Display_print0(dispHandle, 2, 0, &quot;&gt;&gt; INTERNAL ERROR!&quot;);</span>
<span class="gd">-      }</span>
<span class="gd">-      break;</span>
<span class="gd">-</span>
<span class="gd">-    case HAL_ASSERT_CAUSE_ICALL_ABORT:</span>
<span class="gd">-      Display_print0(dispHandle, 0, 0, &quot;***ERROR***&quot;);</span>
<span class="gd">-      Display_print0(dispHandle, 2, 0, &quot;&gt;&gt; ICALL ABORT!&quot;);</span>
<span class="gd">-      HAL_ASSERT_SPINLOCK;</span>
<span class="gd">-      break;</span>
<span class="gd">-</span>
<span class="gd">-    case HAL_ASSERT_CAUSE_ICALL_TIMEOUT:</span>
<span class="gd">-      Display_print0(dispHandle, 0, 0, &quot;***ERROR***&quot;);</span>
<span class="gd">-      Display_print0(dispHandle, 2, 0, &quot;&gt;&gt; ICALL TIMEOUT!&quot;);</span>
<span class="gd">-      HAL_ASSERT_SPINLOCK;</span>
<span class="gd">-      break;</span>
<span class="gd">-</span>
<span class="gd">-    case HAL_ASSERT_CAUSE_WRONG_API_CALL:</span>
<span class="gd">-      Display_print0(dispHandle, 0, 0, &quot;***ERROR***&quot;);</span>
<span class="gd">-      Display_print0(dispHandle, 2, 0, &quot;&gt;&gt; WRONG API CALL!&quot;);</span>
<span class="gd">-      HAL_ASSERT_SPINLOCK;</span>
<span class="gd">-      break;</span>
<span class="gd">-</span>
<span class="gd">-  default:</span>
<span class="gd">-      Display_print0(dispHandle, 0, 0, &quot;***ERROR***&quot;);</span>
<span class="gd">-      Display_print0(dispHandle, 2, 0, &quot;&gt;&gt; DEFAULT SPINLOCK!&quot;);</span>
<span class="gd">-      HAL_ASSERT_SPINLOCK;</span>
<span class="gd">-  }</span>
<span class="gd">-</span>
<span class="gi">+  HAL_ASSERT_SPINLOCK;</span>
   return;
 }
 
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code></p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">index b0af31a..db7c16c 100644</span>
<span class="gu">@@ -55,8 +55,6 @@</span>
 #include &lt;ti/sysbios/knl/Event.h&gt;
 #include &lt;ti/sysbios/knl/Queue.h&gt;
 
<span class="gd">-#include &lt;ti/display/Display.h&gt;</span>
<span class="gd">-</span>
 #if !(defined __TI_COMPILER_VERSION__)
 #include &lt;intrinsics.h&gt;
 #endif
<span class="gu">@@ -77,11 +75,7 @@</span>
 #endif //USE_RCOSC
 
 #include &lt;ti_drivers_config.h&gt;
<span class="gd">-#include &lt;board_key.h&gt;</span>
<span class="gd">-</span>
<span class="gd">-#include &lt;menu/two_btn_menu.h&gt;</span>
 
<span class="gd">-#include &quot;simple_peripheral_menu.h&quot;</span>
 #include &quot;simple_peripheral.h&quot;
 #include &quot;ti_ble_config.h&quot;
 
<span class="gu">@@ -132,18 +126,6 @@</span>
 // Size of string-converted device address (&quot;0xXXXXXXXXXXXX&quot;)
 #define SP_ADDR_STR_SIZE     15
 
<span class="gd">-// Row numbers for two-button menu</span>
<span class="gd">-#define SP_ROW_SEPARATOR_1   (TBM_ROW_APP + 0)</span>
<span class="gd">-#define SP_ROW_STATUS_1      (TBM_ROW_APP + 1)</span>
<span class="gd">-#define SP_ROW_STATUS_2      (TBM_ROW_APP + 2)</span>
<span class="gd">-#define SP_ROW_CONNECTION    (TBM_ROW_APP + 3)</span>
<span class="gd">-#define SP_ROW_ADVSTATE      (TBM_ROW_APP + 4)</span>
<span class="gd">-#define SP_ROW_RSSI          (TBM_ROW_APP + 5)</span>
<span class="gd">-#define SP_ROW_IDA           (TBM_ROW_APP + 6)</span>
<span class="gd">-#define SP_ROW_RPA           (TBM_ROW_APP + 7)</span>
<span class="gd">-#define SP_ROW_DEBUG         (TBM_ROW_APP + 8)</span>
<span class="gd">-#define SP_ROW_AC            (TBM_ROW_APP + 9)</span>
<span class="gd">-</span>
 // For storing the active connections
 #define SP_RSSI_TRACK_CHNLS        1            // Max possible channels can be GAP_BONDINGS_MAX
 #define SP_MAX_RSSI_STORE_DEPTH    5
<span class="gu">@@ -245,9 +227,6 @@ typedef struct</span>
  * GLOBAL VARIABLES
  */
 
<span class="gd">-// Display Interface</span>
<span class="gd">-Display_Handle dispHandle = NULL;</span>
<span class="gd">-</span>
 // Task configuration
 Task_Struct spTask;
 #if defined __TI_COMPILER_VERSION__
<span class="gu">@@ -351,8 +330,6 @@ static void SimplePeripheral_processPairState(spPairStateData_t *pPairState);</span>
 static void SimplePeripheral_processPasscode(spPasscodeData_t *pPasscodeData);
 static void SimplePeripheral_charValueChangeCB(uint8_t paramId);
 static status_t SimplePeripheral_enqueueMsg(uint8_t event, void *pData);
<span class="gd">-static void SimplePeripheral_keyChangeHandler(uint8 keys);</span>
<span class="gd">-static void SimplePeripheral_handleKeys(uint8_t keys);</span>
 static void SimplePeripheral_processCmdCompleteEvt(hciEvt_CmdComplete_t *pMsg);
 static void SimplePeripheral_initPHYRSSIArray(void);
 static void SimplePeripheral_updatePHYStat(uint16_t eventCode, uint8_t *pMsg);
<span class="gu">@@ -366,8 +343,6 @@ static status_t SimplePeripheral_setPhy(uint16_t connHandle, uint8_t allPhys,</span>
                                         uint8_t txPhy, uint8_t rxPhy,
                                         uint16_t phyOpts);
 static uint8_t SimplePeripheral_clearConnListEntry(uint16_t connHandle);
<span class="gd">-static void SimplePeripheral_menuSwitchCb(tbmMenuObj_t* pMenuObjCurr,</span>
<span class="gd">-                                          tbmMenuObj_t* pMenuObjNext);</span>
 static void SimplePeripheral_connEvtCB(Gap_ConnEventRpt_t *pReport);
 static void SimplePeripheral_processConnEvt(Gap_ConnEventRpt_t *pReport);
 #ifdef PTM_MODE
<span class="gu">@@ -499,10 +474,6 @@ void SimplePeripheral_createTask(void)</span>
  */
 static void SimplePeripheral_init(void)
 {
<span class="gd">-  BLE_LOG_INT_TIME(0, BLE_LOG_MODULE_APP, &quot;APP : ---- init &quot;, SP_TASK_PRIORITY);</span>
<span class="gd">-  // Create the menu</span>
<span class="gd">-  SimplePeripheral_buildMenu();</span>
<span class="gd">-</span>
   // ******************************************************************
   // N0 STACK API CALLS CAN OCCUR BEFORE THIS CALL TO ICall_registerApp
   // ******************************************************************
<span class="gu">@@ -601,9 +572,6 @@ static void SimplePeripheral_init(void)</span>
   // Initialize GATT Client
   GATT_InitClient();
 
<span class="gd">-  // Init key debouncer</span>
<span class="gd">-  Board_initKeys(SimplePeripheral_keyChangeHandler);</span>
<span class="gd">-</span>
   // Initialize Connection List
   SimplePeripheral_clearConnListEntry(LINKDB_CONNHANDLE_ALL);
 
<span class="gu">@@ -614,17 +582,6 @@ static void SimplePeripheral_init(void)</span>
   // Initialize array to store connection handle and RSSI values
   SimplePeripheral_initPHYRSSIArray();
 
<span class="gd">-  // The type of display is configured based on the BOARD_DISPLAY_USE...</span>
<span class="gd">-  // preprocessor definitions</span>
<span class="gd">-  dispHandle = Display_open(Display_Type_ANY, NULL);</span>
<span class="gd">-</span>
<span class="gd">-  // Initialize Two-Button Menu module</span>
<span class="gd">-  TBM_SET_TITLE(&amp;spMenuMain, &quot;Simple Peripheral&quot;);</span>
<span class="gd">-  tbm_setItemStatus(&amp;spMenuMain, TBM_ITEM_NONE, TBM_ITEM_ALL);</span>
<span class="gd">-</span>
<span class="gd">-  tbm_initTwoBtnMenu(dispHandle, &amp;spMenuMain, 5, SimplePeripheral_menuSwitchCb);</span>
<span class="gd">-  Display_printf(dispHandle, SP_ROW_SEPARATOR_1, 0, &quot;====================&quot;);</span>
<span class="gd">-</span>
 #ifdef PTM_MODE
   // Intercept NPI RX events.
   NPITask_registerIncomingRXEventAppCB(simple_peripheral_handleNPIRxInterceptEvent, INTERCEPT);
<span class="gu">@@ -764,17 +721,6 @@ static uint8_t SimplePeripheral_processStackMsg(ICall_Hdr *pMsg)</span>
           {
             case HCI_LE_SET_PHY:
             {
<span class="gd">-              if (pMyMsg-&gt;cmdStatus == HCI_ERROR_CODE_UNSUPPORTED_REMOTE_FEATURE)</span>
<span class="gd">-              {</span>
<span class="gd">-                Display_printf(dispHandle, SP_ROW_STATUS_1, 0,</span>
<span class="gd">-                        &quot;PHY Change failure, peer does not support this&quot;);</span>
<span class="gd">-              }</span>
<span class="gd">-              else</span>
<span class="gd">-              {</span>
<span class="gd">-                Display_printf(dispHandle, SP_ROW_STATUS_1, 0,</span>
<span class="gd">-                               &quot;PHY Update Status Event: 0x%x&quot;,</span>
<span class="gd">-                               pMyMsg-&gt;cmdStatus);</span>
<span class="gd">-              }</span>
 
               SimplePeripheral_updatePHYStat(HCI_LE_SET_PHY, (uint8_t *)pMsg);
               break;
<span class="gu">@@ -795,22 +741,6 @@ static uint8_t SimplePeripheral_processStackMsg(ICall_Hdr *pMsg)</span>
           // A Phy Update Has Completed or Failed
           if (pPUC-&gt;BLEEventCode == HCI_BLE_PHY_UPDATE_COMPLETE_EVENT)
           {
<span class="gd">-            if (pPUC-&gt;status != SUCCESS)</span>
<span class="gd">-            {</span>
<span class="gd">-              Display_printf(dispHandle, SP_ROW_STATUS_1, 0,</span>
<span class="gd">-                             &quot;PHY Change failure&quot;);</span>
<span class="gd">-            }</span>
<span class="gd">-            else</span>
<span class="gd">-            {</span>
<span class="gd">-              // Only symmetrical PHY is supported.</span>
<span class="gd">-              // rxPhy should be equal to txPhy.</span>
<span class="gd">-              Display_printf(dispHandle, SP_ROW_STATUS_2, 0,</span>
<span class="gd">-                             &quot;PHY Updated to %s&quot;,</span>
<span class="gd">-                             (pPUC-&gt;rxPhy == PHY_UPDATE_COMPLETE_EVENT_1M) ? &quot;1M&quot; :</span>
<span class="gd">-                             (pPUC-&gt;rxPhy == PHY_UPDATE_COMPLETE_EVENT_2M) ? &quot;2M&quot; :</span>
<span class="gd">-                             (pPUC-&gt;rxPhy == PHY_UPDATE_COMPLETE_EVENT_CODED) ? &quot;CODED&quot; : &quot;Unexpected PHY Value&quot;);</span>
<span class="gd">-            }</span>
<span class="gd">-</span>
             SimplePeripheral_updatePHYStat(HCI_BLE_PHY_UPDATE_COMPLETE_EVENT, (uint8_t *)pMsg);
           }
           break;
<span class="gu">@@ -879,21 +809,6 @@ static uint8_t SimplePeripheral_processStackMsg(ICall_Hdr *pMsg)</span>
  */
 static uint8_t SimplePeripheral_processGATTMsg(gattMsgEvent_t *pMsg)
 {
<span class="gd">-  if (pMsg-&gt;method == ATT_FLOW_CTRL_VIOLATED_EVENT)</span>
<span class="gd">-  {</span>
<span class="gd">-    // ATT request-response or indication-confirmation flow control is</span>
<span class="gd">-    // violated. All subsequent ATT requests or indications will be dropped.</span>
<span class="gd">-    // The app is informed in case it wants to drop the connection.</span>
<span class="gd">-</span>
<span class="gd">-    // Display the opcode of the message that caused the violation.</span>
<span class="gd">-    Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;FC Violated: %d&quot;, pMsg-&gt;msg.flowCtrlEvt.opcode);</span>
<span class="gd">-  }</span>
<span class="gd">-  else if (pMsg-&gt;method == ATT_MTU_UPDATED_EVENT)</span>
<span class="gd">-  {</span>
<span class="gd">-    // MTU size updated</span>
<span class="gd">-    Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;MTU Size: %d&quot;, pMsg-&gt;msg.mtuEvt.MTU);</span>
<span class="gd">-  }</span>
<span class="gd">-</span>
   // Free message payload. Needed only for ATT Protocol messages
   GATT_bm_free(&amp;pMsg-&gt;msg, pMsg-&gt;method);
 
<span class="gu">@@ -930,7 +845,6 @@ static void SimplePeripheral_processAppMsg(spEvt_t *pMsg)</span>
       break;
 
     case SP_KEY_CHANGE_EVT:
<span class="gd">-      SimplePeripheral_handleKeys(*(uint8_t*)(pMsg-&gt;pData));</span>
       break;
 
     case SP_ADV_EVT:
<span class="gu">@@ -1020,8 +934,6 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
         // Set Device Info Service Parameter
         DevInfo_SetParameter(DEVINFO_SYSTEM_ID, DEVINFO_SYSTEM_ID_LEN, systemId);
 
<span class="gd">-        Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;Initialized&quot;);</span>
<span class="gd">-</span>
         BLE_LOG_INT_TIME(0, BLE_LOG_MODULE_APP, &quot;APP : ---- got GAP_DEVICE_INIT_DONE_EVENT&quot;, 0);
         // Setup and start Advertising
         // For more information, see the GAP section in the User&#39;s Guide:
<span class="gu">@@ -1075,11 +987,6 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
         status = GapAdv_enable(advHandleLongRange, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);
         SIMPLEPERIPHERAL_ASSERT(status == SUCCESS);
 
<span class="gd">-        // Display device address</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_IDA, 0, &quot;%s Addr: %s&quot;,</span>
<span class="gd">-                       (addrMode &lt;= ADDRMODE_RANDOM) ? &quot;Dev&quot; : &quot;ID&quot;,</span>
<span class="gd">-                       Util_convertBdAddr2Str(pPkt-&gt;devAddr));</span>
<span class="gd">-</span>
         if (addrMode &gt; ADDRMODE_RANDOM)
         {
           SimplePeripheral_updateRPA();
<span class="gu">@@ -1089,7 +996,6 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
                               READ_RPA_PERIOD, 0, true,
                               (UArg) &amp;argRpaRead);
         }
<span class="gd">-        tbm_setItemStatus(&amp;spMenuMain, SP_ITEM_AUTOCONNECT, TBM_ITEM_NONE);</span>
       }
 
       break;
<span class="gu">@@ -1100,23 +1006,13 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
       gapEstLinkReqEvent_t *pPkt = (gapEstLinkReqEvent_t *)pMsg;
 
       BLE_LOG_INT_TIME(0, BLE_LOG_MODULE_APP, &quot;APP : ---- got GAP_LINK_ESTABLISHED_EVENT&quot;, 0);
<span class="gd">-      // Display the amount of current connections</span>
       uint8_t numActive = linkDB_NumActive();
<span class="gd">-      Display_printf(dispHandle, SP_ROW_STATUS_2, 0, &quot;Num Conns: %d&quot;,</span>
<span class="gd">-                     (uint16_t)numActive);</span>
 
       if (pPkt-&gt;hdr.status == SUCCESS)
       {
         // Add connection to list and start RSSI
         SimplePeripheral_addConn(pPkt-&gt;connectionHandle);
 
<span class="gd">-        // Display the address of this connection</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;Connected to %s&quot;,</span>
<span class="gd">-                       Util_convertBdAddr2Str(pPkt-&gt;devAddr));</span>
<span class="gd">-</span>
<span class="gd">-        // Enable connection selection option</span>
<span class="gd">-        tbm_setItemStatus(&amp;spMenuMain, SP_ITEM_SELECT_CONN,SP_ITEM_AUTOCONNECT);</span>
<span class="gd">-</span>
         // Start Periodic Clock.
         Util_startClock(&amp;clkPeriodic);
       }
<span class="gu">@@ -1139,11 +1035,7 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
     {
       gapTerminateLinkEvent_t *pPkt = (gapTerminateLinkEvent_t *)pMsg;
 
<span class="gd">-      // Display the amount of current connections</span>
       uint8_t numActive = linkDB_NumActive();
<span class="gd">-      Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;Device Disconnected!&quot;);</span>
<span class="gd">-      Display_printf(dispHandle, SP_ROW_STATUS_2, 0, &quot;Num Conns: %d&quot;,</span>
<span class="gd">-                     (uint16_t)numActive);</span>
 
       // Remove the connection from the list and disable RSSI if needed
       SimplePeripheral_removeConn(pPkt-&gt;connectionHandle);
<span class="gu">@@ -1153,9 +1045,6 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
       {
         // Stop periodic clock
         Util_stopClock(&amp;clkPeriodic);
<span class="gd">-</span>
<span class="gd">-        // Disable Connection Selection option</span>
<span class="gd">-        tbm_setItemStatus(&amp;spMenuMain, SP_ITEM_AUTOCONNECT, SP_ITEM_SELECT_CONN);</span>
       }
 
       BLE_LOG_INT_STR(0, BLE_LOG_MODULE_APP, &quot;APP : GAP msg: status=%d, opcode=%s\n&quot;, 0, &quot;GAP_LINK_TERMINATED_EVENT&quot;);
<span class="gu">@@ -1163,9 +1052,6 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
       GapAdv_enable(advHandleLegacy, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);
       GapAdv_enable(advHandleLongRange, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);
 
<span class="gd">-      // Clear remaining lines</span>
<span class="gd">-      Display_clearLine(dispHandle, SP_ROW_CONNECTION);</span>
<span class="gd">-</span>
       break;
     }
 
<span class="gu">@@ -1207,20 +1093,6 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
       linkDBInfo_t linkInfo;
       linkDB_GetInfo(pPkt-&gt;connectionHandle, &amp;linkInfo);
 
<span class="gd">-      if(pPkt-&gt;status == SUCCESS)</span>
<span class="gd">-      {</span>
<span class="gd">-        // Display the address of the connection update</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_STATUS_2, 0, &quot;Link Param Updated: %s&quot;,</span>
<span class="gd">-                       Util_convertBdAddr2Str(linkInfo.addr));</span>
<span class="gd">-      }</span>
<span class="gd">-      else</span>
<span class="gd">-      {</span>
<span class="gd">-        // Display the address of the connection update failure</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_STATUS_2, 0,</span>
<span class="gd">-                       &quot;Link Param Update Failed 0x%x: %s&quot;, pPkt-&gt;opcode,</span>
<span class="gd">-                       Util_convertBdAddr2Str(linkInfo.addr));</span>
<span class="gd">-      }</span>
<span class="gd">-</span>
       // Check if there are any queued parameter updates
       spConnHandleEntry_t *connHandleEntry = (spConnHandleEntry_t *)List_get(&amp;paramUpdateList);
       if (connHandleEntry != NULL)
<span class="gu">@@ -1236,7 +1108,6 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
     }
 
     default:
<span class="gd">-      Display_clearLines(dispHandle, SP_ROW_STATUS_1, SP_ROW_STATUS_2);</span>
       break;
   }
 }
<span class="gu">@@ -1282,14 +1153,10 @@ static void SimplePeripheral_processCharValueChangeEvt(uint8_t paramId)</span>
   {
     case SIMPLEPROFILE_CHAR1:
       SimpleProfile_GetParameter(SIMPLEPROFILE_CHAR1, &amp;newValue);
<span class="gd">-</span>
<span class="gd">-      Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;Char 1: %d&quot;, (uint16_t)newValue);</span>
       break;
 
     case SIMPLEPROFILE_CHAR3:
       SimpleProfile_GetParameter(SIMPLEPROFILE_CHAR3, &amp;newValue);
<span class="gd">-</span>
<span class="gd">-      Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;Char 3: %d&quot;, (uint16_t)newValue);</span>
       break;
 
     default:
<span class="gu">@@ -1330,7 +1197,7 @@ static void SimplePeripheral_performPeriodicTask(void)</span>
 /*********************************************************************
  * @fn      SimplePeripheral_updateRPA
  *
<span class="gd">- * @brief   Read the current RPA from the stack and update display</span>
<span class="gi">+ * @brief   Read the current RPA from the stack</span>
  *          if the RPA has changed.
  *
  * @param   None.
<span class="gu">@@ -1347,8 +1214,6 @@ static void SimplePeripheral_updateRPA(void)</span>
   if (memcmp(pRpaNew, rpa, B_ADDR_LEN))
   {
     // If the RPA has changed, update the display
<span class="gd">-    Display_printf(dispHandle, SP_ROW_RPA, 0, &quot;RP Addr: %s&quot;,</span>
<span class="gd">-                   Util_convertBdAddr2Str(pRpaNew));</span>
     memcpy(rpa, pRpaNew, B_ADDR_LEN);
   }
 }
<span class="gu">@@ -1389,59 +1254,6 @@ static void SimplePeripheral_clockHandler(UArg arg)</span>
  }
 }
 
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimplePeripheral_keyChangeHandler</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Key event handler function</span>
<span class="gd">- *</span>
<span class="gd">- * @param   keys - bitmap of pressed keys</span>
<span class="gd">- *</span>
<span class="gd">- * @return  none</span>
<span class="gd">- */</span>
<span class="gd">-static void SimplePeripheral_keyChangeHandler(uint8_t keys)</span>
<span class="gd">-{</span>
<span class="gd">-  uint8_t *pValue = ICall_malloc(sizeof(uint8_t));</span>
<span class="gd">-</span>
<span class="gd">-  if (pValue)</span>
<span class="gd">-  {</span>
<span class="gd">-    *pValue = keys;</span>
<span class="gd">-</span>
<span class="gd">-    if(SimplePeripheral_enqueueMsg(SP_KEY_CHANGE_EVT, pValue) != SUCCESS)</span>
<span class="gd">-    {</span>
<span class="gd">-      ICall_free(pValue);</span>
<span class="gd">-    }</span>
<span class="gd">-  }</span>
<span class="gd">-}</span>
<span class="gd">-</span>
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimplePeripheral_handleKeys</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Handles all key events for this device.</span>
<span class="gd">- *</span>
<span class="gd">- * @param   keys - bit field for key events. Valid entries:</span>
<span class="gd">- *                 KEY_LEFT</span>
<span class="gd">- *                 KEY_RIGHT</span>
<span class="gd">- */</span>
<span class="gd">-static void SimplePeripheral_handleKeys(uint8_t keys)</span>
<span class="gd">-{</span>
<span class="gd">-  if (keys &amp; KEY_LEFT)</span>
<span class="gd">-  {</span>
<span class="gd">-    // Check if the key is still pressed. Workaround for possible bouncing.</span>
<span class="gd">-    if (PIN_getInputValue(CONFIG_PIN_BTN1) == 0)</span>
<span class="gd">-    {</span>
<span class="gd">-      tbm_buttonLeft();</span>
<span class="gd">-    }</span>
<span class="gd">-  }</span>
<span class="gd">-  else if (keys &amp; KEY_RIGHT)</span>
<span class="gd">-  {</span>
<span class="gd">-    // Check if the key is still pressed. Workaround for possible bouncing.</span>
<span class="gd">-    if (PIN_getInputValue(CONFIG_PIN_BTN2) == 0)</span>
<span class="gd">-    {</span>
<span class="gd">-      tbm_buttonRight();</span>
<span class="gd">-    }</span>
<span class="gd">-  }</span>
<span class="gd">-}</span>
<span class="gd">-</span>
 /*********************************************************************
  * @fn      SimplePeripheral_doSetConnPhy
  *
<span class="gu">@@ -1468,7 +1280,6 @@ bool SimplePeripheral_doSetConnPhy(uint8 index)</span>
   uint8_t connIndex = SimplePeripheral_getConnIndex(menuConnHandle);
   if (connIndex &gt;= MAX_NUM_BLE_CONNS)
   {
<span class="gd">-    Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;Connection handle is not in the connList !!!&quot;);</span>
     return FALSE;
   }
 
<span class="gu">@@ -1483,9 +1294,6 @@ bool SimplePeripheral_doSetConnPhy(uint8 index)</span>
     SimplePeripheral_stopAutoPhyChange(connList[connIndex].connHandle);
 
     SimplePeripheral_setPhy(menuConnHandle, 0, phy[index], phy[index], 0);
<span class="gd">-</span>
<span class="gd">-    Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;PHY preference: %s&quot;,</span>
<span class="gd">-                   TBM_GET_ACTION_DESC(&amp;spMenuConnPhy, index));</span>
   }
   else
   {
<span class="gu">@@ -1531,13 +1339,9 @@ static void SimplePeripheral_processAdvEvent(spGapAdvEventData_t *pEventData)</span>
   {
     case GAP_EVT_ADV_START_AFTER_ENABLE:
       BLE_LOG_INT_TIME(0, BLE_LOG_MODULE_APP, &quot;APP : ---- GAP_EVT_ADV_START_AFTER_ENABLE&quot;, 0);
<span class="gd">-      Display_printf(dispHandle, SP_ROW_ADVSTATE, 0, &quot;Adv Set %d Enabled&quot;,</span>
<span class="gd">-                     *(uint8_t *)(pEventData-&gt;pBuf));</span>
       break;
 
     case GAP_EVT_ADV_END_AFTER_DISABLE:
<span class="gd">-      Display_printf(dispHandle, SP_ROW_ADVSTATE, 0, &quot;Adv Set %d Disabled&quot;,</span>
<span class="gd">-                     *(uint8_t *)(pEventData-&gt;pBuf));</span>
       break;
 
     case GAP_EVT_ADV_START:
<span class="gu">@@ -1547,15 +1351,7 @@ static void SimplePeripheral_processAdvEvent(spGapAdvEventData_t *pEventData)</span>
       break;
 
     case GAP_EVT_ADV_SET_TERMINATED:
<span class="gd">-    {</span>
<span class="gd">-#ifndef Display_DISABLE_ALL</span>
<span class="gd">-      GapAdv_setTerm_t *advSetTerm = (GapAdv_setTerm_t *)(pEventData-&gt;pBuf);</span>
<span class="gd">-</span>
<span class="gd">-      Display_printf(dispHandle, SP_ROW_ADVSTATE, 0, &quot;Adv Set %d disabled after conn %d&quot;,</span>
<span class="gd">-                     advSetTerm-&gt;handle, advSetTerm-&gt;connHandle );</span>
<span class="gd">-#endif</span>
<span class="gd">-    }</span>
<span class="gd">-    break;</span>
<span class="gi">+      break;</span>
 
     case GAP_EVT_SCAN_REQ_RECEIVED:
       break;
<span class="gu">@@ -1645,45 +1441,19 @@ static void SimplePeripheral_passcodeCb(uint8_t *pDeviceAddr,</span>
 static void SimplePeripheral_processPairState(spPairStateData_t *pPairData)
 {
   uint8_t state = pPairData-&gt;state;
<span class="gd">-  uint8_t status = pPairData-&gt;status;</span>
 
   switch (state)
   {
     case GAPBOND_PAIRING_STATE_STARTED:
<span class="gd">-      Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Pairing started&quot;);</span>
       break;
 
     case GAPBOND_PAIRING_STATE_COMPLETE:
<span class="gd">-      if (status == SUCCESS)</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Pairing success&quot;);</span>
<span class="gd">-      }</span>
<span class="gd">-      else</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Pairing fail: %d&quot;, status);</span>
<span class="gd">-      }</span>
       break;
 
     case GAPBOND_PAIRING_STATE_ENCRYPTED:
<span class="gd">-      if (status == SUCCESS)</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Encryption success&quot;);</span>
<span class="gd">-      }</span>
<span class="gd">-      else</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Encryption failed: %d&quot;, status);</span>
<span class="gd">-      }</span>
       break;
 
     case GAPBOND_PAIRING_STATE_BOND_SAVED:
<span class="gd">-      if (status == SUCCESS)</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Bond save success&quot;);</span>
<span class="gd">-      }</span>
<span class="gd">-      else</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Bond save failed: %d&quot;, status);</span>
<span class="gd">-      }</span>
       break;
 
     default:
<span class="gu">@@ -1700,13 +1470,6 @@ static void SimplePeripheral_processPairState(spPairStateData_t *pPairData)</span>
  */
 static void SimplePeripheral_processPasscode(spPasscodeData_t *pPasscodeData)
 {
<span class="gd">-  // Display passcode to user</span>
<span class="gd">-  if (pPasscodeData-&gt;uiOutputs != 0)</span>
<span class="gd">-  {</span>
<span class="gd">-    Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Passcode: %d&quot;,</span>
<span class="gd">-                   B_APP_DEFAULT_PASSCODE);</span>
<span class="gd">-  }</span>
<span class="gd">-</span>
   // Send passcode response
   GAPBondMgr_PasscodeRsp(pPasscodeData-&gt;connHandle , SUCCESS,
                          B_APP_DEFAULT_PASSCODE);
<span class="gu">@@ -1740,12 +1503,6 @@ static void SimplePeripheral_processConnEvt(Gap_ConnEventRpt_t *pReport)</span>
   // Get index from handle
   uint8_t connIndex = SimplePeripheral_getConnIndex(pReport-&gt;handle);
 
<span class="gd">-  if (connIndex &gt;= MAX_NUM_BLE_CONNS)</span>
<span class="gd">-  {</span>
<span class="gd">-    Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;Connection handle is not in the connList !!!&quot;);</span>
<span class="gd">-    return;</span>
<span class="gd">-  }</span>
<span class="gd">-</span>
   // If auto phy change is enabled
   if (connList[connIndex].isAutoPHYEnable == TRUE)
   {
<span class="gu">@@ -1782,29 +1539,6 @@ static status_t SimplePeripheral_enqueueMsg(uint8_t event, void *pData)</span>
   return(bleMemAllocError);
 }
 
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimplePeripheral_doSelectConn</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Select a connection to communicate with</span>
<span class="gd">- *</span>
<span class="gd">- * @param   index - item index from the menu</span>
<span class="gd">- *</span>
<span class="gd">- * @return  always true</span>
<span class="gd">- */</span>
<span class="gd">-bool SimplePeripheral_doSelectConn(uint8_t index)</span>
<span class="gd">-{</span>
<span class="gd">-  menuConnHandle = connList[index].connHandle;</span>
<span class="gd">-</span>
<span class="gd">-  // Set the menu title and go to this connection&#39;s context</span>
<span class="gd">-  TBM_SET_TITLE(&amp;spMenuPerConn, TBM_GET_ACTION_DESC(&amp;spMenuSelectConn, index));</span>
<span class="gd">-</span>
<span class="gd">-  // Clear non-connection-related message</span>
<span class="gd">-  Display_clearLine(dispHandle, SP_ROW_CONNECTION);</span>
<span class="gd">-</span>
<span class="gd">-  tbm_goTo(&amp;spMenuPerConn);</span>
<span class="gd">-</span>
<span class="gd">-  return (true);</span>
<span class="gd">-}</span>
 /*********************************************************************
  * @fn      SimplePeripheral_doAutoConnect
  *
<span class="gu">@@ -1832,7 +1566,6 @@ bool SimplePeripheral_doAutoConnect(uint8_t index)</span>
         GapAdv_enable(advHandleLongRange, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);
         autoConnect = AUTOCONNECT_GROUP_A;
       }	
<span class="gd">-	  Display_printf(dispHandle, SP_ROW_AC, 0, &quot;AutoConnect enabled: Group A&quot;);</span>
     }
     else if (index == 2)
     {
<span class="gu">@@ -1848,7 +1581,6 @@ bool SimplePeripheral_doAutoConnect(uint8_t index)</span>
         GapAdv_enable(advHandleLongRange, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);
         autoConnect = AUTOCONNECT_GROUP_B;
       } 
<span class="gd">-      Display_printf(dispHandle, SP_ROW_AC, 0, &quot;AutoConnect enabled: Group B&quot;);</span>
     }
     else
     {
<span class="gu">@@ -1864,9 +1596,7 @@ bool SimplePeripheral_doAutoConnect(uint8_t index)</span>
         GapAdv_enable(advHandleLongRange, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);
         autoConnect = AUTOCONNECT_DISABLE;
       } 
<span class="gd">-      Display_printf(dispHandle, SP_ROW_AC, 0, &quot;AutoConnect disabled&quot;);</span>
     }
<span class="gd">-    tbm_goTo(&amp;spMenuMain);</span>
     
     return (true);
 }
<span class="gu">@@ -2086,7 +1816,6 @@ static void SimplePeripheral_processParamUpdate(uint16_t connHandle)</span>
   connIndex = SimplePeripheral_getConnIndex(connHandle);
   if (connIndex &gt;= MAX_NUM_BLE_CONNS)
   {
<span class="gd">-    Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;Connection handle is not in the connList !!!&quot;);</span>
     return;
   }
 
<span class="gu">@@ -2146,7 +1875,6 @@ static void SimplePeripheral_processCmdCompleteEvt(hciEvt_CmdComplete_t *pMsg)</span>
         uint8_t index = SimplePeripheral_getConnIndex(handle);
         if (index &gt;= MAX_NUM_BLE_CONNS)
         {
<span class="gd">-          Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;Connection handle is not in the connList !!!&quot;);</span>
           return;
         }
 
<span class="gu">@@ -2234,24 +1962,12 @@ static void SimplePeripheral_processCmdCompleteEvt(hciEvt_CmdComplete_t *pMsg)</span>
           } // end of if (connList[index].phyCngRq == FALSE)
         } // end of if (rssi != LL_RSSI_NOT_AVAILABLE)
 
<span class="gd">-        Display_printf(dispHandle, SP_ROW_RSSI, 0,</span>
<span class="gd">-                       &quot;RSSI:%d dBm, AVG RSSI:%d dBm&quot;,</span>
<span class="gd">-                       (uint32_t)(rssi),</span>
<span class="gd">-                       connList[index].rssiAvg);</span>
<span class="gd">-</span>
<span class="gd">-	  } // end of if (status == SUCCESS)</span>
<span class="gi">+      } // end of if (status == SUCCESS)</span>
       break;
     }
 
     case HCI_LE_READ_PHY:
<span class="gd">-    {</span>
<span class="gd">-      if (status == SUCCESS)</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_RSSI + 2, 0, &quot;RXPh: %d, TXPh: %d&quot;,</span>
<span class="gd">-                       pMsg-&gt;pReturnParam[3], pMsg-&gt;pReturnParam[4]);</span>
<span class="gd">-      }</span>
       break;
<span class="gd">-    }</span>
 
     default:
       break;
<span class="gu">@@ -2451,79 +2167,5 @@ static void SimplePeripheral_updatePHYStat(uint16_t eventCode, uint8_t *pMsg)</span>
   } // end of switch (eventCode)
 }
 
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimplePeripheral_menuSwitchCb</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Detect menu context switching</span>
<span class="gd">- *</span>
<span class="gd">- * @param   pMenuObjCurr - the current menu object</span>
<span class="gd">- * @param   pMenuObjNext - the menu object the context is about to switch to</span>
<span class="gd">- *</span>
<span class="gd">- * @return  none</span>
<span class="gd">- */</span>
<span class="gd">-static void SimplePeripheral_menuSwitchCb(tbmMenuObj_t* pMenuObjCurr,</span>
<span class="gd">-                                       tbmMenuObj_t* pMenuObjNext)</span>
<span class="gd">-{</span>
<span class="gd">-  uint8_t NUMB_ACTIVE_CONNS = linkDB_NumActive();</span>
<span class="gd">-</span>
<span class="gd">-  // interested in only the events of</span>
<span class="gd">-  // entering scMenuConnect, spMenuSelectConn, and scMenuMain for now</span>
<span class="gd">-  if (pMenuObjNext == &amp;spMenuSelectConn)</span>
<span class="gd">-  {</span>
<span class="gd">-    static uint8_t* pAddrs;</span>
<span class="gd">-    uint8_t* pAddrTemp;</span>
<span class="gd">-</span>
<span class="gd">-    if (pAddrs != NULL)</span>
<span class="gd">-    {</span>
<span class="gd">-      ICall_free(pAddrs);</span>
<span class="gd">-    }</span>
<span class="gd">-</span>
<span class="gd">-    // Allocate buffer to display addresses</span>
<span class="gd">-    pAddrs = ICall_malloc(NUMB_ACTIVE_CONNS * SP_ADDR_STR_SIZE);</span>
<span class="gd">-</span>
<span class="gd">-    if (pAddrs == NULL)</span>
<span class="gd">-    {</span>
<span class="gd">-      TBM_SET_NUM_ITEM(&amp;spMenuSelectConn, 0);</span>
<span class="gd">-    }</span>
<span class="gd">-    else</span>
<span class="gd">-    {</span>
<span class="gd">-      uint8_t i;</span>
<span class="gd">-</span>
<span class="gd">-      TBM_SET_NUM_ITEM(&amp;spMenuSelectConn, MAX_NUM_BLE_CONNS);</span>
<span class="gd">-</span>
<span class="gd">-      pAddrTemp = pAddrs;</span>
<span class="gd">-</span>
<span class="gd">-      // Add active connection info to the menu object</span>
<span class="gd">-      for (i = 0; i &lt; MAX_NUM_BLE_CONNS; i++)</span>
<span class="gd">-      {</span>
<span class="gd">-        if (connList[i].connHandle != LINKDB_CONNHANDLE_INVALID)</span>
<span class="gd">-        {</span>
<span class="gd">-          // Get the address from the connection handle</span>
<span class="gd">-          linkDBInfo_t linkInfo;</span>
<span class="gd">-          linkDB_GetInfo(connList[i].connHandle, &amp;linkInfo);</span>
<span class="gd">-          // This connection is active. Set the corresponding menu item with</span>
<span class="gd">-          // the address of this connection and enable the item.</span>
<span class="gd">-          memcpy(pAddrTemp, Util_convertBdAddr2Str(linkInfo.addr),</span>
<span class="gd">-                 SP_ADDR_STR_SIZE);</span>
<span class="gd">-          TBM_SET_ACTION_DESC(&amp;spMenuSelectConn, i, pAddrTemp);</span>
<span class="gd">-          tbm_setItemStatus(&amp;spMenuSelectConn, (1 &lt;&lt; i), SP_ITEM_NONE);</span>
<span class="gd">-          pAddrTemp += SP_ADDR_STR_SIZE;</span>
<span class="gd">-        }</span>
<span class="gd">-        else</span>
<span class="gd">-        {</span>
<span class="gd">-          // This connection is not active. Disable the corresponding menu item.</span>
<span class="gd">-          tbm_setItemStatus(&amp;spMenuSelectConn, SP_ITEM_NONE, (1 &lt;&lt; i));</span>
<span class="gd">-        }</span>
<span class="gd">-      }</span>
<span class="gd">-    }</span>
<span class="gd">-  }</span>
<span class="gd">-  else if (pMenuObjNext == &amp;spMenuMain)</span>
<span class="gd">-  {</span>
<span class="gd">-    // Now we are not in a specific connection&#39;s context</span>
<span class="gd">-</span>
<span class="gd">-    // Clear connection-related message</span>
<span class="gd">-    Display_clearLine(dispHandle, SP_ROW_CONNECTION);</span>
<span class="gd">-  }</span>
<span class="gd">-}</span>
 /*********************************************************************
 *********************************************************************/
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">simple_peripheral.h</span></code></p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">index c5914a5..d5393fc 100644</span>
<span class="gu">@@ -79,18 +79,6 @@ extern &quot;C&quot;</span>
  */
 extern void SimplePeripheral_createTask(void);
 
<span class="gd">-/*</span>
<span class="gd">- * Functions for menu action</span>
<span class="gd">- */</span>
<span class="gd">-/* Actions for Menu: Choose connection to work with */</span>
<span class="gd">-bool SimplePeripheral_doSelectConn(uint8 index);</span>
<span class="gd">-</span>
<span class="gd">-/* Action for Menu: AutoConnect */</span>
<span class="gd">-bool SimplePeripheral_doAutoConnect(uint8_t index);</span>
<span class="gd">-</span>
<span class="gd">-/* Actions for Menu: Set PHY - Select */</span>
<span class="gd">-bool SimplePeripheral_doSetConnPhy(uint8 index);</span>
<span class="gd">-</span>
 /*********************************************************************
 *********************************************************************/
 
</pre></div>
</div>
</li>
</ul>
</div>
</li>
<li><p>[Optional] The following files can be removed from the Application
folder:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">board_key.c</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">board_key.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">simple_peripheral_menu.c</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">simple_peripheral_menu.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">two_btn_menu.c</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">two_btn_menu.h</span></code></p></li>
</ul>
</div></blockquote>
</li>
<li><p>Test your code. It should still compile and work smoothly!
<em>It means you can still advertise, join a connection,
pair with another device, etc…</em></p></li>
</ol>
</div>
<div class="section" id="remove-the-2-long-range-advertisement">
<h3>Remove the #2 (long range) advertisement<a class="headerlink" href="#remove-the-2-long-range-advertisement" title="Permalink to this headline">¶</a></h3>
<p>By removing the secondary advertisement (sometimes called “long range”
advertisement) from the simple_peripheral example you can significantly
save power. The power consumption due to the secondary advertisement
(generally long range advertisement) can represent up to 80% of the
power consumption of the advertisement period. In addition, this
helps you to save memory.</p>
<p>Here are the guidelines:</p>
<ol class="arabic">
<li><p>Import the simple_peripheral project</p></li>
<li><p>Using SysConfig, reduce the number of Advertisement Set to only 1
(this must be done in BLE &gt; Broadcaster Configuration).
This will raise a warning saying we need to update the application
code… this is what we are going to do now :)</p>
<div class="figure align-center" id="id3">
<img alt="../_images/sysCfg_changeAdvSetNumber.png" src="../_images/sysCfg_changeAdvSetNumber.png" />
<p class="caption"><span class="caption-number">Figure 122. </span><span class="caption-text">Change the number of advertisement sets of your device</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p><em>Note: It is perfectly normal and expected if the compilation of
your project fails after this step… be patient and go to the next
steps.</em></p>
</li>
<li><p>Modify <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code> to remove the code related to
the #2 advertisement.</p>
<blockquote>
<div><blockquote>
<div><ul class="simple">
<li><p>remove the declaration of the variable <code class="docutils literal notranslate"><span class="pre">advHandleLongRange</span></code></p></li>
<li><p>remove all the code referencing the variable <code class="docutils literal notranslate"><span class="pre">advHandleLongRange</span></code></p></li>
<li><p>remove all the code referencing the table <code class="docutils literal notranslate"><span class="pre">advData2</span></code></p></li>
</ul>
</div></blockquote>
<div class="toggle docutils container">
<div class="header docutils container">
<p>Here is <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code> diff file (based on SDK 4.10),
click the arrow to see the changes:</p>
</div>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">index b0af31a..4884d0b 100644</span>
<span class="gu">@@ -317,7 +317,6 @@ uint8_t autoConnect = AUTOCONNECT_DISABLE;</span>
 
 // Advertising handles
 static uint8 advHandleLegacy;
<span class="gd">-static uint8 advHandleLongRange;</span>
 
 // Address mode
 static GAP_Addr_Modes_t addrMode = DEFAULT_ADDRESS_MODE;
<span class="gu">@@ -1053,28 +1052,6 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
         status = GapAdv_enable(advHandleLegacy, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);
         SIMPLEPERIPHERAL_ASSERT(status == SUCCESS);
 
<span class="gd">-        BLE_LOG_INT_INT(0, BLE_LOG_MODULE_APP, &quot;APP : ---- call GapAdv_create set=%d,%d\n&quot;, 1, 0);</span>
<span class="gd">-        // Create Advertisement set #2 and assign handle</span>
<span class="gd">-        status = GapAdv_create(&amp;SimplePeripheral_advCallback, &amp;advParams2,</span>
<span class="gd">-                               &amp;advHandleLongRange);</span>
<span class="gd">-        SIMPLEPERIPHERAL_ASSERT(status == SUCCESS);</span>
<span class="gd">-</span>
<span class="gd">-        // Load advertising data for set #2 that is statically allocated by the app</span>
<span class="gd">-        status = GapAdv_loadByHandle(advHandleLongRange, GAP_ADV_DATA_TYPE_ADV,</span>
<span class="gd">-                                     sizeof(advData2), advData2);</span>
<span class="gd">-        SIMPLEPERIPHERAL_ASSERT(status == SUCCESS);</span>
<span class="gd">-</span>
<span class="gd">-        // Set event mask for set #2</span>
<span class="gd">-        status = GapAdv_setEventMask(advHandleLongRange,</span>
<span class="gd">-                                     GAP_ADV_EVT_MASK_START_AFTER_ENABLE |</span>
<span class="gd">-                                     GAP_ADV_EVT_MASK_END_AFTER_DISABLE |</span>
<span class="gd">-                                     GAP_ADV_EVT_MASK_SET_TERMINATED);</span>
<span class="gd">-</span>
<span class="gd">-        BLE_LOG_INT_TIME(0, BLE_LOG_MODULE_APP, &quot;APP : ---- GapAdv_enable&quot;, 0);</span>
<span class="gd">-        // Enable long range advertising for set #2</span>
<span class="gd">-        status = GapAdv_enable(advHandleLongRange, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);</span>
<span class="gd">-        SIMPLEPERIPHERAL_ASSERT(status == SUCCESS);</span>
<span class="gd">-</span>
         // Display device address
         Display_printf(dispHandle, SP_ROW_IDA, 0, &quot;%s Addr: %s&quot;,
                        (addrMode &lt;= ADDRMODE_RANDOM) ? &quot;Dev&quot; : &quot;ID&quot;,
<span class="gu">@@ -1124,12 +1101,10 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
       {
         // Start advertising since there is room for more connections
         GapAdv_enable(advHandleLegacy, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);
<span class="gd">-        GapAdv_enable(advHandleLongRange, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);</span>
       }
       else
       {
         // Stop advertising since there is no room for more connections
<span class="gd">-        GapAdv_disable(advHandleLongRange);</span>
         GapAdv_disable(advHandleLegacy);
       }
       break;
<span class="gu">@@ -1161,7 +1136,6 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
       BLE_LOG_INT_STR(0, BLE_LOG_MODULE_APP, &quot;APP : GAP msg: status=%d, opcode=%s\n&quot;, 0, &quot;GAP_LINK_TERMINATED_EVENT&quot;);
       // Start advertising since there is room for more connections
       GapAdv_enable(advHandleLegacy, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);
<span class="gd">-      GapAdv_enable(advHandleLongRange, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);</span>
 
       // Clear remaining lines
       Display_clearLine(dispHandle, SP_ROW_CONNECTION);
<span class="gu">@@ -1822,14 +1796,10 @@ bool SimplePeripheral_doAutoConnect(uint8_t index)</span>
     {
       if (autoConnect != AUTOCONNECT_GROUP_A)
       {
<span class="gd">-        GapAdv_disable(advHandleLongRange);</span>
         GapAdv_disable(advHandleLegacy);
         advData1[2] = &#39;G&#39;;
         advData1[3] = &#39;A&#39;;
<span class="gd">-        advData2[2] = &#39;G&#39;;</span>
<span class="gd">-        advData2[3] = &#39;A&#39;;</span>
         GapAdv_enable(advHandleLegacy, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);
<span class="gd">-        GapAdv_enable(advHandleLongRange, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);</span>
         autoConnect = AUTOCONNECT_GROUP_A;
       }	
 	  Display_printf(dispHandle, SP_ROW_AC, 0, &quot;AutoConnect enabled: Group A&quot;);
<span class="gu">@@ -1838,14 +1808,10 @@ bool SimplePeripheral_doAutoConnect(uint8_t index)</span>
     {
       if (autoConnect != AUTOCONNECT_GROUP_B)
       {
<span class="gd">-        GapAdv_disable(advHandleLongRange);</span>
         GapAdv_disable(advHandleLegacy);
         advData1[2] = &#39;G&#39;;
         advData1[3] = &#39;B&#39;;
<span class="gd">-        advData2[2] = &#39;G&#39;;</span>
<span class="gd">-        advData2[3] = &#39;B&#39;;</span>
         GapAdv_enable(advHandleLegacy, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);
<span class="gd">-        GapAdv_enable(advHandleLongRange, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);</span>
         autoConnect = AUTOCONNECT_GROUP_B;
       } 
       Display_printf(dispHandle, SP_ROW_AC, 0, &quot;AutoConnect enabled: Group B&quot;);
<span class="gu">@@ -1854,14 +1820,10 @@ bool SimplePeripheral_doAutoConnect(uint8_t index)</span>
     {
       if (autoConnect)
       {
<span class="gd">-        GapAdv_disable(advHandleLongRange);</span>
         GapAdv_disable(advHandleLegacy);
         advData1[2] = &#39;S&#39;;
         advData1[3] = &#39;P&#39;;
<span class="gd">-        advData2[2] = &#39;S&#39;;</span>
<span class="gd">-        advData2[3] = &#39;P&#39;;</span>
         GapAdv_enable(advHandleLegacy, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);
<span class="gd">-        GapAdv_enable(advHandleLongRange, GAP_ADV_ENABLE_OPTIONS_USE_MAX , 0);</span>
         autoConnect = AUTOCONNECT_DISABLE;
       } 
       Display_printf(dispHandle, SP_ROW_AC, 0, &quot;AutoConnect disabled&quot;);
</pre></div>
</div>
</div>
</div></blockquote>
</li>
<li><p>Build and test your project… You might have a warning due to
SysConfig (this warning only appears if SysConfig is run, i.e. if
you modify the content of the SysConfig file or if you “Rebuild” the
project). Apart from that, no warning or error should be raised at build
time and the project should still work smoothly!
<em>It means you can still advertise (legacy advertisement only),
join a connection, pair with another device, etc…</em></p></li>
</ol>
</div>
<div class="section" id="remove-the-auto-phy-update">
<h3>Remove the auto-PHY update<a class="headerlink" href="#remove-the-auto-phy-update" title="Permalink to this headline">¶</a></h3>
<p>The <em>auto-PHY update</em> is a feature provided by the application
and consisting in dynamically change the PHY used by the BLE stack
to handle a connection.
The PHY is selected based on the RSSI measured. The better the RSSI,
the faster the PHY selected is (e.g. if the RSSI is -25, then the
2M PHY will be selected, if the RSSI is -65 then the S8 PHY will be
selected).
This functionality is available in the simple_peripheral project
and has to be activated using the two buttons menu. Other projects
provide this functionality too.</p>
<p>This modification should free up some FLASH and some CPU time.
The amount of stack required by the example should be decreased too.
The goal is to remove the code responsible for the auto-PHY update.
As the auto-PHY update is based on RSSI, we are also going to remove
the code responsible to read the RSSI of the connection.</p>
<p>Here are the guidelines:</p>
<ol class="arabic">
<li><p>Import the simple_peripheral project</p></li>
<li><p>Modify <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code> and <code class="docutils literal notranslate"><span class="pre">simple_peripheral_menu.c</span></code>:</p>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code>:</p>
<ul>
<li><p>Remove the function <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_processCmdCompleteEvt</span></code>
and its calls</p></li>
<li><p>Remove the function <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_initPHYRSSIArray()</span></code>
and its calls</p></li>
<li><p>Remove the function <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_startAutoPhyChange()</span></code>
and its calls.</p></li>
<li><p>Remove the function <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_stopAutoPhyChange()</span></code>
and its calls</p></li>
<li><p>Remove the function <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_updatePHYStat()</span></code>
and its calls</p></li>
<li><p>Modify the function <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_doSetConnPhy()</span></code>
in order to remove the support of the <code class="docutils literal notranslate"><span class="pre">AUTO_PHY_UPDATE</span></code></p></li>
<li><p>Remove the callback function <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_connEvtCB()</span></code></p></li>
<li><p>Remove the RSSI thresholds defined (this does not save any FLASH
or RAM but it these defines are useless now). Same remark for
<code class="docutils literal notranslate"><span class="pre">SP_MAX_RSSI_STORE_DEPTH</span></code>, <code class="docutils literal notranslate"><span class="pre">SP_RSSI_TRACK_CHNLS</span></code>.
You can also remove all the define related to auto-phy update:
<code class="docutils literal notranslate"><span class="pre">SP_PHY_NONE</span></code>, <code class="docutils literal notranslate"><span class="pre">SP_INVALID_HANDLE</span></code> and <code class="docutils literal notranslate"><span class="pre">AUTO_PHY_UPDATE</span></code></p></li>
<li><p>Modify the <code class="docutils literal notranslate"><span class="pre">spConnRec_t</span></code> structure. We don’t need any more the
RSSI related elements (<code class="docutils literal notranslate"><span class="pre">rssiArr</span></code>, <code class="docutils literal notranslate"><span class="pre">rssiCntr</span></code>, <code class="docutils literal notranslate"><span class="pre">rssiAvg</span></code>)
and the PHY change related (<code class="docutils literal notranslate"><span class="pre">currPhy</span></code>, <code class="docutils literal notranslate"><span class="pre">rqPhy</span></code>, <code class="docutils literal notranslate"><span class="pre">phyCngRq</span></code>,
<code class="docutils literal notranslate"><span class="pre">phyRqFailCnt</span></code>, <code class="docutils literal notranslate"><span class="pre">isAutoPHYEnable</span></code>).
Remove all the code referring to these elements.</p></li>
</ul>
</li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">simple_peripheral_menu.c</span></code>:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>In the “ConnPhy” menu, remove the <code class="docutils literal notranslate"><span class="pre">MENU_ITEM_ACTION</span></code> associated
with the auto-PHY update.</p></li>
<li><p>In the corresponding <code class="docutils literal notranslate"><span class="pre">MENU_OBJ</span></code>, modify the number of available
items.</p></li>
</ul>
</div></blockquote>
<div class="toggle docutils container">
<div class="header docutils container">
<p>Here are the diff files (based on SDK 4.10),
click the arrow to see the changes:</p>
</div>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code></p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">index b0af31a..ea9fde6 100644</span>
<span class="gu">@@ -144,17 +144,6 @@</span>
 #define SP_ROW_DEBUG         (TBM_ROW_APP + 8)
 #define SP_ROW_AC            (TBM_ROW_APP + 9)
 
<span class="gd">-// For storing the active connections</span>
<span class="gd">-#define SP_RSSI_TRACK_CHNLS        1            // Max possible channels can be GAP_BONDINGS_MAX</span>
<span class="gd">-#define SP_MAX_RSSI_STORE_DEPTH    5</span>
<span class="gd">-#define SP_INVALID_HANDLE          0xFFFF</span>
<span class="gd">-#define RSSI_2M_THRSHLD           -30           </span>
<span class="gd">-#define RSSI_1M_THRSHLD           -40           </span>
<span class="gd">-#define RSSI_S2_THRSHLD           -50           </span>
<span class="gd">-#define RSSI_S8_THRSHLD           -60           </span>
<span class="gd">-#define SP_PHY_NONE                LL_PHY_NONE  // No PHY set</span>
<span class="gd">-#define AUTO_PHY_UPDATE            0xFF</span>
<span class="gd">-</span>
 // Spin if the expression is not true
 #define SIMPLEPERIPHERAL_ASSERT(expr) if (!(expr)) simple_peripheral_spin();
 
<span class="gu">@@ -231,14 +220,6 @@ typedef struct</span>
   uint16_t         	    connHandle;                        // Connection Handle
   spClockEventData_t*   pParamUpdateEventData;
   Clock_Struct*    	    pUpdateClock;                      // pointer to clock struct
<span class="gd">-  int8_t           	    rssiArr[SP_MAX_RSSI_STORE_DEPTH];</span>
<span class="gd">-  uint8_t          	    rssiCntr;</span>
<span class="gd">-  int8_t           	    rssiAvg;</span>
<span class="gd">-  bool             	    phyCngRq;                          // Set to true if PHY change request is in progress</span>
<span class="gd">-  uint8_t          	    currPhy;</span>
<span class="gd">-  uint8_t          	    rqPhy;</span>
<span class="gd">-  uint8_t          	    phyRqFailCnt;                      // PHY change request count</span>
<span class="gd">-  bool             	    isAutoPHYEnable;                   // Flag to indicate auto phy change</span>
 } spConnRec_t;
 
 /*********************************************************************
<span class="gu">@@ -353,22 +334,16 @@ static void SimplePeripheral_charValueChangeCB(uint8_t paramId);</span>
 static status_t SimplePeripheral_enqueueMsg(uint8_t event, void *pData);
 static void SimplePeripheral_keyChangeHandler(uint8 keys);
 static void SimplePeripheral_handleKeys(uint8_t keys);
<span class="gd">-static void SimplePeripheral_processCmdCompleteEvt(hciEvt_CmdComplete_t *pMsg);</span>
<span class="gd">-static void SimplePeripheral_initPHYRSSIArray(void);</span>
<span class="gd">-static void SimplePeripheral_updatePHYStat(uint16_t eventCode, uint8_t *pMsg);</span>
 static uint8_t SimplePeripheral_addConn(uint16_t connHandle);
 static uint8_t SimplePeripheral_getConnIndex(uint16_t connHandle);
 static uint8_t SimplePeripheral_removeConn(uint16_t connHandle);
 static void SimplePeripheral_processParamUpdate(uint16_t connHandle);
<span class="gd">-static status_t SimplePeripheral_startAutoPhyChange(uint16_t connHandle);</span>
<span class="gd">-static status_t SimplePeripheral_stopAutoPhyChange(uint16_t connHandle);</span>
 static status_t SimplePeripheral_setPhy(uint16_t connHandle, uint8_t allPhys,
                                         uint8_t txPhy, uint8_t rxPhy,
                                         uint16_t phyOpts);
 static uint8_t SimplePeripheral_clearConnListEntry(uint16_t connHandle);
 static void SimplePeripheral_menuSwitchCb(tbmMenuObj_t* pMenuObjCurr,
                                           tbmMenuObj_t* pMenuObjNext);
<span class="gd">-static void SimplePeripheral_connEvtCB(Gap_ConnEventRpt_t *pReport);</span>
 static void SimplePeripheral_processConnEvt(Gap_ConnEventRpt_t *pReport);
 #ifdef PTM_MODE
 void simple_peripheral_handleNPIRxInterceptEvent(uint8_t *pMsg);  // Declaration
<span class="gu">@@ -611,9 +586,6 @@ static void SimplePeripheral_init(void)</span>
   //Initialize GAP layer for Peripheral role and register to receive GAP events
   GAP_DeviceInit(GAP_PROFILE_PERIPHERAL, selfEntity, addrMode, &amp;pRandomAddress);
 
<span class="gd">-  // Initialize array to store connection handle and RSSI values</span>
<span class="gd">-  SimplePeripheral_initPHYRSSIArray();</span>
<span class="gd">-</span>
   // The type of display is configured based on the BOARD_DISPLAY_USE...
   // preprocessor definitions
   dispHandle = Display_open(Display_Type_ANY, NULL);
<span class="gu">@@ -745,12 +717,6 @@ static uint8_t SimplePeripheral_processStackMsg(ICall_Hdr *pMsg)</span>
       // Process HCI message
       switch(pMsg-&gt;status)
       {
<span class="gd">-        case HCI_COMMAND_COMPLETE_EVENT_CODE:</span>
<span class="gd">-        // Process HCI Command Complete Events here</span>
<span class="gd">-        {</span>
<span class="gd">-          SimplePeripheral_processCmdCompleteEvt((hciEvt_CmdComplete_t *) pMsg);</span>
<span class="gd">-          break;</span>
<span class="gd">-        }</span>
 
         case HCI_BLE_HARDWARE_ERROR_EVENT_CODE:
           AssertHandler(HAL_ASSERT_CAUSE_HARDWARE_ERROR,0);
<span class="gu">@@ -776,7 +742,6 @@ static uint8_t SimplePeripheral_processStackMsg(ICall_Hdr *pMsg)</span>
                                pMyMsg-&gt;cmdStatus);
               }
 
<span class="gd">-              SimplePeripheral_updatePHYStat(HCI_LE_SET_PHY, (uint8_t *)pMsg);</span>
               break;
             }
 
<span class="gu">@@ -811,7 +776,6 @@ static uint8_t SimplePeripheral_processStackMsg(ICall_Hdr *pMsg)</span>
                              (pPUC-&gt;rxPhy == PHY_UPDATE_COMPLETE_EVENT_CODED) ? &quot;CODED&quot; : &quot;Unexpected PHY Value&quot;);
             }
 
<span class="gd">-            SimplePeripheral_updatePHYStat(HCI_BLE_PHY_UPDATE_COMPLETE_EVENT, (uint8_t *)pMsg);</span>
           }
           break;
         }
<span class="gu">@@ -1462,7 +1426,6 @@ bool SimplePeripheral_doSetConnPhy(uint8 index)</span>
   static uint8_t phy[] = {
     HCI_PHY_1_MBPS, HCI_PHY_2_MBPS, HCI_PHY_1_MBPS | HCI_PHY_2_MBPS,
     HCI_PHY_CODED, HCI_PHY_1_MBPS | HCI_PHY_2_MBPS | HCI_PHY_CODED,
<span class="gd">-    AUTO_PHY_UPDATE</span>
   };
 
   uint8_t connIndex = SimplePeripheral_getConnIndex(menuConnHandle);
<span class="gu">@@ -1474,27 +1437,14 @@ bool SimplePeripheral_doSetConnPhy(uint8 index)</span>
 
   // Set Phy Preference on the current connection. Apply the same value
   // for RX and TX.
<span class="gd">-  // If auto PHY update is not selected and if auto PHY update is enabled, then</span>
<span class="gd">-  // stop auto PHY update</span>
<span class="gd">-  // Note PHYs are already enabled by default in build_config.opt in stack project.</span>
<span class="gd">-  if(phy[index] != AUTO_PHY_UPDATE)</span>
<span class="gd">-  {</span>
<span class="gd">-    // Cancel RSSI reading  and auto phy changing</span>
<span class="gd">-    SimplePeripheral_stopAutoPhyChange(connList[connIndex].connHandle);</span>
<span class="gd">-</span>
     SimplePeripheral_setPhy(menuConnHandle, 0, phy[index], phy[index], 0);
 
     Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;PHY preference: %s&quot;,
                    TBM_GET_ACTION_DESC(&amp;spMenuConnPhy, index));
<span class="gd">-  }</span>
<span class="gd">-  else</span>
<span class="gd">-  {</span>
<span class="gd">-    // Start RSSI read for auto PHY update (if it is disabled)</span>
<span class="gd">-    SimplePeripheral_startAutoPhyChange(menuConnHandle);</span>
<span class="gd">-  }</span>
 
   return status;
 }
<span class="gi">+</span>
 /*********************************************************************
  * @fn      SimplePeripheral_advCallback
  *
<span class="gu">@@ -1712,22 +1662,6 @@ static void SimplePeripheral_processPasscode(spPasscodeData_t *pPasscodeData)</span>
                          B_APP_DEFAULT_PASSCODE);
 }
 
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimplePeripheral_connEvtCB</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Connection event callback.</span>
<span class="gd">- *</span>
<span class="gd">- * @param pReport pointer to connection event report</span>
<span class="gd">- */</span>
<span class="gd">-static void SimplePeripheral_connEvtCB(Gap_ConnEventRpt_t *pReport)</span>
<span class="gd">-{</span>
<span class="gd">-  // Enqueue the event for processing in the app context.</span>
<span class="gd">-  if(SimplePeripheral_enqueueMsg(SP_CONN_EVT, pReport) != SUCCESS)</span>
<span class="gd">-  {</span>
<span class="gd">-    ICall_free(pReport);</span>
<span class="gd">-  }</span>
<span class="gd">-}</span>
<span class="gd">-</span>
 /*********************************************************************
  * @fn      SimplePeripheral_processConnEvt
  *
<span class="gu">@@ -1745,13 +1679,6 @@ static void SimplePeripheral_processConnEvt(Gap_ConnEventRpt_t *pReport)</span>
     Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;Connection handle is not in the connList !!!&quot;);
     return;
   }
<span class="gd">-</span>
<span class="gd">-  // If auto phy change is enabled</span>
<span class="gd">-  if (connList[connIndex].isAutoPHYEnable == TRUE)</span>
<span class="gd">-  {</span>
<span class="gd">-    // Read the RSSI</span>
<span class="gd">-    HCI_ReadRssiCmd(pReport-&gt;handle);</span>
<span class="gd">-  }</span>
 }
 
 
<span class="gu">@@ -1923,9 +1850,6 @@ static uint8_t SimplePeripheral_addConn(uint16_t connHandle)</span>
         status = bleMemAllocError;
       }
 
<span class="gd">-      // Set default PHY to 1M</span>
<span class="gd">-      connList[i].currPhy = HCI_PHY_1_MBPS;</span>
<span class="gd">-</span>
       break;
     }
   }
<span class="gu">@@ -1986,14 +1910,6 @@ static uint8_t SimplePeripheral_clearConnListEntry(uint16_t connHandle)</span>
     if((connIndex == i) || (connHandle == LINKDB_CONNHANDLE_ALL))
     {
       connList[i].connHandle = LINKDB_CONNHANDLE_INVALID;
<span class="gd">-      connList[i].currPhy = 0;</span>
<span class="gd">-      connList[i].phyCngRq = 0;</span>
<span class="gd">-      connList[i].phyRqFailCnt = 0;</span>
<span class="gd">-      connList[i].rqPhy = 0;</span>
<span class="gd">-      memset(connList[i].rssiArr, 0, SP_MAX_RSSI_STORE_DEPTH);</span>
<span class="gd">-      connList[i].rssiAvg = 0;</span>
<span class="gd">-      connList[i].rssiCntr = 0;</span>
<span class="gd">-      connList[i].isAutoPHYEnable = FALSE;</span>
     }
   }
 
<span class="gu">@@ -2056,8 +1972,6 @@ static uint8_t SimplePeripheral_removeConn(uint16_t connHandle)</span>
     }
     // Clear pending update requests from paramUpdateList
     SimplePeripheral_clearPendingParamUpdate(connHandle);
<span class="gd">-    // Stop Auto PHY Change</span>
<span class="gd">-    SimplePeripheral_stopAutoPhyChange(connHandle);</span>
     // Clear Connection List Entry
     SimplePeripheral_clearConnListEntry(connHandle);
   }
<span class="gu">@@ -2118,226 +2032,6 @@ static void SimplePeripheral_processParamUpdate(uint16_t connHandle)</span>
   }
 }
 
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimpleCentral_processCmdCompleteEvt</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Process an incoming OSAL HCI Command Complete Event.</span>
<span class="gd">- *</span>
<span class="gd">- * @param   pMsg - message to process</span>
<span class="gd">- *</span>
<span class="gd">- * @return  none</span>
<span class="gd">- */</span>
<span class="gd">-static void SimplePeripheral_processCmdCompleteEvt(hciEvt_CmdComplete_t *pMsg)</span>
<span class="gd">-{</span>
<span class="gd">-  uint8_t status = pMsg-&gt;pReturnParam[0];</span>
<span class="gd">-</span>
<span class="gd">-  //Find which command this command complete is for</span>
<span class="gd">-  switch (pMsg-&gt;cmdOpcode)</span>
<span class="gd">-  {</span>
<span class="gd">-    case HCI_READ_RSSI:</span>
<span class="gd">-    {</span>
<span class="gd">-      int8 rssi = (int8)pMsg-&gt;pReturnParam[3];  </span>
<span class="gd">-</span>
<span class="gd">-      // Display RSSI value, if RSSI is higher than threshold, change to faster PHY</span>
<span class="gd">-      if (status == SUCCESS)</span>
<span class="gd">-      {</span>
<span class="gd">-        uint16_t handle = BUILD_UINT16(pMsg-&gt;pReturnParam[1], pMsg-&gt;pReturnParam[2]);</span>
<span class="gd">-</span>
<span class="gd">-        uint8_t index = SimplePeripheral_getConnIndex(handle);</span>
<span class="gd">-        if (index &gt;= MAX_NUM_BLE_CONNS)</span>
<span class="gd">-        {</span>
<span class="gd">-          Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;Connection handle is not in the connList !!!&quot;);</span>
<span class="gd">-          return;</span>
<span class="gd">-        }</span>
<span class="gd">-</span>
<span class="gd">-        if (rssi != LL_RSSI_NOT_AVAILABLE)</span>
<span class="gd">-        {</span>
<span class="gd">-          connList[index].rssiArr[connList[index].rssiCntr++] = rssi;</span>
<span class="gd">-          connList[index].rssiCntr %= SP_MAX_RSSI_STORE_DEPTH;</span>
<span class="gd">-</span>
<span class="gd">-          int16_t sum_rssi = 0;</span>
<span class="gd">-          for(uint8_t cnt=0; cnt&lt;SP_MAX_RSSI_STORE_DEPTH; cnt++)</span>
<span class="gd">-          {</span>
<span class="gd">-            sum_rssi += connList[index].rssiArr[cnt];</span>
<span class="gd">-          }</span>
<span class="gd">-          connList[index].rssiAvg = (uint32_t)(sum_rssi/SP_MAX_RSSI_STORE_DEPTH);</span>
<span class="gd">-</span>
<span class="gd">-          uint8_t phyRq = SP_PHY_NONE;</span>
<span class="gd">-          uint8_t phyRqS = SP_PHY_NONE;</span>
<span class="gd">-          uint8_t phyOpt = LL_PHY_OPT_NONE;</span>
<span class="gd">-</span>
<span class="gd">-          if(connList[index].phyCngRq == FALSE)</span>
<span class="gd">-          {</span>
<span class="gd">-            if((connList[index].rssiAvg &gt;= RSSI_2M_THRSHLD) &amp;&amp;</span>
<span class="gd">-            (connList[index].currPhy != HCI_PHY_2_MBPS) &amp;&amp;</span>
<span class="gd">-                 (connList[index].currPhy != SP_PHY_NONE))</span>
<span class="gd">-            {</span>
<span class="gd">-              // try to go to higher data rate</span>
<span class="gd">-              phyRqS = phyRq = HCI_PHY_2_MBPS;</span>
<span class="gd">-            }</span>
<span class="gd">-            else if((connList[index].rssiAvg &lt; RSSI_2M_THRSHLD) &amp;&amp;</span>
<span class="gd">-                    (connList[index].rssiAvg &gt;= RSSI_1M_THRSHLD) &amp;&amp;</span>
<span class="gd">-                    (connList[index].currPhy != HCI_PHY_1_MBPS) &amp;&amp;</span>
<span class="gd">-                    (connList[index].currPhy != SP_PHY_NONE))</span>
<span class="gd">-            {</span>
<span class="gd">-              // try to go to legacy regular data rate</span>
<span class="gd">-              phyRqS = phyRq = HCI_PHY_1_MBPS;</span>
<span class="gd">-            }</span>
<span class="gd">-            else if((connList[index].rssiAvg &gt;= RSSI_S2_THRSHLD) &amp;&amp;</span>
<span class="gd">-                    (connList[index].rssiAvg &lt; RSSI_1M_THRSHLD) &amp;&amp;</span>
<span class="gd">-                    (connList[index].currPhy != SP_PHY_NONE))</span>
<span class="gd">-            {</span>
<span class="gd">-              // try to go to lower data rate S=2(500kb/s)</span>
<span class="gd">-              phyRqS = HCI_PHY_CODED;</span>
<span class="gd">-              phyOpt = LL_PHY_OPT_S2;</span>
<span class="gd">-              phyRq = BLE5_CODED_S2_PHY;</span>
<span class="gd">-            }</span>
<span class="gd">-            else if(connList[index].rssiAvg &lt; RSSI_S2_THRSHLD )</span>
<span class="gd">-            {</span>
<span class="gd">-              // try to go to lowest data rate S=8(125kb/s)</span>
<span class="gd">-              phyRqS = HCI_PHY_CODED;</span>
<span class="gd">-              phyOpt = LL_PHY_OPT_S8;</span>
<span class="gd">-              phyRq = BLE5_CODED_S8_PHY;</span>
<span class="gd">-            }</span>
<span class="gd">-            if((phyRq != SP_PHY_NONE) &amp;&amp;</span>
<span class="gd">-               // First check if the request for this phy change is already not honored then don&#39;t request for change</span>
<span class="gd">-               (((connList[index].rqPhy == phyRq) &amp;&amp;</span>
<span class="gd">-                 (connList[index].phyRqFailCnt &lt; 2)) ||</span>
<span class="gd">-                 (connList[index].rqPhy != phyRq)))</span>
<span class="gd">-            {</span>
<span class="gd">-              //Initiate PHY change based on RSSI</span>
<span class="gd">-              SimplePeripheral_setPhy(connList[index].connHandle, 0,</span>
<span class="gd">-                                      phyRqS, phyRqS, phyOpt);</span>
<span class="gd">-              connList[index].phyCngRq = TRUE;</span>
<span class="gd">-</span>
<span class="gd">-              // If it a request for different phy than failed request, reset the count</span>
<span class="gd">-              if(connList[index].rqPhy != phyRq)</span>
<span class="gd">-              {</span>
<span class="gd">-                // then reset the request phy counter and requested phy</span>
<span class="gd">-                connList[index].phyRqFailCnt = 0;</span>
<span class="gd">-              }</span>
<span class="gd">-</span>
<span class="gd">-              if(phyOpt == LL_PHY_OPT_NONE)</span>
<span class="gd">-              {</span>
<span class="gd">-                connList[index].rqPhy = phyRq;</span>
<span class="gd">-              }</span>
<span class="gd">-              else if(phyOpt == LL_PHY_OPT_S2)</span>
<span class="gd">-              {</span>
<span class="gd">-                connList[index].rqPhy = BLE5_CODED_S2_PHY;</span>
<span class="gd">-              }</span>
<span class="gd">-              else</span>
<span class="gd">-              {</span>
<span class="gd">-                connList[index].rqPhy = BLE5_CODED_S8_PHY;</span>
<span class="gd">-              }</span>
<span class="gd">-</span>
<span class="gd">-            } // end of if ((phyRq != SP_PHY_NONE) &amp;&amp; ...</span>
<span class="gd">-          } // end of if (connList[index].phyCngRq == FALSE)</span>
<span class="gd">-        } // end of if (rssi != LL_RSSI_NOT_AVAILABLE)</span>
<span class="gd">-</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_RSSI, 0,</span>
<span class="gd">-                       &quot;RSSI:%d dBm, AVG RSSI:%d dBm&quot;,</span>
<span class="gd">-                       (uint32_t)(rssi),</span>
<span class="gd">-                       connList[index].rssiAvg);</span>
<span class="gd">-</span>
<span class="gd">-	  } // end of if (status == SUCCESS)</span>
<span class="gd">-      break;</span>
<span class="gd">-    }</span>
<span class="gd">-</span>
<span class="gd">-    case HCI_LE_READ_PHY:</span>
<span class="gd">-    {</span>
<span class="gd">-      if (status == SUCCESS)</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_RSSI + 2, 0, &quot;RXPh: %d, TXPh: %d&quot;,</span>
<span class="gd">-                       pMsg-&gt;pReturnParam[3], pMsg-&gt;pReturnParam[4]);</span>
<span class="gd">-      }</span>
<span class="gd">-      break;</span>
<span class="gd">-    }</span>
<span class="gd">-</span>
<span class="gd">-    default:</span>
<span class="gd">-      break;</span>
<span class="gd">-  } // end of switch (pMsg-&gt;cmdOpcode)</span>
<span class="gd">-}</span>
<span class="gd">-</span>
<span class="gd">-/*********************************************************************</span>
<span class="gd">-* @fn      SimplePeripheral_initPHYRSSIArray</span>
<span class="gd">-*</span>
<span class="gd">-* @brief   Initializes the array of structure/s to store data related</span>
<span class="gd">-*          RSSI based auto PHy change</span>
<span class="gd">-*</span>
<span class="gd">-* @param   connHandle - the connection handle</span>
<span class="gd">-*</span>
<span class="gd">-* @param   addr - pointer to device address</span>
<span class="gd">-*</span>
<span class="gd">-* @return  index of connection handle</span>
<span class="gd">-*/</span>
<span class="gd">-static void SimplePeripheral_initPHYRSSIArray(void)</span>
<span class="gd">-{</span>
<span class="gd">-  //Initialize array to store connection handle and RSSI values</span>
<span class="gd">-  memset(connList, 0, sizeof(connList));</span>
<span class="gd">-  for (uint8_t index = 0; index &lt; MAX_NUM_BLE_CONNS; index++)</span>
<span class="gd">-  {</span>
<span class="gd">-    connList[index].connHandle = SP_INVALID_HANDLE;</span>
<span class="gd">-  }</span>
<span class="gd">-}</span>
<span class="gd">-/*********************************************************************</span>
<span class="gd">-      // Set default PHY to 1M</span>
<span class="gd">- * @fn      SimplePeripheral_startAutoPhyChange</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Start periodic RSSI reads on a link.</span>
<span class="gd">- *</span>
<span class="gd">- * @param   connHandle - connection handle of link</span>
<span class="gd">- * @param   devAddr - device address</span>
<span class="gd">- *</span>
<span class="gd">- * @return  SUCCESS: Terminate started</span>
<span class="gd">- *          bleIncorrectMode: No link</span>
<span class="gd">- *          bleNoResources: No resources</span>
<span class="gd">- */</span>
<span class="gd">-static status_t SimplePeripheral_startAutoPhyChange(uint16_t connHandle)</span>
<span class="gd">-{</span>
<span class="gd">-  status_t status = FAILURE;</span>
<span class="gd">-</span>
<span class="gd">-  // Get connection index from handle</span>
<span class="gd">-  uint8_t connIndex = SimplePeripheral_getConnIndex(connHandle);</span>
<span class="gd">-  SIMPLEPERIPHERAL_ASSERT(connIndex &lt; MAX_NUM_BLE_CONNS);</span>
<span class="gd">-</span>
<span class="gd">-  // Start Connection Event notice for RSSI calculation</span>
<span class="gd">-  status = Gap_RegisterConnEventCb(SimplePeripheral_connEvtCB, GAP_CB_REGISTER, connHandle);</span>
<span class="gd">-</span>
<span class="gd">-  // Flag in connection info if successful</span>
<span class="gd">-  if (status == SUCCESS)</span>
<span class="gd">-  {</span>
<span class="gd">-    connList[connIndex].isAutoPHYEnable = TRUE;</span>
<span class="gd">-  }</span>
<span class="gd">-</span>
<span class="gd">-  return status;</span>
<span class="gd">-}</span>
<span class="gd">-</span>
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimplePeripheral_stopAutoPhyChange</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Cancel periodic RSSI reads on a link.</span>
<span class="gd">- *</span>
<span class="gd">- * @param   connHandle - connection handle of link</span>
<span class="gd">- *</span>
<span class="gd">- * @return  SUCCESS: Operation successful</span>
<span class="gd">- *          bleIncorrectMode: No link</span>
<span class="gd">- */</span>
<span class="gd">-static status_t SimplePeripheral_stopAutoPhyChange(uint16_t connHandle)</span>
<span class="gd">-{</span>
<span class="gd">-  // Get connection index from handle</span>
<span class="gd">-  uint8_t connIndex = SimplePeripheral_getConnIndex(connHandle);</span>
<span class="gd">-  SIMPLEPERIPHERAL_ASSERT(connIndex &lt; MAX_NUM_BLE_CONNS);</span>
<span class="gd">-</span>
<span class="gd">-  // Stop connection event notice</span>
<span class="gd">-  Gap_RegisterConnEventCb(NULL, GAP_CB_UNREGISTER, connHandle);</span>
<span class="gd">-</span>
<span class="gd">-  // Also update the phychange request status for active RSSI tracking connection</span>
<span class="gd">-  connList[connIndex].phyCngRq = FALSE;</span>
<span class="gd">-  connList[connIndex].isAutoPHYEnable = FALSE;</span>
<span class="gd">-</span>
<span class="gd">-  return SUCCESS;</span>
<span class="gd">-}</span>
<span class="gd">-</span>
 /*********************************************************************
  * @fn      SimplePeripheral_setPhy
  *
<span class="gu">@@ -2365,92 +2059,6 @@ static status_t SimplePeripheral_setPhy(uint16_t connHandle, uint8_t allPhys,</span>
   return SUCCESS;
 }
 
<span class="gd">-/*********************************************************************</span>
<span class="gd">-* @fn      SimplePeripheral_updatePHYStat</span>
<span class="gd">-*</span>
<span class="gd">-* @brief   Update the auto phy update state machine</span>
<span class="gd">-*</span>
<span class="gd">-* @param   connHandle - the connection handle</span>
<span class="gd">-*</span>
<span class="gd">-* @return  None</span>
<span class="gd">-*/</span>
<span class="gd">-static void SimplePeripheral_updatePHYStat(uint16_t eventCode, uint8_t *pMsg)</span>
<span class="gd">-{</span>
<span class="gd">-  uint8_t connIndex;</span>
<span class="gd">-</span>
<span class="gd">-  switch (eventCode)</span>
<span class="gd">-  {</span>
<span class="gd">-    case HCI_LE_SET_PHY:</span>
<span class="gd">-    {</span>
<span class="gd">-      // Get connection handle from list</span>
<span class="gd">-      spConnHandleEntry_t *connHandleEntry =</span>
<span class="gd">-                           (spConnHandleEntry_t *)List_get(&amp;setPhyCommStatList);</span>
<span class="gd">-</span>
<span class="gd">-      if (connHandleEntry)</span>
<span class="gd">-      {</span>
<span class="gd">-        // Get index from connection handle</span>
<span class="gd">-        connIndex = SimplePeripheral_getConnIndex(connHandleEntry-&gt;connHandle);</span>
<span class="gd">-</span>
<span class="gd">-        ICall_free(connHandleEntry);</span>
<span class="gd">-</span>
<span class="gd">-        // Is this connection still valid?</span>
<span class="gd">-        if (connIndex &lt; MAX_NUM_BLE_CONNS)</span>
<span class="gd">-        {</span>
<span class="gd">-          hciEvt_CommandStatus_t *pMyMsg = (hciEvt_CommandStatus_t *)pMsg;</span>
<span class="gd">-</span>
<span class="gd">-          if (pMyMsg-&gt;cmdStatus == HCI_ERROR_CODE_UNSUPPORTED_REMOTE_FEATURE)</span>
<span class="gd">-          {</span>
<span class="gd">-            // Update the phychange request status for active RSSI tracking connection</span>
<span class="gd">-            connList[connIndex].phyCngRq = FALSE;</span>
<span class="gd">-            connList[connIndex].phyRqFailCnt++;</span>
<span class="gd">-          }</span>
<span class="gd">-        }</span>
<span class="gd">-      }</span>
<span class="gd">-      break;</span>
<span class="gd">-    }</span>
<span class="gd">-</span>
<span class="gd">-    // LE Event - a Phy update has completed or failed</span>
<span class="gd">-    case HCI_BLE_PHY_UPDATE_COMPLETE_EVENT:</span>
<span class="gd">-    {</span>
<span class="gd">-      hciEvt_BLEPhyUpdateComplete_t *pPUC =</span>
<span class="gd">-                                     (hciEvt_BLEPhyUpdateComplete_t*) pMsg;</span>
<span class="gd">-</span>
<span class="gd">-      if(pPUC)</span>
<span class="gd">-      {</span>
<span class="gd">-        // Get index from connection handle</span>
<span class="gd">-        connIndex = SimplePeripheral_getConnIndex(pPUC-&gt;connHandle);</span>
<span class="gd">-</span>
<span class="gd">-        // Is this connection still valid?</span>
<span class="gd">-        if (connIndex &lt; MAX_NUM_BLE_CONNS)</span>
<span class="gd">-        {</span>
<span class="gd">-          // Update the phychange request status for active RSSI tracking connection</span>
<span class="gd">-          connList[connIndex].phyCngRq = FALSE;</span>
<span class="gd">-</span>
<span class="gd">-          if (pPUC-&gt;status == SUCCESS)</span>
<span class="gd">-          {</span>
<span class="gd">-            connList[connIndex].currPhy = pPUC-&gt;rxPhy;</span>
<span class="gd">-          }</span>
<span class="gd">-          if(pPUC-&gt;rxPhy != connList[connIndex].rqPhy)</span>
<span class="gd">-          {</span>
<span class="gd">-            connList[connIndex].phyRqFailCnt++;</span>
<span class="gd">-          }</span>
<span class="gd">-          else</span>
<span class="gd">-          {</span>
<span class="gd">-            // Reset the request phy counter and requested phy</span>
<span class="gd">-            connList[connIndex].phyRqFailCnt = 0;</span>
<span class="gd">-            connList[connIndex].rqPhy = 0;</span>
<span class="gd">-          }</span>
<span class="gd">-        }</span>
<span class="gd">-      }</span>
<span class="gd">-</span>
<span class="gd">-      break;</span>
<span class="gd">-    }</span>
<span class="gd">-</span>
<span class="gd">-    default:</span>
<span class="gd">-      break;</span>
<span class="gd">-  } // end of switch (eventCode)</span>
<span class="gd">-}</span>
<span class="gd">-</span>
 /*********************************************************************
  * @fn      SimplePeripheral_menuSwitchCb
  *
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">simple_peripheral_menu.c</span></code></p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">index b4080aa..0c73cbb 100644</span>
<span class="gu">@@ -50,12 +50,11 @@ void SimplePeripheral_buildMenu(void)</span>
 
 // Menu: ConnPhy
 // upper: Select Device
<span class="gd">-  MENU_OBJ(spMenuConnPhy, &quot;Set Conn PHY Preference&quot;, 6, &amp;spMenuPerConn)</span>
<span class="gi">+  MENU_OBJ(spMenuConnPhy, &quot;Set Conn PHY Preference&quot;, 5, &amp;spMenuPerConn)</span>
   MENU_ITEM_ACTION(spMenuConnPhy,0,&quot;1 Mbps&quot;,              SimplePeripheral_doSetConnPhy)
   MENU_ITEM_ACTION(spMenuConnPhy,1,&quot;2 Mbps&quot;,              SimplePeripheral_doSetConnPhy)
   MENU_ITEM_ACTION(spMenuConnPhy,2,&quot;1 &amp; 2 Mbps&quot;,          SimplePeripheral_doSetConnPhy)
   MENU_ITEM_ACTION(spMenuConnPhy,3,&quot;Coded&quot;,               SimplePeripheral_doSetConnPhy)
   MENU_ITEM_ACTION(spMenuConnPhy,4,&quot;1 &amp; 2 Mbps, &amp; Coded&quot;, SimplePeripheral_doSetConnPhy)
<span class="gd">-  MENU_ITEM_ACTION(spMenuConnPhy,5,&quot;Auto PHY change&quot;,     SimplePeripheral_doSetConnPhy)</span>
   MENU_OBJ_END
 }
</pre></div>
</div>
</li>
</ul>
</div>
</li>
<li><p>Test your code. It should still compile and work smoothly!
<em>It means you can still advertise, join a connection,
pair with another device, change the Phy, etc…</em></p></li>
</ol>
</div>
<div class="section" id="remove-the-connection-parameters-update">
<h3>Remove the connection parameters update<a class="headerlink" href="#remove-the-connection-parameters-update" title="Permalink to this headline">¶</a></h3>
<p>Once a connection has been formed, one of the two devices might want to
modify the connection parameters (connection interval, slave latency,
connection timeout). This can be done using a connection parameters
update request.</p>
<p>By default, some of the examples provided (e.g. simple_peripheral) send a
connection parameters update request right after being connected.
By default, the examples are also able to accept a connection update.
Let’s see how to not send connection update request and to deny the
incoming connection updates. Note that you can choose to apply only one
of the two modifications or both of them.
The goal is to save flash space and CPU time.</p>
<ol class="arabic">
<li><p>Import the simple_peripheral project</p></li>
<li><p>Modify the code to deny all the connection parameters update requests</p>
<blockquote>
<div><ul>
<li><p>Using SysConfig, set “Parameter Updates Request Decision” to
“Deny All”. This must be done in BLE &gt; Peripheral Configuration</p>
<blockquote>
<div><div class="figure align-center" id="id4">
<img alt="../_images/SysConfig_deny_conn_update.png" src="../_images/SysConfig_deny_conn_update.png" />
<p class="caption"><span class="caption-number">Figure 123. </span><span class="caption-text">Deny all the connection parameters update requests</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
</div></blockquote>
<p>Note: If your project is not using SysConfig, you have to modify the
call to <code class="docutils literal notranslate"><span class="pre">GAP_SetParamValue(GAP_PARAM_LINK_UPDATE_DECISION,</span> <span class="pre">paramUpdateDecision)</span></code>
to ensure that the second parameter (i.e. <code class="docutils literal notranslate"><span class="pre">paramUpdateDecision</span></code>)
is set to <code class="docutils literal notranslate"><span class="pre">GAP_UPDATE_REQ_DENY_ALL</span></code></p>
</li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code>, remove all the code executed when a
<code class="docutils literal notranslate"><span class="pre">GAP_UPDATE_LINK_PARAM_REQ_EVENT</span></code> is received.
A <code class="docutils literal notranslate"><span class="pre">GAP_UPDATE_LINK_PARAM_REQ_EVENT</span></code> is triggered at the reception
of a connection parameters update requests.</p>
<div class="toggle docutils container">
<div class="header docutils container">
<p>Here is <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code> diff file (based on SDK 4.10),
click the arrow to see the changes:</p>
</div>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">index b0af31a..5b9a694 100644</span>
<span class="gu">@@ -1169,36 +1169,6 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
       break;
     }
 
<span class="gd">-    case GAP_UPDATE_LINK_PARAM_REQ_EVENT:</span>
<span class="gd">-    {</span>
<span class="gd">-      gapUpdateLinkParamReqReply_t rsp;</span>
<span class="gd">-</span>
<span class="gd">-      gapUpdateLinkParamReqEvent_t *pReq = (gapUpdateLinkParamReqEvent_t *)pMsg;</span>
<span class="gd">-</span>
<span class="gd">-      rsp.connectionHandle = pReq-&gt;req.connectionHandle;</span>
<span class="gd">-      rsp.signalIdentifier = pReq-&gt;req.signalIdentifier;</span>
<span class="gd">-</span>
<span class="gd">-      // Only accept connection intervals with slave latency of 0</span>
<span class="gd">-      // This is just an example of how the application can send a response</span>
<span class="gd">-      if(pReq-&gt;req.connLatency == 0)</span>
<span class="gd">-      {</span>
<span class="gd">-        rsp.intervalMin = pReq-&gt;req.intervalMin;</span>
<span class="gd">-        rsp.intervalMax = pReq-&gt;req.intervalMax;</span>
<span class="gd">-        rsp.connLatency = pReq-&gt;req.connLatency;</span>
<span class="gd">-        rsp.connTimeout = pReq-&gt;req.connTimeout;</span>
<span class="gd">-        rsp.accepted = TRUE;</span>
<span class="gd">-      }</span>
<span class="gd">-      else</span>
<span class="gd">-      {</span>
<span class="gd">-        rsp.accepted = FALSE;</span>
<span class="gd">-      }</span>
<span class="gd">-</span>
<span class="gd">-      // Send Reply</span>
<span class="gd">-      VOID GAP_UpdateLinkParamReqReply(&amp;rsp);</span>
<span class="gd">-</span>
<span class="gd">-      break;</span>
<span class="gd">-    }</span>
<span class="gd">-</span>
     case GAP_LINK_PARAM_UPDATE_EVENT:
     {
       gapLinkUpdateEvent_t *pPkt = (gapLinkUpdateEvent_t *)pMsg;
</pre></div>
</div>
</div>
</li>
</ul>
</div></blockquote>
</li>
</ol>
<ol class="arabic" start="3">
<li><p>Modify <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code> in order to remove the code related
to connection update:</p>
<blockquote>
<div><ul>
<li><p>Remove the treatment of the <code class="docutils literal notranslate"><span class="pre">GAP_LINK_PARAM_UPDATE_EVENT</span></code>
(this event is posted when a connection updated has been attempted)</p></li>
<li><p>Remove the <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_processParamUpdate()</span></code> function</p></li>
<li><p>Remove the treatments of <code class="docutils literal notranslate"><span class="pre">SP_SEND_PARAM_UPDATE_EVT</span></code></p></li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_addConn()</span></code>, remove the code corresponding to
connection parameters update.</p></li>
<li><p>Modify the <code class="docutils literal notranslate"><span class="pre">spConnRec_t</span></code> structure to remove the elements
<code class="docutils literal notranslate"><span class="pre">pParamUpdateEventData</span></code> and <code class="docutils literal notranslate"><span class="pre">pUpdateClock</span></code>.
Remove the code using those elements too</p></li>
<li><p>Remove the list <code class="docutils literal notranslate"><span class="pre">paramUpdateList</span></code> (and the code referring to).</p></li>
<li><p>Remove the function <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_clearPendingParamUpdate()</span></code></p>
<div class="toggle docutils container">
<div class="header docutils container">
<p>Here is <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code> diff file (based on SDK 4.10),
click the arrow to see the changes:</p>
</div>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">index b0af31a..3d0468b 100644</span>
<span class="gu">@@ -229,8 +229,6 @@ typedef struct</span>
 typedef struct
 {
   uint16_t         	    connHandle;                        // Connection Handle
<span class="gd">-  spClockEventData_t*   pParamUpdateEventData;</span>
<span class="gd">-  Clock_Struct*    	    pUpdateClock;                      // pointer to clock struct</span>
   int8_t           	    rssiArr[SP_MAX_RSSI_STORE_DEPTH];
   uint8_t          	    rssiCntr;
   int8_t           	    rssiAvg;
<span class="gu">@@ -309,9 +307,6 @@ static uint16_t menuConnHandle = LINKDB_CONNHANDLE_INVALID;</span>
 // List to store connection handles for set phy command status&#39;s
 static List_List setPhyCommStatList;
 
<span class="gd">-// List to store connection handles for queued param updates</span>
<span class="gd">-static List_List paramUpdateList;</span>
<span class="gd">-</span>
 // Auto connect Disabled/Enabled {0 - Disabled, 1- Group A , 2-Group B, ...}
 uint8_t autoConnect = AUTOCONNECT_DISABLE;
 
<span class="gu">@@ -359,7 +354,6 @@ static void SimplePeripheral_updatePHYStat(uint16_t eventCode, uint8_t *pMsg);</span>
 static uint8_t SimplePeripheral_addConn(uint16_t connHandle);
 static uint8_t SimplePeripheral_getConnIndex(uint16_t connHandle);
 static uint8_t SimplePeripheral_removeConn(uint16_t connHandle);
<span class="gd">-static void SimplePeripheral_processParamUpdate(uint16_t connHandle);</span>
 static status_t SimplePeripheral_startAutoPhyChange(uint16_t connHandle);
 static status_t SimplePeripheral_stopAutoPhyChange(uint16_t connHandle);
 static status_t SimplePeripheral_setPhy(uint16_t connHandle, uint8_t allPhys,
<span class="gu">@@ -953,18 +947,6 @@ static void SimplePeripheral_processAppMsg(spEvt_t *pMsg)</span>
       SimplePeripheral_updateRPA();
       break;
 
<span class="gd">-    case SP_SEND_PARAM_UPDATE_EVT:</span>
<span class="gd">-    {</span>
<span class="gd">-      // Extract connection handle from data</span>
<span class="gd">-      uint16_t connHandle = *(uint16_t *)(((spClockEventData_t *)pMsg-&gt;pData)-&gt;data);</span>
<span class="gd">-</span>
<span class="gd">-      SimplePeripheral_processParamUpdate(connHandle);</span>
<span class="gd">-</span>
<span class="gd">-      // This data is not dynamically allocated</span>
<span class="gd">-      dealloc = FALSE;</span>
<span class="gd">-      break;</span>
<span class="gd">-    }</span>
<span class="gd">-</span>
     case SP_CONN_EVT:
       SimplePeripheral_processConnEvt((Gap_ConnEventRpt_t *)(pMsg-&gt;pData));
       break;
<span class="gu">@@ -1199,42 +1181,6 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
       break;
     }
 
<span class="gd">-    case GAP_LINK_PARAM_UPDATE_EVENT:</span>
<span class="gd">-    {</span>
<span class="gd">-      gapLinkUpdateEvent_t *pPkt = (gapLinkUpdateEvent_t *)pMsg;</span>
<span class="gd">-</span>
<span class="gd">-      // Get the address from the connection handle</span>
<span class="gd">-      linkDBInfo_t linkInfo;</span>
<span class="gd">-      linkDB_GetInfo(pPkt-&gt;connectionHandle, &amp;linkInfo);</span>
<span class="gd">-</span>
<span class="gd">-      if(pPkt-&gt;status == SUCCESS)</span>
<span class="gd">-      {</span>
<span class="gd">-        // Display the address of the connection update</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_STATUS_2, 0, &quot;Link Param Updated: %s&quot;,</span>
<span class="gd">-                       Util_convertBdAddr2Str(linkInfo.addr));</span>
<span class="gd">-      }</span>
<span class="gd">-      else</span>
<span class="gd">-      {</span>
<span class="gd">-        // Display the address of the connection update failure</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_STATUS_2, 0,</span>
<span class="gd">-                       &quot;Link Param Update Failed 0x%x: %s&quot;, pPkt-&gt;opcode,</span>
<span class="gd">-                       Util_convertBdAddr2Str(linkInfo.addr));</span>
<span class="gd">-      }</span>
<span class="gd">-</span>
<span class="gd">-      // Check if there are any queued parameter updates</span>
<span class="gd">-      spConnHandleEntry_t *connHandleEntry = (spConnHandleEntry_t *)List_get(&amp;paramUpdateList);</span>
<span class="gd">-      if (connHandleEntry != NULL)</span>
<span class="gd">-      {</span>
<span class="gd">-        // Attempt to send queued update now</span>
<span class="gd">-        SimplePeripheral_processParamUpdate(connHandleEntry-&gt;connHandle);</span>
<span class="gd">-</span>
<span class="gd">-        // Free list element</span>
<span class="gd">-        ICall_free(connHandleEntry);</span>
<span class="gd">-      }</span>
<span class="gd">-</span>
<span class="gd">-      break;</span>
<span class="gd">-    }</span>
<span class="gd">-</span>
     default:
       Display_clearLines(dispHandle, SP_ROW_STATUS_1, SP_ROW_STATUS_2);
       break;
<span class="gu">@@ -1382,11 +1328,6 @@ static void SimplePeripheral_clockHandler(UArg arg)</span>
    // Post event to read the current RPA
    SimplePeripheral_enqueueMsg(SP_READ_RPA_EVT, NULL);
  }
<span class="gd">- else if (pData-&gt;event == SP_SEND_PARAM_UPDATE_EVT)</span>
<span class="gd">- {</span>
<span class="gd">-    // Send message to app</span>
<span class="gd">-    SimplePeripheral_enqueueMsg(SP_SEND_PARAM_UPDATE_EVT, pData);</span>
<span class="gd">- }</span>
 }
 
 /*********************************************************************
<span class="gu">@@ -1894,35 +1835,6 @@ static uint8_t SimplePeripheral_addConn(uint16_t connHandle)</span>
       // Found available entry to put a new connection info in
       connList[i].connHandle = connHandle;
 
<span class="gd">-      // Allocate data to send through clock handler</span>
<span class="gd">-      connList[i].pParamUpdateEventData = ICall_malloc(sizeof(spClockEventData_t) +</span>
<span class="gd">-                                                       sizeof (uint16_t));</span>
<span class="gd">-      if(connList[i].pParamUpdateEventData)</span>
<span class="gd">-      {</span>
<span class="gd">-        connList[i].pParamUpdateEventData-&gt;event = SP_SEND_PARAM_UPDATE_EVT;</span>
<span class="gd">-        *((uint16_t *)connList[i].pParamUpdateEventData-&gt;data) = connHandle;</span>
<span class="gd">-</span>
<span class="gd">-        // Create a clock object and start</span>
<span class="gd">-        connList[i].pUpdateClock</span>
<span class="gd">-          = (Clock_Struct*) ICall_malloc(sizeof(Clock_Struct));</span>
<span class="gd">-</span>
<span class="gd">-        if (connList[i].pUpdateClock)</span>
<span class="gd">-        {</span>
<span class="gd">-          Util_constructClock(connList[i].pUpdateClock,</span>
<span class="gd">-                              SimplePeripheral_clockHandler,</span>
<span class="gd">-                              SEND_PARAM_UPDATE_DELAY, 0, true,</span>
<span class="gd">-                              (UArg) (connList[i].pParamUpdateEventData));</span>
<span class="gd">-        }</span>
<span class="gd">-        else</span>
<span class="gd">-        {</span>
<span class="gd">-            ICall_free(connList[i].pParamUpdateEventData);</span>
<span class="gd">-        }</span>
<span class="gd">-      }</span>
<span class="gd">-      else</span>
<span class="gd">-      {</span>
<span class="gd">-        status = bleMemAllocError;</span>
<span class="gd">-      }</span>
<span class="gd">-</span>
       // Set default PHY to 1M
       connList[i].currPhy = HCI_PHY_1_MBPS;
 
<span class="gu">@@ -2000,28 +1912,6 @@ static uint8_t SimplePeripheral_clearConnListEntry(uint16_t connHandle)</span>
   return(SUCCESS);
 }
 
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimplePeripheral_clearPendingParamUpdate</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   clean pending param update request in the paramUpdateList list</span>
<span class="gd">- *</span>
<span class="gd">- * @param   connHandle - connection handle to clean</span>
<span class="gd">- *</span>
<span class="gd">- * @return  none</span>
<span class="gd">- */</span>
<span class="gd">-void SimplePeripheral_clearPendingParamUpdate(uint16_t connHandle)</span>
<span class="gd">-{</span>
<span class="gd">-  List_Elem *curr;</span>
<span class="gd">-</span>
<span class="gd">-  for (curr = List_head(&amp;paramUpdateList); curr != NULL; curr = List_next(curr)) </span>
<span class="gd">-  {</span>
<span class="gd">-    if (((spConnHandleEntry_t *)curr)-&gt;connHandle == connHandle)</span>
<span class="gd">-    {</span>
<span class="gd">-      List_remove(&amp;paramUpdateList, curr);</span>
<span class="gd">-    }</span>
<span class="gd">-  }</span>
<span class="gd">-}</span>
<span class="gd">-</span>
 /*********************************************************************
  * @fn      SimplePeripheral_removeConn
  *
<span class="gu">@@ -2037,25 +1927,6 @@ static uint8_t SimplePeripheral_removeConn(uint16_t connHandle)</span>
 
   if(connIndex != MAX_NUM_BLE_CONNS)
   {
<span class="gd">-    Clock_Struct* pUpdateClock = connList[connIndex].pUpdateClock;</span>
<span class="gd">-</span>
<span class="gd">-    if (pUpdateClock != NULL)</span>
<span class="gd">-    {</span>
<span class="gd">-      // Stop and destruct the RTOS clock if it&#39;s still alive</span>
<span class="gd">-      if (Util_isActive(pUpdateClock))</span>
<span class="gd">-      {</span>
<span class="gd">-        Util_stopClock(pUpdateClock);</span>
<span class="gd">-      }</span>
<span class="gd">-</span>
<span class="gd">-      // Destruct the clock object</span>
<span class="gd">-      Clock_destruct(pUpdateClock);</span>
<span class="gd">-      // Free clock struct</span>
<span class="gd">-      ICall_free(pUpdateClock);</span>
<span class="gd">-      // Free ParamUpdateEventData</span>
<span class="gd">-      ICall_free(connList[connIndex].pParamUpdateEventData);</span>
<span class="gd">-    }</span>
<span class="gd">-    // Clear pending update requests from paramUpdateList</span>
<span class="gd">-    SimplePeripheral_clearPendingParamUpdate(connHandle);</span>
     // Stop Auto PHY Change
     SimplePeripheral_stopAutoPhyChange(connHandle);
     // Clear Connection List Entry
<span class="gu">@@ -2065,59 +1936,6 @@ static uint8_t SimplePeripheral_removeConn(uint16_t connHandle)</span>
   return connIndex;
 }
 
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimplePeripheral_processParamUpdate</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Process a parameters update request</span>
<span class="gd">- *</span>
<span class="gd">- * @return  None</span>
<span class="gd">- */</span>
<span class="gd">-static void SimplePeripheral_processParamUpdate(uint16_t connHandle)</span>
<span class="gd">-{</span>
<span class="gd">-  gapUpdateLinkParamReq_t req;</span>
<span class="gd">-  uint8_t connIndex;</span>
<span class="gd">-</span>
<span class="gd">-  req.connectionHandle = connHandle;</span>
<span class="gd">-  req.connLatency = DEFAULT_DESIRED_SLAVE_LATENCY;</span>
<span class="gd">-  req.connTimeout = DEFAULT_DESIRED_CONN_TIMEOUT;</span>
<span class="gd">-  req.intervalMin = DEFAULT_DESIRED_MIN_CONN_INTERVAL;</span>
<span class="gd">-  req.intervalMax = DEFAULT_DESIRED_MAX_CONN_INTERVAL;</span>
<span class="gd">-</span>
<span class="gd">-  connIndex = SimplePeripheral_getConnIndex(connHandle);</span>
<span class="gd">-  if (connIndex &gt;= MAX_NUM_BLE_CONNS)</span>
<span class="gd">-  {</span>
<span class="gd">-    Display_printf(dispHandle, SP_ROW_STATUS_1, 0, &quot;Connection handle is not in the connList !!!&quot;);</span>
<span class="gd">-    return;</span>
<span class="gd">-  }</span>
<span class="gd">-</span>
<span class="gd">-  // Deconstruct the clock object</span>
<span class="gd">-  Clock_destruct(connList[connIndex].pUpdateClock);</span>
<span class="gd">-  // Free clock struct, only in case it is not NULL</span>
<span class="gd">-  if (connList[connIndex].pUpdateClock != NULL)</span>
<span class="gd">-  {</span>
<span class="gd">-      ICall_free(connList[connIndex].pUpdateClock);</span>
<span class="gd">-      connList[connIndex].pUpdateClock = NULL;</span>
<span class="gd">-  }</span>
<span class="gd">-  // Free ParamUpdateEventData, only in case it is not NULL</span>
<span class="gd">-  if (connList[connIndex].pParamUpdateEventData != NULL)</span>
<span class="gd">-      ICall_free(connList[connIndex].pParamUpdateEventData);</span>
<span class="gd">-</span>
<span class="gd">-  // Send parameter update</span>
<span class="gd">-  bStatus_t status = GAP_UpdateLinkParamReq(&amp;req);</span>
<span class="gd">-</span>
<span class="gd">-  // If there is an ongoing update, queue this for when the udpate completes</span>
<span class="gd">-  if (status == bleAlreadyInRequestedMode)</span>
<span class="gd">-  {</span>
<span class="gd">-    spConnHandleEntry_t *connHandleEntry = ICall_malloc(sizeof(spConnHandleEntry_t));</span>
<span class="gd">-    if (connHandleEntry)</span>
<span class="gd">-    {</span>
<span class="gd">-      connHandleEntry-&gt;connHandle = connHandle;</span>
<span class="gd">-</span>
<span class="gd">-      List_put(&amp;paramUpdateList, (List_Elem *)connHandleEntry);</span>
<span class="gd">-    }</span>
<span class="gd">-  }</span>
<span class="gd">-}</span>
<span class="gd">-</span>
 /*********************************************************************
  * @fn      SimpleCentral_processCmdCompleteEvt
  *
</pre></div>
</div>
</div>
</li>
</ul>
</div></blockquote>
</li>
<li><p>Test your code. It should still compile and work smoothly!
<em>It means you can still advertise, join a connection,
pair with another device, change the Phy, etc…</em></p></li>
</ol>
</div>
<div class="section" id="remove-the-pairing-capabilities">
<h3>Remove the pairing capabilities<a class="headerlink" href="#remove-the-pairing-capabilities" title="Permalink to this headline">¶</a></h3>
<p>Pairing is the process of generating and exchanging keys (not to be confused
with forming or establishing a BLE connection between two devices).
The pairing capability is included in many examples provided in your SDK.</p>
<p>As bonding consists in storing the keys generated during the pairing process
in nonvolatile memory to use for the next encryption sequence, this
functionality will be removed too.</p>
<p>This modification should free up some FLASH and some CPU time.</p>
<ol class="arabic">
<li><p>Import the simple_peripheral project</p></li>
<li><p>Using SysConfig, disable pairing and bonding capabilities.
This must be done in BLE &gt; Bond Manager</p>
<blockquote>
<div><div class="figure align-center" id="id5">
<img alt="../_images/SysConfig_disable_pairing_bonding.png" src="../_images/SysConfig_disable_pairing_bonding.png" />
<p class="caption"><span class="caption-number">Figure 124. </span><span class="caption-text">Disable pairing and bonding capabilities</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
</div></blockquote>
</li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code>, remove the code related to pairing and bonding.</p>
<blockquote>
<div><ul>
<li><p>Remove the callback-functions <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_passcodeCb()</span></code> and
<code class="docutils literal notranslate"><span class="pre">SimplePeripheral_pairStateCb()</span></code></p></li>
<li><p>Remove the structure <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_BondMgrCBs</span></code>.</p></li>
<li><p>Remove the call to the function <code class="docutils literal notranslate"><span class="pre">GAPBondMgr_Register()</span></code></p></li>
<li><p>Remove the function <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_processPairState()</span></code> and its calls.</p></li>
<li><p>Remove the function <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_processPasscode()</span></code> and its calls.</p>
<div class="toggle docutils container">
<div class="header docutils container">
<p>Here is <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code> diff file (based on SDK 4.10),
click the arrow to see the changes:</p>
</div>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">index b0af31a..d8244a6 100644</span>
<span class="gu">@@ -179,28 +179,6 @@ typedef struct</span>
   void    *pData;               // pointer to message
 } spEvt_t;
 
<span class="gd">-// Container to store passcode data when passing from gapbondmgr callback</span>
<span class="gd">-// to app event. See the pfnPairStateCB_t documentation from the gapbondmgr.h</span>
<span class="gd">-// header file for more information on each parameter.</span>
<span class="gd">-typedef struct</span>
<span class="gd">-{</span>
<span class="gd">-  uint8_t state;</span>
<span class="gd">-  uint16_t connHandle;</span>
<span class="gd">-  uint8_t status;</span>
<span class="gd">-} spPairStateData_t;</span>
<span class="gd">-</span>
<span class="gd">-// Container to store passcode data when passing from gapbondmgr callback</span>
<span class="gd">-// to app event. See the pfnPasscodeCB_t documentation from the gapbondmgr.h</span>
<span class="gd">-// header file for more information on each parameter.</span>
<span class="gd">-typedef struct</span>
<span class="gd">-{</span>
<span class="gd">-  uint8_t deviceAddr[B_ADDR_LEN];</span>
<span class="gd">-  uint16_t connHandle;</span>
<span class="gd">-  uint8_t uiInputs;</span>
<span class="gd">-  uint8_t uiOutputs;</span>
<span class="gd">-  uint32_t numComparison;</span>
<span class="gd">-} spPasscodeData_t;</span>
<span class="gd">-</span>
 // Container to store advertising event data when passing from advertising
 // callback to app event. See the respective event in GapAdvScan_Event_IDs
 // in gap_advertiser.h for the type that pBuf should be cast to.
<span class="gu">@@ -342,13 +320,6 @@ static void SimplePeripheral_processCharValueChangeEvt(uint8_t paramId);</span>
 static void SimplePeripheral_performPeriodicTask(void);
 static void SimplePeripheral_updateRPA(void);
 static void SimplePeripheral_clockHandler(UArg arg);
<span class="gd">-static void SimplePeripheral_passcodeCb(uint8_t *pDeviceAddr, uint16_t connHandle,</span>
<span class="gd">-                                        uint8_t uiInputs, uint8_t uiOutputs,</span>
<span class="gd">-                                        uint32_t numComparison);</span>
<span class="gd">-static void SimplePeripheral_pairStateCb(uint16_t connHandle, uint8_t state,</span>
<span class="gd">-                                         uint8_t status);</span>
<span class="gd">-static void SimplePeripheral_processPairState(spPairStateData_t *pPairState);</span>
<span class="gd">-static void SimplePeripheral_processPasscode(spPasscodeData_t *pPasscodeData);</span>
 static void SimplePeripheral_charValueChangeCB(uint8_t paramId);
 static status_t SimplePeripheral_enqueueMsg(uint8_t event, void *pData);
 static void SimplePeripheral_keyChangeHandler(uint8 keys);
<span class="gu">@@ -384,13 +355,6 @@ extern void AssertHandler(uint8 assertCause, uint8 assertSubcause);</span>
  * PROFILE CALLBACKS
  */
 
<span class="gd">-// GAP Bond Manager Callbacks</span>
<span class="gd">-static gapBondCBs_t SimplePeripheral_BondMgrCBs =</span>
<span class="gd">-{</span>
<span class="gd">-  SimplePeripheral_passcodeCb,       // Passcode callback</span>
<span class="gd">-  SimplePeripheral_pairStateCb       // Pairing/Bonding state Callback</span>
<span class="gd">-};</span>
<span class="gd">-</span>
 // Simple GATT Profile Callbacks
 static simpleProfileCBs_t SimplePeripheral_simpleProfileCBs =
 {
<span class="gu">@@ -573,9 +537,6 @@ static void SimplePeripheral_init(void)</span>
   // Register callback with SimpleGATTprofile
   SimpleProfile_RegisterAppCBs(&amp;SimplePeripheral_simpleProfileCBs);
 
<span class="gd">-  // Start Bond Manager and register callback</span>
<span class="gd">-  VOID GAPBondMgr_Register(&amp;SimplePeripheral_BondMgrCBs);</span>
<span class="gd">-</span>
   // Register with GAP for HCI/Host messages. This is needed to receive HCI
   // events. For more information, see the HCI section in the User&#39;s Guide:
   // http://software-dl.ti.com/lprf/ble5stack-latest/
<span class="gu">@@ -937,14 +898,6 @@ static void SimplePeripheral_processAppMsg(spEvt_t *pMsg)</span>
       SimplePeripheral_processAdvEvent((spGapAdvEventData_t*)(pMsg-&gt;pData));
       break;
 
<span class="gd">-    case SP_PAIR_STATE_EVT:</span>
<span class="gd">-      SimplePeripheral_processPairState((spPairStateData_t*)(pMsg-&gt;pData));</span>
<span class="gd">-      break;</span>
<span class="gd">-</span>
<span class="gd">-    case SP_PASSCODE_EVT:</span>
<span class="gd">-      SimplePeripheral_processPasscode((spPasscodeData_t*)(pMsg-&gt;pData));</span>
<span class="gd">-      break;</span>
<span class="gd">-</span>
     case SP_PERIODIC_EVT:
       SimplePeripheral_performPeriodicTask();
       break;
<span class="gu">@@ -1575,143 +1528,6 @@ static void SimplePeripheral_processAdvEvent(spGapAdvEventData_t *pEventData)</span>
   }
 }
 
<span class="gd">-</span>
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimplePeripheral_pairStateCb</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Pairing state callback.</span>
<span class="gd">- *</span>
<span class="gd">- * @return  none</span>
<span class="gd">- */</span>
<span class="gd">-static void SimplePeripheral_pairStateCb(uint16_t connHandle, uint8_t state,</span>
<span class="gd">-                                         uint8_t status)</span>
<span class="gd">-{</span>
<span class="gd">-  spPairStateData_t *pData = ICall_malloc(sizeof(spPairStateData_t));</span>
<span class="gd">-</span>
<span class="gd">-  // Allocate space for the event data.</span>
<span class="gd">-  if (pData)</span>
<span class="gd">-  {</span>
<span class="gd">-    pData-&gt;state = state;</span>
<span class="gd">-    pData-&gt;connHandle = connHandle;</span>
<span class="gd">-    pData-&gt;status = status;</span>
<span class="gd">-</span>
<span class="gd">-    // Queue the event.</span>
<span class="gd">-    if(SimplePeripheral_enqueueMsg(SP_PAIR_STATE_EVT, pData) != SUCCESS)</span>
<span class="gd">-    {</span>
<span class="gd">-      ICall_free(pData);</span>
<span class="gd">-    }</span>
<span class="gd">-  }</span>
<span class="gd">-}</span>
<span class="gd">-</span>
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimplePeripheral_passcodeCb</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Passcode callback.</span>
<span class="gd">- *</span>
<span class="gd">- * @return  none</span>
<span class="gd">- */</span>
<span class="gd">-static void SimplePeripheral_passcodeCb(uint8_t *pDeviceAddr,</span>
<span class="gd">-                                        uint16_t connHandle,</span>
<span class="gd">-                                        uint8_t uiInputs,</span>
<span class="gd">-                                        uint8_t uiOutputs,</span>
<span class="gd">-                                        uint32_t numComparison)</span>
<span class="gd">-{</span>
<span class="gd">-  spPasscodeData_t *pData = ICall_malloc(sizeof(spPasscodeData_t));</span>
<span class="gd">-</span>
<span class="gd">-  // Allocate space for the passcode event.</span>
<span class="gd">-  if (pData )</span>
<span class="gd">-  {</span>
<span class="gd">-    pData-&gt;connHandle = connHandle;</span>
<span class="gd">-    memcpy(pData-&gt;deviceAddr, pDeviceAddr, B_ADDR_LEN);</span>
<span class="gd">-    pData-&gt;uiInputs = uiInputs;</span>
<span class="gd">-    pData-&gt;uiOutputs = uiOutputs;</span>
<span class="gd">-    pData-&gt;numComparison = numComparison;</span>
<span class="gd">-</span>
<span class="gd">-    // Enqueue the event.</span>
<span class="gd">-    if(SimplePeripheral_enqueueMsg(SP_PASSCODE_EVT, pData) != SUCCESS)</span>
<span class="gd">-    {</span>
<span class="gd">-      ICall_free(pData);</span>
<span class="gd">-    }</span>
<span class="gd">-  }</span>
<span class="gd">-}</span>
<span class="gd">-</span>
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimplePeripheral_processPairState</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Process the new paring state.</span>
<span class="gd">- *</span>
<span class="gd">- * @return  none</span>
<span class="gd">- */</span>
<span class="gd">-static void SimplePeripheral_processPairState(spPairStateData_t *pPairData)</span>
<span class="gd">-{</span>
<span class="gd">-  uint8_t state = pPairData-&gt;state;</span>
<span class="gd">-  uint8_t status = pPairData-&gt;status;</span>
<span class="gd">-</span>
<span class="gd">-  switch (state)</span>
<span class="gd">-  {</span>
<span class="gd">-    case GAPBOND_PAIRING_STATE_STARTED:</span>
<span class="gd">-      Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Pairing started&quot;);</span>
<span class="gd">-      break;</span>
<span class="gd">-</span>
<span class="gd">-    case GAPBOND_PAIRING_STATE_COMPLETE:</span>
<span class="gd">-      if (status == SUCCESS)</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Pairing success&quot;);</span>
<span class="gd">-      }</span>
<span class="gd">-      else</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Pairing fail: %d&quot;, status);</span>
<span class="gd">-      }</span>
<span class="gd">-      break;</span>
<span class="gd">-</span>
<span class="gd">-    case GAPBOND_PAIRING_STATE_ENCRYPTED:</span>
<span class="gd">-      if (status == SUCCESS)</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Encryption success&quot;);</span>
<span class="gd">-      }</span>
<span class="gd">-      else</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Encryption failed: %d&quot;, status);</span>
<span class="gd">-      }</span>
<span class="gd">-      break;</span>
<span class="gd">-</span>
<span class="gd">-    case GAPBOND_PAIRING_STATE_BOND_SAVED:</span>
<span class="gd">-      if (status == SUCCESS)</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Bond save success&quot;);</span>
<span class="gd">-      }</span>
<span class="gd">-      else</span>
<span class="gd">-      {</span>
<span class="gd">-        Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Bond save failed: %d&quot;, status);</span>
<span class="gd">-      }</span>
<span class="gd">-      break;</span>
<span class="gd">-</span>
<span class="gd">-    default:</span>
<span class="gd">-      break;</span>
<span class="gd">-  }</span>
<span class="gd">-}</span>
<span class="gd">-</span>
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimplePeripheral_processPasscode</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Process the Passcode request.</span>
<span class="gd">- *</span>
<span class="gd">- * @return  none</span>
<span class="gd">- */</span>
<span class="gd">-static void SimplePeripheral_processPasscode(spPasscodeData_t *pPasscodeData)</span>
<span class="gd">-{</span>
<span class="gd">-  // Display passcode to user</span>
<span class="gd">-  if (pPasscodeData-&gt;uiOutputs != 0)</span>
<span class="gd">-  {</span>
<span class="gd">-    Display_printf(dispHandle, SP_ROW_CONNECTION, 0, &quot;Passcode: %d&quot;,</span>
<span class="gd">-                   B_APP_DEFAULT_PASSCODE);</span>
<span class="gd">-  }</span>
<span class="gd">-</span>
<span class="gd">-  // Send passcode response</span>
<span class="gd">-  GAPBondMgr_PasscodeRsp(pPasscodeData-&gt;connHandle , SUCCESS,</span>
<span class="gd">-                         B_APP_DEFAULT_PASSCODE);</span>
<span class="gd">-}</span>
<span class="gd">-</span>
 /*********************************************************************
  * @fn      SimplePeripheral_connEvtCB
  *
</pre></div>
</div>
</div>
</li>
</ul>
</div></blockquote>
</li>
<li><p>Rebuild your project.</p></li>
<li><p>The Flash consumption can be even more decreased by not linking and/or
compiling any of the code related to pairing and/or pairing.
To do so, the pre-defined symbol <code class="docutils literal notranslate"><span class="pre">GAP_BOND_MGR</span></code> must not be declared.</p>
<p><strong>If your project is using SysConfig:</strong>
By default <code class="docutils literal notranslate"><span class="pre">GAP_BOND_MGR</span></code> is declared in the file <code class="docutils literal notranslate"><span class="pre">ti_build_config.opt</span></code>
(in the folder Debug/syscfg of your project). The file <code class="docutils literal notranslate"><span class="pre">ti_build_config.opt</span></code>
cannot be directly altered as it is generated by SysConfig.</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="../sysconfig/sysconfig-disable.html#sysconfig-disable"><span class="std std-ref">Disable SysConfig</span></a> and remove the declaration of the
symbol <code class="docutils literal notranslate"><span class="pre">GAP_BOND_MGR</span></code> in the file <code class="docutils literal notranslate"><span class="pre">ti_build_config.opt</span></code>.</p></li>
</ul>
<p><strong>OR</strong></p>
<ul class="simple">
<li><p>Change the way SysConfig is generating the ti_build_config.opt file.
SysConfig is using a template that can be modified. The
template to be considered is in the SDK in
<code class="docutils literal notranslate"><span class="pre">source\ti\ble5stack\.meta\templates\build_config.opt.xdt</span></code>.
Remove the declaration of the symbol <code class="docutils literal notranslate"><span class="pre">GAP_BOND_MGR</span></code> in the file
<code class="docutils literal notranslate"><span class="pre">build_config.opt.xdt</span></code>.</p></li>
</ul>
</div></blockquote>
<p><strong>If your project is not using SysConfig:</strong>
In general <code class="docutils literal notranslate"><span class="pre">GAP_BOND_MGR</span></code> is declared in the file build_config.opt.
Remove the declaration of the symbol in the appropriate file.</p>
</li>
<li><p>Rebuild and test your code. It should still build and work smoothly!
<em>It means you can still advertise, join a connection,
change the Phy, etc…</em></p></li>
</ol>
</div>
<div class="section" id="remove-the-resolvable-private-address-rpa-functionality">
<h3>Remove the Resolvable Private Address (RPA) functionality<a class="headerlink" href="#remove-the-resolvable-private-address-rpa-functionality" title="Permalink to this headline">¶</a></h3>
<p>(Random) Resolvable Private Address or RPA is a functionality helping
to preserve privacy. It consists in changing the device address over time.
The address can be matched, or resolved, to an Identity Address for
tracking by trusted peers.</p>
<p>This functionality is provided in several examples and can be removed
in order to save memory and CPU time.</p>
<ol class="arabic">
<li><p>Import the simple_peripheral project</p></li>
<li><p>Using SysConfig, go to <em>BLE &gt; General Configuration &gt; Address Mode</em> and
verify you are not using an RPA. Chose, for example “Random Static Address”.
Specify the random static address you want.</p>
<blockquote>
<div><div class="figure align-center" id="id6">
<img alt="../_images/SysConfig_disable_RPA.png" src="../_images/SysConfig_disable_RPA.png" />
<p class="caption"><span class="caption-number">Figure 125. </span><span class="caption-text">Select a non-RPA address mode</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</div>
</div></blockquote>
</li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code>, remove the code related to RPA.</p>
<blockquote>
<div><ul>
<li><p>Remove the function <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_updateRPA()</span></code> and all its calls</p></li>
<li><p>Remove the global variable <code class="docutils literal notranslate"><span class="pre">argRpaRead</span></code> and all the code using it</p></li>
<li><p>Remove the clock structure <code class="docutils literal notranslate"><span class="pre">clkRpaRead</span></code> and all the code using it</p></li>
<li><p>Remove the code handling the <code class="docutils literal notranslate"><span class="pre">SP_READ_RPA_EVT</span></code> events</p></li>
<li><p>Remove the global variable <code class="docutils literal notranslate"><span class="pre">rpa[]</span></code> (and all the code using it if
some is remaining)</p>
<div class="toggle docutils container">
<div class="header docutils container">
<p>Here is <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code> diff file (based on SDK 4.10),
click the arrow to see the changes:</p>
</div>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">index b0af31a..c261222 100644</span>
<span class="gu">@@ -289,17 +289,11 @@ static Queue_Handle appMsgQueueHandle;</span>
 // Clock instance for internal periodic events. Only one is needed since
 // GattServApp will handle notifying all connected GATT clients
 static Clock_Struct clkPeriodic;
<span class="gd">-// Clock instance for RPA read events.</span>
<span class="gd">-static Clock_Struct clkRpaRead;</span>
 
 // Memory to pass periodic event ID to clock handler
 spClockEventData_t argPeriodic =
 { .event = SP_PERIODIC_EVT };
 
<span class="gd">-// Memory to pass RPA read event ID to clock handler</span>
<span class="gd">-spClockEventData_t argRpaRead =</span>
<span class="gd">-{ .event = SP_READ_RPA_EVT };</span>
<span class="gd">-</span>
 // Per-handle connection info
 static spConnRec_t connList[MAX_NUM_BLE_CONNS];
 
<span class="gu">@@ -322,9 +316,6 @@ static uint8 advHandleLongRange;</span>
 // Address mode
 static GAP_Addr_Modes_t addrMode = DEFAULT_ADDRESS_MODE;
 
<span class="gd">-// Current Random Private Address</span>
<span class="gd">-static uint8 rpa[B_ADDR_LEN] = {0};</span>
<span class="gd">-</span>
 /*********************************************************************
  * LOCAL FUNCTIONS
  */
<span class="gu">@@ -340,7 +331,6 @@ static void SimplePeripheral_processAdvEvent(spGapAdvEventData_t *pEventData);</span>
 static void SimplePeripheral_processAppMsg(spEvt_t *pMsg);
 static void SimplePeripheral_processCharValueChangeEvt(uint8_t paramId);
 static void SimplePeripheral_performPeriodicTask(void);
<span class="gd">-static void SimplePeripheral_updateRPA(void);</span>
 static void SimplePeripheral_clockHandler(UArg arg);
 static void SimplePeripheral_passcodeCb(uint8_t *pDeviceAddr, uint16_t connHandle,
                                         uint8_t uiInputs, uint8_t uiOutputs,
<span class="gu">@@ -949,10 +939,6 @@ static void SimplePeripheral_processAppMsg(spEvt_t *pMsg)</span>
       SimplePeripheral_performPeriodicTask();
       break;
 
<span class="gd">-    case SP_READ_RPA_EVT:</span>
<span class="gd">-      SimplePeripheral_updateRPA();</span>
<span class="gd">-      break;</span>
<span class="gd">-</span>
     case SP_SEND_PARAM_UPDATE_EVT:
     {
       // Extract connection handle from data
<span class="gu">@@ -1080,15 +1066,6 @@ static void SimplePeripheral_processGapMessage(gapEventHdr_t *pMsg)</span>
                        (addrMode &lt;= ADDRMODE_RANDOM) ? &quot;Dev&quot; : &quot;ID&quot;,
                        Util_convertBdAddr2Str(pPkt-&gt;devAddr));
 
<span class="gd">-        if (addrMode &gt; ADDRMODE_RANDOM)</span>
<span class="gd">-        {</span>
<span class="gd">-          SimplePeripheral_updateRPA();</span>
<span class="gd">-</span>
<span class="gd">-          // Create one-shot clock for RPA check event.</span>
<span class="gd">-          Util_constructClock(&amp;clkRpaRead, SimplePeripheral_clockHandler,</span>
<span class="gd">-                              READ_RPA_PERIOD, 0, true,</span>
<span class="gd">-                              (UArg) &amp;argRpaRead);</span>
<span class="gd">-        }</span>
         tbm_setItemStatus(&amp;spMenuMain, SP_ITEM_AUTOCONNECT, TBM_ITEM_NONE);
       }
 
<span class="gu">@@ -1327,32 +1304,6 @@ static void SimplePeripheral_performPeriodicTask(void)</span>
   }
 }
 
<span class="gd">-/*********************************************************************</span>
<span class="gd">- * @fn      SimplePeripheral_updateRPA</span>
<span class="gd">- *</span>
<span class="gd">- * @brief   Read the current RPA from the stack and update display</span>
<span class="gd">- *          if the RPA has changed.</span>
<span class="gd">- *</span>
<span class="gd">- * @param   None.</span>
<span class="gd">- *</span>
<span class="gd">- * @return  None.</span>
<span class="gd">- */</span>
<span class="gd">-static void SimplePeripheral_updateRPA(void)</span>
<span class="gd">-{</span>
<span class="gd">-  uint8_t* pRpaNew;</span>
<span class="gd">-</span>
<span class="gd">-  // Read the current RPA.</span>
<span class="gd">-  pRpaNew = GAP_GetDevAddress(FALSE);</span>
<span class="gd">-</span>
<span class="gd">-  if (memcmp(pRpaNew, rpa, B_ADDR_LEN))</span>
<span class="gd">-  {</span>
<span class="gd">-    // If the RPA has changed, update the display</span>
<span class="gd">-    Display_printf(dispHandle, SP_ROW_RPA, 0, &quot;RP Addr: %s&quot;,</span>
<span class="gd">-                   Util_convertBdAddr2Str(pRpaNew));</span>
<span class="gd">-    memcpy(rpa, pRpaNew, B_ADDR_LEN);</span>
<span class="gd">-  }</span>
<span class="gd">-}</span>
<span class="gd">-</span>
 /*********************************************************************
  * @fn      SimplePeripheral_clockHandler
  *
<span class="gu">@@ -1374,14 +1325,6 @@ static void SimplePeripheral_clockHandler(UArg arg)</span>
    // Post event to wake up the application
    SimplePeripheral_enqueueMsg(SP_PERIODIC_EVT, NULL);
  }
<span class="gd">- else if (pData-&gt;event == SP_READ_RPA_EVT)</span>
<span class="gd">- {</span>
<span class="gd">-   // Start the next period</span>
<span class="gd">-   Util_startClock(&amp;clkRpaRead);</span>
<span class="gd">-</span>
<span class="gd">-   // Post event to read the current RPA</span>
<span class="gd">-   SimplePeripheral_enqueueMsg(SP_READ_RPA_EVT, NULL);</span>
<span class="gd">- }</span>
  else if (pData-&gt;event == SP_SEND_PARAM_UPDATE_EVT)
  {
     // Send message to app
</pre></div>
</div>
</div>
</li>
</ul>
</div></blockquote>
</li>
<li><p>Test your code. It should still compile and work smoothly!
<em>It means you can still advertise, join a connection,
pair with another device, change the Phy, etc…</em></p></li>
</ol>
</div>
<div class="section" id="remove-the-gatt-client-functionality">
<span id="creating-a-custom-ble-app-directed-advertisements"></span><h3>Remove the GATT Client functionality<a class="headerlink" href="#remove-the-gatt-client-functionality" title="Permalink to this headline">¶</a></h3>
<p>Depending on your design, GATT client features may not
be required and thus can be disabled.</p>
<p>The implication of disabling the GATT client is that the GAP bond manager
will not query the Central Address Resolution characteristic of the remote
device. As a result, directed advertisements cannot be used.
For more information, see <a class="reference internal" href="privacy.html#central-address-resolution"><span class="std std-ref">Central Address Resolution Characteristic (CAR)</span></a>.</p>
<p>By default, sample applications such as simple_peripheral does not define
<code class="docutils literal notranslate"><span class="pre">GATT_NO_CLIENT</span></code> but initializes the GATT Client as shown below:</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Initialize GATT Client, used by GAPBondMgr to look for RPAO</span>
<span class="cm"> * characteristic for network privacy</span>
<span class="cm"> */</span><span class="w"></span>
<span class="n">GATT_InitClient</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>To remove GATT client support, you can add the <code class="docutils literal notranslate"><span class="pre">GATT_NO_CLIENT</span></code>
predefined symbol to your project and remove the initialization shown above.</p>
</div>
<div class="section" id="optimize-ti-drivers-for-your-project">
<h3>Optimize TI drivers for your project<a class="headerlink" href="#optimize-ti-drivers-for-your-project" title="Permalink to this headline">¶</a></h3>
<p>In order to have easy-to-use and portable code, the TI drivers handle a lot
of different configurations. Most of the time, a specific application does
not require all those configurations. By optimizing the TI drivers for your
own application you can save RAM, FLASH and processor time.</p>
<p>A good example of this is the Power driver (but you can analyze any
TI driver in order to optimize it using a similar process).
The Power driver is a pretty complex driver. A lot of different
combinations of crystals can be used and it handles all of them.</p>
<p>Let’s see how to optimize the Power driver:</p>
<ol class="arabic">
<li><p>Force CCS or IAR to not use the compiled sources for the Power driver.</p>
<blockquote>
<div><blockquote>
<div><ul>
<li><p>[CCS] Right click on your project and click “Add Files…”
Add the files PowerCC26X2.c and PowerCC26X2.h to your project.
<em>(The TI drivers files are stored in &lt;Your SDK&gt;/source/ti/drivers)</em></p>
<p>It is recommended to select <em>Copy Files</em> and not <em>Link to files</em>.</p>
<p>Verify if the linker is considering the files you added by checking
the “MODULE SUMMARY” section of the .map file.
You should find a line presenting the memory consumed by
<code class="docutils literal notranslate"><span class="pre">PowerCC26X2.obj</span></code>.</p>
</li>
</ul>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><ul class="simple">
<li><p>[IAR] Right click on your project, then chose “Add” and
“Add Files…”.
Add the files PowerCC26X2.c and PowerCC26X2.h to your project.
<em>(The TI drivers files are stored in &lt;Your SDK&gt;/source/ti/drivers)</em></p></li>
</ul>
</div></blockquote>
</div></blockquote>
</li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Review the configuration of your project (for the Power driver,
the crystal configuration is the most important). To do so, use
<code class="docutils literal notranslate"><span class="pre">SysConfig</span></code> and/or consult the file <code class="docutils literal notranslate"><span class="pre">ti_devices_config.c</span></code>.
If <code class="docutils literal notranslate"><span class="pre">SysConfig</span></code> is not used, consult the file <code class="docutils literal notranslate"><span class="pre">ccfg.c</span></code>.</p></li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ol class="arabic" start="3">
<li><p>Optimize the code! The goal here is to find the variables that
are not seen as constant by the code optimizer but that are
constant in practice.</p>
<blockquote>
<div><p>a- Expressions returning always the same value for a given configuration:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CCFGRead_DIS_GPRAM()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CCFGRead_SCLK_LF_OPTION()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CCFGRead_XOSC_FREQ()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OSCClockSourceGet(OSC_SRC_CLK_LF)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OSCClockSourceGet(OSC_SRC_CLK_HF)</span></code></p></li>
</ul>
<p>Those expressions can be replaced by their constant value. This will
allow the code optimizer to generate a simpler code.</p>
</div></blockquote>
<p>b- Variable that won’t be used (or that will always the same value).</p>
<blockquote>
<div><ul class="simple">
<li><p>Function pointer never set (i.e. always pointing on NULL).
In this case no need to test if the function is not NULL,
just remove the corresponding code. A good example of this case
in the Power driver is <code class="docutils literal notranslate"><span class="pre">PowerCC26X2_config.enableTCXOFxn</span></code>. By
it points on NULL and it is wasting time and FLASH to test this
at each execution.</p></li>
<li><p>Variable with a constant value set only once at driver opening.
(<em>The Power driver does not contain any example of this case</em>.)</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</li>
<li><p>That’s it! Once again, these guidelines can be adapted to all the
drivers used. It is important to test properly your code once optimized
to be sure that no unexpected behavior occurs.</p></li>
</ol>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="custom-hardware-cc13xx_cc26xx-ble.html" class="btn btn-neutral float-left" title="Clock accuracies and Bluetooth LE" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../coexistence/coexistence.html" class="btn btn-neutral float-right" title="Coexistence" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2010-2022, Texas Instruments.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>