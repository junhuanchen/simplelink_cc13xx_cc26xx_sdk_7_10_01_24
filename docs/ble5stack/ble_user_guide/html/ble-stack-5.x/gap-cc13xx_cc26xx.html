<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generic Access Profile (GAP) &mdash; 
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User&#39;s Guide
 2.02.08.01 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Generic Attribute Profile (GATT)" href="gatt.html" />
    <link rel="prev" title="Overview" href="overview-cc13xx_cc26xx.html" />
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug ble-stack-5.x gap-cc13xx_cc26xx";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html" class="icon icon-home"> 
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User's Guide

          </a>
              <div class="version">
                2.02.08.01
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/disclaimer.html">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/quickstart-intro-cc13xx_cc26xx.html">Introduction to the SimpleLink CC13xx/CC26xx SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/ble5-quick-start.html">TI BLE5-Stack Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/platform-cc13xx_cc26xx.html">The CC13xx or CC26xx SDK Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/tirtos-index-cc13xx_cc26xx.html">TI-RTOS7 (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/freertos-index.html">FreeRTOS (RTOS Kernel) Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../ble-stack-5.x-guide/ble-stack-5-index-cc13xx_cc26xx.html">BLE5-Stack</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview-cc13xx_cc26xx.html">Overview</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Generic Access Profile (GAP)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gap-roles">GAP Roles</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gap-constraints">GAP Constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gap-advertiser">GAP Advertiser</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#changing-advertising-parameters">Changing advertising parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ending-advertisement">Ending Advertisement</a></li>
<li class="toctree-l4"><a class="reference internal" href="#updating-advertisement-scan-response-data">Updating Advertisement/Scan Response Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#directly-manipulating-a-buffer-while-advertising-is-enabled">Directly Manipulating a Buffer While Advertising is Enabled</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-tx-power-to-an-advertisement-payload">Adding TX Power to an Advertisement Payload</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sending-up-to-1650-bytes-scan-response-data">Sending Up To 1650 Bytes Scan Response Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limited-advertising">Limited Advertising</a></li>
<li class="toctree-l4"><a class="reference internal" href="#periodic-advertising">Periodic Advertising</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#gap-peripheral">GAP Peripheral</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gap-scanner">GAP Scanner</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#advertising-report-recording">Advertising Report Recording</a></li>
<li class="toctree-l4"><a class="reference internal" href="#obtain-advertising-channel-from-advertising-report">Obtain Advertising Channel from Advertising Report</a></li>
<li class="toctree-l4"><a class="reference internal" href="#filtering">Filtering</a></li>
<li class="toctree-l4"><a class="reference internal" href="#synchronize-with-a-periodic-advertising-train">Synchronize with a Periodic Advertising Train</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#gap-initiator">GAP Initiator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gap-central">GAP Central</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gap-connection-state">GAP Connection State</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#connection-event-callback">Connection Event Callback</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">Connection Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#effective-connection-interval">Effective Connection Interval</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connection-parameter-considerations">Connection Parameter Considerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connection-parameter-update">Connection Parameter Update</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connection-termination">Connection Termination</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gatt.html">Generic Attribute Profile (GATT)</a></li>
<li class="toctree-l2"><a class="reference internal" href="gatt.html#gap-gatt-service-ggs">GAP GATT Service (GGS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="gatt.html#generic-attribute-profile-service-gatt-service">Generic Attribute Profile Service (GATT Service)</a></li>
<li class="toctree-l2"><a class="reference internal" href="gatt.html#gattservapp-module">GATTServApp Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="gapbondmngr-cc13xx_cc26xx.html">GAP Bond Manager and LE Secure Connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="privacy.html">Privacy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-common/l2cap.html">Logical Link Control and Adaptation Layer Protocol (L2CAP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-common/link-layer-cc13xx_cc26xx.html">Link Layer (LL)</a></li>
<li class="toctree-l2"><a class="reference internal" href="channel-selection-algorithm-number-two.html">Channel Selection Algorithm #2</a></li>
<li class="toctree-l2"><a class="reference internal" href="hci.html">Host Controller Interface (HCI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="phy.html">Physical Layer (PHY)</a></li>
<li class="toctree-l2"><a class="reference internal" href="stack-configuration-cc13xx_cc26xx.html">Stack Configurations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html">Developing a Bluetooth LE Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coexistence/coexistence.html">Coexistence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/localization-index-cc13xx_cc26xx.html">RTLS Toolbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-mesh/index.html">Bluetooth Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/u-stack-index-cc13xx_cc26xx.html">Micro BLE Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sensor-controller/sensor-controller.html">Sensor Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/debugging-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/memory-index.html">Memory Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-common/npi-index.html">Network Processor Interface (NPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble5-oad-index-cc13xx_cc26xx.html">TI Over-the-Air Download (OAD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble5-oad-index-mcuboot.html">MCUBoot Over-the-Air Download (OAD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security-tfm/index.html">Security Features of CC13x4 and CC26x4 Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/sysconfig-index-cc13xx_cc26xx.html">System Configuration Tool (SysConfig)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/migration-cc13xx_cc26xx.html">Porting Guide and Migration Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13xx_cc26xx.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html">Terms and Definitions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html">
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User's Guide
</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../ble-stack-5.x-guide/ble-stack-5-index-cc13xx_cc26xx.html">BLE5-Stack</a> &raquo;</li>
      <li>Generic Access Profile (GAP)</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="generic-access-profile-gap">
<span id="gap"></span><h1>Generic Access Profile (GAP)<a class="headerlink" href="#generic-access-profile-gap" title="Permalink to this headline">¶</a></h1>
<p>The GAP layer of the Bluetooth Low Energy protocol stack is
responsible for connection functionality. This layer handles the
access modes and procedures of the device including device
discovery, link establishment, link termination, initiation of
security features, and device configuration. See <a class="reference internal" href="#gap-state-diagram"><span class="std std-ref">GAP State Diagram.</span></a> for
more details.</p>
<div class="figure align-center" id="id10">
<span id="gap-state-diagram"></span><img alt="../_images/image72.jpeg" src="../_images/image72.jpeg" />
<p class="caption"><span class="caption-number">Figure 66. </span><span class="caption-text">GAP State Diagram.</span><a class="headerlink" href="#id10" title="Permalink to this image">¶</a></p>
</div>
<p>Based on the role for which the device is configured, <a class="reference internal" href="#gap-state-diagram"><span class="std std-ref">GAP State Diagram.</span></a>
shows the states of the device. The following describes these states.</p>
<ul class="simple">
<li><p><strong>Standby</strong>: The device is in the initial idle state upon reset.</p></li>
<li><p><strong>Advertiser</strong>: The device is advertising with specific data letting
any initiating devices know that it is a connectable device (this
advertisement contains the device address and can contain some
additional data such as the device name).</p></li>
<li><p><strong>Scanner</strong>: When receiving the advertisement, the scanning device
sends a scan request to the advertiser. The advertiser responds
with a scan response. This process is called device discovery.
The scanning device is aware of the advertising device and can
initiate a connection with it.</p></li>
<li><p><strong>Initiator</strong>: When initiating, the initiator must specify a peer
device address to which to connect. If an advertisement is
received matching that address of the peer device, the initiating
device then sends out a request to establish a connection (link) with the
advertising device with the connection parameters described in
<a class="reference internal" href="#connection-parameters"><span class="std std-ref">GAP Connection State</span></a>.</p></li>
<li><p><strong>Peripheral/Central</strong>: When a connection is formed, the device functions
as a Peripheral if it is the advertiser and a Central if it is the initiator.</p></li>
</ul>
<p>Bluetooth devices operate in one or more GAP roles based on the application use
case. The GAP roles utilize one or more of the GAP states.
Based on this configuration, many Bluetooth Low Energy protocol stack events
are handled directly by the main application task and sometimes routed from the
GAP Bond Manager. The application can register with the stack to be notified of
certain events.</p>
<div class="section" id="gap-roles">
<span id="id2"></span><h2>GAP Roles<a class="headerlink" href="#gap-roles" title="Permalink to this headline">¶</a></h2>
<p>Based on the configuration of the device, the GAP layer always operates in one
of four (4) roles as defined by the specification:</p>
<ul class="simple">
<li><p><strong>Broadcaster</strong> - The device is an advertiser that is non connectable.</p></li>
<li><p><strong>Observer</strong> - The device scans for advertisements but cannot initiate
connections.</p></li>
<li><p><strong>Peripheral</strong> - The device is an advertiser that is connectable and operates as
Peripheral in a single link-layer connection.</p></li>
<li><p><strong>Central</strong> - The device scans for advertisements and initiates
connections and operates as a Central in a single or multiple
link-layer connections.</p></li>
</ul>
<p>The <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a> allows for certain combinations of multiple roles, which are
supported by the Bluetooth Low Energy protocol stack. For configuration of the
Bluetooth Low Energy stack features, see <a class="reference internal" href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html#creating-custom-ble-app"><span class="std std-ref">Developing a Bluetooth LE Application</span></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Bluetooth 5 also introduces new features including Extended Advertising. Bluetooth 5
supports legacy advertising maintaining backwards compatibility with previous versions.
The following sections will describe how to operate the device for various GAP roles along with
how to use the new Extended Advertising features with the new APIs.</p>
</div>
<p>The following sections will describe how to use the LE Advertising Extension
feature. As its name suggests, the amount of advertising data that can be sent
over the air has been extended from 31 bytes to 1650 bytes. Also multiple
advertising sets can be created using a mix of legacy and extended
advertisements. Extended advertisements introduces use the secondary
advertising channels which uses the data channels to send extensive data in
addition to the primary advertising channels (Ch. 37, 38, and 39) used in
legacy advertisement.</p>
</div>
<div class="section" id="gap-constraints">
<span id="id3"></span><h2>GAP Constraints<a class="headerlink" href="#gap-constraints" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>GAP Scanner can only scan one PHY per scanning cycle.</p></li>
<li><p>The data length of the advertising data and the scan response data for
Extended Advertising is limited to 1650 bytes. The connectable undirected
advertising data is limited to 212 bytes. The connectable directed advertising
data is limited to 206 bytes. For more information, refer to the Host Advertising Data section
([Vol 6], Part B, Section 2.3.4.9) of the <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>. Following
is the overview of maximum payload with different Advertising Extension events.</p></li>
</ul>
<p><strong>Advertisement Extensions Event Type and its Maximum Payload Size</strong></p>
<div class="table-wrap docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 26%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 18%" />
<col style="width: 24%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Max AdvData</p></th>
<th class="head"><p>Max ScanRsp</p></th>
<th class="head"><p>PDUs Used</p></th>
<th class="head"><p>PDUs Listened for</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Connectable
(Non-Scannable)</p></td>
<td><p>212 bytes</p></td>
<td><p>0</p></td>
<td><p>ADV_EXT_IND
AUX_ADV_IND</p></td>
<td><p>AUX_CONNECT_REQ</p></td>
</tr>
<tr class="row-odd"><td><p>Scannable</p></td>
<td><p>0</p></td>
<td><p>1650 bytes
w/chain</p></td>
<td><p>ADV_EXT_IND
AUX_ADV_IND
AUX_CHAIN_IND</p></td>
<td><p>AUX_SCAN_REQ</p></td>
</tr>
<tr class="row-even"><td><p>Broadcast</p></td>
<td><p>1650 bytes</p></td>
<td><p>0</p></td>
<td><p>ADV_EXT_IND
AUX_ADV_IND
AUX_CHAIN_IND</p></td>
<td><p>N/A</p></td>
</tr>
<tr class="row-odd"><td><p>Periodic Advertising</p></td>
<td><p>1650 bytes</p></td>
<td><p>0</p></td>
<td><p>ADV_EXT_IND
AUX_ADV_IND
AUX_SYNC_IND</p></td>
<td><p>N/A</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="gap-advertiser">
<span id="id4"></span><h2>GAP Advertiser<a class="headerlink" href="#gap-advertiser" title="Permalink to this headline">¶</a></h2>
<p>The application and profiles can directly call GAP API functions to perform
Bluetooth Low Energy-related functions such as advertising or connecting.
The GAP layer functionality is mostly defined in library code. The
function headers can be found in <a class="reference external" href="../../doxygen/ble/html/gap_8h.html">gap.h</a>. The advertising specific
implementation is found in <a class="reference external" href="../../doxygen/ble/html/gap__advertiser_8h.html">gap_advertiser.h</a>. Most of these functions
can be called directly.</p>
<p>The GAP Advertiser module lets you create advertisement sets. The application
can then enable and disable the sets. This way, the application can quickly
change the advertisement parameters and advertisement data. For example, an
application can create an advertisement set for legacy advertising and one for
long range advertising. If both sets are enabled, the application advertises
both on the primary advertising channels with legacy advertising, and on a LE
Coded PHY with the long range set. With long range advertising, more advertising data can
be sent and connections can be formed from larger distances compared to legacy advertising.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The advertisement data is de-coupled from the advertisement sets, so multiple
sets can use the same advertisement data.</p>
</div>
<p>Multiple active advertising sets can set different advertising intervals. The
figure below illustrate how two advertising sets with different intervals are
scheduled. The intervals do not have to be multiples of each other. In the
examples the advertising interval can be set in the <code class="docutils literal notranslate"><span class="pre">.primIntMin</span></code> and
<code class="docutils literal notranslate"><span class="pre">primIntMax</span></code> Advertisement Params (<code class="docutils literal notranslate"><span class="pre">GapAdv_params_t</span></code>) member before the
advertisement set is enabled or during advertising as described in
<a class="reference internal" href="#gap-changing-adv-param"><span class="std std-ref">Changing advertising parameters</span></a>.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-number">Listing 49. </span><span class="caption-text"><strong>simple_peripheral.c :: SimplePeripheral_processGapMessage() :: GAP_DEVICE_INIT_DONE_EVENT</strong> -  Change advertising interval before advertisment enable</span><a class="headerlink" href="#id11" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="n">advParams1</span><span class="p">.</span><span class="n">primIntMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">160</span><span class="p">;</span><span class="w"> </span><span class="c1">// 100 ms</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">advParams1</span><span class="p">.</span><span class="n">primIntMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">160</span><span class="p">;</span><span class="w"> </span><span class="c1">// 100 ms</span>
<span class="linenos">3</span><span class="w">  </span><span class="n">advParams2</span><span class="p">.</span><span class="n">primIntMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">800</span><span class="p">;</span><span class="w"> </span><span class="c1">// 500 ms</span>
<span class="linenos">4</span><span class="w">  </span><span class="n">advParams2</span><span class="p">.</span><span class="n">primIntMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">800</span><span class="p">;</span><span class="w"> </span><span class="c1">// 500 ms</span>
</pre></div>
</div>
</div>
</div></blockquote>
<div class="figure align-center" id="id12">
<span id="gap-diff-adv-interval"></span><img alt="../_images/multiple_ae_adv_diff_interval.png" src="../_images/multiple_ae_adv_diff_interval.png" />
<p class="caption"><span class="caption-number">Figure 67. </span><span class="caption-text">Multiple AE Advertising sets with different interval.</span><a class="headerlink" href="#id12" title="Permalink to this image">¶</a></p>
</div>
<p>The following list describes how to configure the GAP layer for
advertising. The <em>simple peripheral</em> example project will be used as an example.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The advertisement set creation can be done using SysConfig.</p>
</div>
<ol class="arabic" id="sbp-gap-configuration-example">
<li><p><strong>Create Advertisement set with</strong> <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga3a4facdca0b45e2266097d540ff09a43">GapAdv_create()</a>. The return value
of <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga3a4facdca0b45e2266097d540ff09a43">GapAdv_create()</a> is a handle for the advertisement set. The create
function takes a <a class="reference external" href="../../doxygen/ble/html/struct_gap_adv__params__t.html">GapAdv_params_t</a> variable, so the first thing to do
is to create this variable.
<strong>The Tx Power of legacy advertisements cannot be individually set.</strong></p>
<p>Some <a class="reference external" href="../../doxygen/ble/html/struct_gap_adv__params__t.html">GapAdv_params_t</a> variables are defined in
<a class="reference external" href="../../doxygen/ble/html/gap__advertiser_8h.html">gap_advertiser.h</a>. In this example we will use one of
them, <code class="docutils literal notranslate"><span class="pre">GAPADV_PARAMS_LEGACY_SCANN_CONN</span></code>. You can of course define your own
<a class="reference external" href="../../doxygen/ble/html/struct_gap_adv__params__t.html">GapAdv_params_t</a> variable or modify an existing <a class="reference external" href="../../doxygen/ble/html/struct_gap_adv__params__t.html">GapAdv_params_t</a>
variable.</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-number">Listing 50. </span><span class="caption-text"><strong>simple_peripheral.c :: SimplePeripheral_processGapMessage() :: GAP_DEVICE_INIT_DONE_EVENT</strong> - Creating an advertising parameters variable.</span><a class="headerlink" href="#id13" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="c1">// Temporary memory for advertising parameters. These will be copied by the GapAdv module</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">GapAdv_params_t</span><span class="w"> </span><span class="n">advParamLegacy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPADV_PARAMS_LEGACY_SCANN_CONN</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-number">Listing 51. </span><span class="caption-text"><strong>simple_peripheral.c :: LOCAL VARIABLES</strong> - Create advertisement handle</span><a class="headerlink" href="#id14" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="c1">// Advertising handle</span>
<span class="linenos">2</span><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">uint8</span><span class="w"> </span><span class="n">advHandleLegacy</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-number">Listing 52. </span><span class="caption-text"><strong>simple_peripheral.c :: SimplePeripheral_processGapMessage() :: GAP_DEVICE_INIT_DONE_EVENT</strong> - Create advertisement set and assign handle</span><a class="headerlink" href="#id15" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="c1">// Create Advertisement set and assign handle</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SimplePeripheral_advCallback</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">advParamLegacy</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">advHandleLegacy</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p><strong>Set Advertiser’s virtual address set with</strong> <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga72696f5a9e5650cc43443a0ec46f86b7">GapAdv_setVirtualAdvAddr()</a>.
The handle for the advertisement set, returned from <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga3a4facdca0b45e2266097d540ff09a43">GapAdv_create()</a>, can
also be used to create a custom private address for that advertisement set. This
allows different advertising sets to have different addresses. This is only
applicable for legacy non-connectable and non-scannable advertising sets.</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-number">Listing 53. </span><span class="caption-text"><strong>simple_peripheral.c :: SimplePeripheral_processGapMessage() :: GAP_DEVICE_INIT_DONE_EVENT</strong> - Set advertiser’s virtual address</span><a class="headerlink" href="#id16" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="c1">// Set virtual address</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_setVirtualAdvAddr</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bdAddr</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p><strong>Load Advertisement and Scan Response data</strong>. Advertising and scan response
data is decoupled from the advertising set. That is, it is possible for multiple
advertising sets to use the same memory for advertising/scan response data. An
advertising set could also use the same memory for its advertising and scan
response data. (Note that this requires diligence as there are some data types
that are only allowed once in the advertisement and scan response data. See the
<a class="reference external" href="https://www.bluetooth.com/specifications/bluetooth-core-specification">Bluetooth Core Specification Supplement (CSSv7)</a> for specifics.)</p>
<p>If your advertisement set is not scannable, you can of course skip the last step
(load scan response data). Example advertising and scan response data is shown
in <a class="reference internal" href="#sp-advertdata"><span class="std std-numref">Listing 55.</span></a> and <a class="reference internal" href="#sp-scanrspdata"><span class="std std-numref">Listing 56.</span></a></p>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-number">Listing 54. </span><span class="caption-text">Loading advertising data in SimplePeripheral_processGapMessage()</span><a class="headerlink" href="#id17" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">   </span><span class="c1">// Load advertising data that is statically allocated by the app</span>
<span class="linenos">2</span><span class="w">   </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_loadByHandle</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_DATA_TYPE_ADV</span><span class="p">,</span><span class="w"></span>
<span class="linenos">3</span><span class="w">                                </span><span class="k">sizeof</span><span class="p">(</span><span class="n">advertData</span><span class="p">),</span><span class="w"> </span><span class="n">advertData</span><span class="p">);</span><span class="w"></span>
<span class="linenos">4</span>
<span class="linenos">5</span><span class="w">   </span><span class="c1">// Load scan response data that is statically allocated by the app</span>
<span class="linenos">6</span><span class="w">   </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_loadByHandle</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_DATA_TYPE_SCAN_RSP</span><span class="p">,</span><span class="w"></span>
<span class="linenos">7</span><span class="w">                                </span><span class="k">sizeof</span><span class="p">(</span><span class="n">scanRspData</span><span class="p">),</span><span class="w"> </span><span class="n">scanRspData</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="sp-advertdata">
<div class="code-block-caption"><span class="caption-number">Listing 55. </span><span class="caption-text"><strong>simple_peripheral.c :: LOCAL VARIABLES</strong> - Example advertisement data.</span><a class="headerlink" href="#sp-advertdata" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Advertisement data</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">advertData</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x02</span><span class="p">,</span><span class="w">   </span><span class="c1">// length of this data</span>
<span class="w">    </span><span class="n">GAP_ADTYPE_FLAGS</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">DEFAULT_DISCOVERABLE_MODE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GAP_ADTYPE_FLAGS_BREDR_NOT_SUPPORTED</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="c1">// service UUID, to notify central devices what services are included</span>
<span class="w">    </span><span class="c1">// in this peripheral</span>
<span class="w">    </span><span class="mh">0x03</span><span class="p">,</span><span class="w">   </span><span class="c1">// length of this data</span>
<span class="w">    </span><span class="n">GAP_ADTYPE_16BIT_MORE</span><span class="p">,</span><span class="w">      </span><span class="c1">// some of the UUID&#39;s, but not all</span>
<span class="w">    </span><span class="n">LO_UINT16</span><span class="p">(</span><span class="n">SIMPLEPROFILE_SERV_UUID</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">HI_UINT16</span><span class="p">(</span><span class="n">SIMPLEPROFILE_SERV_UUID</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="sp-scanrspdata">
<div class="code-block-caption"><span class="caption-number">Listing 56. </span><span class="caption-text"><strong>simple_peripheral.c :: LOCAL VARIABLES</strong> - Example scan response data.</span><a class="headerlink" href="#sp-scanrspdata" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Scan Response Data</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">scanRspData</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// complete name</span>
<span class="w">    </span><span class="mi">17</span><span class="p">,</span><span class="w">   </span><span class="c1">// length of this data</span>
<span class="w">    </span><span class="n">GAP_ADTYPE_LOCAL_NAME_COMPLETE</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;S&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;i&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;m&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;p&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;P&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;r&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;i&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;p&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;h&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;r&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="c1">// connection interval range</span>
<span class="w">    </span><span class="mi">5</span><span class="p">,</span><span class="w">   </span><span class="c1">// length of this data</span>
<span class="w">    </span><span class="n">GAP_ADTYPE_SLAVE_CONN_INTERVAL_RANGE</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">LO_UINT16</span><span class="p">(</span><span class="n">DEFAULT_DESIRED_MIN_CONN_INTERVAL</span><span class="p">),</span><span class="w">   </span><span class="c1">// 100ms</span>
<span class="w">    </span><span class="n">HI_UINT16</span><span class="p">(</span><span class="n">DEFAULT_DESIRED_MIN_CONN_INTERVAL</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">LO_UINT16</span><span class="p">(</span><span class="n">DEFAULT_DESIRED_MAX_CONN_INTERVAL</span><span class="p">),</span><span class="w">   </span><span class="c1">// 1s</span>
<span class="w">    </span><span class="n">HI_UINT16</span><span class="p">(</span><span class="n">DEFAULT_DESIRED_MAX_CONN_INTERVAL</span><span class="p">),</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Tx power level</span>
<span class="w">    </span><span class="mi">2</span><span class="p">,</span><span class="w">   </span><span class="c1">// length of this data</span>
<span class="w">    </span><span class="n">GAP_ADTYPE_POWER_LEVEL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">5</span><span class="w">       </span><span class="c1">// 5dBm</span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p><strong>Set which events to send to application.</strong> The events will be sent to the
callback function given in <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga3a4facdca0b45e2266097d540ff09a43">GapAdv_create()</a> (in this
case <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_advCallback()</span></code>).</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-number">Listing 57. </span><span class="caption-text"><strong>simple_peripheral.c :: SimplePeripheral_processGapMessage() :: GAP_DEVICE_INIT_DONE_EVENT</strong> - Setting advertising mask.</span><a class="headerlink" href="#id18" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">   </span><span class="c1">// Set event mask</span>
<span class="linenos">2</span><span class="w">   </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_setEventMask</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"></span>
<span class="linenos">3</span><span class="w">                                </span><span class="n">GAP_ADV_EVT_MASK_START_AFTER_ENABLE</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="linenos">4</span><span class="w">                                </span><span class="n">GAP_ADV_EVT_MASK_END_AFTER_DISABLE</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="linenos">5</span><span class="w">                                </span><span class="n">GAP_ADV_EVT_MASK_SET_TERMINATED</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p><strong>Enable advertising.</strong> Calling <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga9b94640e5689a2b2b800d70c1a55538b">GapAdv_enable()</a> will start
advertising.</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-number">Listing 58. </span><span class="caption-text"><strong>simple_peripheral.c :: SimplePeripheral_processGapMessage() :: GAP_DEVICE_INIT_DONE_EVENT</strong> - Start advertising.</span><a class="headerlink" href="#id19" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">   </span><span class="c1">// Enable advertising</span>
<span class="linenos">2</span><span class="w">   </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_enable</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_ENABLE_OPTIONS_USE_MAX</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
</ol>
<p>The above steps can be repeated to create multiple advertising sets. There is an
upper limit of six advertising sets (defined in the controller). The heap may
also restrict the number of advertising sets you can create in one application.</p>
<div class="section" id="changing-advertising-parameters">
<span id="gap-changing-adv-param"></span><h3>Changing advertising parameters<a class="headerlink" href="#changing-advertising-parameters" title="Permalink to this headline">¶</a></h3>
<p>In order to change an individual parameter after advertising has been enabled,
advertising must first be disabled. Re-enable advertising after the parameter is modified.</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-number">Listing 59. </span><span class="caption-text">Changing advertising parameter during advertising.</span><a class="headerlink" href="#id20" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">   </span><span class="c1">// Stop advertising</span>
<span class="linenos">2</span><span class="w">   </span><span class="n">GapAdv_disable</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">);</span><span class="w"></span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="w">   </span><span class="c1">// Set a parameter</span>
<span class="linenos">5</span><span class="w">   </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">newAdvInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span><span class="w"></span>
<span class="linenos">6</span><span class="w">   </span><span class="n">GapAdv_setParam</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_PARAM_PRIMARY_INTERVAL_MIN</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">newAdvInt</span><span class="p">);</span><span class="w"></span>
<span class="linenos">7</span>
<span class="linenos">8</span><span class="w">   </span><span class="c1">// Re-enable advertising</span>
<span class="linenos">9</span><span class="w">   </span><span class="n">GapAdv_enable</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_ENABLE_OPTIONS_USE_MAX</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ending-advertisement">
<h3>Ending Advertisement<a class="headerlink" href="#ending-advertisement" title="Permalink to this headline">¶</a></h3>
<p>An advertising set can be disabled with <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga4e45550a6887067a26b8cc797e3d51fe">GapAdv_disable()</a> and deleted
(such that all memory related to the set is freed) with <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gad770d595fc51dc46a8c9bd9fd047f5c7">GapAdv_destroy()</a>.</p>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-number">Listing 60. </span><span class="caption-text">Stop advertising and free memory.</span><a class="headerlink" href="#id21" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="c1">// Stop advertising</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">GapAdv_disable</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">);</span><span class="w"></span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="w">  </span><span class="c1">// Free all data related to advertising set (besides advertising / scan response data).</span>
<span class="linenos">5</span><span class="w">  </span><span class="c1">// Note that this can be called while advertising is still enabled</span>
<span class="linenos">6</span><span class="w">  </span><span class="n">GapAdv_destroy</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_FREE_OPTION_DONT_FREE</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>The advertising and scan response data is statically allocated and is thus not
freed as part of <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gad770d595fc51dc46a8c9bd9fd047f5c7">GapAdv_destroy()</a>.</p>
</div>
<div class="section" id="updating-advertisement-scan-response-data">
<h3>Updating Advertisement/Scan Response Data<a class="headerlink" href="#updating-advertisement-scan-response-data" title="Permalink to this headline">¶</a></h3>
<p>Again, since the advertising and scan response data is decoupled from the
advertising set, it is possible for multiple advertising sets to use the same
memory for advertising/scan response data. An advertising set could also use
the same memory for its advertising and scan response data.  The memory used for
advertising/scan response data is referred to as a “buffer” throughout this
section.</p>
<p>The preferred and safest method to update a buffer is to use the prepare/load
latching mechanism. This will ensure the following:</p>
<ul class="simple">
<li><p>No buffer is freed if it is used by another advertising set.</p></li>
<li><p>Advertising is always disabled before the buffer is modified, thus ensuring
that no corrupted advertisement packets are transmitted.</p></li>
<li><p>Prevent double-copying.</p></li>
</ul>
<p>The following offers several ways to update the advertising and scan response
data.</p>
<div class="section" id="update-the-advertising-scan-response-data-of-a-single-handle">
<span id="gap-update-adv-scan-data"></span><h4>Update the Advertising/Scan Response Data of a Single Handle<a class="headerlink" href="#update-the-advertising-scan-response-data-of-a-single-handle" title="Permalink to this headline">¶</a></h4>
<p>If the application wants to modify a few bytes of advertising/scan response data
that is used by a single advertisement set, use <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gae783d648cb49d7aa764cd97d366de812">GapAdv_prepareLoadByHandle()</a>
and <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga1bbb75a51200d38ed8f760d274c8b8c0">GapAdv_loadByHandle()</a>.</p>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-number">Listing 61. </span><span class="caption-text">Update the advertising buffer of a single handle.</span><a class="headerlink" href="#id22" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="c1">// Don&#39;t free anything since we&#39;re going to use the same buffer to re-load</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">GapAdv_prepareLoadByHandle</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_FREE_OPTION_DONT_FREE</span><span class="p">);</span><span class="w"></span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="w">  </span><span class="c1">// Sample buffer modification</span>
<span class="linenos">5</span><span class="w">  </span><span class="n">advertData</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xAA</span><span class="p">;</span><span class="w"></span>
<span class="linenos">6</span>
<span class="linenos">7</span><span class="w">  </span><span class="c1">// Reload buffer to handle</span>
<span class="linenos">8</span><span class="w">  </span><span class="n">GapAdv_loadByHandle</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_DATA_TYPE_ADV</span><span class="p">,</span><span class="w"> </span><span class="n">ADV_DATA_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">advertData</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>The GapAdv_prepareLoadByHandle() will perform the following here:</p>
<ul class="simple">
<li><p>Check that this buffer isn’t used by other handles. If
<a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gae783d648cb49d7aa764cd97d366de812">GapAdv_prepareLoadByHandle()</a> returns success, the application will
know that it can now safely modify this buffer.</p></li>
<li><p>Automatically disable advertising and mark it for re-enabling</p></li>
</ul>
<p><a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga1bbb75a51200d38ed8f760d274c8b8c0">GapAdv_loadByHandle()</a> will automatically re-enable advertising with the
updated buffer. This method can also be used to use a subset of the original
advertising data. In this case, simply update the data length parameter of
<a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga1bbb75a51200d38ed8f760d274c8b8c0">GapAdv_loadByHandle()</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The above methods of changing advertising or scan response data have one
limitation. A special procedure is required when the data length is
currently set to zero and application wants to change that to a non-zero
length. In this case the application needs to destroy the advertisement set
and re-create it with the desired data as shown in below code example for
legacy advertisements.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-number">Listing 62. </span><span class="caption-text">Destroy advertisement set and create new one with desired data.</span><a class="headerlink" href="#id23" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">  </span><span class="c1">// Stop advertising</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="n">GapAdv_disable</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">  </span><span class="c1">// Free all data related to advertising set (besides advertising / scan response data).</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="n">GapAdv_destroy</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="c1">// Create Advertisement set and assign handle</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="n">GapAdv_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SimplePeripheral_advCallback</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">advParams1</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">                         </span><span class="o">&amp;</span><span class="n">advHandleLegacy</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">  </span><span class="c1">// Load advertising data that is statically allocated by the app</span>
<span class="linenos">10</span><span class="w">  </span><span class="n">GapAdv_loadByHandle</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_DATA_TYPE_ADV</span><span class="p">,</span><span class="w"></span>
<span class="linenos">11</span><span class="w">                               </span><span class="k">sizeof</span><span class="p">(</span><span class="n">advData1</span><span class="p">),</span><span class="w"> </span><span class="n">advData1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">12</span><span class="w">  </span><span class="c1">// Load scan response data that is statically allocated by the app</span>
<span class="linenos">13</span><span class="w">  </span><span class="n">GapAdv_loadByHandle</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_DATA_TYPE_SCAN_RSP</span><span class="p">,</span><span class="w"></span>
<span class="linenos">14</span><span class="w">                               </span><span class="k">sizeof</span><span class="p">(</span><span class="n">scanResData1</span><span class="p">),</span><span class="w"> </span><span class="n">scanResData1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">15</span><span class="w">  </span><span class="c1">// Set event mask</span>
<span class="linenos">16</span><span class="w">  </span><span class="n">GapAdv_setEventMask</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"></span>
<span class="linenos">17</span><span class="w">                               </span><span class="n">GAP_ADV_EVT_MASK_START_AFTER_ENABLE</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="linenos">18</span><span class="w">                               </span><span class="n">GAP_ADV_EVT_MASK_END_AFTER_DISABLE</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="linenos">19</span><span class="w">                               </span><span class="n">GAP_ADV_EVT_MASK_SET_TERMINATED</span><span class="p">);</span><span class="w"></span>
<span class="linenos">20</span><span class="w">  </span><span class="c1">// Enable legacy advertising</span>
<span class="linenos">21</span><span class="w">  </span><span class="n">GapAdv_enable</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_ENABLE_OPTIONS_USE_MAX</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="load-a-new-buffer-to-a-single-advertising-handle">
<h4>Load a New Buffer to a Single Advertising Handle<a class="headerlink" href="#load-a-new-buffer-to-a-single-advertising-handle" title="Permalink to this headline">¶</a></h4>
<p>If the application wants to load a new buffer to a single advertising handle
without double-copying, use <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gae783d648cb49d7aa764cd97d366de812">GapAdv_prepareLoadByHandle()</a> and
<a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga1bbb75a51200d38ed8f760d274c8b8c0">GapAdv_loadByHandle()</a>. This way, the advertising data exists in only one
place in memory that is used by the GAP Advertiser. In this case we will free the buffer and
allocate a new one.</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-number">Listing 63. </span><span class="caption-text">Load a new advertising buffer for a single handle.</span><a class="headerlink" href="#id24" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="c1">// Free the buffer (to avoid double copying) since we&#39;re loading a new buffer</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">GapAdv_prepareLoadByHandle</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_FREE_OPTION_ADV_DATA</span><span class="p">);</span><span class="w"></span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="w">  </span><span class="c1">// Allocate new buffer (and then fill it as desired)</span>
<span class="linenos">5</span><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">advertData2</span><span class="o">=</span><span class="w"> </span><span class="n">ICall_malloc</span><span class="p">(</span><span class="n">ADV_DATA2_LEN</span><span class="p">);</span><span class="w"></span>
<span class="linenos">6</span>
<span class="linenos">7</span><span class="w">  </span><span class="c1">// Load the new buffer to the advertisement set handle</span>
<span class="linenos">8</span><span class="w">  </span><span class="n">GapAdv_loadByHandle</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_DATA_TYPE_ADV</span><span class="p">,</span><span class="w"> </span><span class="n">ADV_DATA2_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">advertData2</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p><a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gae783d648cb49d7aa764cd97d366de812">GapAdv_prepareLoadByHandle()</a> will perform the following here:</p>
<ul class="simple">
<li><p>Check that the buffer isn’t used by any other advertisement handles. If
<a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gae783d648cb49d7aa764cd97d366de812">GapAdv_prepareLoadByHandle()</a> returns success, the application will
know that it can now safely modify this buffer.</p></li>
<li><p>Automatically disable advertising and mark it for re-enabling</p></li>
<li><p>Free the original buffer</p></li>
</ul>
<p>The <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga1bbb75a51200d38ed8f760d274c8b8c0">GapAdv_loadByHandle()</a> will automatically re-enable advertising on
the handle with the new buffer.</p>
</div>
<div class="section" id="update-advertising-scan-response-data-that-is-used-for-multiple-advertising-handles">
<h4>Update Advertising/Scan Response Data that is Used for Multiple Advertising Handles<a class="headerlink" href="#update-advertising-scan-response-data-that-is-used-for-multiple-advertising-handles" title="Permalink to this headline">¶</a></h4>
<p>This is the case where the application wants to modify a few bytes of
advertising or scan response data that is shared among advertisement sets.</p>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-number">Listing 64. </span><span class="caption-text">Update an advertising buffer used by multiple handles.</span><a class="headerlink" href="#id25" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="c1">// Don&#39;t free anything since we&#39;re going to use the same buffer to reload</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">GapAdv_prepareLoadByBuffer</span><span class="p">(</span><span class="n">advertData</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">);</span><span class="w"></span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="w">  </span><span class="c1">// Sample buffer modification</span>
<span class="linenos">5</span><span class="w">  </span><span class="n">advertData</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xAA</span><span class="p">;</span><span class="w"></span>
<span class="linenos">6</span>
<span class="linenos">7</span><span class="w">  </span><span class="c1">// Reload the buffer to be used by the advertisement set handles</span>
<span class="linenos">8</span><span class="w">  </span><span class="n">GapAdv_loadByBuffer</span><span class="p">(</span><span class="n">ADV_DATA_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">advertData</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p><a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga2d97eeb71e379410e0f6f48c7c1eece7">GapAdv_prepareLoadByBuffer()</a> will automatically disable advertising for
all advertising handles that use this buffer. <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gace138d1c3a9257893543e47f8774fdb9">GapAdv_loadByBuffer()</a>
will automatically re-enable advertising for all handles that use this buffer.</p>
</div>
<div class="section" id="load-a-new-buffer-to-multiple-advertising-handles">
<h4>Load a New Buffer To Multiple Advertising Handles<a class="headerlink" href="#load-a-new-buffer-to-multiple-advertising-handles" title="Permalink to this headline">¶</a></h4>
<p>This is the case where the applications wants to load a new buffer to all
advertisement set handles that are using this buffer.</p>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-number">Listing 65. </span><span class="caption-text">Load new advertising buffer for multiple handles.</span><a class="headerlink" href="#id26" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="c1">// Free buffer (to avoid double copying) since we&#39;re loading a new buffer</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">GapAdv_prepareLoadByBuffer</span><span class="p">(</span><span class="n">advertData</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">);</span><span class="w"></span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="w">  </span><span class="c1">// Allocate new buffer (and then fill as desired)</span>
<span class="linenos">5</span><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">advertData2</span><span class="o">=</span><span class="w"> </span><span class="n">ICall_malloc</span><span class="p">(</span><span class="n">ADV_DATA2_LEN</span><span class="p">);</span><span class="w"></span>
<span class="linenos">6</span>
<span class="linenos">7</span><span class="w">  </span><span class="c1">// Reload the buffer to be used by all the handles</span>
<span class="linenos">8</span><span class="w">  </span><span class="n">GapAdv_loadByBuffer</span><span class="p">(</span><span class="n">ADV_DATA2_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">advertData2</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p><a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gace138d1c3a9257893543e47f8774fdb9">GapAdv_loadByBuffer()</a> will perform the following here:</p>
<ul class="simple">
<li><p>Automatically disable advertising and mark it for re-enabling on all handles
that use this buffer</p></li>
<li><p>Free the original buffer</p></li>
</ul>
<p><a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gace138d1c3a9257893543e47f8774fdb9">GapAdv_loadByBuffer()</a> will automatically re-enable advertising on all
handles that used the original buffer.</p>
</div>
</div>
<div class="section" id="directly-manipulating-a-buffer-while-advertising-is-enabled">
<h3>Directly Manipulating a Buffer While Advertising is Enabled<a class="headerlink" href="#directly-manipulating-a-buffer-while-advertising-is-enabled" title="Permalink to this headline">¶</a></h3>
<p>Since the application owns the advertising and scan response buffers and thus has access to
the memory where the buffers are stored, there is nothing preventing it from directly
modifying this memory. While discouraged, there are scenarios where this can
be useful, such as updating the data after each advertisement in the most power-efficient
manner. The main drawback to this is that there is no way to guarantee that this update
won’t occur while an advertising packet is being transmitted that is using this buffer,
potentially resulting in a corrupted advertising packet. This is especially true if
multiple advertising sets are using the same buffer. If the application accepts the risk
of potentially corrupting an advertising packet, there is a recommended way to do this with
minimized risk.</p>
<p>The buffer should be updated directly in the advertising callback (in the stack context)
when the <code class="docutils literal notranslate"><span class="pre">GAP_EVT_ADV_END</span></code> is received. Generally, it is recommended to
minimize processing in these callbacks and, instead, to post an event to process
in the application context. It should be noted that any processing in the stack
context has the potential to break the timing of the controller. This should not
be a problem if the only processing is to update the buffer. Also, for both this
reason and because it will lead to a semaphore that never gets posted due to
calling an ICall API from the stack context, it should be noted that no stack
API calls can be made from the stack context. To reiterate for clarity, no BLE-Stack APIs
can be called from the callback (stack) context.</p>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-number">Listing 66. </span><span class="caption-text">Directly update advertising data in stack context.</span><a class="headerlink" href="#id27" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">  </span><span class="c1">// Callback passed into GapAdv_create(). This code is running in the stack context.</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SimplePeripheral_advCallback</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">pBuf</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">    </span><span class="c1">// Advertisement just ended so it should be safe to update buffer here</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="c1">// without corrupting an advertisement.</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GAP_EVT_ADV_END</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">       </span><span class="n">advertData</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xAA</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>Note that this can not be guaranteed to work all the time without corrupting an
advertisement. Also, if the buffer is used by multiple advertisement handles, the
application would need to track the <code class="docutils literal notranslate"><span class="pre">GAP_EVT_ADV_ENDs</span></code> across all of these handles to
find an ideal time to update the buffer. If this processing is added to the callback
in the stack context, this increases the risk of breaking the timing of the
controller. Also, remember to include <code class="docutils literal notranslate"><span class="pre">GAP_EVT_ADV_END</span></code> in the event mask
passed in <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#ga5d7659d489538c2d62ed3409b22e3f9c">GapAdv_setEventMask()</a>.</p>
</div>
<div class="section" id="adding-tx-power-to-an-advertisement-payload">
<h3>Adding TX Power to an Advertisement Payload<a class="headerlink" href="#adding-tx-power-to-an-advertisement-payload" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This feature is only available for Extended Advertisements.</p>
</div>
<p>In some cases, it is desired to add the TX power to an advertisement payload. At
the application layer, a central device who scans for the advertisment can use
this field (amongst others) to filter out devices and connect to a specific
peripheral.</p>
<p>The TX power value can be added using SysConfig. To do so, open the project’s
SysConfig file.</p>
<ol class="arabic simple">
<li><p>Navigate to BLE → Broadcaster Configuration → Advertisement Set # → Advertisement Parameters #.</p></li>
<li><p>Under <strong>Event Properties</strong>, select <code class="docutils literal notranslate"><span class="pre">Include</span> <span class="pre">TxPower</span> <span class="pre">in</span> <span class="pre">the</span> <span class="pre">extended</span> <span class="pre">header</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">advertising</span> <span class="pre">PDU</span></code>.</p></li>
<li><p>Navigate to the Advertisement Data section and select the <code class="docutils literal notranslate"><span class="pre">TX</span> <span class="pre">Power</span> <span class="pre">Level</span></code>
check box to add this to the advertisement payload.</p></li>
</ol>
</div>
<div class="section" id="sending-up-to-1650-bytes-scan-response-data">
<h3>Sending Up To 1650 Bytes Scan Response Data<a class="headerlink" href="#sending-up-to-1650-bytes-scan-response-data" title="Permalink to this headline">¶</a></h3>
<p>The Advertising Extension enables user to send huge amount of data without forming
connections and prevent jamming legacy advertising channels.
There are currently three methods for sending 1650 bytes data without
establishing connections which listed under <a class="reference internal" href="#gap-constraints"><span class="std std-ref">GAP Constraints</span></a>.</p>
<p>Here we are focusing on transmitting 1650 bytes through scan response data.
Even though broadcasting and periodic advertising can achieve the same outcome, it
can sometimes consume more energy than necessary due to it is always transmitting
1650 bytes of data whether or not there are scanners listening.
To avoid wasting energy, we can store 1650 bytes data in scan response. Then only
when the advertiser receives scan request, it will respond with 1650 scan response data.</p>
<p>To send 1650 bytes scan response data, you will need to enable
the extended advertisement which contains PDU type <code class="docutils literal notranslate"><span class="pre">ADV_EXT_IND</span></code> and <code class="docutils literal notranslate"><span class="pre">AUX_ADV_IND</span></code> packets.
The <code class="docutils literal notranslate"><span class="pre">ADV_EXT_IND</span></code> contains the following information which makes it possible for
scanner to send <code class="docutils literal notranslate"><span class="pre">AUX_SCAN_REQ</span></code> packets under correct timing.</p>
<ul class="simple">
<li><p>The data channel for the Auxiliary Packet Pointer which is <code class="docutils literal notranslate"><span class="pre">AUX_ADV_IND</span></code> packet.</p></li>
<li><p>The clock accuracy for advertiser.</p></li>
<li><p>The time of when the <code class="docutils literal notranslate"><span class="pre">AUX_ADV_IND</span></code> packet will be transmitted.</p></li>
<li><p>The PHY which is used by <code class="docutils literal notranslate"><span class="pre">AUX_ADV_IND</span></code> packet.</p></li>
</ul>
<p>With the information provided by <code class="docutils literal notranslate"><span class="pre">ADV_EXT_IND</span></code> packet, the scanner can jump
to data channel to listen for <code class="docutils literal notranslate"><span class="pre">AUX_ADV_IND</span></code> ahead of time and then send
out <code class="docutils literal notranslate"><span class="pre">AUX_SCAN_REQ</span></code> packet to request more data.</p>
<p>Once the advertiser receives <code class="docutils literal notranslate"><span class="pre">AUX_SCAN_REQ</span></code> packet, it will respond with
<code class="docutils literal notranslate"><span class="pre">AUX_SCAN_RSP</span></code> packet which can hold up to 242 bytes application data.
If the scan response data is more than 242 bytes, then the BLE5-Stack will
automatically create <code class="docutils literal notranslate"><span class="pre">AUX_CHAIN_IND</span></code> packet(s), which can also
hold up to 242 bytes application data, and fragment the rest of the
scan response data until all the 1650 bytes are sent.</p>
<img alt="../_images/ditaa-455fa95abed544d15ee8324039740a3ccf90b610.png" src="../_images/ditaa-455fa95abed544d15ee8324039740a3ccf90b610.png" />
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This is currently not supported through Sysconfig, therefore
to implement this feature, you will need to <a class="reference internal" href="../sysconfig/sysconfig-disable.html#sysconfig-disable"><span class="std std-ref">Disable SysConfig</span></a>.</p>
</div>
<p>To acheive this using BLE5-Stack, follow the steps below:</p>
<ol class="arabic">
<li><p>Set the advertising event property to <code class="docutils literal notranslate"><span class="pre">GAP_ADV_PROP_SCANNABLE</span></code>.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-number">Listing 67. </span><span class="caption-text">Configure advertising parameters</span><a class="headerlink" href="#id28" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">  </span><span class="c1">// Advertisement Params</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="n">GapAdv_params_t</span><span class="w"> </span><span class="n">advParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="linenos"> 3</span><span class="w">    </span><span class="p">.</span><span class="n">eventProps</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="n">GAP_ADV_PROP_SCANNABLE</span><span class="p">,</span><span class="w"></span>
</span><span class="linenos"> 4</span><span class="w">    </span><span class="p">.</span><span class="n">primIntMin</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="mi">160</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="p">.</span><span class="n">primIntMax</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="mi">160</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">    </span><span class="p">.</span><span class="n">primChanMap</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">GAP_ADV_CHAN_ALL</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">.</span><span class="n">peerAddrType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PEER_ADDRTYPE_PUBLIC_OR_PUBLIC_ID</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="p">.</span><span class="n">peerAddr</span><span class="w"> </span><span class="o">=</span><span class="w">     </span><span class="p">{</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">,</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">,</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">,</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">,</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">,</span><span class="w"> </span><span class="mh">0xaa</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">.</span><span class="n">filterPolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAP_ADV_WL_POLICY_ANY_REQ</span><span class="p">,</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="p">.</span><span class="n">txPower</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="n">GAP_ADV_TX_POWER_NO_PREFERENCE</span><span class="p">,</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">.</span><span class="n">primPhy</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="n">GAP_ADV_PRIM_PHY_1_MBPS</span><span class="p">,</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">.</span><span class="n">secPhy</span><span class="w"> </span><span class="o">=</span><span class="w">       </span><span class="n">GAP_ADV_SEC_PHY_2_MBPS</span><span class="p">,</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="p">.</span><span class="n">sid</span><span class="w"> </span><span class="o">=</span><span class="w">          </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">14</span><span class="w">   </span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
</li>
<li><p>Create advertising handle with above parameters.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-number">Listing 68. </span><span class="caption-text">Configure advertising parameters</span><a class="headerlink" href="#id29" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">uint8</span><span class="w"> </span><span class="n">advHandle</span><span class="p">;</span><span class="w"></span>
<span class="linenos">2</span><span class="w">  </span><span class="n">GapAdv_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Application_advCallback</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">advParams</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">advHandle</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Here we do NOT load the advertising data as we are creating AE
scannable packet which is not allowed to have data on legacy
advertising channels.</p>
</div>
</div></blockquote>
</li>
<li><p>Change the size of scanResData.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-number">Listing 69. </span><span class="caption-text">scanResData[] can be found under ti_ble_config.h.</span><a class="headerlink" href="#id30" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">scanResData</span><span class="p">[</span><span class="mi">1650</span><span class="p">];</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
</li>
<li><p>Fill out the scanResData to what you want to send over the air
under application_init function.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id31">
<div class="code-block-caption"><span class="caption-number">Listing 70. </span><span class="caption-text">Fill out scan response data array</span><a class="headerlink" href="#id31" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="w">  </span><span class="c1">// Use the sysconfig-generated scan response</span>
<span class="linenos">4</span><span class="w">  </span><span class="c1">// data for the first 27 bytes and fill out</span>
<span class="linenos">5</span><span class="w">  </span><span class="c1">// the rest with 0x55</span>
<span class="linenos">6</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">27</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">scanResData</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">7</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">8</span><span class="w">    </span><span class="n">scanResData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x55</span><span class="p">;</span><span class="w"></span>
<span class="linenos">9</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
</li>
<li><p>Load scan response data and enable advertising.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id32">
<div class="code-block-caption"><span class="caption-number">Listing 71. </span><span class="caption-text">Load scan response data</span><a class="headerlink" href="#id32" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="c1">// Load scan response data</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">GapAdv_loadByHandle</span><span class="p">(</span><span class="n">advHandle</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_DATA_TYPE_SCAN_RSP</span><span class="p">,</span><span class="w"></span>
<span class="linenos">3</span><span class="w">                      </span><span class="k">sizeof</span><span class="p">(</span><span class="n">scanResData</span><span class="p">),</span><span class="w"> </span><span class="n">scanResData</span><span class="p">);</span><span class="w"></span>
<span class="linenos">4</span><span class="w">  </span><span class="c1">// Enable advertising</span>
<span class="linenos">5</span><span class="w">  </span><span class="n">GapAdv_enable</span><span class="p">(</span><span class="n">advHandle</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_ENABLE_OPTIONS_USE_MAX</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To change scan response data on the fly, you can refer
to <a class="reference internal" href="#gap-update-adv-scan-data"><span class="std std-ref">Update the Advertising/Scan Response Data of a Single Handle</span></a>.</p>
</div>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="limited-advertising">
<span id="gap-limited-advertising"></span><h3>Limited Advertising<a class="headerlink" href="#limited-advertising" title="Permalink to this headline">¶</a></h3>
<p>The above code sets the advertising interval for limited and general
advertising modes. By default, the peripheral advertises in general
discoverable mode. To use limited discoverable mode, the
corresponding fields inside the advertising data packet should be
changed by defining <code class="docutils literal notranslate"><span class="pre">DEFAULT_DISCOVERABLE_MODE</span></code> to
<code class="docutils literal notranslate"><span class="pre">GAP_ADTYPE_FLAGS_LIMITED</span></code>. The application is responsible for setting the advertising
data and advertising duration.</p>
</div>
<div class="section" id="periodic-advertising">
<span id="gap-periodic-advertising"></span><h3>Periodic Advertising<a class="headerlink" href="#periodic-advertising" title="Permalink to this headline">¶</a></h3>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The symbol <code class="docutils literal notranslate"><span class="pre">USE_PERIODIC_ADV</span></code> must be pre-defined if you
wish to send periodic advertisements (for more details, please see
<a class="reference internal" href="stack-configuration-cc13xx_cc26xx.html#stackconfigurablefeatures"><span class="std std-ref">Bluetooth Low Energy Stack Configuration Parameters</span></a>).</p>
</div>
<p>Periodic adverting is part of the Advertising Extension and it allows device to
send data synchronously at a fixed interval. Periodic advertising is not scannable,
not connectable and the advertiser’s address should not be hidden.</p>
<p>In order for scanner to receive periodic advertisement, the extended advertisement
needs to be enabled and contain at least one PDU type <code class="docutils literal notranslate"><span class="pre">AUX_ADV_IND</span></code> packet. The reason for that
is the <code class="docutils literal notranslate"><span class="pre">SyncInfo</span></code> to the periodic advertisement packets can only be found
under <code class="docutils literal notranslate"><span class="pre">AUX_ADV_IND</span></code> packet.</p>
<p>The detailed process for enabling periodic advertisement is as follows:</p>
<ul class="simple">
<li><p>Advertiser sends out <code class="docutils literal notranslate"><span class="pre">ADV_EXT_IND</span></code> PDU type. Scanner will find the channel index, timing and PHY that a coming
auxiliary packet(<code class="docutils literal notranslate"><span class="pre">AUX_ADV_IND</span></code>) will be sent at under AuxPtr field.</p></li>
<li><p>Advertiser then sends out <code class="docutils literal notranslate"><span class="pre">AUX_ADV_IND</span></code> PDU type package. If there is periodic advertisement coming
up, scanner will find <code class="docutils literal notranslate"><span class="pre">SyncInfo</span></code> field under extended header. The SyncInfo field
contains the needed information for a scanner to follow periodic advertisement packets.
For more detail, please refer to the picture below and Vol 6, Part B, Section 2.3 of <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>.</p></li>
</ul>
<img alt="../_images/ditaa-964afdd9f3726284675afa715790eb2dcfaf5def.png" src="../_images/ditaa-964afdd9f3726284675afa715790eb2dcfaf5def.png" />
<p>The picture below depicts the overall flow of how periodic advertisement works.</p>
<img alt="../_images/ditaa-1bfd3b2faab1fd091377d32843003bb9ca332a6e.png" src="../_images/ditaa-1bfd3b2faab1fd091377d32843003bb9ca332a6e.png" />
<p>The following list describes how to configure the GAP layer for periodic advertising.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The periodic advertisement set creation is not supported in SysConfig.</p>
</div>
<div class="section" id="enable-non-connectable-non-scannable-extended-advertisement">
<h4>Enable Non-Connectable Non-Scannable Extended Advertisement<a class="headerlink" href="#enable-non-connectable-non-scannable-extended-advertisement" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p>Setup parameters for <strong>non-connectable and non-scannable</strong> extended advertisement.
To achieve this, you can set eventProps = 0 and sid != 0</p>
<div class="literal-block-wrapper docutils container" id="id33">
<div class="code-block-caption"><span class="caption-number">Listing 72. </span><span class="caption-text">Setting up advertising parameters for non-connectable and non-scannable extended advertisement set</span><a class="headerlink" href="#id33" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="c1">/// Non-Connectable &amp; Non-Scannable advertising set</span>
<span class="linenos"> 2</span><span class="w"> </span><span class="cp">#define GAPADV_PARAMS_AE_NC_NS {                                           \</span>
<span class="hll"><span class="linenos"> 3</span><span class="cp">   .eventProps = 0,                                                         \</span>
</span><span class="linenos"> 4</span><span class="cp">   .primIntMin = 160,                                                       \</span>
<span class="linenos"> 5</span><span class="cp">   .primIntMax = 160,                                                       \</span>
<span class="linenos"> 6</span><span class="cp">   .primChanMap = GAP_ADV_CHAN_ALL,                                         \</span>
<span class="linenos"> 7</span><span class="cp">   .peerAddrType = PEER_ADDRTYPE_PUBLIC_OR_PUBLIC_ID,                       \</span>
<span class="linenos"> 8</span><span class="cp">   .peerAddr = { 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa },                      \</span>
<span class="linenos"> 9</span><span class="cp">   .filterPolicy = GAP_ADV_WL_POLICY_ANY_REQ,                               \</span>
<span class="linenos">10</span><span class="cp">   .txPower = GAP_ADV_TX_POWER_NO_PREFERENCE,                               \</span>
<span class="linenos">11</span><span class="cp">   .primPhy = GAP_ADV_PRIM_PHY_1_MBPS,                                      \</span>
<span class="linenos">12</span><span class="cp">   .secPhy = GAP_ADV_SEC_PHY_1_MBPS,                                        \</span>
<span class="hll"><span class="linenos">13</span><span class="cp">   .sid = 1                                                                 \</span>
</span><span class="linenos">14</span><span class="cp"> }</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w"> </span><span class="c1">// Create non connectable &amp; non scannable advertising</span>
<span class="linenos">17</span><span class="w"> </span><span class="n">GapAdv_params_t</span><span class="w"> </span><span class="n">advParamNonConn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPADV_PARAMS_AE_NC_NS</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p>Creating <strong>non-connectable and non-scannable</strong> extended advertisement.</p>
<div class="literal-block-wrapper docutils container" id="id34">
<div class="code-block-caption"><span class="caption-number">Listing 73. </span><span class="caption-text">Creating and enable extended advertisement</span><a class="headerlink" href="#id34" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">   </span><span class="k">static</span><span class="w"> </span><span class="n">uint8</span><span class="w"> </span><span class="n">advHandleNCNS</span><span class="p">;</span><span class="w">      </span><span class="c1">// Non-Connactable &amp; Non-Scannable</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="w">   </span><span class="c1">// Create Advertisement set #3 and assign handle</span>
<span class="linenos"> 4</span><span class="w">   </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">advCallback</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">advParamNonConn</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">                                        </span><span class="o">&amp;</span><span class="n">advHandleNCNS</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">   </span><span class="c1">// Load advertising data for set #3 that is statically allocated by the app</span>
<span class="linenos"> 8</span><span class="w">   </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_loadByHandle</span><span class="p">(</span><span class="n">advHandleNCNS</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_DATA_TYPE_ADV</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">                                </span><span class="k">sizeof</span><span class="p">(</span><span class="n">advertData</span><span class="p">),</span><span class="w"> </span><span class="n">advertData</span><span class="p">);</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="w">   </span><span class="c1">// Set event mask for set #3</span>
<span class="linenos">12</span><span class="w">   </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_setEventMask</span><span class="p">(</span><span class="n">advHandleNCNS</span><span class="p">,</span><span class="w"></span>
<span class="linenos">13</span><span class="w">                                </span><span class="n">GAP_ADV_EVT_MASK_START_AFTER_ENABLE</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="linenos">14</span><span class="w">                                </span><span class="n">GAP_ADV_EVT_MASK_END_AFTER_DISABLE</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="linenos">15</span><span class="w">                                </span><span class="n">GAP_ADV_EVT_MASK_SET_TERMINATED</span><span class="p">);</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="w">   </span><span class="c1">// Enable non connectable &amp; non scannable advertising for set #3</span>
<span class="linenos">18</span><span class="w">   </span><span class="c1">// This is a must in order to enable periodic advertisement</span>
<span class="linenos">19</span><span class="w">   </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_enable</span><span class="p">(</span><span class="n">advHandleNCNS</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_ENABLE_OPTIONS_USE_MAX</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p>Setup parameters for periodic advertisement.
The BLE5-Stack will then return <code class="docutils literal notranslate"><span class="pre">GAP_ADV_SET_PERIODIC_ADV_PARAMS_EVENT</span></code> to the application layer whether
or not the parameters are set successfully.</p>
<div class="literal-block-wrapper docutils container" id="id35">
<div class="code-block-caption"><span class="caption-number">Listing 74. </span><span class="caption-text">Setting up advertising parameters for non-connectable and non-scannable extended advertisement set</span><a class="headerlink" href="#id35" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="c1">/// Non-Connectable &amp; Non-Scannable advertising set</span>
<span class="linenos"> 2</span><span class="w"> </span><span class="cp">#define GAPADV_PARAMS_PERIODIC_ADV {                                     \</span>
<span class="linenos"> 3</span><span class="cp">   .periodicAdvIntervalMin = 160,                                         \</span>
<span class="linenos"> 4</span><span class="cp">   .periodicAdvIntervalMax = 160,                                         \</span>
<span class="linenos"> 5</span><span class="cp">   .periodicAdvProp = GAPADV_PERIODIC_ADV_ENABLE_TX_POWER                 \</span>
<span class="linenos"> 6</span><span class="cp"> }</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w"> </span><span class="c1">// Set Periodic Advertising parameters</span>
<span class="linenos"> 9</span><span class="w"> </span><span class="n">GapAdv_periodicAdvParams_t</span><span class="w"> </span><span class="n">advParamsPerAdv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPADV_PARAMS_PERIODIC_ADV</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_SetPeriodicAdvParams</span><span class="p">(</span><span class="n">advHandleNCNS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">advParamsPerAdv</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Only bit 6 in periodicAdvProp field can be set, otherwise the BLE5-Stack will return bleInvalidRange.</p>
</div>
</li>
</ol>
</div>
<div class="section" id="configure-advertising-data-for-periodic-advertisement">
<span id="gap-periodic-advertising-advdata-set"></span><h4>Configure Advertising Data For Periodic Advertisement<a class="headerlink" href="#configure-advertising-data-for-periodic-advertisement" title="Permalink to this headline">¶</a></h4>
<p>Advertising data for periodic advertisement is optional. It’s not needed to have periodic advertisment running.</p>
<ol class="arabic">
<li><p>Setup advertising data for periodic advertisement.
The BLE5-Stack will then return <code class="docutils literal notranslate"><span class="pre">GAP_ADV_SET_PERIODIC_ADV_DATA_EVENT</span></code> to the application layer whether
or not the adverting data are set successfully.</p>
<div class="literal-block-wrapper docutils container" id="id36">
<div class="code-block-caption"><span class="caption-number">Listing 75. </span><span class="caption-text">Setting up advertising data for periodic advertising</span><a class="headerlink" href="#id36" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="c1">// Periodic Advertising Data</span>
<span class="linenos"> 2</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">periodicData</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">   </span><span class="sc">&#39;P&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">   </span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">   </span><span class="sc">&#39;r&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">   </span><span class="sc">&#39;i&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">   </span><span class="sc">&#39;o&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">   </span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos">10</span><span class="w">   </span><span class="sc">&#39;i&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos">11</span><span class="w">   </span><span class="sc">&#39;c&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos">12</span><span class="w">   </span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos">13</span><span class="w">   </span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos">14</span><span class="w">   </span><span class="sc">&#39;v&#39;</span><span class="w"></span>
<span class="linenos">15</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="w"> </span><span class="cp">#define GAPADV_DATA_PERIODIC_ADV {                          \</span>
<span class="linenos">18</span><span class="cp">   .operation = GAPADV_PERIODIC_ADV_DATA_COMPLETE,           \</span>
<span class="linenos">19</span><span class="cp">   .dataLength = sizeof(periodicData),                       \</span>
<span class="linenos">20</span><span class="cp">   .pData = periodicData                                     \</span>
<span class="linenos">21</span><span class="cp"> }</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w"> </span><span class="n">GapAdv_periodicAdvData_t</span><span class="w"> </span><span class="n">periodicDataParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAPADV_DATA_PERIODIC_ADV</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_SetPeriodicAdvData</span><span class="p">(</span><span class="n">advHandleNCNS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">periodicDataParams</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can find a list of define made for periodic advertisement under gap_advertiser.h.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The maximum data length that is supported here is 252 bytes. Therefore, if you have a advertising
data for more than 252 bytes, you will have to fragment the payload in the application layer before calling
<a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gad929bae6c5297bead40bb62017ccf541">GapAdv_SetPeriodicAdvData()</a>.</p>
<p>For example, if you have 1000 bytes advertising data you want to send using periodic advertisement, you will
have to call <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gad929bae6c5297bead40bb62017ccf541">GapAdv_SetPeriodicAdvData()</a> four times.
The operation field for first 252 bytes needs to be set to <code class="docutils literal notranslate"><span class="pre">GAPADV_PERIODIC_ADV_DATA_FIRST_FRAG(0x01)</span></code>.
The operation field for 253 ~ 504 and 505 ~ 756 bytes needs to be set to
<code class="docutils literal notranslate"><span class="pre">GAPADV_PERIODIC_ADV_DATA_INTERMIDIATE_FRAG</span> <span class="pre">(0x00)</span></code>, and the operation field for the last part of
the data needs to be set to <code class="docutils literal notranslate"><span class="pre">GAPADV_PERIODIC_ADV_DATA_LAST_FRAG</span> <span class="pre">(0x02)</span></code>.</p>
<p>The BLE5-Stack will chain the data based on the order of <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gad929bae6c5297bead40bb62017ccf541">GapAdv_SetPeriodicAdvData()</a> calls.</p>
</div>
</li>
</ol>
</div>
<div class="section" id="enable-periodic-advertisement">
<span id="gap-periodic-advertising-enable"></span><h4>Enable Periodic Advertisement<a class="headerlink" href="#enable-periodic-advertisement" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p>Enable periodic advertisement.
The BLE5-Stack will then return <code class="docutils literal notranslate"><span class="pre">GAP_ADV_SET_PERIODIC_ADV_ENABLE_EVENT</span></code> to the application layer whether
or not the periodic advertising starts successfully.</p>
<div class="literal-block-wrapper docutils container" id="id37">
<div class="code-block-caption"><span class="caption-number">Listing 76. </span><span class="caption-text">Enable periodic advertising</span><a class="headerlink" href="#id37" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_SetPeriodicAdvEnable</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">advHandleNCNS</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Even when <a class="reference external" href="../../doxygen/ble/html/group___gap_adv.html#gacd62e9c48c01972b352181b7186ef162">GapAdv_SetPeriodicAdvEnable()</a> was called, if the non-connectable non-scannable
extended advertisement is not enabled, the periodic advertisement will not start.</p>
</div>
</li>
</ol>
</div>
<div class="section" id="disable-periodic-advertisement">
<span id="gap-periodic-advertising-disable"></span><h4>Disable Periodic Advertisement<a class="headerlink" href="#disable-periodic-advertisement" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p>Disable periodic advertisement.
The BLE5-Stack will then return <code class="docutils literal notranslate"><span class="pre">GAP_ADV_SET_PERIODIC_ADV_ENABLE_EVENT</span></code> to the application layer whether
or not the periodic advertising stops successfully.</p>
<div class="literal-block-wrapper docutils container" id="id38">
<div class="code-block-caption"><span class="caption-number">Listing 77. </span><span class="caption-text">Enable periodic advertising</span><a class="headerlink" href="#id38" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapAdv_SetPeriodicAdvEnable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">advHandleNCNS</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
</ol>
</div>
<div class="section" id="change-advertising-data-for-periodic-advertisement">
<h4>Change Advertising Data For Periodic Advertisement<a class="headerlink" href="#change-advertising-data-for-periodic-advertisement" title="Permalink to this headline">¶</a></h4>
<p>There are two methods to change the advertising data for periodic advertisement.</p>
<ol class="arabic simple">
<li><p>If the new data is less than or equal to 252 bytes, which means operation mode =
<code class="docutils literal notranslate"><span class="pre">GAPADV_PERIODIC_ADV_DATA_COMPLETE</span> <span class="pre">(0x3)</span></code>. Then you can just follow
<a class="reference internal" href="#gap-periodic-advertising-advdata-set"><span class="std std-ref">Configure Advertising Data For Periodic Advertisement</span></a> to populate the new data.</p></li>
<li><p>If the new data is more than 252 bytes, then you will have to disable the periodic advertisement
first, please refer to <a class="reference internal" href="#gap-periodic-advertising-disable"><span class="std std-ref">Disable Periodic Advertisement</span></a> and then
follow <a class="reference internal" href="#gap-periodic-advertising-advdata-set"><span class="std std-ref">Configure Advertising Data For Periodic Advertisement</span></a> to populate the new data.</p></li>
</ol>
</div>
</div>
</div>
<div class="section" id="gap-peripheral">
<span id="gaprole-peripheral-role"></span><h2>GAP Peripheral<a class="headerlink" href="#gap-peripheral" title="Permalink to this headline">¶</a></h2>
<p>The peripheral role is demonstrated in simple_peripheral.c and
simple_peripheral.h. The Peripheral role demonstrates the use of the advertising and
connection states. The steps to use this role are as follows:</p>
<ol class="arabic">
<li><p>Initialize the GAP parameters. This initialization should occur in the
application initialization function, for example in <code class="docutils literal notranslate"><span class="pre">SimplePeripheral_init</span></code>
as shown below.</p>
<div class="literal-block-wrapper docutils container" id="id39">
<span id="gaprole-init"></span><div class="code-block-caption"><span class="caption-number">Listing 78. </span><span class="caption-text"><strong>simple_peripheral.c :: SimplePeripheral_init()</strong> - Setup of the GAP Peripheral Role</span><a class="headerlink" href="#id39" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="c1">// Configure GAP</span>
<span class="linenos">2</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">3</span><span class="w">   </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">paramUpdateDecision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_PARAM_UPDATE_REQ_DECISION</span><span class="p">;</span><span class="w"></span>
<span class="linenos">4</span>
<span class="linenos">5</span><span class="w">   </span><span class="c1">// Pass all parameter update requests to the app for it to decide</span>
<span class="linenos">6</span><span class="w">   </span><span class="n">GAP_SetParamValue</span><span class="p">(</span><span class="n">GAP_PARAM_LINK_UPDATE_DECISION</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">paramUpdateDecision</span><span class="p">);</span><span class="w"></span>
<span class="linenos">7</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p>Initialize the application task for the Peripheral Role and register to
receive GAP events.</p>
<div class="literal-block-wrapper docutils container" id="id40">
<div class="code-block-caption"><span class="caption-number">Listing 79. </span><span class="caption-text"><strong>simple_peripheral.c :: SimplePeripheral_init()</strong> - Initialize the GAP layer and register for GAP events.</span><a class="headerlink" href="#id40" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">   </span><span class="c1">//Initialize GAP layer for Peripheral role and register to receive GAP events</span>
<span class="linenos">2</span><span class="w">   </span><span class="n">GAP_DeviceInit</span><span class="p">(</span><span class="n">GAP_PROFILE_PERIPHERAL</span><span class="p">,</span><span class="w"> </span><span class="n">selfEntity</span><span class="p">,</span><span class="w"> </span><span class="n">addrMode</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p>Now you can send commands from the application. The following is an example
of the application initiating PHY change using <a class="reference external" href="../../doxygen/ble/html/group___h_c_i.html#ga540aa5d357dedb39422bfe98bada4b22">HCI_LE_SetPhyCmd()</a>.</p>
<div class="literal-block-wrapper docutils container" id="id41">
<div class="code-block-caption"><span class="caption-number">Listing 80. </span><span class="caption-text"><strong>simple_peripheral.c :: SimplePeripheral_setPhy()</strong> - Changing the PHY</span><a class="headerlink" href="#id41" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">  </span><span class="c1">// Send PHY Update</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">HCI_LE_SetPhyCmd</span><span class="p">(</span><span class="n">connHandle</span><span class="p">,</span><span class="w"> </span><span class="n">allPhys</span><span class="p">,</span><span class="w"> </span><span class="n">txPhy</span><span class="p">,</span><span class="w"> </span><span class="n">rxPhy</span><span class="p">,</span><span class="w"> </span><span class="n">phyOpts</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>The following shows the software flow when the user chooses to set the PHY preference
from the terminal in simple_peripheral example:</p>
<div class="figure align-center" id="id42">
<p class="plantuml">
<img src="../_images/plantuml-00e7d8dc061af3bd7483d8d1c4a4a1aaafc718b2.png" alt="&#64;startuml
participant Application
participant &quot;BLE Stack&quot;

group Connected to a device

group User presses button to initiate PHY change
  Application -&gt; Application: Button ISR
end

  rnote over Application
   Button handler calls
   application callback
  end note

  Application -&gt; Application : SimplePeripheral_doSetConnPhy()
  Application -&gt; Application : SimplePeripheral_setPhy()
  Application -&gt; &quot;BLE Stack&quot; : HCI_LE_SetPhyCmd()

  &quot;BLE Stack&quot; -&gt; Application : return(status)

  group Receive HCI Event
    &quot;BLE Stack&quot; -&gt; Application : SimplePeripheral_processStackMsg

    rnote over &quot;Application&quot;
     HCI_GAP_EVENT_EVENT -&gt; HCI_LE_EVENT_CODE -&gt; HCI_BLE_PHY_UPDATE_COMPLETE_EVENT
    end note

    rnote over &quot;Application&quot;
     Display changed PHY
    end note
  end
end

&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 68. </span><span class="caption-text">Context Diagram of Application Updating PHY.</span><a class="headerlink" href="#id42" title="Permalink to this image">¶</a></p>
</div>
<p>As shown in the diagram above, the actual PHY change is returned asynchronously and is
passed to the application with event code HCI_BLE_PHY_UPDATE_COMPLETE_EVENT.</p>
</li>
<li><p>The application task processes most of the GAP-related events passed to it
from the Bluetooth Low Energy protocol stack. For example, when a link is
terminated, the application automatically restarts advertising. The following
code snippet can be found in <code class="docutils literal notranslate"><span class="pre">simple_peripheral.c</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id43">
<div class="code-block-caption"><span class="caption-number">Listing 81. </span><span class="caption-text"><strong>simple_peripheral.c :: SimplePeripheral_processGapMessage()</strong> - Restart advertising after disconnect</span><a class="headerlink" href="#id43" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SimplePeripheral_processGapMessage</span><span class="p">(</span><span class="n">gapEventHdr_t</span><span class="w"> </span><span class="o">*</span><span class="n">pMsg</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">    </span><span class="c1">//.......</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">GAP_LINK_TERMINATED_EVENT</span><span class="p">:</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">        </span><span class="c1">//.......</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">        </span><span class="c1">// Restart advertising since there is now an active connection</span>
<span class="linenos"> 9</span><span class="w">        </span><span class="n">GapAdv_enable</span><span class="p">(</span><span class="n">advHandleLegacy</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_ADV_ENABLE_OPTIONS_USE_MAX</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="w">        </span><span class="c1">//.......</span>
<span class="linenos">12</span><span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
</ol>
</div>
<div class="section" id="gap-scanner">
<span id="gapscanner"></span><h2>GAP Scanner<a class="headerlink" href="#gap-scanner" title="Permalink to this headline">¶</a></h2>
<p>The GAP Scanner performs Extended Scanning, Legacy Scanning and
Synchronization with periodic advertisements operations as
defined by the <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>. It controls the Scanner GAP state (see
<a class="reference internal" href="#gap-state-diagram"><span class="std std-ref">GAP State Diagram.</span></a>). The Central and Observer role uses the scanning
state implemented by the GAP Scanner. The GAP Scanner is demonstrated in the
<em>simple central</em> and <em>simple observer</em> example projects. The periodic
advertisement synchronization capability of the GAP Scanner is
demonstrated in the <em>rtls_master</em> example project. See the
<a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13xx_cc26xx.html#ble-api-reference"><span class="std std-ref">BLE Stack API Reference</span></a> for the full GAP Scanner API including commands,
configurable parameters, events, and callbacks. The steps to use this module are
listed in the following, along with example code from <em>simple central</em>.</p>
<ol class="arabic">
<li><p><strong>Start a Central or Observer GAP role.</strong> In this case we will use the GAP
Central role.</p>
<div class="literal-block-wrapper docutils container" id="id44">
<div class="code-block-caption"><span class="caption-number">Listing 82. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_init()</strong> - Initialize the GAP central role.</span><a class="headerlink" href="#id44" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Initialize GAP layer for Central role and register to receive GAP events</span>
<span class="w">  </span><span class="n">GAP_DeviceInit</span><span class="p">(</span><span class="n">GAP_PROFILE_CENTRAL</span><span class="p">,</span><span class="w"> </span><span class="n">selfEntity</span><span class="p">,</span><span class="w"> </span><span class="n">addrMode</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p><strong>Set up a callback function for scanner events and register to</strong>
<a class="reference external" href="../../doxygen/ble/html/gap__advertiser_8h.html">gap_advertiser.h</a>. Since the callback (in this
case <code class="docutils literal notranslate"><span class="pre">SimpleCentral_scanCb()</span></code>) is called from the stack, as little processing
as possible should happen in it.</p>
<div class="literal-block-wrapper docutils container" id="id45">
<div class="code-block-caption"><span class="caption-number">Listing 83. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processGapMsg() :: GAP_DEVICE_INIT_DONE_EVENT</strong> - Initialize the GAP central role.</span><a class="headerlink" href="#id45" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Register callback to process Scanner events</span>
<span class="w">  </span><span class="n">GapScan_registerCb</span><span class="p">(</span><span class="n">SimpleCentral_scanCb</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p><strong>Set which events to pass to application.</strong></p>
<div class="literal-block-wrapper docutils container" id="id46">
<div class="code-block-caption"><span class="caption-number">Listing 84. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processGapMsg() :: GAP_DEVICE_INIT_DONE_EVENT</strong> - Set which events to pass to the callback function.</span><a class="headerlink" href="#id46" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Set Scanner Event Mask</span>
<span class="w">  </span><span class="n">GapScan_setEventMask</span><span class="p">(</span><span class="n">GAP_EVT_SCAN_ENABLED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GAP_EVT_SCAN_DISABLED</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">                          </span><span class="n">GAP_EVT_ADV_REPORT</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</li>
<li><p><strong>Set scan parameters.</strong> It’s worth noting that the parameters are split into
PHY-related parameters (set with <a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#ga91e950a09e7bb42aca94de5825955144">GapScan_setPhyParams()</a>) and
non-PHY-related parameters (set with <a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#gaea670f68167c414703dc53a687f451d5">GapScan_setParam()</a>). Remember
to set both.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Make sure the scanning window is at least twice the length of the expected advertising interval to ensure at least 1 advertising event
is captured in each scanning window. Otherwise, the scanning device may not find the advertising device.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id47">
<div class="code-block-caption"><span class="caption-number">Listing 85. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processGapMsg() :: GAP_DEVICE_INIT_DONE_EVENT</strong> - Set PHY-related GAP scanner parameters.</span><a class="headerlink" href="#id47" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Set Scan PHY parameters</span>
<span class="w">  </span><span class="n">GapScan_setPhyParams</span><span class="p">(</span><span class="n">DEFAULT_SCAN_PHY</span><span class="p">,</span><span class="w"> </span><span class="n">SCAN_TYPE_ACTIVE</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">SCAN_PARAM_DFLT_INTERVAL</span><span class="p">,</span><span class="w"> </span><span class="n">SCAN_PARAM_DFLT_INTERVAL</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>Set which advertising report fields to send to the application (to the callback function, in this case <code class="docutils literal notranslate"><span class="pre">SimpleCentral_scanCb()</span></code>).</p>
<div class="literal-block-wrapper docutils container" id="id48">
<div class="code-block-caption"><span class="caption-number">Listing 86. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processGapMsg() :: GAP_DEVICE_INIT_DONE_EVENT</strong> - Set GAP scanner parameter.</span><a class="headerlink" href="#id48" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Set Advertising report fields to keep</span>
<span class="w">    </span><span class="n">temp16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SC_ADV_RPT_FIELDS</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">GapScan_setParam</span><span class="p">(</span><span class="n">SCAN_PARAM_RPT_FIELDS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">temp16</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>Enable filter to remove duplicate advertising reports.</p>
<div class="literal-block-wrapper docutils container" id="id49">
<div class="code-block-caption"><span class="caption-number">Listing 87. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processGapMsg() :: GAP_DEVICE_INIT_DONE_EVENT</strong> - Set GAP scanner parameter.</span><a class="headerlink" href="#id49" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Set LL Duplicate Filter</span>
<span class="w">    </span><span class="n">temp8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCAN_FLT_DUP_ENABLE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">GapScan_setParam</span><span class="p">(</span><span class="n">SCAN_PARAM_FLT_DUP</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">temp8</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>Set which PHY to scan on.</p>
<div class="literal-block-wrapper docutils container" id="id50">
<div class="code-block-caption"><span class="caption-number">Listing 88. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processGapMsg() :: GAP_DEVICE_INIT_DONE_EVENT</strong> - Set GAP scanner parameter.</span><a class="headerlink" href="#id50" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Set Scanning Primary PHY</span>
<span class="w">    </span><span class="n">temp8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_SCAN_PHY</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">GapScan_setParam</span><span class="p">(</span><span class="n">SCAN_PARAM_PRIM_PHYS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">temp8</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>Set scan filter to filter by PDU type.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Set PDU type filter -</span>
<span class="c1">// Only &#39;Connectable&#39; and &#39;Complete&#39; packets are desired.</span>
<span class="c1">// It doesn&#39;t matter if received packets are</span>
<span class="c1">// Scannable or Non-Scannable, Directed or Undirected,</span>
<span class="c1">// Scan_Rsp&#39;s or Advertisements, and whether they are Legacy or Extended.</span>
<span class="n">temp16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCAN_FLT_PDU_CONNECTABLE_ONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SCAN_FLT_PDU_COMPLETE_ONLY</span><span class="p">;</span><span class="w"></span>
<span class="n">GapScan_setParam</span><span class="p">(</span><span class="n">SCAN_PARAM_FLT_PDU_TYPE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">temp16</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic">
<li><p><strong>Start scanning</strong>. Remember to reset the number of scan results every time
you start scanning.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Scanning for DEFAULT_SCAN_DURATION x 10 ms.</span>
<span class="c1">// The stack does not need to record advertising reports</span>
<span class="c1">// since the application will filter them by Service UUID and save.</span>

<span class="c1">// Reset number of scan results to 0 before starting scan</span>
<span class="n">numScanRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="n">GapScan_enable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">DEFAULT_SCAN_DURATION</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The return status from the protocol stack call of <a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#ga60e22e486791087008affa3e9054c0a9">GapScan_enable()</a>
indicates only whether or not the attempt to perform device discovery was
successful. The actual device discovered is returned asynchronously as a
<code class="docutils literal notranslate"><span class="pre">SC_EVT_ADV_REPORT</span></code> forwarded through the GAP Scanner callbacks
registered by the application (here: <code class="docutils literal notranslate"><span class="pre">SimpleCentral_scanCb()</span></code>). This is
described below.</p>
</li>
<li><p>The GAP Scanner performs some processing on the GAP events it
receives from the protocol stack. The task also forwards some events
to the application. <a class="reference internal" href="#cd-gap-dev-disc"><span class="std std-numref">Figure 69.</span></a> shows this and how the
<code class="docutils literal notranslate"><span class="pre">SC_EVT_ADV_REPORT</span></code> is processed from the protocol stack to the
application.</p>
<div class="figure align-center" id="id51">
<span id="cd-gap-dev-disc"></span><p class="plantuml">
<img src="../_images/plantuml-4a19c3a519191296623db500b8289ef2bd4998e4.png" alt="&#64;startuml
participant Application
participant &quot;BLE Stack&quot;

group !scanning &amp;&amp; (central or observer)

  Application -&gt; &quot;BLE Stack&quot; : GapScan_enable()

  rnote over &quot;BLE Stack&quot;
   BLE stack attempts to
   start device discovery
  end note

  &quot;BLE Stack&quot; -&gt; Application : return(status)


group status==SUCCESS
rnote over &quot;Application&quot;
SC_EVT_SCAN_ENABLED
indicates scanning has started
end note
...
... BLE Stack does device discovery ...
...
&quot;BLE Stack&quot;-&gt;Application : SimpleCentral_scanCb()
Application-&gt;Application: SimpleCentral_enqueueMsg()
Application -&gt;Application: SimpleCentral_processAppMsg()

  rnote over &quot;Application&quot;
  SC_EVT_ADV_REPORT
  end note
  ...
  rnote over &quot;Application&quot;
  SC_EVT_SCAN_DISABLED
  indicates scanning has ended
  end note
end

end

&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 69. </span><span class="caption-text">Context Diagram of Application using GapScan_enable()</span><a class="headerlink" href="#id51" title="Permalink to this image">¶</a></p>
</div>
</li>
</ol>
<p>Note that during scanning, individual advertisements and scan responses are
returned as <code class="docutils literal notranslate"><span class="pre">SC_EVT_ADV_REPORT</span></code>.This is defined by the <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>. By
default, duplicate reports are filtered such that only one event is returned to
the application per peer device BDA. This can be configured via the
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacbadd2d4423a7a7b068b492929ae5eab00f">SCAN_PARAM_FLT_DUP</a> GAP Scanner parameter.
<code class="docutils literal notranslate"><span class="pre">SC_EVT_SCAN_ENABLED</span></code> indicates the start of scanning. After the scan
has completed, a summary of discovered reports will be returned to the
application with <code class="docutils literal notranslate"><span class="pre">SC_EVT_SCAN_DISABLED</span></code>. You can see the implementation
of this in <code class="docutils literal notranslate"><span class="pre">SimpleCentral_processAppMsg()</span></code>.</p>
<p>The maximum amount of scan responses that can be discovered during one scan can
be set with the <code class="docutils literal notranslate"><span class="pre">DEFAULT_MAX_SCAN_RES</span></code> parameter that is passed into the <code class="docutils literal notranslate"><span class="pre">maxNumReport</span></code>
parameter of <a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#ga60e22e486791087008affa3e9054c0a9">GapScan_enable()</a>.</p>
<p>In an environment saturated with advertisements and scan responses, this can have
a drastic impact on heap usage to the point of potentially breaking the stack.
Therefore, it is essential to profile your application for the worst-case
scenario where the maximum amount of scan responses are discovered during a scan.</p>
<p>You can change scanning parameters with <a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#gaea670f68167c414703dc53a687f451d5">GapScan_setParam()</a>. Note that some scanning parameters will not be updated before scanning has been disabled and re-enabled. This is true for the following parameters:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacba245de43430f04d12e982746439261854">SCAN_PARAM_FLT_PDU_TYPE</a> - Filter by PDU Type</p></li>
<li><p><a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacba48f59e808b2cec440ee2f364875ac13b">SCAN_PARAM_FLT_MIN_RSSI</a> - Filter by Minimum RSSI</p></li>
<li><p><a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacba69ff421a331c2057b6f21f568fef8189">SCAN_PARAM_FLT_DISC_MODE</a> - Filter by Discoverable Mode</p></li>
<li><p><a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacbad098168c818c96705f51862e6a361fda">SCAN_PARAM_RPT_FIELDS</a> - Advertising Report Fields</p></li>
</ul>
</div></blockquote>
<div class="section" id="advertising-report-recording">
<h3>Advertising Report Recording<a class="headerlink" href="#advertising-report-recording" title="Permalink to this headline">¶</a></h3>
<p>In addition to the advertising report, the advertising report recording feature can be used
to record only a certain part of the Advertising Report information without the data payload.
The application can specify which fields of the Advertising Report information by using
GapScan_setParam() with the parameter ID SCAN_PARAM_RPT_FIELDS and the associate bitmap.
This is useful in the use case where the application is not interested in the payload of
Advertising Reports thus doesn’t want to get GAP_EVT_ADV_REPORT event from GAP Scanner but
needs some specific information such as address type, address, RSSI, etc.. To prepare
recording, GAP Scanner allocates necessary amount of memory in GapScan_enable().
Then whenever GAP Scanner gets a new packet, it puts only the specified fields of the
information in the Advertising Report List in packed form. The list is kept in RAM even
after the scanning ends until the application calls GapScan_discardAdvReportList()
or a new scanning starts. While the list is available, the application can retrieve the
information by using GapScan_getAdvReport(). When the list gets full, GAP Scanner issues
SCAN_EVT_ADV_REPORT_FULL to the application to notify that no more Advertising Report
information will be recorded. How many Advertising Reports’ information have been recorded
can be found in the numReport field of the data buffer of type GapScan_Evt_End_t,
coming with GAP_EVT_SCAN_END event. Alternatively, if the application didn’t mask
GAP_EVT_SCAN_END and doesn’t get it, GapScan_getParam() with parameter
ID SCAN_PARAM_NUM_ADV_RPT can be used.</p>
</div>
<div class="section" id="obtain-advertising-channel-from-advertising-report">
<span id="gap-advertising-channel"></span><span id="gap-scanner-filtering"></span><h3>Obtain Advertising Channel from Advertising Report<a class="headerlink" href="#obtain-advertising-channel-from-advertising-report" title="Permalink to this headline">¶</a></h3>
<p>The application can extract the advertising channel from the advertising report with the following modifications:</p>
<ol class="arabic">
<li><p>Enable the advertising channel in the advertising report:</p>
<ul class="simple">
<li><p>With SysConfig: Enable the setting <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">Advertisement</span> <span class="pre">Channel</span> <span class="pre">Number</span></code> inside <code class="docutils literal notranslate"><span class="pre">Observer</span> <span class="pre">Configuration</span></code>, see <a class="reference internal" href="../sysconfig/ble5-sysconfig.html#fig-observer-configurations"><span class="std std-ref">Observer Configurations</span></a></p></li>
<li><p>Without SysConfig: Add <code class="docutils literal notranslate"><span class="pre">-DADV_RPT_INC_CHANNEL=1</span></code> in the file <code class="docutils literal notranslate"><span class="pre">ti_ble_app_config.opt</span></code></p></li>
</ul>
</li>
<li><p>Use the following example code in <code class="docutils literal notranslate"><span class="pre">SimpleCentral_processAppMsg()</span></code> to access the channel information</p>
<div class="literal-block-wrapper docutils container" id="id52">
<div class="code-block-caption"><span class="caption-number">Listing 89. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processAppMsg() :: SC_EVT_ADV_REPORT</strong> - Extract the advertising channel</span><a class="headerlink" href="#id52" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="k">case</span><span class="w"> </span><span class="nl">SC_EVT_ADV_REPORT</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">GapScan_Evt_AdvRpt_t</span><span class="o">*</span><span class="w"> </span><span class="n">pAdvRpt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GapScan_Evt_AdvRpt_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">);</span><span class="w"></span>
<span class="hll"><span class="w">     </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">advChannel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pAdvRpt</span><span class="o">-&gt;</span><span class="n">secPhy</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
</span>
<span class="w">     </span><span class="c1">//...</span>
</pre></div>
</div>
</div>
</li>
</ol>
</div>
<div class="section" id="filtering">
<h3>Filtering<a class="headerlink" href="#filtering" title="Permalink to this headline">¶</a></h3>
<p>The GAP Scanner module provides 5 different types of filter to reduce the amount of advertising
report notifications to the application and eventually save memory and power consumption.
The result of the filtering affects both advertising reports and advertising report recording.
The packets filtered out by the filter configurations are discarded and will
neither be reported nor recorded. The filters are set by using the API
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#gaea670f68167c414703dc53a687f451d5">GapScan_setParam()</a> with the following parameter IDs:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#cd-gap-filter-policy"><span class="std std-ref">Filter by LL Filter Policy</span></a>: <a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacbac0162455415801400539a4e2737179a4">SCAN_PARAM_FLT_POLICY</a></p></li>
<li><p><a class="reference internal" href="#cd-gap-filter-type"><span class="std std-ref">Filter by PDU Type</span></a>: <a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacba245de43430f04d12e982746439261854">SCAN_PARAM_FLT_PDU_TYPE</a></p></li>
<li><p><a class="reference internal" href="#cd-gap-filter-rssi"><span class="std std-ref">Filter by Minimum RSSI</span></a>: <a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacba48f59e808b2cec440ee2f364875ac13b">SCAN_PARAM_FLT_MIN_RSSI</a></p></li>
<li><p><a class="reference internal" href="#cd-gap-filter-discoverable"><span class="std std-ref">Filter by Discoverable Mode</span></a>: <a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacba69ff421a331c2057b6f21f568fef8189">SCAN_PARAM_FLT_DISC_MODE</a></p></li>
<li><p><a class="reference internal" href="#cd-gap-filter-duplicates"><span class="std std-ref">Filter by Duplicates</span></a>: <a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacbadd2d4423a7a7b068b492929ae5eab00f">SCAN_PARAM_FLT_DUP</a>.</p></li>
</ul>
<p>All parameter IDs are described in the following sections. The GAP Scanner
allows the application to apply any combination of the individual filters at the
same time to narrow the scope of packets to receive.</p>
<div class="section" id="filter-by-ll-filter-policy">
<span id="cd-gap-filter-policy"></span><h4>Filter by LL Filter Policy<a class="headerlink" href="#filter-by-ll-filter-policy" title="Permalink to this headline">¶</a></h4>
<p>This filter is a link layer-level filter. The associated parameter ID used in
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#gaea670f68167c414703dc53a687f451d5">GapScan_setParam()</a> is <a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacbac0162455415801400539a4e2737179a4">SCAN_PARAM_FLT_POLICY</a>. The parameter
accompanying <a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacbac0162455415801400539a4e2737179a4">SCAN_PARAM_FLT_POLICY</a> is passed to the link layer when
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#ga60e22e486791087008affa3e9054c0a9">GapScan_enable()</a> is called before actually enabling scanning. Since the filtering
is done by the link layer, the application only receives advertising report events
that have passed the filter. The parameter value can be one of the following:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 4%" />
<col style="width: 81%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SCAN_FLT_POLICY_ALL</p></td>
<td><p>0</p></td>
<td><p>Accept all Advs except directed Adv not addressed to this device.</p></td>
</tr>
<tr class="row-odd"><td><p>SCAN_FLT_POLICY_WL</p></td>
<td><p>1</p></td>
<td><p>Accept only Advs from devices where the advertiser’s address is in the FIlter Accept List.</p></td>
</tr>
<tr class="row-even"><td><p>SCAN_FLT_POLICY_ALL_RPA</p></td>
<td><p>2</p></td>
<td><p>Accept all Advs except directed Adv not addressed to this device and any packet addressed to this device or addressed to a private resolvable address.</p></td>
</tr>
<tr class="row-odd"><td><p>SCAN_FLT_POLICY_WL_RPA</p></td>
<td><p>3</p></td>
<td><p>Accept only Advs from devices where the advertiser’s address is in the FIlter Accept List and any packet addressed to this device or addressed to a private resolvable address.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="filter-by-pdu-type">
<span id="cd-gap-filter-type"></span><h4>Filter by PDU Type<a class="headerlink" href="#filter-by-pdu-type" title="Permalink to this headline">¶</a></h4>
<p>This filter is based on the <code class="docutils literal notranslate"><span class="pre">Event_Type</span></code> parameter coming with the LE Extended
Advertising Report Event. The associated parameter ID is
<code class="docutils literal notranslate"><span class="pre">SCAN_PARAM_FLT_PDY_TYPE</span></code>. The parameter value specifies packets
classified in six categories:</p>
<ul class="simple">
<li><p>Connectable/Non-Connectable</p></li>
<li><p>Scannable/Non-Scannable</p></li>
<li><p>Directed/Undirected</p></li>
<li><p>ScanRsp/Adv</p></li>
<li><p>Legacy/Extended</p></li>
<li><p>Complete/Incomplete.</p></li>
</ul>
<p>Every incoming packet has exactly one attribute in each category. For example,
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan___constants.html#gga8db7c404b7f17a487daa6b3e424dde42a77986b19a25ab8960be14e55b52566d7">SCAN_FLT_PDU_NONSCANNABLE_ONLY</a> and
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan___constants.html#gga8db7c404b7f17a487daa6b3e424dde42ade9872044802d53c1682f2493c39787b">SCAN_FLT_PDU_SCANNABLE_ONLY</a> cannot be chosen together since they
represent scannable and non-scannable packets. Only either one can be used. If
neither type is selected in a set, the filter will not care about that category.
For example, if neither <a class="reference external" href="../../doxygen/ble/html/group___gap_scan___constants.html#gga8db7c404b7f17a487daa6b3e424dde42a59e2d5dae597ac56e45bdae579b6f9df">SCAN_FLT_PDU_NONCONNECTABLE_ONLY</a> nor
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan___constants.html#gga8db7c404b7f17a487daa6b3e424dde42aab0d1bc385e9a815fc6c628700ed78d9">SCAN_FLT_PDU_CONNECTABLE_ONLY</a> is set in the parameter value, the GAP
Scanner will notify the application of both connectable packets and
non-connectable packets. It will also record both connectable packets and
non-connectable packets. The <code class="docutils literal notranslate"><span class="pre">SCAN_PARAM_FLT_PDY_TYPE</span></code> parameter value
can be any combination of the following individual values (except individual
values that are mutually exclusive):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 7%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SCAN_FLT_PDU_NONCONNECTABLE_ONLY</p></td>
<td><p>0x0001</p></td>
<td><p>Non-connectable packets only. Mutually exclusive with SCAN_FLT_PDU_CONNECTABLE_ONLY</p></td>
</tr>
<tr class="row-odd"><td><p>SCAN_FLT_PDU_CONNECTABLE_ONLY</p></td>
<td><p>0x0002</p></td>
<td><p>Connectable packets only. Mutually exclusive with SCAN_FLT_PDU_NONCONNECTABLE_ONLY</p></td>
</tr>
<tr class="row-even"><td><p>SCAN_FLT_PDU_NONSCANNABLE_ONLY</p></td>
<td><p>0x0004</p></td>
<td><p>Non-scannable packets only. Mutually exclusive with SCAN_FLT_PDU_SCANNABLE_ONLY</p></td>
</tr>
<tr class="row-odd"><td><p>SCAN_FLT_PDU_SCANNABLE_ONLY</p></td>
<td><p>0x0008</p></td>
<td><p>Scannable packets only. Mutually exclusive with SCAN_FLT_PDU_NONSCANNABLE_ONLY</p></td>
</tr>
<tr class="row-even"><td><p>SCAN_FLT_PDU_UNDIRECTED_ONLY</p></td>
<td><p>0x0010</p></td>
<td><p>Undirected packets only. Mutually exclusive with SCAN_FLT_PDU_DIRECTIED_ONLY</p></td>
</tr>
<tr class="row-odd"><td><p>SCAN_FLT_PDU_DIRECTED_ONLY</p></td>
<td><p>0x0020</p></td>
<td><p>Directed packets only. Mutually exclusive with SCAN_FLT_PDU_UNDIRECTED_ONLY</p></td>
</tr>
<tr class="row-even"><td><p>SCAN_FLT_PDU_ADV_ONLY</p></td>
<td><p>0x0040</p></td>
<td><p>Advertisement packets only. Mutually exclusive with SCAN_FLT_PDU_SCANRSP_ONLY</p></td>
</tr>
<tr class="row-odd"><td><p>SCAN_FLT_PDU_SCANRSP_ONLY</p></td>
<td><p>0x0080</p></td>
<td><p>Scan Response packets only. Mutually exclusive with SCAN_FLT_PDU_ADV_ONLY</p></td>
</tr>
<tr class="row-even"><td><p>SCAN_FLT_PDU_EXTENDED_ONLY</p></td>
<td><p>0x0100</p></td>
<td><p>Extended packets only. Mutually exclusive with SCAN_FLT_PDU_LEGACY_ONLY</p></td>
</tr>
<tr class="row-odd"><td><p>SCAN_FLT_PDU_LEGACY_ONLY</p></td>
<td><p>0x0200</p></td>
<td><p>Legacy packets only. Mutually exclusive with SCAN_FLT_PDU_EXTENDED_ONLY</p></td>
</tr>
<tr class="row-even"><td><p>SCAN_FLT_PDU_TRUNCATED_ONLY</p></td>
<td><p>0x0400</p></td>
<td><p>Truncated packets only. Mutually exclusive with SCAN_FLT_PDU_COMPLETE_ONLY</p></td>
</tr>
<tr class="row-odd"><td><p>SCAN_FLT_PDU_COMPLETE_ONLY</p></td>
<td><p>0x0800</p></td>
<td><p>Complete packets only. Mutually exclusive with SCAN_FLT_PDU_TRUNCATED_ONLY</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="filter-by-minimum-rssi">
<span id="cd-gap-filter-rssi"></span><h4>Filter by Minimum RSSI<a class="headerlink" href="#filter-by-minimum-rssi" title="Permalink to this headline">¶</a></h4>
<p>This filter is based on the RSSI parameter coming with the LE Extended
Advertising Report Event. The associated parameter ID used in
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#gaea670f68167c414703dc53a687f451d5">GapScan_setParam()</a> is <a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacba48f59e808b2cec440ee2f364875ac13b">SCAN_PARAM_FLT_MIN_RSSI</a>. The GAP
Scanner will discard LE Extended Advertising Report Event whose RSSI parameter
value is smaller than the minimum RSSI value given by the application. The
available range is -128 dBm to 127 dBm.</p>
</div>
<div class="section" id="filter-by-discoverable-mode">
<span id="cd-gap-filter-discoverable"></span><h4>Filter by Discoverable Mode<a class="headerlink" href="#filter-by-discoverable-mode" title="Permalink to this headline">¶</a></h4>
<p>This filter is based on the <code class="docutils literal notranslate"><span class="pre">Flags</span> <span class="pre">AD</span></code> type value in the payload (in
the <code class="docutils literal notranslate"><span class="pre">Data</span></code> parameter) of the LE Extended Advertising Report Event. The
associated parameter ID used in <a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#gaea670f68167c414703dc53a687f451d5">GapScan_setParam()</a> is
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacba69ff421a331c2057b6f21f568fef8189">SCAN_PARAM_FLT_DISC_MODE</a>. This filter is applied after the GAP
Scanner reassembles all the fragmented payloads delivered by multiple LE
Extended Advertising Report Events. The GAP Scanner will discard the
defragmented packet if the found Flags AD type value doesn’t match the parameter
value given by the application. The parameter value can be one of the following:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 8%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SCAN_FLT_DISC_NONE</p></td>
<td><p>0</p></td>
<td><p>Accept only Non-Discoverable mode</p></td>
</tr>
<tr class="row-odd"><td><p>SCAN_FLT_DISC_GENERAL</p></td>
<td><p>1</p></td>
<td><p>Accept only General Discoverable mode</p></td>
</tr>
<tr class="row-even"><td><p>SCAN_FLT_DISC_LIMITED</p></td>
<td><p>2</p></td>
<td><p>Accept only Limited Discoverable mode</p></td>
</tr>
<tr class="row-odd"><td><p>SCAN_FLT_DISC_ALL</p></td>
<td><p>3</p></td>
<td><p>Accept both General and Limited Discoverable mode</p></td>
</tr>
<tr class="row-even"><td><p>SCAN_FLT_DISC_DISABLE</p></td>
<td><p>4</p></td>
<td><p>Discoverable Mode Filter Off (Don’t care about the Flags AD type value)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="filter-by-duplicates">
<span id="cd-gap-filter-duplicates"></span><h4>Filter by Duplicates<a class="headerlink" href="#filter-by-duplicates" title="Permalink to this headline">¶</a></h4>
<p>Like the Link Layer Scanner Filter Policy, this filter is a link layer-level filter.
The associated parameter ID used in <a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#gaea670f68167c414703dc53a687f451d5">GapScan_setParam()</a> is
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacbadd2d4423a7a7b068b492929ae5eab00f">SCAN_PARAM_FLT_DUP</a>. The parameter accompanying the
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan___params.html#gga0ddb2a0f5c2ed1663478732f4836dacbadd2d4423a7a7b068b492929ae5eab00f">SCAN_PARAM_FLT_DUP</a> parameter ID is passed to the link layer when
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#ga60e22e486791087008affa3e9054c0a9">GapScan_enable()</a> internally calls <code class="docutils literal notranslate"><span class="pre">LE_SetExtScanEnable</span></code> to
enable scanning. Since the filtering is done by the link layer, GAP Scanner
receives only the LE Extended Advertising Report Events that have passed the
filter. The parameter value can be one of the following:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 9%" />
<col style="width: 62%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SCAN_FLT_DUP_DISABLE</p></td>
<td><p>0</p></td>
<td><p>Disable duplicate filtering.</p></td>
</tr>
<tr class="row-odd"><td><p>SCAN_FLT_DUP_ENABLE</p></td>
<td><p>1</p></td>
<td><p>Enable duplicate filtering.</p></td>
</tr>
<tr class="row-even"><td><p>SCAN_FLT_DUP_RESET</p></td>
<td><p>2</p></td>
<td><p>Enable duplicate filtering. Reset for each scan period.</p></td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When the duplicate filtering is enabled, the maximum amount of devices that can
be found is 16. If more than 16 devices need to be discovered, the duplicate filtering needs to
be disabled.</p>
</div>
</div>
</div>
<div class="section" id="synchronize-with-a-periodic-advertising-train">
<h3>Synchronize with a Periodic Advertising Train<a class="headerlink" href="#synchronize-with-a-periodic-advertising-train" title="Permalink to this headline">¶</a></h3>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The symbol <code class="docutils literal notranslate"><span class="pre">USE_PERIODIC_SCAN</span></code> must be pre-defined if you
wish to use the functions related to scanning and synchronization with
periodic advertising (for more details, please see
<a class="reference internal" href="stack-configuration-cc13xx_cc26xx.html#stackconfigurablefeatures"><span class="std std-ref">Bluetooth Low Energy Stack Configuration Parameters</span></a>).</p>
</div>
<p>Additional information about periodic advertisements is provided within the section
<a class="reference internal" href="#gap-periodic-advertising"><span class="std std-ref">Periodic Advertising</span></a>.</p>
<p>From a high level point of view, in order to synchronize with a periodic advertiser,
the scanner has to:</p>
<ol class="arabic simple">
<li><p>Start a Central or Observer GAP role</p></li>
<li><p>Set up a callback function for scanner events and register to</p></li>
<li><p>Set which events to pass to application.</p></li>
<li><p>Set scan parameters</p></li>
<li><p>Start scanning</p></li>
<li><p>Identify periodic advertisers</p></li>
<li><p>Synchronize with a periodic advertising train</p></li>
<li><p>Enable the reception of the periodic advertisements</p></li>
<li><p>Handle the periodic advertisements reports</p></li>
<li><p>Disable the reception of the periodic advertisements and terminate the synchronization</p></li>
</ol>
<p>The first steps are detailed at the beginning of the <a class="reference internal" href="#gapscanner"><span class="std std-ref">GAP Scanner</span></a> section.</p>
<div class="section" id="identify-periodic-advertisers">
<h4>Identify periodic advertisers<a class="headerlink" href="#identify-periodic-advertisers" title="Permalink to this headline">¶</a></h4>
<p>The advertising reports for
periodic advertisements have the exact same structure and the exact same way
of reception like other advertisement types.
The actual device discovered is returned asynchronously as a
<code class="docutils literal notranslate"><span class="pre">SC_EVT_ADV_REPORT</span></code> forwarded through the GAP Scanner callbacks
registered by the application (here: <code class="docutils literal notranslate"><span class="pre">SimpleCentral_scanCb()</span></code>).</p>
<p>Periodic advertisements are non-connectable, non-scannable. By default, the
<code class="docutils literal notranslate"><span class="pre">simple_central</span></code> project example filters out non-connectable
advertisements. Make sure to change this PDU filtering policy.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id53">
<div class="code-block-caption"><span class="caption-number">Listing 90. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processGapMsg() :: GAP_DEVICE_INIT_DONE_EVENT</strong> - Disable filtering out of non-connectable advertisements / keep only non-connectable advertisements</span><a class="headerlink" href="#id53" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">temp16</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="c1">// ...</span>

<span class="w">   </span><span class="c1">//temp16 = SCAN_FLT_PDU_CONNECTABLE_ONLY | SCAN_FLT_PDU_COMPLETE_ONLY;</span>
<span class="w">   </span><span class="n">temp16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCAN_FLT_PDU_NONCONNECTABLE_ONLY</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="n">GapScan_setParam</span><span class="p">(</span><span class="n">SCAN_PARAM_FLT_PDU_TYPE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">temp16</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
<p>The parameter <code class="docutils literal notranslate"><span class="pre">periodicAdvInt</span></code> from the structure <a class="reference external" href="../../doxygen/ble/html/struct_gap_scan___evt___adv_rpt__t.html">GapScan_Evt_AdvRpt_t</a>
will help to assess it is possible to synchronize with the advertiser.
It means this field of the advertise report has to be activated.
The same apply to the field <code class="docutils literal notranslate"><span class="pre">advSid</span></code> (Advertise Set Id).</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id54">
<div class="code-block-caption"><span class="caption-number">Listing 91. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processAppMsg() :: SC_EVT_ADV_REPORT</strong> - Assess if the advertisement is a periodic advertisement</span><a class="headerlink" href="#id54" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="n">GapScan_Evt_AdvRpt_t</span><span class="o">*</span><span class="w"> </span><span class="n">pAdvRpt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GapScan_Evt_AdvRpt_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">);</span><span class="w"></span>

<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pAdvRpt</span><span class="o">-&gt;</span><span class="n">periodicAdvInt</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="c1">// this is a periodic advertisement</span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="k">else</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="c1">// this is NOT a periodic advertisement</span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
</div>
<div class="section" id="id5">
<h4>Synchronize with a periodic advertising train<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>When a periodic advertisement is identified, the synchronization can be started.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a> (Vol 6, Part B, §4.3.5) define two ways for the scanner’s Link
Layer to process advertising PDUs when attempting to synchronize to a
periodic advertising train.
The first policy which requires specifying the device to synchronize with.
The second policy allows to synchronize with all the devices in the
Periodic Advertiser List with only one scan. This is then a way to save
time and energy.</p>
</div>
<ul class="simple">
<li><p><strong>Policy 1: Ignore the Periodic Advertiser List and process advertising PDUs from a specific single device</strong></p></li>
</ul>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id55">
<div class="code-block-caption"><span class="caption-number">Listing 92. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processAppMsg() :: SC_EVT_ADV_REPORT</strong> - Create synchronization with a periodic advertsiement train</span><a class="headerlink" href="#id55" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="n">GapScan_Evt_AdvRpt_t</span><span class="o">*</span><span class="w"> </span><span class="n">pAdvRpt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GapScan_Evt_AdvRpt_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">);</span><span class="w"></span>

<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pAdvRpt</span><span class="o">-&gt;</span><span class="n">periodicAdvInt</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="c1">// this is a periodic advertisement</span>
<span class="w">       </span><span class="n">GapScan_PeriodicAdvCreateSyncParams_t</span><span class="w"> </span><span class="n">pSyncParams</span><span class="p">;</span><span class="w"></span>

<span class="w">       </span><span class="n">pSyncParams</span><span class="p">.</span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCAN_PERIODIC_DO_NOT_USE_PERIODIC_ADV_LIST</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">                             </span><span class="n">SCAN_PERIODIC_REPORTING_INITIALLY_DISABLED</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="n">pSyncParams</span><span class="p">.</span><span class="n">advAddrType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint8</span><span class="p">)</span><span class="n">pAdvRpt</span><span class="o">-&gt;</span><span class="n">addrType</span><span class="p">;</span><span class="w"> </span><span class="c1">// only ADDRTYPE_PUBLIC and ADDRTYPE_RANDOM are allowed</span>
<span class="w">       </span><span class="n">osal_memcpy</span><span class="p">(</span><span class="n">pSyncParams</span><span class="p">.</span><span class="n">advAddress</span><span class="p">,</span><span class="w"> </span><span class="n">pAdvRpt</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">B_ADDR_LEN</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="n">pSyncParams</span><span class="p">.</span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// should be between 0 and SCAN_PERIODIC_SKIP_MAX</span>
<span class="w">       </span><span class="n">pSyncParams</span><span class="p">.</span><span class="n">syncTimeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// synchronization timeout for the periodic advertising train is 1000*10ms = 10s</span>
<span class="w">                                       </span><span class="c1">// should be between SCAN_PERIODIC_TIMEOUT_MIN and SCAN_PERIODIC_TIMEOUT_MAX</span>
<span class="w">       </span><span class="n">pSyncParams</span><span class="p">.</span><span class="n">syncCteType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCAN_PERIODIC_CTE_TYPE_ALL</span><span class="p">;</span><span class="w"></span>

<span class="w">       </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapScan_PeriodicAdvCreateSync</span><span class="p">(</span><span class="n">pAdvRpt</span><span class="o">-&gt;</span><span class="n">advSid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pSyncParams</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="k">if</span><span class="p">(</span><span class="n">SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">){</span><span class="w"></span>
<span class="w">         </span><span class="c1">// handle error</span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>

<span class="w">       </span><span class="n">GapScan_disable</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">       </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="k">else</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="c1">// this is NOT a periodic advertisement</span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
<ul>
<li><p><strong>Policy 2: process advertising PDUs from all devices in the Periodic Advertiser List.</strong></p>
<p>This policy first requires to add one or several device(s) to the
Periodic Advertiser List. This can be done using the function
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#ga7ad978fccc3a58d614ab6e411da0f10a">GapScan_AddDeviceToPeriodicAdvList()</a></p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id56">
<div class="code-block-caption"><span class="caption-number">Listing 93. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processAppMsg() :: SC_EVT_ADV_REPORT</strong> - Create synchronization with a periodic advertsiement train using the Periodic Advertiser List</span><a class="headerlink" href="#id56" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">GapScan_Evt_AdvRpt_t</span><span class="o">*</span><span class="w"> </span><span class="n">pAdvRpt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GapScan_Evt_AdvRpt_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">);</span><span class="w"></span>

<span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pAdvRpt</span><span class="o">-&gt;</span><span class="n">periodicAdvInt</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="c1">// this is a periodic advertisement</span>

<span class="w">     </span><span class="c1">// add the device to the Periodic Advertiser List</span>
<span class="w">     </span><span class="n">GapScan_AddDeviceToPeriodicAdvList</span><span class="p">((</span><span class="n">uint8</span><span class="p">)</span><span class="n">pAdvRpt</span><span class="o">-&gt;</span><span class="n">addrType</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">pAdvRpt</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">pAdvRpt</span><span class="o">-&gt;</span><span class="n">advSid</span><span class="p">);</span><span class="w"></span>

<span class="w">     </span><span class="c1">// connect the devices on the Periodic Advertiser List.</span>
<span class="w">     </span><span class="n">GapScan_PeriodicAdvCreateSyncParams_t</span><span class="w"> </span><span class="n">pSyncParams</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="n">pSyncParams</span><span class="p">.</span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCAN_PERIODIC_USE_PERIODIC_ADV_LIST</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">                           </span><span class="n">SCAN_PERIODIC_REPORTING_INITIALLY_DISABLED</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">pSyncParams</span><span class="p">.</span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// should be between 0 and SCAN_PERIODIC_SKIP_MAX</span>
<span class="w">     </span><span class="n">pSyncParams</span><span class="p">.</span><span class="n">syncTimeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// synchronization timeout for the periodic advertising train is 1000*10ms = 10s</span>
<span class="w">                                     </span><span class="c1">// should be between SCAN_PERIODIC_TIMEOUT_MIN and SCAN_PERIODIC_TIMEOUT_MAX</span>
<span class="w">     </span><span class="n">pSyncParams</span><span class="p">.</span><span class="n">syncCteType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCAN_PERIODIC_CTE_TYPE_ALL</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapScan_PeriodicAdvCreateSync</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pSyncParams</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="n">SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">){</span><span class="w"></span>
<span class="w">       </span><span class="c1">// handle error</span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="n">GapScan_disable</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">     </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
<p>The functions <a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#gaad981f06df02fbe6d2378c8aaa484ba7">GapScan_RemoveDeviceFromPeriodicAdvList()</a>
and <a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#gae9144b203b660c9c5c6f30fd8b9f1a28">GapScan_ClearPeriodicAdvList()</a> can be used to remove
device(s) from the Periodic Advertiser List.</p>
</li>
</ul>
<p>Once the synchronization is created, a <a class="reference external" href="../../doxygen/ble/html/group___g_a_p___event___i_ds.html#gaef0e6ebc8ba2af46474499a9aea669cd">GAP_SCAN_CREATE_SYNC_EVENT</a>
event with status <code class="docutils literal notranslate"><span class="pre">SUCCESS</span></code> is issued. After this, scanning has to be
enabled in order to let the device find the periodic advertisement train
that has been specified before.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id57">
<div class="code-block-caption"><span class="caption-number">Listing 94. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processGapMsg() :: GAP_SCAN_CREATE_SYNC_EVENT</strong> - Re-enable scanning after receiving GAP_SCAN_CREATE_SYNC_EVENT event to establish the synchronization</span><a class="headerlink" href="#id57" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">GapScan_PeriodicAdvEvt_t</span><span class="w"> </span><span class="o">*</span><span class="n">pPkt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GapScan_PeriodicAdvEvt_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="n">pPkt</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapScan_enable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">DEFAULT_SCAN_DURATION</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="k">if</span><span class="p">(</span><span class="n">SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">){</span><span class="w"></span>
<span class="w">         </span><span class="c1">// handle error</span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
</div>
<div class="section" id="enable-the-reception-of-the-periodic-advertisements">
<h4>Enable the reception of the periodic advertisements<a class="headerlink" href="#enable-the-reception-of-the-periodic-advertisements" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>After the synchronization is established, the event <code class="docutils literal notranslate"><span class="pre">GAP_SCAN_PERIODIC_ADV_SYNC_EST_EVENT</span></code>
is issued. If not already done, the reception of the periodic advertisements reports
has to be turned on.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id58">
<div class="code-block-caption"><span class="caption-number">Listing 95. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processGapMsg() :: GAP_SCAN_CREATE_SYNC_EVENT</strong> - Re-enable scanning after receiving GAP_SCAN_CREATE_SYNC_EVENT event to establish the synchronization</span><a class="headerlink" href="#id58" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">GapScan_Evt_PeriodicAdvSyncEst_t</span><span class="w"> </span><span class="o">*</span><span class="n">pPkt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GapScan_Evt_PeriodicAdvSyncEst_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="n">pPkt</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapScan_SetPeriodicAdvReceiveEnable</span><span class="p">(</span><span class="n">pPkt</span><span class="o">-&gt;</span><span class="n">syncHandle</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="k">if</span><span class="p">(</span><span class="n">SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">){</span><span class="w"></span>
<span class="w">         </span><span class="c1">// handle error</span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="handle-the-periodic-advertisements-reports">
<h4>Handle the periodic advertisements reports<a class="headerlink" href="#handle-the-periodic-advertisements-reports" title="Permalink to this headline">¶</a></h4>
<p>After enabling the reception of the periodic advertisements,
the reception of a periodic advertisement leads to the generation of a
<code class="docutils literal notranslate"><span class="pre">GAP_SCAN_PERIODIC_ADV_REPORT_EVENT</span></code> event.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id59">
<div class="code-block-caption"><span class="caption-number">Listing 96. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processGapMsg() :: GAP_SCAN_PERIODIC_ADV_REPORT_EVENT</strong> - Reception of the periodic advertisement reports</span><a class="headerlink" href="#id59" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">GapScan_Evt_PeriodicAdvRpt_t</span><span class="w"> </span><span class="o">*</span><span class="n">pPkt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GapScan_Evt_PeriodicAdvRpt_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="c1">// Handle periodic advertisement report</span>
<span class="w">     </span><span class="c1">// ...</span>

<span class="w">     </span><span class="c1">// Free report payload data</span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pPkt</span><span class="o">-&gt;</span><span class="n">pData</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">ICall_free</span><span class="p">(</span><span class="n">pPkt</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
</div>
<div class="section" id="disable-the-reception-of-the-periodic-advertisements-and-terminate-the-synchronization">
<h4>Disable the reception of the periodic advertisements and terminate the synchronization<a class="headerlink" href="#disable-the-reception-of-the-periodic-advertisements-and-terminate-the-synchronization" title="Permalink to this headline">¶</a></h4>
<p>The periodic advertisement reports can be disabled using the function
<a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#ga3003c97cd3dbb307d95e25cc4d238c9c">GapScan_SetPeriodicAdvReceiveEnable()</a>.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id60">
<div class="code-block-caption"><span class="caption-number">Listing 97. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processGapMsg() :: GAP_SCAN_PERIODIC_ADV_REPORT_EVENT</strong> - Disable the reception of periodic advertisement reports</span><a class="headerlink" href="#id60" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">GapScan_Evt_PeriodicAdvRpt_t</span><span class="w"> </span><span class="o">*</span><span class="n">pPkt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GapScan_Evt_PeriodicAdvRpt_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapScan_SetPeriodicAdvReceiveEnable</span><span class="p">(</span><span class="n">pPkt</span><span class="o">-&gt;</span><span class="n">syncHandle</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="n">SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">){</span><span class="w"></span>
<span class="w">         </span><span class="c1">// handle error</span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
<p>Disabling the periodic advertisement reports does NOT interrupt the synchronization.
In other words, the device will still wake-up and scan at each periodic advertisement.
The function <a class="reference external" href="../../doxygen/ble/html/group___gap_scan.html#ga0a8b58a85ca1c5cf46adeac5e7cf0805">GapScan_PeriodicAdvTerminateSync()</a> is used to terminate
the synchronization.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id61">
<div class="code-block-caption"><span class="caption-number">Listing 98. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_processGapMsg() :: GAP_SCAN_PERIODIC_ADV_REPORT_EVENT</strong> - Disable the reception of periodic advertisement reports</span><a class="headerlink" href="#id61" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">GapScan_Evt_PeriodicAdvRpt_t</span><span class="w"> </span><span class="o">*</span><span class="n">pPkt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GapScan_Evt_PeriodicAdvRpt_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pMsg</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GapScan_PeriodicAdvTerminateSync</span><span class="p">(</span><span class="n">pPkt</span><span class="o">-&gt;</span><span class="n">syncHandle</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="n">SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">){</span><span class="w"></span>
<span class="w">       </span><span class="c1">// handle error</span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div></blockquote>
<p>The event <a class="reference external" href="../../doxygen/ble/html/group___g_a_p___event___i_ds.html#ga03a86106c674e897f56703caddefdd03">GAP_SCAN_TERMINATE_SYNC_EVENT</a> will be received once the
synchronization is terminated.</p>
</div>
</div>
</div>
<div class="section" id="gap-initiator">
<span id="gapinitiator"></span><h2>GAP Initiator<a class="headerlink" href="#gap-initiator" title="Permalink to this headline">¶</a></h2>
<p>The initiator module is used to initiate the connection to a peripheral device.
An initiator generally scans for advertisements then connects to a specific
device. The initiator is a short lived state that transitions to the Central
Role after a connection is established.
Unlike the GAP Advertiser and GAP Scanner modules, GAP Initiator doesn’t have
any callback function to call or to be called.</p>
<p>Only a device initiated with the GAP Central Role can become an initiator.</p>
<div class="literal-block-wrapper docutils container" id="id62">
<div class="code-block-caption"><span class="caption-number">Listing 99. </span><span class="caption-text"><strong>simple_central.c :: SimpleCentral_init()</strong> Setup of Central Role</span><a class="headerlink" href="#id62" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kt">void</span><span class="w"> </span><span class="nf">SimpleCentral_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2</span><span class="p">{</span><span class="w"></span>
<span class="linenos">3</span><span class="w">    </span><span class="c1">// Register with GAP for HCI/Host messages (for RSSI)</span>
<span class="linenos">4</span><span class="w">    </span><span class="n">GAP_RegisterForMsgs</span><span class="p">(</span><span class="n">selfEntity</span><span class="p">);</span><span class="w"></span>
<span class="linenos">5</span>
<span class="linenos">6</span><span class="w">    </span><span class="c1">// Initialize GAP layer for Central role and register to receive GAP events</span>
<span class="linenos">7</span><span class="w">    </span><span class="n">GAP_DeviceInit</span><span class="p">(</span><span class="n">GAP_PROFILE_CENTRAL</span><span class="p">,</span><span class="w"> </span><span class="n">selfEntity</span><span class="p">,</span><span class="w"> </span><span class="n">addrMode</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="linenos">8</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>The following API is used to initiate connection to a peer device, see
<a class="reference external" href="../../doxygen/ble/html/group___gap_init.html#gac48c7e153d960604f9da90aca3f75d08">GapInit_connect()</a></p>
<div class="literal-block-wrapper docutils container" id="id63">
<div class="code-block-caption"><span class="caption-number">Listing 100. </span><span class="caption-text">Initiating connection in Central Role</span><a class="headerlink" href="#id63" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">GapScan_Evt_AdvRpt_t</span><span class="w"> </span><span class="n">advRpt</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="n">GapScan_getAdvReport</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">advRpt</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="cm">/*</span>
<span class="linenos"> 6</span><span class="cm"> * The initiating timeout is in milliseconds and will automatically cancel</span>
<span class="linenos"> 7</span><span class="cm"> * connection initiation if the peer is not connected. This can be set to</span>
<span class="linenos"> 8</span><span class="cm"> * 0 to wait indefinitely.</span>
<span class="linenos"> 9</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">10</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">initTimeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="n">GapInit_connect</span><span class="p">(</span><span class="n">advRpt</span><span class="p">.</span><span class="n">addrType</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MASK_ADDRTYPE_ID</span><span class="p">,</span><span class="w"></span>
<span class="linenos">13</span><span class="w">              </span><span class="n">advRpt</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">DEFAULT_INIT_PHY</span><span class="p">,</span><span class="w"> </span><span class="n">initTimeout</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>If the on-going connection attempt is intended to be canceled by either timeout
or a user request (the application calling <a class="reference external" href="../../doxygen/ble/html/group___gap_init.html#gab6106f8ac76d6991ad0fbf53b883e278">GapInit_cancelConnect()</a>),
the stack notifies the application of the cancellation completion with a
<a class="reference external" href="../../doxygen/ble/html/group___g_a_p___event___i_ds.html#ga273acd93b0bcd10dc317a7bd9691dd77">GAP_CONNECTING_CANCELLED_EVENT</a>.</p>
<p>The initiator task will use the parameters saved for the PHY specified in the
call to <a class="reference external" href="../../doxygen/ble/html/group___gap_init.html#gac48c7e153d960604f9da90aca3f75d08">GapInit_connect()</a>. These may be set with
<a class="reference external" href="../../doxygen/ble/html/group___gap_init.html#ga0f177b422346f91e33327b795324d611">GapInit_setPhyParam()</a>. Defaults are shown in <code class="docutils literal notranslate"><span class="pre">gap_initiator.h</span></code></p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>When initiating timeout is set to 0 (wait indefinitely), the CC13xx or CC26xx will
stay in initiator role until a connection is successfully established.
If the peripheral device disappeared from the network before the connection
is established, the only method for initiator to exit this state is
to call <a class="reference external" href="../../doxygen/ble/html/group___gap_init.html#gab6106f8ac76d6991ad0fbf53b883e278">GapInit_cancelConnect()</a>.</p>
</div>
</div>
<div class="section" id="gap-central">
<h2>GAP Central<a class="headerlink" href="#gap-central" title="Permalink to this headline">¶</a></h2>
<p>The GAP Central role is demonstrated in simple_central.c and simple_central.h. The Central
role demonstrates the use of the scanning and initiating states and supports connections
to peripheral devices. See the simple_central example project for an example of
implementing the Central role. The steps to use this module are as follows.</p>
<ol class="arabic">
<li><p>Initialize the GAP and GATT parameters.
This initialization should occur in the application
initialization function (for example in <code class="docutils literal notranslate"><span class="pre">SimpleCentral_init</span></code>).
GAP parameters can also be set in this initialization function.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SimpleCentral_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Initialize GATT Client</span>
<span class="w">  </span><span class="n">VOID</span><span class="w"> </span><span class="n">GATT_InitClient</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Accept all parameter update requests</span>
<span class="w">  </span><span class="n">GAP_SetParamValue</span><span class="p">(</span><span class="n">GAP_PARAM_LINK_UPDATE_DECISION</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_UPDATE_REQ_ACCEPT_ALL</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>Start the GAP Central role and register to receive events in the application task.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Initialize GAP layer for Central role and register to receive GAP events</span>
<span class="n">GAP_DeviceInit</span><span class="p">(</span><span class="n">GAP_PROFILE_CENTRAL</span><span class="p">,</span><span class="w"> </span><span class="n">selfEntity</span><span class="p">,</span><span class="w"> </span><span class="n">addrMode</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="gap-connection-state">
<span id="connection-parameters"></span><h2>GAP Connection State<a class="headerlink" href="#gap-connection-state" title="Permalink to this headline">¶</a></h2>
<p>A BLE device can be either in the Central or Peripheral role in
the Connection State. After devices enter connection state,
the devices exchange data under specific time within a specific time slot.
This slot where the data is exchanged is called a <strong>Connection Event</strong>.</p>
<p>The beginning of the Connection Event is called an <strong>Anchor Point</strong>.
During the connection event, the central and peripheral device will meet at
the anchor point and the central will transmit the first packet, while the
peripheral will have woken up to listen for the central devices transmitted packet.</p>
<img alt="../_images/ditaa-f65e20228cc9595f3a457201a18c7bff3c1200ce.png" src="../_images/ditaa-f65e20228cc9595f3a457201a18c7bff3c1200ce.png" />
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is no limitation on the number of packet transactions per connection
event other than MAX_NUM_PDU define in TI’s BLE5-Stack. It can either be one packet
per direction or multiple packets per direction.</p>
</div>
<div class="section" id="connection-event-callback">
<span id="id6"></span><h3>Connection Event Callback<a class="headerlink" href="#connection-event-callback" title="Permalink to this headline">¶</a></h3>
<p>Knowing what happened during the connection event can be beneficial for
the system design. For example, by knowing which channels has higher CRC error,
the application layer can decide to do a channelmap update to avoid those channels
to ensure better communication. In addition to CRC error, the connection report
also contains RSSI value per channel, which can be useful for Real Time Localization System
(<a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html#term-RTLS"><span class="xref std std-term">RTLS</span></a>) to distinguish which channel has higher interference. For more information on
RSSI based RTLS, please refer to <a class="reference internal" href="../ble-stack-5.x-guide/localization-index-cc13xx_cc26xx.html#sec-rssi-localization"><span class="std std-ref">RSSI Based Localization</span></a></p>
<p>TI’s BLE5-Stack provides the ability for application to obtain a detailed report of thes
connection event. The report will be sent at the end of the connection event and
it contains status and statistics of the most recent connection event.</p>
<p>The report contains the following parameters:</p>
<ul>
<li><p><strong>status</strong> - Status of the last connection event.</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 70%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>status</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>GAP_CONN_EVT_STAT_SUCCESS</p></td>
<td><p>Both central and peripheral show up for the conenction event and
exchange packets.</p></td>
</tr>
<tr class="row-odd"><td><p>GAP_CONN_EVT_STAT_CRC_ERROR</p></td>
<td><p>Packets were exchanged but the failed at the CRC checkout.</p></td>
</tr>
<tr class="row-even"><td><p>GAP_CONN_EVT_STAT_MISSED</p></td>
<td><p>The peer device did not show up for the connection event.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p><strong>handle</strong> - Connection event handle which is used to identify the most recent connection
event when there are multilple connections per device.</p></li>
<li><p><strong>channel</strong> - The RF channel which the most recent connection event used.</p></li>
<li><p><strong>phy</strong> - The PHY which the most recent connection event used.</p></li>
<li><p><strong>lastRssi</strong> - The RSSI value measured on the last packet of the most recent connection event.</p></li>
<li><p><strong>packets</strong> - Number of packets received during the most recent connection event.</p></li>
<li><p><strong>errors</strong> - Accumulated number of packets with CRC error for this connection handle.</p></li>
<li><p><strong>nextTaskType</strong> - The next task the link layer is going to run.</p></li>
<li><p><strong>nextTaskTime</strong> - The time to next task.</p></li>
<li><p><strong>eventCounter</strong> - The event counter of the most recent connection event.</p></li>
<li><p><strong>timeStamp</strong> - The anchor point of the most recent connection event.</p></li>
<li><p><strong>eventType</strong> - There are 3 types of events returning from BLE5-Stack.</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 27%" />
<col style="width: 73%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>eventType</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>GAP_CB_CONN_ESTABLISHED</p></td>
<td><p>This event is returned when connection is established. When this
returns, the eventCount will be 0.</p></td>
</tr>
<tr class="row-odd"><td><p>GAP_CB_PHY_UPDATE</p></td>
<td><p>This event is returned when last connection event received
LL_PHY_UPDATE_IND packet.</p></td>
</tr>
<tr class="row-even"><td><p>GAP_CB_CONN_EVENT_ALL</p></td>
<td><p>This event covers the above and rest of the scenarios.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
<p>To enable the application layer to receive connection report, you can use
<a class="reference external" href="../../doxygen/ble/html/group___g_a_p.html#ga906f77b10b92d57dcc2303d2ac2ed113">Gap_RegisterConnEventCb()</a>.</p>
<p>The following code is an example of how to register connection event report
for all types of event within certain connection.</p>
<div class="literal-block-wrapper docutils container" id="id64">
<div class="code-block-caption"><span class="caption-number">Listing 101. </span><span class="caption-text">Register for connection event report</span><a class="headerlink" href="#id64" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="c1">// Assuming connHandle was assigned when the connection established.</span>
<span class="linenos">2</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">connHandle</span><span class="p">;</span><span class="w"></span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="n">Gap_RegisterConnEventCb</span><span class="p">(</span><span class="n">application_connEvtCB</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_CB_REGISTER</span><span class="p">,</span><span class="w"> </span><span class="n">GAP_CB_CONN_EVENT_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">connHandle</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id7">
<h3>Connection Parameters<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>This section describes the connection parameters which are sent by
the initiating device with the connection request and can be
modified by either device when the connection is established. These
parameters are as follows:</p>
<ul class="simple">
<li><p><strong>Connection Interval</strong> - In Bluetooth Low Energy connections, a
frequency-hopping scheme is used. The two devices each send and
receive data from one another only on a specific channel at a
specific time. These devices meet a specific amount of time later
at a new channel (the link layer of the Bluetooth Low Energy
protocol stack handles the channel switching). This meeting
where the two devices send and receive data is known as a
<code class="docutils literal notranslate"><span class="pre">connection</span> <span class="pre">event</span></code>. If there is no application data to be sent or
received, the two devices exchange link layer data with empty
application payload to maintain the connection.
The connection interval is the amount of time
between two connection events in units of 1.25 ms. The connection
interval can range from a minimum value of 6 (7.5 ms) to a
maximum of 3200 (4.0 s). See <a class="reference internal" href="#gap-connection-event"><span class="std std-ref">Connection Event and Interval</span></a> for more details.</p></li>
</ul>
<div class="figure align-center" id="id65">
<span id="gap-connection-event"></span><img alt="../_images/image73.jpeg" src="../_images/image73.jpeg" />
<p class="caption"><span class="caption-number">Figure 70. </span><span class="caption-text">Connection Event and Interval</span><a class="headerlink" href="#id65" title="Permalink to this image">¶</a></p>
</div>
<p>Different applications may require different connection intervals.
As described in <a class="reference internal" href="#connection-parameter-considerations"><span class="std std-ref">Connection Parameter Considerations</span></a>, these requirements
affect the power consumption of the device. For more detailed information on
power consumption, see the <a class="reference external" href="http://www.ti.com/lit/pdf/swra478">Measuring Bluetooth Smart Power Consumption Application Report (SWRA478)</a>.</p>
<ul class="simple">
<li><p><strong>Peripheral Latency</strong> - Formerly known as ‘Slave Latency’.
This parameter gives the Peripheral
device the option of skipping a number of connection events. This
ability gives the peripheral device some flexibility. If the
peripheral does not have any data to send, it can skip connection
events, stay asleep, and save power. The peripheral device
selects whether to wake or not on a per connection event basis.
The peripheral can skip connection events but must not skip more
than allowed by the Peripheral latency parameter or the connection
fails. See picture below for more details.</p></li>
</ul>
<img alt="../_images/ditaa-f92cdd54bc72846402bd7d861d556f3d393d333d.png" src="../_images/ditaa-f92cdd54bc72846402bd7d861d556f3d393d333d.png" />
<ul class="simple">
<li><p><strong>Supervision Time-out</strong> - This time-out is the maximum amount of
time between two successful connection events. If this time
passes without a successful connection event, the device
terminates the connection and returns to an unconnected state.
This parameter value is represented in units of 10 ms. The
supervision time-out value can range from a minimum of 10 (100
ms) to 3200 (32.0 s). The time-out must be larger than the
effective connection interval (see <a class="reference internal" href="#effective-connection-interval"><span class="std std-ref">Effective Connection Interval</span></a> for
more details).</p></li>
</ul>
</div>
<div class="section" id="effective-connection-interval">
<span id="id8"></span><h3>Effective Connection Interval<a class="headerlink" href="#effective-connection-interval" title="Permalink to this headline">¶</a></h3>
<p>The effective connection interval is equal to the amount of time
between two connection events, assuming that the Peripheral skips the
maximum number of possible events if Peripheral latency is allowed (the
effective connection interval is equal to the actual connection
interval if Peripheral latency is set to 0).</p>
<p>The Peripheral Latency value represents the maximum number of events that
can be skipped. This number can range from a minimum value of 0
(meaning that no connection events can be skipped) to a maximum of
499. The maximum value must not make the effective connection
interval (see the following formula) greater than 16 s. The interval
can be calculated using the following formula:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">Effective</span> <span class="pre">Connection</span> <span class="pre">Interval</span> <span class="pre">=</span> <span class="pre">(Connection</span> <span class="pre">Interval)</span> <span class="pre">*</span> <span class="pre">(1</span> <span class="pre">+</span> <span class="pre">[Peripheral</span> <span class="pre">Latency])</span></code></p>
</div></blockquote>
<p>Consider the following example:</p>
<ul class="simple">
<li><p>Connection Interval: 80 (100 ms)</p></li>
<li><p>Peripheral Latency: 4</p></li>
<li><p>Effective Connection Interval: (100 ms) * (1 + 4) = 500 ms</p></li>
</ul>
<p>When no data is being sent from the Peripheral to the Central, the Peripheral
transmits during a connection event once every 500 ms.</p>
</div>
<div class="section" id="connection-parameter-considerations">
<span id="id9"></span><h3>Connection Parameter Considerations<a class="headerlink" href="#connection-parameter-considerations" title="Permalink to this headline">¶</a></h3>
<p>In many applications, the Peripheral skips the maximum number of
connection events. Consider the effective connection interval when
selecting or requesting connection parameters. Selecting the correct
group of connection parameters plays an important role in power
optimization of the Bluetooth Low Energy device. The following list
gives a general summary of the trade-offs in connection parameter
settings.</p>
<p>Reducing the connection interval does as follows:</p>
<ul class="simple">
<li><p>Increases the power consumption for both devices</p></li>
<li><p>Increases the throughput in both directions</p></li>
<li><p>Reduces the time for sending data in either direction</p></li>
</ul>
<p>Increasing the connection interval does as follows:</p>
<ul class="simple">
<li><p>Reduces the power consumption for both devices</p></li>
<li><p>Reduces the throughput in both directions</p></li>
<li><p>Increases the time for sending data in either direction</p></li>
</ul>
<p>Reducing the Peripheral latency (or setting it to zero) does as follows:</p>
<ul class="simple">
<li><p>Increases the power consumption for the peripheral device</p></li>
<li><p>Reduces the time for the peripheral device to receive the data sent
from a central device</p></li>
</ul>
<p>Increasing the Peripheral latency does as follows:</p>
<ul class="simple">
<li><p>Reduces power consumption for the peripheral during periods when the
peripheral has no data to send to the central device</p></li>
<li><p>Increases the time for the peripheral device to receive the data sent
from the central device</p></li>
</ul>
</div>
<div class="section" id="connection-parameter-update">
<h3>Connection Parameter Update<a class="headerlink" href="#connection-parameter-update" title="Permalink to this headline">¶</a></h3>
<p>In some cases, the central device requests a connection with a
peripheral device containing connection parameters that are
unfavorable to the peripheral device. In other cases, a peripheral
device might have the desire to change connection parameters in the middle of a
connection, based on the peripheral application. The peripheral
device can request the central device to change the connection
parameters by sending a <code class="docutils literal notranslate"><span class="pre">Connection</span> <span class="pre">Parameter</span> <span class="pre">Update</span> <span class="pre">Request</span></code>.
For Bluetooth 4.1, 4.2, 5.0 and 5.1-capable devices, this request is handled directly by
the Link Layer. For Bluetooth 4.0 devices, the L2CAP layer of the
protocol stack handles the request. The Bluetooth Low Energy stack
automatically selects the update method.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Connection</span> <span class="pre">Parameter</span> <span class="pre">Update</span> <span class="pre">Request</span></code> contains four parameters:</p>
<ul class="simple">
<li><p>Minimum connection interval</p></li>
<li><p>Maximum connection interval</p></li>
<li><p>Peripheral latency</p></li>
<li><p>Supervision time-out</p></li>
</ul>
<p>These values represent the parameters that the peripheral device wants for
the connection. The connection interval is given as a range. When
the central device receives the <code class="docutils literal notranslate"><span class="pre">Connection</span> <span class="pre">Parameter</span> <span class="pre">Update</span> <span class="pre">Request</span></code> request,
it can accept or reject the new parameters.</p>
<p>Sending a <code class="docutils literal notranslate"><span class="pre">Connection</span> <span class="pre">Parameter</span> <span class="pre">Update</span> <span class="pre">Request</span></code> is optional and it is not
required for the central device to accept or apply the requested
parameters. Some applications try to establish a connection at a
faster connection interval to allow for a faster service discovery
and initial setup. These applications later request a longer
(slower) connection interval for optimal power usage.</p>
<p>Regardless of the roles (peripheral or central), connection parameter updates can
be sent asynchronously with the <a class="reference external" href="../../doxygen/ble/html/group___g_a_p.html#gaad99f6598df0ee36c4cd2608afa09618">GAP_UpdateLinkParamReq()</a> command. The
simple_peripheral application can be configured to automatically send a
parameter update a certain amount of time after establishing a connection. An
example is provided in the simple_peripheral application, which sends a
connection parameter update upon a connection <strong>by default</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To change or modify the default connection parameter update settings,
open the project’s SysConfig file. Navigate to BLE → Peripheral
Configuration. Here you can modify the Connection Update Request Params
to configure the symbols below. If desired, you can also turn off the
default connection parameter update by unchecking
<em>`Send Parameter Update Request`</em>.</p>
</div>
<p>By default, the following symbols are generated by the SysConfig tool:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Pass parameter updates to the app for it to decide.</span>
<span class="cp">#define DEFAULT_SEND_PARAM_UPDATE_REQ</span>

<span class="c1">// Delay (in ms) after connection establishment before sending a parameter update requst</span>
<span class="cp">#define SEND_PARAM_UPDATE_DELAY                 6000</span>

<span class="c1">// Minimum connection interval (units of 1.25ms) if automatic parameter update</span>
<span class="c1">// request is enabled</span>
<span class="cp">#define DEFAULT_DESIRED_MIN_CONN_INTERVAL      400</span>

<span class="c1">// Maximum connection interval (units of 1.25ms) if automatic parameter update</span>
<span class="c1">// request is enabled</span>
<span class="cp">#define DEFAULT_DESIRED_MAX_CONN_INTERVAL      800</span>

<span class="c1">// Slave latency to use if automatic parameter update request is enabled</span>
<span class="cp">#define DEFAULT_DESIRED_SLAVE_LATENCY          0</span>

<span class="c1">// Supervision timeout value (units of 10ms) if automatic parameter update</span>
<span class="c1">// request is enabled</span>
<span class="cp">#define DEFAULT_DESIRED_CONN_TIMEOUT           600</span>
</pre></div>
</div>
<p>In simple_peripheral, six seconds after a connection is established the application
automatically sends a GAP Update Link Parameter Request:</p>
<div class="literal-block-wrapper docutils container" id="id66">
<div class="code-block-caption"><span class="caption-number">Listing 102. </span><span class="caption-text"><strong>simple_peripheral.c :: SimplePeripheral_processParamUpdate()</strong> - Initiating parameter update request</span><a class="headerlink" href="#id66" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SimplePeripheral_processParamUpdate</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">connHandle</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">    </span><span class="n">gapUpdateLinkParamReq_t</span><span class="w"> </span><span class="n">req</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">connIndex</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">req</span><span class="p">.</span><span class="n">connectionHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connHandle</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">  </span><span class="cp">#ifdef DEFAULT_SEND_PARAM_UPDATE_REQ</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">req</span><span class="p">.</span><span class="n">connLatency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_DESIRED_SLAVE_LATENCY</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">req</span><span class="p">.</span><span class="n">connTimeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_DESIRED_CONN_TIMEOUT</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">req</span><span class="p">.</span><span class="n">intervalMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_DESIRED_MIN_CONN_INTERVAL</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">req</span><span class="p">.</span><span class="n">intervalMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_DESIRED_MAX_CONN_INTERVAL</span><span class="p">;</span><span class="w"></span>
<span class="linenos">12</span><span class="w">  </span><span class="cp">#endif</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">    </span><span class="c1">//...</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">    </span><span class="c1">// Send parameter update</span>
<span class="linenos">17</span><span class="w">    </span><span class="n">bStatus_t</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GAP_UpdateLinkParamReq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>When the peer device receives this update request, the GAP parameter
<a class="reference external" href="../../doxygen/ble/html/group___g_a_p___params.html#ggad3fe20690fa942f702d9009944fe4d38a3cfae7911ef33cc29782430c27d0e967">GAP_PARAM_LINK_UPDATE_DECISION</a> determines how it responds. See
<a class="reference internal" href="#gaprole-peripheral-role"><span class="std std-ref">GAP Peripheral</span></a> for an explanation of how this parameter is
configured.</p>
</div>
<div class="section" id="connection-termination">
<h3>Connection Termination<a class="headerlink" href="#connection-termination" title="Permalink to this headline">¶</a></h3>
<p>Either the Central or the Peripheral can terminate a connection for any
reason. One side initiates termination and the other side must
respond before both devices exit the connected state. Use the
<a class="reference external" href="../../doxygen/ble/html/group___g_a_p.html#ga7e7d184cdce75306919cd660ccab3b3b">GAP_TerminateLinkReq()</a> command to terminate an existing connection.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="overview-cc13xx_cc26xx.html" class="btn btn-neutral float-left" title="Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="gatt.html" class="btn btn-neutral float-right" title="Generic Attribute Profile (GATT)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2010-2022, Texas Instruments.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>