<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Application Layer &mdash; 
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User&#39;s Guide
 2.02.08.01 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="External Interface" href="external-interface.html" />
    <link rel="prev" title="Overview" href="overview.html" />
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug u-stack uStack-application";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html" class="icon icon-home"> 
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User's Guide

          </a>
              <div class="version">
                2.02.08.01
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/disclaimer.html">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/quickstart-intro-cc13xx_cc26xx.html">Introduction to the SimpleLink CC13xx/CC26xx SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/ble5-quick-start.html">TI BLE5-Stack Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/platform-cc13xx_cc26xx.html">The CC13xx or CC26xx SDK Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/tirtos-index-cc13xx_cc26xx.html">TI-RTOS7 (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/freertos-index.html">FreeRTOS (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble-stack-5-index-cc13xx_cc26xx.html">BLE5-Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/developing-with-sdk-index-cc13xx_cc26xx.html">Developing a Bluetooth LE Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coexistence/coexistence.html">Coexistence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/localization-index-cc13xx_cc26xx.html">RTLS Toolbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-mesh/index.html">Bluetooth Mesh</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../ble-stack-5.x-guide/u-stack-index-cc13xx_cc26xx.html">Micro BLE Stack</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#system-architecture">System Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#micro-rf-interface">Micro RF interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#micro-link-layer">Micro Link Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#micro-gap">Micro GAP</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Application Layer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#connection-monitor-cm-application">Connection Monitor (CM) Application</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#initializing-cm-session">Initializing CM Session</a></li>
<li class="toctree-l4"><a class="reference internal" href="#starting-a-monitor-session">Starting a Monitor Session</a></li>
<li class="toctree-l4"><a class="reference internal" href="#monitoring-a-connection">Monitoring a Connection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lose-sync">Lose Sync</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connection-information-update">Connection Information Update</a></li>
<li class="toctree-l4"><a class="reference internal" href="#monitor-multiple-connections">Monitor Multiple Connections</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limitation">Limitation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="external-interface.html">External Interface</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../sensor-controller/sensor-controller.html">Sensor Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/debugging-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/memory-index.html">Memory Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-common/npi-index.html">Network Processor Interface (NPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble5-oad-index-cc13xx_cc26xx.html">TI Over-the-Air Download (OAD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble5-oad-index-mcuboot.html">MCUBoot Over-the-Air Download (OAD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security-tfm/index.html">Security Features of CC13x4 and CC26x4 Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/sysconfig-index-cc13xx_cc26xx.html">System Configuration Tool (SysConfig)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/migration-cc13xx_cc26xx.html">Porting Guide and Migration Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13xx_cc26xx.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html">Terms and Definitions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html">
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User's Guide
</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../ble-stack-5.x-guide/index-cc13xx_cc26xx.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../ble-stack-5.x-guide/u-stack-index-cc13xx_cc26xx.html">Micro BLE Stack</a> &raquo;</li>
      <li>Application Layer</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="application-layer">
<h1>Application Layer<a class="headerlink" href="#application-layer" title="Permalink to this headline">¶</a></h1>
<p>Since the micro stack can support multiple functionalities (broadcaster,
observer, connection monitor), it is up to the application layer to define
the behavior of the system. The following sections will discuss the TI provided
implementations of monitor role.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">micro_ble_cm.c</span></code> : rtls_passive and connection monitor application</p></li>
</ul>
<div class="section" id="connection-monitor-cm-application">
<span id="sec-cm-app"></span><h2>Connection Monitor (CM) Application<a class="headerlink" href="#connection-monitor-cm-application" title="Permalink to this headline">¶</a></h2>
<p>The connection monitor application is built on top of the uGAP layer
operating in monitor mode and is responsible for implementing the high level
connection tracking feature. This includes:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Initializing connection parameters for a connection to monitor</p></li>
<li><p>Performing the initial scan to find a connection event</p></li>
<li><p>Scheduling subsequent scans to continue following the connection</p></li>
</ol>
</div></blockquote>
<p>The following sections will describe the above list in detail.</p>
<div class="section" id="initializing-cm-session">
<span id="sec-cm-init"></span><h3>Initializing CM Session<a class="headerlink" href="#initializing-cm-session" title="Permalink to this headline">¶</a></h3>
<p>In order to follow a connection, the CM needs to know the connection parameters
that were exchanged during the connection process between Central and Peripheral.
These include:</p>
<blockquote>
<div><ul class="simple">
<li><p>access address</p></li>
<li><p>connection interval</p></li>
<li><p>hop value</p></li>
<li><p>next channel</p></li>
<li><p>channel map</p></li>
<li><p>CRC initialization value</p></li>
</ul>
</div></blockquote>
<p>These parameters can be obtained from a BLE5-Stack application by calling
the <code class="docutils literal notranslate"><span class="pre">HCI_EXT_GetActiveConnInfoCmd</span></code> command. Once they are obtained,
they should be shared (via an out of band mechanism such as UART, LIN, CAN etc)
with the CM device. The CM device then can use <code class="docutils literal notranslate"><span class="pre">ubCM_startNewSession()</span></code> to start the
initial scan.</p>
</div>
<div class="section" id="starting-a-monitor-session">
<span id="sec-cm-starting-monitoring"></span><h3>Starting a Monitor Session<a class="headerlink" href="#starting-a-monitor-session" title="Permalink to this headline">¶</a></h3>
<p>In order to start tracking a connection the connection monitor needs to
perform an initial scan with long scan duration in order to
catch a connection event.
This scan should be at worst case the connection interval times the number of
active channels in order to ensure the connection can be detected.</p>
<p>The logic trace below shows the initial scan of connection monitor
and it was generated by enabling the RF observable pins on
Central and Peripheral device in the connection (RX, TX) as well as the
connection monitor (RX). For more information regarding RF observable,
please refer to <a class="reference internal" href="../ble-stack-5.x-guide/debugging-index.html#debug-rf-output"><span class="std std-ref">Debugging RF Output</span></a></p>
<div class="figure align-default" id="cm-init-scan">
<img alt="../_images/cm-initial-scan.png" src="../_images/cm-initial-scan.png" />
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For example, if the active channel map is channel 0, 1, 2, 3, 4, 5 and
the hop number is 1. The next channel sent from peripheral is 2 and
connection interval is 7.5 ms. Then CM will stay at channel 2 for maximum
45 ms(6 * 7.5).</p>
</div>
</div>
<div class="section" id="monitoring-a-connection">
<span id="sec-cm-monitoring-connection"></span><h3>Monitoring a Connection<a class="headerlink" href="#monitoring-a-connection" title="Permalink to this headline">¶</a></h3>
<p>Once a packet is received during the initial scan the CM will setup
smaller scans based on the next expected event. Since it is now monitoring the
connection, it can calculate the channel and instant (adjusted for Central and
Peripheral sleep clock accuracy) to listen for the next event.</p>
<p>The core of connection monitoring is based on</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">monitor_indicationCB</span></code> : Invoked when a packet is received</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">monitor_completeCB</span></code> : Invoked when a scan window has completed.</p></li>
</ul>
<p>The logic trace below shows the CM actively tracking a connection</p>
</div></blockquote>
<div class="figure align-default" id="cm-conn">
<img alt="../_images/cm-conn.png" src="../_images/cm-conn.png" />
</div>
<p>The sequence diagram below illustrates the whole process of how CM
starts monitoring the connection and report RSSI to application.</p>
<div class="figure align-center" id="id2">
<p class="plantuml">
<img src="../_images/plantuml-28e2a79b86292b558e7718d9993286fe23e66377.png" alt="&#64;startuml

participant CM as &quot;Connection Monitor&quot;
participant Mul as &quot;Multi-role&quot;
participant Phone as &quot;Phone&quot;

Mul &lt;-- Phone: Connection Request
== After connection has established ==
CM &lt;- Mul: Pass needed information to Connection Monitor

rnote left
  Multi-role device needs to pass Access Address,
  connection interval, channel map,
  hop increment, CRC init
  and next channel to Connection Monitor.
end note

activate CM
  CM --&gt; CM: Start scanning for packet at next channel
  Phone --&gt; Mul: Send packet
  Mul --&gt; Phone: Send packet
...
... Connection Monitor will stay at next channel for maximum\nCI * (Number of Active Channel) amount of time...
...
  Phone --&gt; Mul: Send packet
  Mul --&gt; Phone: Send packet
deactivate CM

Group If Connection Monitor Initial Scan Timeout\nScan Timeout = (CI * Number of Active Channels)
  CM --&gt; CM: Back to Idle state
  CM -&gt; Mul: Notify Multi-role that sync failed
  Mul -&gt; CM: Send over needed information to restart \nConnection Monitor
end

Group After Connection Monitor syncs up

Phone --&gt; Mul: Send acket

activate CM

CM --&gt; CM: Scan packet sent from Phone and\nextract rssi
[&lt;-CM : The rssi value from Phone will be \nsent to monitor_indicationCB

Mul --&gt; Phone: Send Packet
CM --&gt; CM: Scan packet sent from Multi-role device \nand extract rssi
[&lt;-CM : The rssi value from Multi-role device will \nbe sent to monitor_indicationCB
CM --&gt; CM: Finish one monitor event
[&lt;-CM : Send notification to monitor_completeCB \nto indicate one monitor event has finished
CM -&gt; Mul: One monitor event success. \nSend RSSI, timeStamp and monitored channel to Multi-role device
Deactivate CM

...
... Change to next channel and Connection Monitor continues monitoring the connection...
...
end
&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 165. </span><span class="caption-text">Connection Monitor initialization and connection tracking</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="lose-sync">
<span id="sec-cm-loses-sync"></span><h3>Lose Sync<a class="headerlink" href="#lose-sync" title="Permalink to this headline">¶</a></h3>
<p>Application layer can decide how many consecutive connection events
CM is allowed to miss by setting <code class="docutils literal notranslate"><span class="pre">BLE_CONSECUTIVE_MISSED_CONN_EVT_THRES</span></code>.</p>
<p>CM keeps track of consecutive missed events(<code class="docutils literal notranslate"><span class="pre">consecutiveTimesMissed</span></code>)
and total missed events(<code class="docutils literal notranslate"><span class="pre">timesMissed</span></code>).
Those variables can be found under ubCM_ConnInfo_t struct.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-number">Listing 190. </span><span class="caption-text">Connection Monitor Information</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">  </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="linenos"> 2</span>  <span class="p">{</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">sessionId</span><span class="p">;</span><span class="w">                             </span><span class="c1">//! Number 1-255 assigned as they are created identifying each connection monitor session</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">timesScanned</span><span class="p">;</span><span class="w">                          </span><span class="c1">//! track count of recent events monitored to determine next priority CM session to avoid starvation</span>
<span class="hll"><span class="linenos"> 5</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">timesMissed</span><span class="p">;</span><span class="w">                           </span><span class="c1">//! missed count of recent events monitored</span>
</span><span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">consecutiveTimesMissed</span><span class="p">;</span><span class="w">                </span><span class="c1">//! consecutive missed count of recent events monitored</span>
</span><span class="linenos"> 7</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">missedEvents</span><span class="p">;</span><span class="w">                          </span><span class="c1">//! missed count of events since last monitoring session</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">numEvents</span><span class="p">;</span><span class="w">                             </span><span class="c1">//! how many connection events have passed since the last anchor point.</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">accessAddr</span><span class="p">;</span><span class="w">                            </span><span class="c1">//! return error code if failed to get conn info</span>
<span class="linenos">10</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">connRole</span><span class="p">;</span><span class="w">                              </span><span class="c1">//! RTLS Coordinator BLE role (4 - Peripheral, 8- Central)</span>
<span class="linenos">11</span><span class="w">    </span><span class="kt">uint16_t</span><span class="w">  </span><span class="n">connInterval</span><span class="p">;</span><span class="w">                          </span><span class="c1">//! connection interval time, range 12 to 6400 in  625us increments (7.5ms to 4s)</span>
<span class="linenos">12</span><span class="w">    </span><span class="kt">uint16_t</span><span class="w">  </span><span class="n">scanDuration</span><span class="p">;</span><span class="w">                          </span><span class="c1">//! Required scan window to capture minimum of 1 packet from Central and Peripheral up to max possible packet size</span>
<span class="linenos">13</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">hopValue</span><span class="p">;</span><span class="w">                              </span><span class="c1">//! Hop value for conn alg 1, integer range (5,16)</span>
<span class="linenos">14</span><span class="w">    </span><span class="kt">uint16_t</span><span class="w">  </span><span class="n">combSCA</span><span class="p">;</span><span class="w">                               </span><span class="c1">//! mSCA + cmSCA</span>
<span class="linenos">15</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">currentChan</span><span class="p">;</span><span class="w">                           </span><span class="c1">//! current unmapped data channel</span>
<span class="linenos">16</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">lastUnmappedChannel</span><span class="p">;</span><span class="w">                   </span><span class="c1">//! last used unmapped channel when received data packet from the central</span>
<span class="linenos">17</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">nextChan</span><span class="p">;</span><span class="w">                              </span><span class="c1">//! next data channel</span>
<span class="linenos">18</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">numUsedChans</span><span class="p">;</span><span class="w">                          </span><span class="c1">//! count of the number of usable data channels</span>
<span class="linenos">19</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">chanMap</span><span class="p">[</span><span class="n">CM_MAX_NUM_DATA_CHAN</span><span class="p">];</span><span class="w">         </span><span class="c1">//! current channel map table that is in use for this connection</span>
<span class="linenos">20</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">centralAddress</span><span class="p">[</span><span class="n">CM_DEVICE_ADDR_LEN</span><span class="p">];</span><span class="w">    </span><span class="c1">//! BLE address of connection central</span>
<span class="linenos">21</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">peripheralAddress</span><span class="p">[</span><span class="n">CM_DEVICE_ADDR_LEN</span><span class="p">];</span><span class="w"> </span><span class="c1">//! BLE address of connection peripheral</span>
<span class="linenos">22</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">rssiCentral</span><span class="p">;</span><span class="w">                           </span><span class="c1">//! last Rssi value Central</span>
<span class="linenos">23</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w">   </span><span class="n">rssiPeripheral</span><span class="p">;</span><span class="w">                        </span><span class="c1">//! last Rssi value Peripheral</span>
<span class="linenos">24</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">timeStampCentral</span><span class="p">;</span><span class="w">                      </span><span class="c1">//! last timeStamp Central</span>
<span class="linenos">25</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">timeStampCentral2</span><span class="p">;</span><span class="w">                     </span><span class="c1">//! last timeStamp Central</span>
<span class="linenos">26</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">timeStampPeripheral</span><span class="p">;</span><span class="w">                   </span><span class="c1">//! last timeStamp Peripheral</span>
<span class="linenos">27</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">currentStartTime</span><span class="p">;</span><span class="w">                      </span><span class="c1">//! Current anchor point</span>
<span class="linenos">28</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">nextStartTime</span><span class="p">;</span><span class="w">                         </span><span class="c1">//! Record next planned scan anchor point to compare with competing CM sessions</span>
<span class="linenos">29</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">lastStartTime</span><span class="p">;</span><span class="w">                         </span><span class="c1">//! Record last planned scan anchor point to compare with competing CM sessions</span>
<span class="linenos">30</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">timerDrift</span><span class="p">;</span><span class="w">                            </span><span class="c1">//! Clock timer drift</span>
<span class="linenos">31</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">crcInit</span><span class="p">;</span><span class="w">                               </span><span class="c1">//! crcInit value for this connection</span>
<span class="linenos">32</span><span class="w">    </span><span class="kt">uint16_t</span><span class="w">  </span><span class="n">hostConnHandle</span><span class="p">;</span><span class="w">                        </span><span class="c1">//! keep connHandle from host requests</span>
<span class="linenos">33</span><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">ubCM_ConnInfo_t</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>Once <code class="docutils literal notranslate"><span class="pre">consecutiveTimesMissed</span></code> is larger than <code class="docutils literal notranslate"><span class="pre">BLE_CONSECUTIVE_MISSED_CONN_EVT_THRES</span></code>,
the CM will terminate the monitor session and notify the
host. Host can then restart the monitor session by going
through <a class="reference internal" href="#sec-cm-init"><span class="std std-ref">Initializing CM Session</span></a>, <a class="reference internal" href="#sec-cm-starting-monitoring"><span class="std std-ref">Starting a Monitor Session</span></a>
and <a class="reference internal" href="#sec-cm-monitoring-connection"><span class="std std-ref">Monitoring a Connection</span></a>.</p>
<p>The sequence diagram below illustrates the whole process of how CM
deals with losing sync.</p>
<div class="figure align-center" id="id4">
<p class="plantuml">
<img src="../_images/plantuml-d8837ca8679b86c0d4f469782e5a845c91da3952.png" alt="&#64;startuml

participant CM as &quot;Connection Monitor&quot;
participant Mul as &quot;Multi-role&quot;
participant Phone as &quot;Phone&quot;

== BLE_CONSECUTIVE_MISSED_CONN_EVT_THRES = 30 ==
== Connection Monitor syncs up ==
Phone --&gt; Mul: Send packet
activate CM
...
... Assume Connection Monitor has been scanning \nbut missed 30 consecutive connection events.\n connInfo-&gt;consecutiveTimesMissed is now at 30...
...

Mul --&gt; Phone: Send packet

Group If CM successfully monitors 31st connection event

Phone --&gt; Mul: Send packet
Mul --&gt; Phone: Send packet

CM --&gt; CM: connInfo-&gt;consecutiveTimesMissed = 0

CM --&gt; CM: Finish one monitor event
[&lt;-CM : Send notification to monitor_completeCB \nto indicate one monitor event has finished
CM -&gt; Mul: One monitor event success. \nSend RSSI, timeStamp and monitored channel \nto Multi-role device

end

Group If CM misses 31st connection event

Phone --&gt; Mul: Send packet
Mul --&gt; Phone: Send packet
CM --&gt; CM: connInfo-&gt;consecutiveTimesMissed ++
deactivate CM

CM --&gt; CM: Change status to CM_FAILED_NOT_ACTIVE

[&lt;-CM: Send notification to monitor_completeCB \nto indicate the monitor session \nis no longer active
CM --&gt; CM: Terminate the monitor session by calling \nubCM_stop
CM-&gt; Mul: Notify Multi-role device that the monitor session is terminated

CM --&gt; CM: Back to Idle.
Mul -&gt; CM: Send over needed information to \nrestart monitoring session

end

&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 166. </span><span class="caption-text">Connection Monitor loses sync</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="connection-information-update">
<span id="sec-cm-update-conninfo"></span><h3>Connection Information Update<a class="headerlink" href="#connection-information-update" title="Permalink to this headline">¶</a></h3>
<p>CM does not extract the payload information, it only measures the
RSSI from the payload. Therefore, if there are control packets such as
channelmap update, connection parameters update
exchanged between central and peripheral, the device that has wired
connection to CM needs to pass on the information so that CM can continue
monitoring the connection.</p>
<p>Once CM receives the new information, the application needs to call
<code class="docutils literal notranslate"><span class="pre">MicroCmApp_cmStartReq</span></code> or <code class="docutils literal notranslate"><span class="pre">RTLSPassive_cmStartReq</span></code> which eventually
calls <code class="docutils literal notranslate"><span class="pre">ubCM_updateExt</span></code> if the session already exists.</p>
<div class="figure align-center" id="id5">
<p class="plantuml">
<img src="../_images/plantuml-9326794e6d45cb42925e38ea2e234d2249343da9.png" alt="&#64;startuml

participant CM as &quot;Connection Monitor&quot;
participant Mul as &quot;Multi-role&quot;
participant Phone as &quot;Phone&quot;

activate CM

== Connection Monitor syncs up ==
Phone --&gt; Mul: Send packet

Mul --&gt; Phone: Send packet

group Channel Map Update

Phone --&gt; Mul: Send channel map update packet
Mul --&gt; Phone: Send packet
Mul -&gt; CM: Send the updated channel map

CM --&gt; CM: Update the current monitor session \nwith new information by calling \nubCM_updateExt

end

Group Connection Parameters Update

Phone --&gt; Mul: Connection parameters update packet
Mul --&gt; Phone: Response to the connection \nparameters update packet
Mul -&gt; CM: Send the new connection parameters

CM --&gt; CM: Update the current monitor session \nwith new information by calling \nubCM_updateExt

end

CM --&gt; CM: Stop monitoring current session and \ncontinue scanning until sync found/timeout

&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 167. </span><span class="caption-text">Connection Monitor control packets update</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="monitor-multiple-connections">
<span id="sec-cm-multiple-connection"></span><h3>Monitor Multiple Connections<a class="headerlink" href="#monitor-multiple-connections" title="Permalink to this headline">¶</a></h3>
<p>CM can monitor multiple connections even when all the monitored connections
have different connection intervals.</p>
<p>To determine which connection to monitor, after ending each monitor session,
the CM scheduler will sort the all connections based on future start time.
Then CM will do a timing conflict check on selected and sec connections.
If (conn1 start time + monitor/scan duration) &gt; conne2 start time, then
CM will consider there is conflict between connection 1 and connection 2.</p>
<p>The monitor/scan duration for each monitor session is determined by
the following parameters:</p>
<blockquote>
<div><ul>
<li><p>Sleep Clock Accuracy(<a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html#term-SCA"><span class="xref std std-term">SCA</span></a>)for both central and peripheral device.</p></li>
<li><p>The processing time for the radio core and the CM software.</p></li>
<li><p>Time needed to receive only one packet per central and periperal device using
1M Phy. No <a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html#term-MD"><span class="xref std std-term">MD</span></a> in the same connection event.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CM example is to extract (<a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13xx_cc26xx.html#term-RSSI"><span class="xref std std-term">RSSI</span></a>) information for central and peripheral device
when they are in connection. It does not extract payload information, therefore,
there is no need to monitor more packets.</p>
</div>
</li>
</ul>
</div></blockquote>
<p>When there is timing conflict among monitored connections, CM will decide which
connection to monitor based on the following factors and the list below is in
order of priorities from high to low:</p>
<blockquote>
<div><ul>
<li><p>If one of the connection has larger connection interval, then the connection
which CM misses more monitored time will be scheduled.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For example, if the next connection events for connection 1(CI = 100ms)
and connection 2(CI = 40ms, cmMissedEvent = 3) are in conflict, then CM will monitor
connection 2 because connection 2 missed more monitored time (100 &lt; 40*3).</p>
</div>
</li>
<li><p>Connection with higher cmMissedEvents.</p></li>
<li><p>Connection with earlier start time.</p></li>
</ul>
</div></blockquote>
<p>The following diagram illustrates how the CM handling monitor session conflict:</p>
<img alt="../_images/ditaa-3b9d36a604fb3da71543a779e3a2841befac919d.png" src="../_images/ditaa-3b9d36a604fb3da71543a779e3a2841befac919d.png" />
</div>
<div class="section" id="limitation">
<span id="sec-cm-limitation"></span><h3>Limitation<a class="headerlink" href="#limitation" title="Permalink to this headline">¶</a></h3>
<p>When requesting a new monitor session while CM has already been
monitoring connection(s), the CM will process the request based
on the timing of when the request comes in.</p>
<blockquote>
<div><ul class="simple">
<li><p>If the request comes in when CM is not monitoring
a connection, the request will be processed right away. This
means that CM will start scanning for a new connection immediately
after receiving the request.</p></li>
<li><p>If the request comes in when CM is monitoring a connection,
the information of the new connection will be saved and processed
once the current monitor session has ended.</p></li>
</ul>
</div></blockquote>
<p>The following diagram illustrates how the CM handles new monitor request.</p>
<img alt="../_images/ditaa-d2f6c860f257a718c30be079445cf7b8597683da.png" src="../_images/ditaa-d2f6c860f257a718c30be079445cf7b8597683da.png" />
<p>Due to the nature of how <a class="reference internal" href="#sec-cm-starting-monitoring"><span class="std std-ref">Starting a Monitor Session</span></a> works,
the radio core might still be scanning for the new connection when
it is time to monitor existing connection(s). CM will
prioritize scanning for new connection over monitoring existing connection(s).
Once CM is able to track the new connection or scan timeout, it will continue
monitoring the existing connections.</p>
<p>That being said, if there are multiple new monitor sessions’ requests coming in,
then CM will process all the new monitor sessions’ requests before it goes back to
monitor the existing connections.</p>
<p>In addition to the above limitation, CM example also
has the following constraints:</p>
<ul class="simple">
<li><p>Connections must use LE Channel Selection Algorithm #1</p></li>
<li><p>Connections must use LE 1M PHY</p></li>
<li><p>Connections must exist on LE Data channels</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is not recommended to call <code class="docutils literal notranslate"><span class="pre">ubCM_stop</span></code> or <code class="docutils literal notranslate"><span class="pre">ubCM_start</span></code> in the
middle of a monitor session. Calling the aforementioned APIs while
the radio core is active might cause unexpected behavior.</p>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="overview.html" class="btn btn-neutral float-left" title="Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="external-interface.html" class="btn btn-neutral float-right" title="External Interface" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2010-2022, Texas Instruments.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>