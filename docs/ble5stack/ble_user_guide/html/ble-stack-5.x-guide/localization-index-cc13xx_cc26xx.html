<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RTLS Toolbox &mdash; 
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User&#39;s Guide
 2.02.08.01 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Bluetooth Mesh" href="../ble-mesh/index.html" />
    <link rel="prev" title="Coexistence" href="../coexistence/coexistence.html" />
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug ble-stack-5.x-guide localization-index-cc13xx_cc26xx";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index-cc13xx_cc26xx.html" class="icon icon-home"> 
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User's Guide

          </a>
              <div class="version">
                2.02.08.01
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="disclaimer.html">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/quickstart-intro-cc13xx_cc26xx.html">Introduction to the SimpleLink CC13xx/CC26xx SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/ble5-quick-start.html">TI BLE5-Stack Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="platform-cc13xx_cc26xx.html">The CC13xx or CC26xx SDK Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="tirtos-index-cc13xx_cc26xx.html">TI-RTOS7 (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="freertos-index.html">FreeRTOS (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="ble-stack-5-index-cc13xx_cc26xx.html">BLE5-Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="developing-with-sdk-index-cc13xx_cc26xx.html">Developing a Bluetooth LE Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coexistence/coexistence.html">Coexistence</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">RTLS Toolbox</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#general-rtls-software-architecture">General RTLS Software Architecture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">RTLS Toolbox</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rtls-utility">RTLS Utility</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rtls-node-manager">RTLS Node Manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rtls-control-module">RTLS Control Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rtls-roles-and-topology">RTLS Roles and Topology</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#coordinator">Coordinator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#responder">Responder</a></li>
<li class="toctree-l4"><a class="reference internal" href="#passive">Passive</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pc-central-processing-node">PC/Central Processing Node</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#role-combinations">Role Combinations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ble-stack">BLE-Stack</a></li>
<li class="toctree-l4"><a class="reference internal" href="#aoa">AoA</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#rtls-driver">RTLS Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="#physical-considerations">Physical Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-mode">Test mode</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#rssi-based-localization">RSSI Based Localization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#reading-rssi">Reading RSSI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connection-monitor">Connection Monitor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#keyless-entry-with-ti-connection-monitor">Keyless entry with TI connection monitor</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ble-5-stack">BLE(5)-Stack</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#calculation-detail">Calculation Detail</a></li>
<li class="toctree-l4"><a class="reference internal" href="#advantages-of-a-connection-based-rssi-system">Advantages of a connection based RSSI system</a></li>
<li class="toctree-l4"><a class="reference internal" href="#advantages-of-a-connectionless-based-rssi-system">Advantages of a connectionless based RSSI system</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#angle-of-arrival">Angle of Arrival</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#packet-format">Packet Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#integration">Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#aoa-driver">AoA Driver</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configurations-supported">Configurations Supported</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-collection-flow">Data Collection Flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#antenna-switching">Antenna Switching</a></li>
<li class="toctree-l4"><a class="reference internal" href="#valid-i-q-samples-for-angle-calculation">Valid I/Q Samples For Angle Calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#aoa-functions-overview">AoA Functions Overview</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#aoa-applications-overview">AoA Applications Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#connection-aoa">Connection AoA</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connectionless-aoa">Connectionless AoA</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ble-mesh/index.html">Bluetooth Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="u-stack-index-cc13xx_cc26xx.html">Micro BLE Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sensor-controller/sensor-controller.html">Sensor Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="memory-index.html">Memory Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-common/npi-index.html">Network Processor Interface (NPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="ble5-oad-index-cc13xx_cc26xx.html">TI Over-the-Air Download (OAD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="ble5-oad-index-mcuboot.html">MCUBoot Over-the-Air Download (OAD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security-tfm/index.html">Security Features of CC13x4 and CC26x4 Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="sysconfig-index-cc13xx_cc26xx.html">System Configuration Tool (SysConfig)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration-cc13xx_cc26xx.html">Porting Guide and Migration Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-reference-cc13xx_cc26xx.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference-cc13xx_cc26xx.html">Terms and Definitions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index-cc13xx_cc26xx.html">
SimpleLink™ CC13XX/CC26XX SDK
BLE5-Stack User's Guide
</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index-cc13xx_cc26xx.html" class="icon icon-home"></a> &raquo;</li>
      <li>RTLS Toolbox</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="rtls-toolbox">
<h1>RTLS Toolbox<a class="headerlink" href="#rtls-toolbox" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Only CTE Tx is supported on the CC13x1x3 or CC26x1x3 devices.
Enabling CTE Rx feature on CC13x1x3 or CC26x1x3 devices will result in unexpected
behavior in the BLE5-Stack.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The RTLS examples, documentation and tools have been updated to follow the
Appropriate Language nomenclature directive from Bluetooth SIG. Existing
E2E threads will not be modified and may use the terms <em>rtls_master</em> and
<em>rtls_slave</em> instead of <em>rtls_coordinator</em> and <em>rtls_responder</em>.</p>
</div>
<p>The RTLS (Real Time Localization System) Toolbox, is a collection of RTLS
techniques that can be implemented on TI’s standard Bluetooth Low Energy radios
in the CC26xx series. These techniques provide raw data that can be utilized for
developing localization algorithms and secure range bounding other Bluetooth Low
Energy nodes. The two main techniques included in the RTLS toolbox are
RSSI and <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a> Angle of Arrival.</p>
<p>RSSI details the Received Signal Strength Indication of an incoming
signal and is commonly leveraged for deriving the distance between a receiver
and a transmitter through the process of trilateration in localization
algorithms. The Bluetooth Low Energy stack enables developers to receive the
RSSI of an incoming Bluetooth packet.</p>
<p><a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a> Angle of Arrival is a technique for finding the direction that an
incoming Bluetooth packet is coming from, creating a basis for triangulation.
The device samples an incoming constant tone and as I/Q data. This raw I/Q data
represents the amplitude and phase data of a signal and this data can be used
to derive the angle the device transmitting the constant tone.</p>
<p>For detailed information on the specific example, see the relevant README.html
file in the
simplelink_cc13xx_cc26xx_sdk_x_xx_xx_xx/examples/rtos/CC26X2R1_LAUNCHXL/ble5stack/PROJECT
folder.</p>
<p>Using the raw data provided by the RTLS Toolbox, TI is enabling developers to
improve localization algorithms based on Bluetooth technology by delivering more
data that can be leveraged for trilateration and triangulation.</p>
<p>The inherent flexibility of the CC13xx or CC26xx RF Core is what enables this
significant extension of functionality. The main advantages using the CC13xx or CC26xx
are that customers can start adding RTLS features and security with little extra
cost, very little extra energy consumption and no increase in peak power.</p>
<p>There are two fundamentally different approaches for localization:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><strong>Trilateration</strong></p></td>
<td><p><strong>Triangulation</strong></p></td>
</tr>
<tr class="row-even"><td><div class="figure align-default">
<img alt="../_images/trilateration.png" src="../_images/trilateration.png" />
</div>
</td>
<td><div class="figure align-default">
<img alt="../_images/triangulation.png" src="../_images/triangulation.png" />
</div>
</td>
</tr>
<tr class="row-odd"><td><p>Trilateration is where you know the distance between a reference node and a
target node. This means that the possible locations seen by one locator
constitute a circle, so typically  three locators are needed to find a single
common intersect point. (Assuming a 2D scenario)</p>
<p><a class="reference internal" href="#sec-rssi-localization"><span class="std std-ref">RSSI Based Localization</span></a> gives you the distance from the receiver to the
transmitter.</p>
</td>
<td><p>Triangulation is where you know the direction from a reference node to a
target node. This means that the possible locations seen by one locator
constitute a straight line,  so two nodes will be enough to determine a single
intersect point. (Assuming a 2D scenario)</p>
<p><a class="reference internal" href="#sec-aoa"><span class="std std-ref">Angle of Arrival</span></a> gives you the angle from the receiver to the transmitter.</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Existing examples with no external control interface are discontinued.
All RTLS examples now have an external control interface.</p>
</div>
<div class="section" id="general-rtls-software-architecture">
<span id="sec-rtls-sw-architecture"></span><h2>General RTLS Software Architecture<a class="headerlink" href="#general-rtls-software-architecture" title="Permalink to this headline">¶</a></h2>
<p>The diagram below shows the RTLS software architecture.</p>
<p>With multiple nodes that collect localization data, it is important to have an
architecture that supports control of these nodes. It must be possible to
configure and trigger localization and it must be possible to retrieve
localization data. We achieve this by reuse of our Network Processor Interface
(NPI). It is basically a means to support Remote Procedure Calls (RPC) over a
serial interface. Note that the architecture is such that it is possible to
replace NPI with your own preferred serial protocol.</p>
<p>In our example we use UART as the serial transport layer. This is because it
is readily available on host PC as UART over USB, and our LaunchPads include a
UART to USB bridge. Along with the embedded examples we provide PC software to
act as host, to control, retrieve and present localization data. This also
allows much quicker customer performance characterization, as well as
configuration of important parameters, not to mention the ability to develop
and test higher level post-processing algorithms.</p>
<img alt="../_images/ditaa-0dc246adba8db1ad7ffa16408e949dae27a86d33.png" src="../_images/ditaa-0dc246adba8db1ad7ffa16408e949dae27a86d33.png" />
<div class="section" id="id2">
<h3>RTLS Toolbox<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>The RTLS toolbox is a collection of software that is purposed for the
localization use case. A table below summarizes each software component in the
toolbox as well as its applications for localization. The software components
below will run on the embedded nodes.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Software Component</p></th>
<th class="head"><p>Usage</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BLE-Stack</p></td>
<td><p>Advertising, scanning, connection, exchanging RTLS data</p></td>
</tr>
<tr class="row-odd"><td><p>Connection Monitor</p></td>
<td><p>Follows a BLE connection using Micro BLE-Stack</p></td>
</tr>
<tr class="row-even"><td><p>Angle of Arrival</p></td>
<td><p>Radio patches and driver to read AoA data embedded in
BLE packets</p></td>
</tr>
<tr class="row-odd"><td><p>Unified Network Processor
Interface (UNPI)</p></td>
<td><p>A serial protocol including packet format and
handshaking for power savings</p></td>
</tr>
<tr class="row-even"><td><p>RTLS Control Module</p></td>
<td><p>Implements the command and event set used to
communicate RTLS information between devices. This runs
on the embedded devices and translates UNPI frames into
the necessary AoA function calls</p></td>
</tr>
</tbody>
</table>
<p>The software components in the following table run on a PC. TI has setup
a PC based environment to facilitate in evaluating and prototyping various
RTLS algorithms. Once the algorithms are complete, the various PC components
above can be migrated to an embedded device.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Software Component</p></th>
<th class="head"><p>Usage</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>RTLS Util</p></td>
<td><p>Event handling and distribution  across nodes. Implements
results queues, and setting up worker threads for data
handling.</p></td>
</tr>
<tr class="row-odd"><td><p>RTLS Node Manager</p></td>
<td><p>Framework for sending and receiving RTLS commands and
events from the embedded devices to PC. Implements higher
level logic such as forwarding necessary BLE connection
information to the connection monitor node.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="rtls-utility">
<h3>RTLS Utility<a class="headerlink" href="#rtls-utility" title="Permalink to this headline">¶</a></h3>
<p>The RTLSUtil module is a convenience layer that is built on top of the node
manager that implements event handling and blocking as required by the RTLS
network (e.g. seed distribution). Additionally the RTLSUtil module is able to
setup worker threads for data processing of results from the device as well as
creating queues to store the incoming data.</p>
</div>
<div class="section" id="rtls-node-manager">
<h3>RTLS Node Manager<a class="headerlink" href="#rtls-node-manager" title="Permalink to this headline">¶</a></h3>
<p>The RTLS Node Manager provides the following functionality:</p>
<ul class="simple">
<li><p>A bridge between host processor and CC13xx or CC26xx</p></li>
<li><p>Holds the state of each device and takes care of configuration</p></li>
<li><p>Enables the simplicity of RTLS Control Module</p></li>
</ul>
<p>Due to the above functionality, the Node Manager can operate on user’s CPU and
help with slow bus (LIN/CAN).</p>
</div>
<div class="section" id="rtls-control-module">
<h3>RTLS Control Module<a class="headerlink" href="#rtls-control-module" title="Permalink to this headline">¶</a></h3>
<p>The RTLS Control Module is an on-chip module which runs as a RTOS Task
and it provides the following functionality:</p>
<ul class="simple">
<li><p>Parsing commands coming from Node Manager</p></li>
<li><p>RTLS Driver configuration and operation</p></li>
<li><p>RF and NPI message queue</p></li>
</ul>
</div>
<div class="section" id="rtls-roles-and-topology">
<h3>RTLS Roles and Topology<a class="headerlink" href="#rtls-roles-and-topology" title="Permalink to this headline">¶</a></h3>
<p>Each node in an RTLS network utilizes the software components listed above in a
different way to perform a specific task related to localization. These
capabilities map to a role within the RTLS network and ultimately are implemented
by sample applications within the SDK. There are three examples: <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code>,
<code class="docutils literal notranslate"><span class="pre">rtls_responder</span></code>, and <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code>. The capabilities of these examples are
explained below. All embedded nodes implement UNPI and act as responders in the UNPI
protocol. Additionally all embedded nodes have the RTLS Control module implemented
for processing RTLS commands from the UNPI interface.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The following subsections aim to describe what localization roles are
implemented by the sample applications in the SDK. This is not a comprehensive
list of what is possible on each node, but rather an explanation of what the
examples will do out of the box. For a list of potential combinations, please
see Role Combinations.</p>
</div>
<div class="section" id="coordinator">
<h4>Coordinator<a class="headerlink" href="#coordinator" title="Permalink to this headline">¶</a></h4>
<p>The RTLS coordinator runs a full BLE5-Stack and is based on the <a class="reference external" href="../../../../../examples/rtos/CC26X2R1_LAUNCHXL/ble5stack/multi_role/README.html">multi_role</a> example.</p>
<p>In the case of connection AoA, it scans and connects to the RTLS responder over BLE.
Once a connection is established the RTLS Coordinator does the following.</p>
<blockquote>
<div><ul class="simple">
<li><p>Share the connection parameters (access address, coordinator sleep clock accuracy,
and CRC init) with the PC.</p></li>
<li><p>Use the BLE link to share AoA parameters with the responder device.</p></li>
<li><p>Implements the AoA coordinator role</p></li>
<li><p>Does not send out AoA packets, but configures the responder to do so (in the case of connection AoA)</p></li>
</ul>
<p>In the case of connectionless-AOA, the RTLS Coordinator does the following.</p>
<ul class="simple">
<li><p>Synchronizes with periodic advertisements sent by the responder (in the case of connectionless AoA)</p></li>
<li><p>Receives packets with CTE and performs in-phase and quadrature component (IQ)
sampling</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="responder">
<h4>Responder<a class="headerlink" href="#responder" title="Permalink to this headline">¶</a></h4>
<p>The RTLS responder runs a full BLE5-Stack. It is based on the <a class="reference external" href="../../../../../examples/rtos/CC26X2R1_LAUNCHXL/ble5stack/multi_role/README.html">multi_role</a> example. This is
the device that is to be located. In the case of connected Aoa, the responder device
will advertise and enter a connection with the RTLS Coordinator. In the case of
connectionless AoA, the responder sends out periodic advertisements the coordinator can
synchronize with.</p>
<blockquote>
<div><ul class="simple">
<li><p>Sends data packets with AoA tone embedded using Constant Tone Extension (CTE)</p></li>
<li><p>Advertises special string to be detected by <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> (in the case of connection AoA)</p></li>
<li><p>Advertises periodic advertisements (in the case of connectionless AoA)</p></li>
<li><p>Implements AoA responder role</p></li>
<li><p>Wireless/battery operated, not connected to PC</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="passive">
<h4>Passive<a class="headerlink" href="#passive" title="Permalink to this headline">¶</a></h4>
<p>The RTLS passive does not actively participate in the BLE connection between
the RTLS coordinator and responder. Instead, it uses the <a class="reference internal" href="u-stack-index-cc13xx_cc26xx.html#sec-index-micro-ble-stack"><span class="std std-ref">Micro BLE Stack</span></a> in
connection monitoring mode to follow the connection. To do this, the passive
device relies on the Coordinator to distribute the connection parameters once a
connection is formed. The passive node does the following:</p>
<blockquote>
<div><ul class="simple">
<li><p>Implement AoA passive role</p></li>
<li><p>Receives packets with CTE and performs in-phase and quadrature component (IQ)
sampling</p></li>
<li><p>Implements the Micro BLE-Stack connection monitoring application layer.
See <a class="reference internal" href="../u-stack/uStack-application.html#sec-cm-app"><span class="std std-ref">Connection Monitor (CM) Application</span></a> for more information on the connection monitor.</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code> device is not used for Connectionless AoA.</p>
</div>
</div>
<div class="section" id="pc-central-processing-node">
<h4>PC/Central Processing Node<a class="headerlink" href="#pc-central-processing-node" title="Permalink to this headline">¶</a></h4>
<p>The PC node is responsible for controlling the embedded RTLS nodes by sending
commands and processing events. In the SDK, this is realized by
Python layer that implements the UNPI coordinator role.</p>
<p>This software is intended to use as a framework for extracting data from the
embedded nodes and using it to prototype high level RTLS algorithms on the PC.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In a final product, these algorithms may be implemented on an embedded
device or even perhaps the RTLS coordinator node. TI has provided PC software
to aid in prototyping various algorithms.</p>
</div>
<p>The PC implements the following roles in Python:</p>
<blockquote>
<div><ul class="simple">
<li><p>UNPI coordinator</p></li>
<li><p>COM port interface</p></li>
<li><p>Implementation of RTLS UNPI subsystem/command set</p></li>
</ul>
</div></blockquote>
<p>The PC implements the following roles in RTLS UI GUI/JavaScript:</p>
<blockquote>
<div><ul class="simple">
<li><p>Parsing JSON objects to extract IQ data</p></li>
<li><p>Enumerate devices</p></li>
<li><p>Distribute connection parameters to passives</p></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="role-combinations">
<h3>Role Combinations<a class="headerlink" href="#role-combinations" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In all of the tables following (BLE, AoA) features listed as optional are
<strong>not implemented</strong> by the sample applications included in the SDK, but are
valid and possible configurations that can be implemented by the user.</p>
<p>For example: <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> could be a multi-role device or <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code> could
operate as AoA coordinator.</p>
</div>
<div class="section" id="ble-stack">
<h4>BLE-Stack<a class="headerlink" href="#ble-stack" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a> allows for devices to operate in various roles as well as
combinations of roles. The table below shows the required and optional features
for each example.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 14%" />
<col style="width: 19%" />
<col style="width: 21%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Example Name</p></th>
<th class="head"><p>Central</p></th>
<th class="head"><p>Peripheral</p></th>
<th class="head"><p>Broadcaster</p></th>
<th class="head"><p>Observer</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>RTLS Coordinator</p></td>
<td><p>R**</p></td>
<td><p>R**</p></td>
<td><p>O</p></td>
<td><p>R</p></td>
</tr>
<tr class="row-odd"><td><p>RTLS Responder</p></td>
<td><p>R**</p></td>
<td><p>R**</p></td>
<td><p>R</p></td>
<td><p>O</p></td>
</tr>
<tr class="row-even"><td><p>RTLS Passive</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>O</p></td>
<td><p>R*</p></td>
</tr>
</tbody>
</table>
<p>Legend:</p>
<blockquote>
<div><ul class="simple">
<li><p>R: Required</p></li>
<li><p>O: Optional</p></li>
<li><p>No: Not supported</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The R* above denotes that while the connection monitor is capable of scanning
for beacons, it is also required that the connection monitor follow a connection.
The monitoring role is not officially defined by the Bluetooth Spec, but it is
a critical functionality in the <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code>.</p>
<p>The R** above denote that coordinator and responder can be either central or
peripheral as long as coordinator and responder can form a connection. TI’s
out of the box coordinator has central role and responder has peripheral role.</p>
</div>
</div>
<div class="section" id="aoa">
<h4>AoA<a class="headerlink" href="#aoa" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a> defines multiple roles for both connected and connection-less AoA.
The following configurations are supported by the examples in the <a class="reference external" href="http://www.ti.com/tool/simplelink-cc13xx-cc26xx-sdk">SimpleLink CC13xx/CC26xx SDK</a>.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 38%" />
<col style="width: 20%" />
<col style="width: 42%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Example Name</p></th>
<th class="head"><p>Send CTE</p></th>
<th class="head"><p>Perform IQ Sampling</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>RTLS Coordinator</p></td>
<td><p>No</p></td>
<td><p>R</p></td>
</tr>
<tr class="row-odd"><td><p>RTLS Responder</p></td>
<td><p>R</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p>RTLS Passive</p></td>
<td><p>N/A</p></td>
<td><p>O</p></td>
</tr>
</tbody>
</table>
<p>Legend:</p>
<blockquote>
<div><ul class="simple">
<li><p>R: Required</p></li>
<li><p>O: Optional</p></li>
<li><p>No: Not supported</p></li>
<li><p>N/A: Not applicable</p></li>
</ul>
</div></blockquote>
<p>For connection AoA, an AoA Coordinator / Passive is capable of connecting to / monitoring
up to and including eight AoA responders simultaneously.</p>
<p>For connectionless AoA, an AoA Coordinator is capable to synchronize with up to 40 responders.
When the number of responder synchronized with the coordinator is big, some of the periodic
advertisements may not be received. In addition, the number of buffers allocated to
CTE sampling has to be big enough (see <code class="docutils literal notranslate"><span class="pre">MAX_NUM_CTE_BUFS</span></code>)</p>
</div>
</div>
<div class="section" id="rtls-driver">
<h3>RTLS Driver<a class="headerlink" href="#rtls-driver" title="Permalink to this headline">¶</a></h3>
<p>The purpose of RTLS Driver is to handle the Direct Call implementation of the
RTLS module.</p>
<p>For more detail please take a look at <a class="reference internal" href="#sec-aoa-driver"><span class="std std-ref">AoA Driver</span></a> section.</p>
</div>
<div class="section" id="physical-considerations">
<h3>Physical Considerations<a class="headerlink" href="#physical-considerations" title="Permalink to this headline">¶</a></h3>
<p>Before evaluating the RTLS solution, it is important to consider the
environment. All radio communication protocols can be susceptible to
<a class="reference internal" href="reference-cc13xx_cc26xx.html#term-Multi-path-fading"><span class="xref std std-term">multi-path fading</span></a>, and RTLS based systems are
not exempt. It is important to control the environment when evaluating or at
least be aware of the potential effects of multi-path on the results.</p>
<p>It is recommended to evaluate the RTLS solution in an area that optimizes
RF conditions. This includes:</p>
<blockquote>
<div><ul class="simple">
<li><p>An open space with no large metal or concrete obstructions (pillars, poles, etc.)</p></li>
<li><p>Relatively few interference sources (i.e. Wi-Fi access points, etc.)</p></li>
<li><p>Raised platforms for the nodes made out of cardboard ~1 m off the ground.</p></li>
</ul>
</div></blockquote>
<p>A desk environment generally has sub-optimal RF conditions and should be avoided.</p>
<p>See the image below for a recommended layout of the nodes during evaluation,
this is a 2D image where all devices are laying on a flat surface “pointing”
as shown in the picture. In this case each node should be placed on a box
so that it does not sit directly on the ground.</p>
<div class="figure align-center">
<img alt="../_images/suggested_layout.png" src="../_images/suggested_layout.png" />
</div>
<p>For angle of arrival application, we have created
<a class="reference external" href="https://www.ti.com/lit/pdf/tida029">Bluetooth Angle of Arrival Antenna Design</a>
to further explain what users should look for when making their own
<a class="reference internal" href="reference-cc13xx_cc26xx.html#term-AoA"><span class="xref std std-term">AoA</span></a> board.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The examples provided within the <a class="reference external" href="http://www.ti.com/tool/simplelink-cc13xx-cc26xx-sdk">SimpleLink CC13xx/CC26xx SDK</a> are not tied to a specific antenna
board design. They can be configured through Sysconfig to work with the
antenna board designed by the user (see <a class="reference internal" href="#sec-aoa-gpio-config"><span class="std std-ref">GPIO configuration</span></a>).</p>
</div>
</div>
<div class="section" id="test-mode">
<h3>Test mode<a class="headerlink" href="#test-mode" title="Permalink to this headline">¶</a></h3>
<p>Test mode is used for Bluetooth certification.
RTLS test mode can be enabled in the <cite>host_test</cite> example by adding the
pre-defined symbols <cite>USE_RTLS</cite>, <cite>RTLS_CTE</cite>, and <cite>RTLS_CTE_TEST</cite>.
For further description of the above preprocessor defines, please see <a class="reference internal" href="../ble-stack-5.x/stack-configuration-cc13xx_cc26xx.html#stackconfigurablefeatures"><span class="std std-numref">Table 22.</span></a></p>
</div>
</div>
<div class="section" id="rssi-based-localization">
<span id="sec-rssi-localization"></span><h2>RSSI Based Localization<a class="headerlink" href="#rssi-based-localization" title="Permalink to this headline">¶</a></h2>
<p>RSSI details the Received Signal Strength Indication of an incoming
signal and is the most commonly used method of trilateration localization in
Bluetooth. TI Bluetooth low energy stack enables developers to receive the
RSSI of an incoming Bluetooth packet with can be used to enable RTLS algorithms.</p>
<p>RSSI localization is based on the <a class="reference external" href="http://www.antenna-theory.com/basics/friis.php">Frii’s Transmission Equation</a>.
The core concept is that received signal strength is proportional to the
distance of the transmitting node. The graphic below describes how RSSI
can be used to estimate distance.</p>
<div class="figure align-default" id="id4">
<img alt="../_images/friis_equation_illustrated.png" src="../_images/friis_equation_illustrated.png" />
<p class="caption"><span class="caption-number">Figure 133. </span><span class="caption-text"><strong>Frii’s Equation</strong> Relationship between received power and distance.</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<p>While RSSI based localization is the most commonly used method in today’s RTLS
systems, it also faces challenges that need to be overcome:</p>
<ul class="simple">
<li><p>Accuracy can be influenced by the presence of reflections and obstructions</p></li>
<li><p>No Relay Attack protection</p></li>
</ul>
<p>Some of these challenges with RSSI can be overcome through smart system design.
TI’s RTLS Toolbox enables developers to monitor the connection between a coordinator
and responder and get independent RSSI measurements from the same packet via the
Connection Monitor. This approach gives more data and reference points that can
be used to help improve the resolution of an RTLS application.</p>
<p>For future RTLS applications, it is recommended to combine RSSI with the other
localization techniques such as AoA to help improve the accuracy and
security.</p>
<div class="section" id="reading-rssi">
<h3>Reading RSSI<a class="headerlink" href="#reading-rssi" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="u-stack-index-cc13xx_cc26xx.html#sec-index-micro-ble-stack"><span class="std std-ref">Micro BLE Stack</span></a> (foundation of the <a class="reference internal" href="../u-stack/uStack-application.html#sec-cm-app"><span class="std std-ref">Connection Monitor (CM) Application</span></a>)
and the full BLE5-Stack</p>
<p>provide APIs to read RSSI information of the received packet. The following
sections will describe how to extract RSSI information from the received
packet.</p>
</div>
<div class="section" id="connection-monitor">
<h3>Connection Monitor<a class="headerlink" href="#connection-monitor" title="Permalink to this headline">¶</a></h3>
<p>The connection monitor will keep an array of connection information
for each connection it is tracking. This includes coordinator and responder RSSI
from the last scan. These fields can be found in the <code class="docutils literal notranslate"><span class="pre">ubCM_ConnInfo_t</span></code>
structure. The fields are <code class="docutils literal notranslate"><span class="pre">rssiCentral</span></code> and <code class="docutils literal notranslate"><span class="pre">rssiPeripheral</span></code> respectively.</p>
<p>RSSI information is valid after the monitor complete callback is invoked
(when the monitoring scan is complete for a connection event).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code> sample application shows an example of extracting
responder RSSI in <code class="docutils literal notranslate"><span class="pre">RTLSPassive_monitorCompleteEvt</span></code>.</p>
<div class="section" id="keyless-entry-with-ti-connection-monitor">
<h4>Keyless entry with TI connection monitor<a class="headerlink" href="#keyless-entry-with-ti-connection-monitor" title="Permalink to this headline">¶</a></h4>
<p>This <a class="reference external" href="https://training.ti.com/car-access-ti-connection-monitor">video</a>
explains the concept of using TI Connection Monitor to monitor Bluetooth Low Energy
communications to estimate the distance between the connection monitor and
Bluetooth LE enabled devices. This can be used in applications such as car access
or remote keyless entry.</p>
</div>
</div>
<div class="section" id="ble-5-stack">
<h3>BLE(5)-Stack<a class="headerlink" href="#ble-5-stack" title="Permalink to this headline">¶</a></h3>
<p>When using the BLE5-Stack, the <code class="docutils literal notranslate"><span class="pre">Gap_RegisterConnEventCb</span></code> (<a class="reference internal" href="../ble-stack-5.x/gap-cc13xx_cc26xx.html#gap"><span class="std std-ref">Generic Access Profile (GAP)</span></a>) will provide
RSSI from the last connection event. It can be used in the central or peripheral
configuration. The <a class="reference internal" href="../ble-stack-5.x/gap-cc13xx_cc26xx.html#connection-event-callback"><span class="std std-ref">Connection Event Callback</span></a> is already the synchronization
method used by the <code class="docutils literal notranslate"><span class="pre">RTLSCtrl</span></code> module for reporting data to the PC/Node
Manager.</p>
<p>In the case of communication that consists of multiple packets, only the RSSI of the
last received packet is reported. There is no averaging over channels. In general, the
received signal strength will vary across channels due to varying channel conditions and
antenna gains.  This has the following consequences in regards to BLE:</p>
<ul class="simple">
<li><p>Advertising: The RSSI will only be reported on the last advertisement channel that data
is received on.</p></li>
<li><p>Connection Events with multiple data packets: These occur on the same channel but the
RSSI will still only be reported for the last data packet that was received.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The algorithm that calculates RSSI is the same algorithm for all BLE channels.</p>
</div>
<div class="section" id="calculation-detail">
<h4>Calculation Detail<a class="headerlink" href="#calculation-detail" title="Permalink to this headline">¶</a></h4>
<p>The RSSI value is a measurement of the actual power level delivered to the input of the
reference design RF matching and balun. A valid range for RSSI signals is approximately
-90dbm to -30dBm. Note that it is not easy to directly correlate RSSI to distance as it is
highly dependent on the antenna design and polarization of both the transmitter and the
receiver antenna.</p>
<p>The RSSI can have negative tolerance which means that if you are receiving on the
sensitivity limit, reported RSSI can potentially be lower than this.
The sensitivity can be found in the device datasheet and is in accordance with Bluetooth
requirements.</p>
<p>The RSSI performance will be the same between both single ended and differential
configurations and the expected accuracy is +/-4 dBm as stated in the datasheet.</p>
</div>
<div class="section" id="advantages-of-a-connection-based-rssi-system">
<h4>Advantages of a connection based RSSI system<a class="headerlink" href="#advantages-of-a-connection-based-rssi-system" title="Permalink to this headline">¶</a></h4>
<p>A connection based RSSI system relies on a Bluetooth Low Energy connection.
The RSSI of the signal received during the connection event is measured.
The advantages of this technique against connectionless based RSSI system are:</p>
<ol class="arabic simple">
<li><p>The Bluetooth Low Energy connection ensures the identity of the target device.</p></li>
<li><p>The number of possible RF channels used is increased from 3 to 37. This increases the
system’s robustness to interferences.</p></li>
<li><p>The energy consumption of the passive devices is smaller as they are not continuously
scanning.</p></li>
</ol>
</div>
<div class="section" id="advantages-of-a-connectionless-based-rssi-system">
<h4>Advantages of a connectionless based RSSI system<a class="headerlink" href="#advantages-of-a-connectionless-based-rssi-system" title="Permalink to this headline">¶</a></h4>
<p>A connectionless based RSSI system locates beacons without forming a Bluetooth Low
Energy connection. The RSSI of the advertisements is measured.
The advantages of this technique against connection based RSSI system are:</p>
<ol class="arabic simple">
<li><p>The complexity of the system is reduced as there is no need for sharing the
connection parameters between the passive-nodes.</p></li>
<li><p>The number of targets that can be tracked simultaneously is slightly bigger
(fewer resources are required to keep track of a non-connected device than a
connected device).</p></li>
</ol>
</div>
</div>
</div>
<div class="section" id="angle-of-arrival">
<span id="sec-aoa"></span><h2>Angle of Arrival<a class="headerlink" href="#angle-of-arrival" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>The CC13xx or CC26xx and the <a class="reference external" href="http://www.ti.com/tool/simplelink-cc13xx-cc26xx-sdk">SimpleLink CC13xx/CC26xx SDK</a> support <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a> compliant
Angle-of-Arrival (AoA) features. The BLE5-Stack allows the user’s application
to collect I/Q data and use them to calculate angle.</p>
<p>End product implementation incorporating AOA locator
technology requires advanced knowledge and further integration by the
customer that would not normally be required in a product using Bluetooth LE
for communication purposes. Some challenges the customer may be required to
address with AoA in their product include, but are not limited to, the following:</p>
<blockquote>
<div><ul class="simple">
<li><p>Embedded or system-level algorithms to achieve desired localization
performance/angular accuracy while mitigating the presence of undesired
signals (e.g. multi-path reflections) in various operating environments</p></li>
<li><p>Antenna design to match the end product’s industrial design constraints
and/or performance expectations</p></li>
</ul>
</div></blockquote>
<p>The <a class="reference external" href="http://www.ti.com/tool/simplelink-cc13xx-cc26xx-sdk">SimpleLink CC13xx/CC26xx SDK</a> provides the rtls_agent and rtls examples helping to control the IQ data
sampling process. The BLE5-Stack showcases IQ sampling for both connection and
connectionless modes, and also offers the possibility to tune IQ data
sampling parameters - such as the number of antennas, the
switching pattern, the sampling frequency, and the sampling slot.</p>
<p>Implementations leveraging AoA direction finding targets (CTE TX only)
do not require such advanced knowledge and can directly leverage the
<code class="docutils literal notranslate"><span class="pre">rtls_responder</span></code> example provided in the SDK.</p>
</div>
</div></blockquote>
<p>Angle-of-Arrival (AoA) is a technique for finding the direction that an incoming
Bluetooth packet is coming from, creating a basis for triangulation.</p>
<p>An array of antennas with well-defined properties is used, and the receiver will
switch quickly between the individual antennas while measuring the phase shift
resulting from the small differences in path length to the different antenna.</p>
<p>These path length differences will depend on the direction of the incoming RF
waves relative to the antennas in the array. In order to facilitate the phase
measurement, the packet must contain a section of constant tone
(CT) where there are no phase shifts caused by modulation.</p>
<div class="section" id="packet-format">
<h3>Packet Format<a class="headerlink" href="#packet-format" title="Permalink to this headline">¶</a></h3>
<p>In order to get a good estimate of ϕ (phase), all other intentional phase shifts
in the signal should be removed.</p>
<p><a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a> introduces AoA/AoD which are
covered under <code class="docutils literal notranslate"><span class="pre">Direction</span> <span class="pre">Finding</span> <span class="pre">Using</span> <span class="pre">Bluetooth</span> <span class="pre">Low</span> <span class="pre">Energy</span> <span class="pre">Device</span></code> section
and it also specifies the following
states can support sending direction finding packets:</p>
<ol class="arabic simple">
<li><p>Periodic advertising; also called <code class="docutils literal notranslate"><span class="pre">Connectionless</span> <span class="pre">CTE</span></code></p></li>
<li><p>Connection; also called <code class="docutils literal notranslate"><span class="pre">Connection</span> <span class="pre">CTE</span></code></p></li>
</ol>
<p>The theory behind AoA/AoD and Connectionless/Connection CTE(Constant Tone Extension)
is the same, therefore, we will only focus on Connection CTE AoA. Both Connection CTE
and Connectionless CTE are provided in BLE5-Stack.</p>
<p>First let’s take a look at the payload.
By adding a section of consecutive 1’s at the end of connection packet, effectively
transmitting a single tone at the carrier frequency + 250 kHz.</p>
<blockquote>
<div><div class="figure align-center">
<img alt="../_images/connection_aoa_packet_format.png" src="../_images/connection_aoa_packet_format.png" />
</div>
</div></blockquote>
<p>In the header, the CP bit (<code class="docutils literal notranslate"><span class="pre">CTE</span> <span class="pre">Present</span></code>) determines whether header
contains <code class="docutils literal notranslate"><span class="pre">CTEInfo</span></code> or not.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">CTEType</span></code> field of <code class="docutils literal notranslate"><span class="pre">CTEInfo</span></code> further specifies which type of direction finding
packet this is and the <code class="docutils literal notranslate"><span class="pre">CTETime</span></code> field specifies the duration of the CTE.</p>
<blockquote>
<div><span id="ctetype-var"></span><table class="docutils align-default" id="id5">
<caption><span class="caption-number">Table 25. </span><span class="caption-text">CTEType value</span><a class="headerlink" href="#id5" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>AoA CTE packet.</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>AoD CTE with 1 µs slots.</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>AoD CTE with 2 µs slots.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The value of <code class="docutils literal notranslate"><span class="pre">CTETime</span></code> should be within 2~20 and it’s interpreted as
in 8us unit. That means when <code class="docutils literal notranslate"><span class="pre">CTETime</span></code> is set to 20, there will be
CTE at the end of connection packet which lasts 8*20 = 160(us).</p>
<p>This gives the receiver time to synchronize the demodulator first, and then
store I and Q samples from the single tone 250 kHz section at the end into a
buffer and the buffer can then be post-processed by an AoA application</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<blockquote>
<div><p>The I/Q Data Sample is the coordinates of your signal as seen down the time
axis. In fact, I/Q data is merely a translation of amplitude and phase data
from a polar coordinate system to a Cartesian (X,Y) coordinate system and
using trigonometry, you can convert the polar coordinate sine wave
information into Cartesian I/Q sine wave data.</p>
</div></blockquote>
<div class="figure align-center">
<img alt="../_images/iq_phasor_diagram.png" src="../_images/iq_phasor_diagram.png" />
</div>
</div>
</div>
<div class="section" id="integration">
<span id="sec-aoa-integration"></span><h3>Integration<a class="headerlink" href="#integration" title="Permalink to this headline">¶</a></h3>
<p>The I and Q samples from the
transmitted carrier frequency + 250 kHz tone can be captured, pre-processed, and
buffered by the RF Core without any load on the main MCU.</p>
<p>Due to the pre-processing, the application can determine the phase shift without
having to remove DC offset or IF first, significantly simplifying the estimation
process and leaving the application MCU free to do more on top.</p>
<blockquote>
<div><div class="figure align-center">
<img alt="../_images/processing_phase.png" src="../_images/processing_phase.png" />
</div>
</div></blockquote>
<p>For <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code>, the I/Q sampling rate is currently not configurable and
it is 4 MHz. Each I/Q pair occupies 32 bits space in radio RAM and the
radio RAM can store up to 512 samples (i.e. 2048 bytes - 2 kB).
This limitation is only due to the micro-stack which limits the amount
of data read in the Radio RAM. The radio RAM length is 4 kB.</p>
<p>With sampling rate 4MHz, there will be 16 I/Q pairs every 4us, which
equals to 16 * 4 (one I/Q pair takes up 4 bytes space) = 64 bytes per 4us.</p>
<p>That means even if the CTE is 160us long with 4MHz sampling rate,
the radio RAM for <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code> can only store I/Q data for 128us duration.
There is currently no workaround for it unless we shorten the CTE
length. This is not an issue for rtls_coordinator.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code>, I and Q samples only have 13 bits resolution even though
they occupy 16 bits space in RF Core RAM.
Since they only have 13 bits resolution, the maximum and
minimum value you will observe as signed integers are [4095, -4096].</p>
</div>
<p>For rtls_coordinator, the I/Q <a class="reference internal" href="#samplerate-table"><span class="std std-ref">sampleRate Setting</span></a> is configurable and it’s
from 1MHz up to 4MHz. Each I/Q pair occupies 32 bits space in radio RAM and
the radio RAM can store up to 624 samples (2496 bytes - around 2.5kB).
When the sampling frequency is maximum (4 MHz), exactly 624 samples are stored
during each CTE. (The CTE lasts 160 us, minus 4 us of guard period.
When sampling frequency is 4 MHz, in 156 us, 156*4 = 624 samples are stored.
More details are provided in <a class="reference internal" href="#sec-valid-iq-samples"><span class="std std-ref">Valid I/Q Samples For Angle Calculation</span></a>.)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For rtls_coordinator, I and Q samples resolution is configurable, please
see <a class="reference internal" href="#samplesize-table"><span class="std std-ref">sampleSize Setting</span></a>.
You can either choose 16 bits which only have 13 bits resolution or
8 bit resolution which is <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a> standard.
It does not matter which resolution is chosen, each I/Q pair
will always take 32 bits space in radio RAM.</p>
</div>
<p>The application layer passes in the antenna toggling table into RF Core,
RF Core then does the antenna switching while collecting I/Q samples.</p>
<p>In the responder device, the RF Core ensures that the CTE is inserted at the
end of the connection event packet without being distorted by the whitening filter.</p>
<p>In the passive and coordinator devices, the RF Core analyzes the packet and starts capturing samples at the
right time while synchronizing antenna switching. The samples are left in the
RF Core RAM for analysis by the main MCU</p>
</div>
<div class="section" id="aoa-driver">
<span id="sec-aoa-driver"></span><h3>AoA Driver<a class="headerlink" href="#aoa-driver" title="Permalink to this headline">¶</a></h3>
<p>For <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code>, an example that uses <a class="reference internal" href="u-stack-index-cc13xx_cc26xx.html#sec-index-micro-ble-stack"><span class="std std-ref">Micro BLE Stack</span></a>,
the AoA driver is responsible for pin initialization, AoA enabling and IQ data
extraction.</p>
<p>AoA functionality in rtls_coordinator is implemented as <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a> compliant, therefore,
the initialization, AoA enabling and data extraction are moved to host module.
However, users can still use RTLS Control Module to setup the wanted parameters.</p>
<div class="section" id="configurations-supported">
<h4>Configurations Supported<a class="headerlink" href="#configurations-supported" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Sampling frequency supported: 1 Mhz (<a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>), 2 Mhz, 3 Mhz or 4 Mhz</p></li>
<li><p>Sampling slot length supported: 1 us* or 2 us (both are authorized by
<a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>). <em>Note: Per BLE spec, the sampling slot and the switching
slots must have the same duration</em>.</p></li>
<li><p>Sample size supported: 8bit (<a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>) or 16bit</p></li>
</ul>
<p>* <em>Sampling slot of 1us is supported by the AoA driver but some limitations
may exist in the hardware. The antennas switch and settle time should be
considered when selecting the sampling slot length.</em></p>
</div>
<div class="section" id="data-collection-flow">
<h4>Data Collection Flow<a class="headerlink" href="#data-collection-flow" title="Permalink to this headline">¶</a></h4>
<p>When RF Core detects AoA packets, it will start sampling the I/Q on the tone
while toggling the antenna according to a user defined period.</p>
<p>For rtls_passive, IQ samples will be extracted after <code class="docutils literal notranslate"><span class="pre">RTLSPassive_monitorCompleteEvt()</span></code>
has triggered the next sync event.
During sync event processing <code class="docutils literal notranslate"><span class="pre">RTLSCtrl_postProcessAoa</span></code> will enable the radio RAM,
and read out the IQ samples using <code class="docutils literal notranslate"><span class="pre">AOA_postProcess()</span></code></p>
<p>For rtls_coordinator, IQ samples will be sent to application from RTLS Service host module
with event type <code class="docutils literal notranslate"><span class="pre">RTLSSRV_CONNECTION_CTE_IQ_REPORT_EVT</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For rtls_coordinator, the BLE5-Stack will filter out
the I/Q data from switching period if bit[0] in <code class="docutils literal notranslate"><span class="pre">sampleCtrl</span></code> is set to 0. To obtain
the full set of I/Q data, you will need to set bit[0] in <code class="docutils literal notranslate"><span class="pre">sampleCtrl</span></code> to 1.
Please see <a class="reference internal" href="#samplectrl-iq-table"><span class="std std-ref">sampleCtrl I/Q data Filter Setting</span></a> for the overview.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In <a class="reference external" href="http://www.ti.com/tool/simplelink-cc13xx-cc26xx-sdk">SimpleLink CC13xx/CC26xx SDK</a> and later, embedded angle calculation is not available. In
accordance with <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>, only IQ data are repported by the BLE5-Stack.
In other words, the only <code class="docutils literal notranslate"><span class="pre">aoaResultMode</span></code> is <code class="docutils literal notranslate"><span class="pre">AOA_MODE_RAW</span></code>.
Please refer to SDK 5.10 for an example of embedded angle calculation
implementation.</p>
</div>
</div>
<div class="section" id="antenna-switching">
<h4>Antenna Switching<a class="headerlink" href="#antenna-switching" title="Permalink to this headline">¶</a></h4>
<div class="section" id="switching-pattern">
<h5>Switching pattern<a class="headerlink" href="#switching-pattern" title="Permalink to this headline">¶</a></h5>
<p>Antennas toggle pattern is set in the python as part of <code class="docutils literal notranslate"><span class="pre">RTLS_CMD_AOA_SET_PARAMS</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-number">Listing 185. </span><span class="caption-text">AoaSetParamsReq</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>  <span class="k">class</span> <span class="nc">AoaSetParamsReq</span><span class="p">(</span><span class="n">NpiRequest</span><span class="p">,</span> <span class="n">SyncReq</span><span class="p">,</span> <span class="n">FromAp</span><span class="p">):</span>
<span class="linenos"> 2</span>      <span class="n">command</span> <span class="o">=</span> <span class="n">Commands</span><span class="o">.</span><span class="n">RTLS_CMD_AOA_SET_PARAMS</span>
<span class="linenos"> 3</span>      <span class="n">struct</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">(</span>
<span class="linenos"> 4</span>          <span class="s2">&quot;aoaRole&quot;</span> <span class="o">/</span> <span class="n">Enum</span><span class="p">(</span><span class="n">Int8ul</span><span class="p">,</span> <span class="n">AoaRole</span><span class="p">),</span>  <span class="c1"># AOA_COORDINATOR, AOA_RESPONDER, AOA_PASSIVE</span>
<span class="linenos"> 5</span>          <span class="s2">&quot;aoaResultMode&quot;</span> <span class="o">/</span> <span class="n">Enum</span><span class="p">(</span><span class="n">Int8ul</span><span class="p">,</span> <span class="n">AoaResultMode</span><span class="p">),</span>  <span class="c1"># AOA_MODE_ANGLE, AOA_MODE_PAIR_ANGLES, AOA_MODE_RAW</span>
<span class="linenos"> 6</span>          <span class="s2">&quot;connHandle&quot;</span> <span class="o">/</span> <span class="n">Int16ul</span><span class="p">,</span>
<span class="linenos"> 7</span>          <span class="s2">&quot;slotDurations&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">,</span>  <span class="c1"># 1us/2us sampling slots</span>
<span class="linenos"> 8</span>          <span class="s2">&quot;sampleRate&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">,</span>  <span class="c1"># 1Mhz (BT5.1 spec), 2Mhz, 3Mhz or 4Mhz - this enables oversampling</span>
<span class="linenos"> 9</span>          <span class="s2">&quot;sampleSize&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">,</span>  <span class="c1"># 8 bit sample (as defined by BT5.1 spec), 16 bit sample (higher accuracy)</span>
<span class="linenos">10</span>          <span class="s2">&quot;sampleCtrl&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">,</span>  <span class="c1"># sample control flags 0x00-default filtering, 0x01-RAW_RF no filtering</span>
<span class="hll"><span class="linenos">11</span>          <span class="s2">&quot;samplingEnable&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">,</span>  <span class="c1"># 0 = mask CTE even if enabled, 1 = don&#39;t mask CTE, even if disabled (support Unrequested CTE)</span>
</span><span class="hll"><span class="linenos">12</span>          <span class="s2">&quot;numAnt&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">,</span>  <span class="c1"># Number of antennas in antenna array</span>
</span><span class="linenos">13</span>          <span class="s2">&quot;antArray&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">[</span><span class="n">this</span><span class="o">.</span><span class="n">numAnt</span><span class="p">],</span>  <span class="c1"># GPIO&#39;s of antennas</span>
<span class="linenos">14</span>      <span class="p">)</span>
</pre></div>
</div>
</div>
<span id="antpatten"></span><table class="docutils align-default" id="id7">
<caption><span class="caption-number">Table 26. </span><span class="caption-text">Antenna Pattern</span><a class="headerlink" href="#id7" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 18%" />
<col style="width: 82%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Definition</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>numAnt</p></td>
<td><p>Number of IOs RF Core should toggle during I/Q sampling</p></td>
</tr>
<tr class="row-odd"><td><p>antArray</p></td>
<td><p>The IOs should be toggled during I/Q sampling.</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For rtls_passive, the slotDuration, sampleRate, sampleSize, samplingEnable, numAnt and antArray are
hardcoded in the embedded software. The only configurable parameter is the aoaResultMode.</p>
</div>
<p>Following is an example provided in our rtls_agent toolbox.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-number">Listing 186. </span><span class="caption-text">IO control pattern setup example</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>      <span class="n">use_connection_aoa</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 2</span>      <span class="n">slot_duration</span> <span class="o">=</span> <span class="mi">2</span>
<span class="linenos"> 3</span>      <span class="n">sample_rate</span> <span class="o">=</span> <span class="mi">4</span>
<span class="linenos"> 4</span>      <span class="n">sample_size</span> <span class="o">=</span> <span class="mi">2</span>
<span class="linenos"> 5</span>      <span class="n">enable_filter</span> <span class="o">=</span> <span class="kc">False</span>
<span class="hll"><span class="linenos"> 6</span>      <span class="n">ant_pattern</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span class="linenos"> 7</span>
<span class="linenos"> 8</span>      <span class="k">if</span> <span class="n">use_connection_aoa</span><span class="p">:</span>
<span class="linenos"> 9</span>          <span class="c1"># for connection-AoA</span>
<span class="linenos">10</span>          <span class="n">aoa_params</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">11</span>              <span class="s2">&quot;aoa_run_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;AOA_MODE_RAW&quot;</span><span class="p">,</span>
<span class="linenos">12</span>              <span class="s2">&quot;aoa_cc26x2&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos">13</span>                  <span class="s2">&quot;aoa_slot_durations&quot;</span><span class="p">:</span> <span class="n">slot_duration</span><span class="p">,</span>
<span class="linenos">14</span>                  <span class="s2">&quot;aoa_sample_rate&quot;</span><span class="p">:</span> <span class="n">sample_rate</span><span class="p">,</span>
<span class="linenos">15</span>                  <span class="s2">&quot;aoa_sample_size&quot;</span><span class="p">:</span><span class="n">sample_size</span><span class="p">,</span>
<span class="linenos">16</span>                  <span class="s2">&quot;aoa_sampling_control&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;0x10&#39;</span> <span class="k">if</span> <span class="n">enable_filter</span> <span class="k">else</span> <span class="s1">&#39;0x11&#39;</span><span class="p">,</span><span class="mi">16</span><span class="p">),</span>
<span class="linenos">17</span>                  <span class="s2">&quot;aoa_sampling_enable&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="hll"><span class="linenos">18</span>                  <span class="s2">&quot;aoa_pattern_len&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ant_pattern</span><span class="p">),</span>
</span><span class="hll"><span class="linenos">19</span>                  <span class="s2">&quot;aoa_ant_pattern&quot;</span><span class="p">:</span> <span class="n">ant_pattern</span>
</span><span class="linenos">20</span>              <span class="p">}</span>
<span class="linenos">21</span>
<span class="linenos">22</span>      <span class="k">else</span> <span class="p">:</span>
<span class="linenos">23</span>          <span class="c1"># for connectionless-AoA</span>
<span class="linenos">24</span>          <span class="n">aoa_params</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">25</span>              <span class="s2">&quot;cl_aoa_role&quot;</span><span class="p">:</span> <span class="s2">&quot;AOA_COORDINATOR&quot;</span><span class="p">,</span>
<span class="linenos">26</span>              <span class="s2">&quot;cl_aoa_result_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;AOA_MODE_RAW&quot;</span><span class="p">,</span>
<span class="linenos">27</span>              <span class="s2">&quot;cl_aoa_slot_durations&quot;</span><span class="p">:</span> <span class="n">slot_duration</span><span class="p">,</span>
<span class="linenos">28</span>              <span class="s2">&quot;cl_aoa_sample_rate&quot;</span><span class="p">:</span> <span class="n">sample_rate</span><span class="p">,</span>
<span class="linenos">29</span>              <span class="s2">&quot;cl_aoa_sample_size&quot;</span><span class="p">:</span> <span class="n">sample_size</span><span class="p">,</span>
<span class="linenos">30</span>              <span class="s2">&quot;cl_aoa_sampling_control&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;0x10&#39;</span> <span class="k">if</span> <span class="n">enable_filter</span> <span class="k">else</span> <span class="s1">&#39;0x11&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
<span class="linenos">31</span>              <span class="s2">&quot;max_sample_cte&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="hll"><span class="linenos">32</span>              <span class="s2">&quot;cl_aoa_pattern_len&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ant_pattern</span><span class="p">),</span>
</span><span class="hll"><span class="linenos">33</span>              <span class="s2">&quot;cl_aoa_ant_pattern&quot;</span><span class="p">:</span> <span class="n">ant_pattern</span>
</span><span class="linenos">34</span>          <span class="p">}</span>
</pre></div>
</div>
</div>
<p>The example shows that 3 IOs(<code class="docutils literal notranslate"><span class="pre">aoa_pattern_len</span></code>) should be toggled during the I/Q sampling and the order for toggling is
set to 0, 1 and 2 which is mapped to the <code class="docutils literal notranslate"><span class="pre">antennaTbl[]</span></code> array element 0, 1 and 2 in <code class="docutils literal notranslate"><span class="pre">ble_user_config.c</span></code>.
Make sure the switching pattern only refers to array element referenced in <code class="docutils literal notranslate"><span class="pre">antennaTbl[]</span></code>.</p>
</div>
<div class="section" id="gpio-configuration">
<span id="sec-aoa-gpio-config"></span><h5>GPIO configuration<a class="headerlink" href="#gpio-configuration" title="Permalink to this headline">¶</a></h5>
<p>The GPIOs used to control antenna switching are configurable
through Sysconfig. The GPIOs to use depend on the antenna board design.</p>
<p>Below is an example showing how to configure the example
for a 12-antenna board. This is the out of the box example
from the RTLS Coordinator.
For each antenna, the GPIOs to set to select it should be specified.
If no GPIOs need to be set to enable a specific antenna, select “None”.</p>
<div class="figure align-default">
<img alt="../_images/aoa_sysconfig_antenna_board.png" src="../_images/aoa_sysconfig_antenna_board.png" />
</div>
<p>Sysconfig generates the following code in <code class="docutils literal notranslate"><span class="pre">ti_aoa_config.h</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-number">Listing 187. </span><span class="caption-text">Anteannas GPIO configuration</span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">  </span><span class="c1">// Antenna board configurations (example for a 12-antenna board)</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="c1">// Maximum number of antennas</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="cp">#define ANTENNA_TABLE_SIZE 12</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="c1">// BitMask of all the relevant GPIOs which needed for the antennas</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="cp">#define ANTENNA_IO_MASK  BV(27)|BV(28)|BV(29)|BV(30)</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="c1">// Antenna GPIO configuration (should be adapted to the antenna board design)</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="n">antennaIOEntry_t</span><span class="w"> </span><span class="n">antennaTbl</span><span class="p">[</span><span class="n">ANTENNA_TABLE_SIZE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">                                     </span><span class="mi">0</span><span class="p">,</span><span class="w">                        </span><span class="c1">// antenna 0 GPIO configuration (all GPIOs in ANTENNA_IO_MASK are LOW)</span>
<span class="linenos">10</span><span class="w">                                     </span><span class="n">BV</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span><span class="w">                   </span><span class="c1">// antenna 1</span>
<span class="linenos">11</span><span class="w">                                     </span><span class="n">BV</span><span class="p">(</span><span class="mi">29</span><span class="p">),</span><span class="w">                   </span><span class="c1">// antenna 2</span>
<span class="linenos">12</span><span class="w">                                     </span><span class="n">BV</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BV</span><span class="p">(</span><span class="mi">29</span><span class="p">),</span><span class="w">          </span><span class="c1">// antenna 3</span>
<span class="linenos">13</span><span class="w">                                     </span><span class="n">BV</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span><span class="w">                   </span><span class="c1">// antenna 4</span>
<span class="linenos">14</span><span class="w">                                     </span><span class="n">BV</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BV</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span><span class="w">          </span><span class="c1">// antenna 5</span>
<span class="linenos">15</span><span class="w">                                     </span><span class="n">BV</span><span class="p">(</span><span class="mi">27</span><span class="p">),</span><span class="w">                   </span><span class="c1">// antenna 6</span>
<span class="linenos">16</span><span class="w">                                     </span><span class="n">BV</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BV</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span><span class="w">          </span><span class="c1">// antenna 7</span>
<span class="linenos">17</span><span class="w">                                     </span><span class="n">BV</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BV</span><span class="p">(</span><span class="mi">29</span><span class="p">),</span><span class="w">          </span><span class="c1">// antenna 8</span>
<span class="linenos">18</span><span class="w">                                     </span><span class="n">BV</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BV</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BV</span><span class="p">(</span><span class="mi">29</span><span class="p">),</span><span class="w"> </span><span class="c1">// antenna 9</span>
<span class="linenos">19</span><span class="w">                                     </span><span class="n">BV</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BV</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span><span class="w">          </span><span class="c1">// antenna 10</span>
<span class="linenos">20</span><span class="w">                                     </span><span class="n">BV</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BV</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BV</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w">  </span><span class="c1">// antenna 11</span>
<span class="linenos">21</span><span class="w">  </span><span class="p">};</span><span class="w"></span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w">  </span><span class="c1">// Antenna properties passes to the stack</span>
<span class="linenos">24</span><span class="w">  </span><span class="n">cteAntProp_t</span><span class="w">  </span><span class="n">appCTEAntProp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ANTENNA_IO_MASK</span><span class="p">,</span><span class="w"></span>
<span class="linenos">25</span><span class="w">                                 </span><span class="n">ANTENNA_TABLE_SIZE</span><span class="p">,</span><span class="w"></span>
<span class="linenos">26</span><span class="w">                                 </span><span class="n">antennaTbl</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="execution">
<h5>Execution<a class="headerlink" href="#execution" title="Permalink to this headline">¶</a></h5>
<p>Based on the switching sequence provided and the GPIO configuration, the
RF Core will control the GPIOs to perform antenna switching.
The switching sequence is repeated until the end of the CTE. Afterwards,
the IOs will be restored to their original state.</p>
<p>Even though RF Core takes care of the toggling, it does not initialize the pin state.
The application should initialize the pin state by calling either <code class="docutils literal notranslate"><span class="pre">AOA_initAntArray</span></code> for rtls_passive or
calling <code class="docutils literal notranslate"><span class="pre">RTLSSrv_initAntArray</span></code> for rtls_coordinator.
This is taken care when host sends <code class="docutils literal notranslate"><span class="pre">RTLS_CMD_AOA_SET_PARAMS</span></code>.</p>
<p>For users that want to use different IOs and patterns,
please visit SimpleLink Academy –&gt; RTLS Toolbox –&gt; Angle of Arrival –&gt; Task 3.</p>
<p>The RTLS API does not provide a direct way to determine which antenna
has been used to sample a given piece of data.
However, knowing the antenna switch sequence and the number of samples
recorded per slot, it is possible to deduce the antenna used. Please
see details in <a class="reference internal" href="#sec-valid-iq-samples"><span class="std std-ref">Valid I/Q Samples For Angle Calculation</span></a>.</p>
</div>
</div>
<div class="section" id="valid-i-q-samples-for-angle-calculation">
<span id="sec-valid-iq-samples"></span><h4>Valid I/Q Samples For Angle Calculation<a class="headerlink" href="#valid-i-q-samples-for-angle-calculation" title="Permalink to this headline">¶</a></h4>
<p>The BLE spec defines two terms “Switch slot” and “Sample slot”.
The length of the switch slot and sample slot must be equal, and only
two values (1us or 2us) are allowed.</p>
<p>At the beginning of a CTE, the number of elements to discard depends on the
length of the switch and sample slots and of the sampling frequency.</p>
<p>The following figure presents the way the CTE is sampled.
The image is copied from the
BLUETOOTH CORE SPECIFICATION Version 5.1 | Vol 6, Part B | 2.5.1.</p>
<div class="figure align-default" id="id10">
<img alt="../_images/cte_sampling.png" src="../_images/cte_sampling.png" />
<p class="caption"><span class="caption-number">Figure 134. </span><span class="caption-text">Constant tone sampling structure</span><a class="headerlink" href="#id10" title="Permalink to this image">¶</a></p>
<div class="legend">
<blockquote>
<div><ul>
<li><p><strong>When using 1us slots</strong>:</p>
<blockquote>
<div><ul class="simple">
<li><p>the guard period is 4us (no sampling is done during the
guard period / no sample has to be discarded)</p></li>
<li><p>the reference period is 8us. All the samples acquired during
the reference period has to be discarded (e.g. if the
sampling frequency is 4MHz, it means that 32 samples have
to be discarded - 8 samples have to be discarded if sampling
frequency is 1Mhz)</p></li>
<li><p>the first switch slot (and all the others) lasts 1us. The data
sampled during a switch slot has to be discarded (e.g. if the
sampling frequency is 4MHz, it means that 4 samples have
to be discarded during each switch slot - 1 sample per switch
slot has to be discarded if sampling frequency is 1MHz).</p></li>
</ul>
</div></blockquote>
<p>As a result, when sampling frequency is 4MHz, the first sample to
consider is the 37th. When sampling frequency is 1MHz, the first
sample to consider is the 10th.</p>
</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><ul>
<li><p><strong>When using 2us slots</strong>:</p>
<blockquote>
<div><ul>
<li><p>the guard period is still 4us (no sampling is done during the
guard period / no sample has to be discarded)</p></li>
<li><p>the reference period is still 8us. All the samples acquired during
the reference period have to be discarded (e.g. if the
sampling frequency is 4MHz, it means that 32 samples have
to be discarded - 8 samples have to be discarded if sampling
frequency is 1Mhz)</p></li>
<li><p>the first switch slot (and all the others) lasts 2us. The data
sampled during a switch slot has to be discarded (e.g. if the
sampling frequency is 4MHz, it means that 8 samples have
to be discarded during each switch slot - 2 samples per switch
slot have to be discarded if sampling frequency is 1MHz).</p></li>
<li><p>the sampling slots are divided in two</p>
<blockquote>
<div><ul class="simple">
<li><p>one idle slot of 1us (which allows the antenna to settle).
The data sampled during the idle slot has to be discarded
(e.g. if the sampling frequency is 4MHz, it means that
4 samples have to be discarded during each idle slot -
1 sample per idle slot has to be discarded if sampling
frequency is 1MHz).</p></li>
<li><p>one sample slot of 1us (e.g. if the sampling frequency
is 4MHz, 4 samples are recorded per sample slot -
1 sample is recorded per sample slot if the sampling frequency
is 1MHz)</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>As a result, when sampling frequency is 4MHz, the first sample to
consider is the 45th. When sampling frequency is 1MHz, the first
sample to consider is the 12th.</p>
</li>
</ul>
</div></blockquote>
<p>The following figure presents how each sample slot is divided.
This image is copied from the
BLUETOOTH CORE SPECIFICATION Version 5.1 | Vol 6, Part B | 2.5.4</p>
<div class="figure align-default" id="id11">
<img alt="../_images/sample_slot_detail.png" src="../_images/sample_slot_detail.png" />
<p class="caption"><span class="caption-number">Figure 135. </span><span class="caption-text">“Zoom” on a sampling slot</span><a class="headerlink" href="#id11" title="Permalink to this image">¶</a></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It’s important to note that 1us switch slot can only be used if the
antennas are able to switch and settle in less than 1us.
If the antennas are not able to switch and settle in less than 1us
a part of the data sampled during the sampling slot won’t be correct
and will have to be discarded.</p>
</div>
<p>An other good way to determine what I/Q samples to use is to plot
all the I/Q samples.</p>
<p>The picture below shows the I/Q samples which were collected using the <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code>
example together with <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> and <code class="docutils literal notranslate"><span class="pre">rtls_responder</span></code> examples using 4MHz sampling rate
and 2us slot.</p>
<blockquote>
<div><table class="docutils align-default" id="id12">
<caption><span class="caption-number">Table 27. </span><span class="caption-text">Axis description</span><a class="headerlink" href="#id12" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 14%" />
<col style="width: 86%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Axis</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>X top</p></td>
<td><p>Angle between a rtls_responder device and rtls_passive.</p></td>
</tr>
<tr class="row-odd"><td><p>X bottom</p></td>
<td><p>Index number of I/Q data.</p></td>
</tr>
<tr class="row-even"><td><p>Y</p></td>
<td><p>I/Q values.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The first 32(index 0~31) samples are taken in reference period which there is no antenna switching.
Therefore the I/Q plot looks like sinusoid wave.</p>
<p>After that at index 32, you can see when switching happened there comes discontinuity of I/Q samples.</p>
<blockquote>
<div><div class="figure align-center">
<img alt="../_images/IQ-sample-switching.png" src="../_images/IQ-sample-switching.png" />
</div>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It’s easier to see the phase discontinuity when there is indeed phase difference.
Therefore, before collecting I/Q data, make sure the angle between rtls_passive and
rtls_responder is not 0 degree.</p>
</div>
</div>
<div class="section" id="aoa-functions-overview">
<h4>AoA Functions Overview<a class="headerlink" href="#aoa-functions-overview" title="Permalink to this headline">¶</a></h4>
<p>Here is the list of the most important functions for AoA users.</p>
<div class="section" id="python">
<h5>Python<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h5>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">aoa_set_params</span></code>:</p></li>
</ol>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-number">Listing 188. </span><span class="caption-text">AoA Set Parameter</span><a class="headerlink" href="#id13" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">AoaSetParamsReq</span><span class="p">(</span><span class="n">NpiRequest</span><span class="p">,</span> <span class="n">SyncReq</span><span class="p">,</span> <span class="n">FromAp</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="n">command</span> <span class="o">=</span> <span class="n">Commands</span><span class="o">.</span><span class="n">RTLS_CMD_AOA_SET_PARAMS</span>
<span class="linenos"> 3</span>    <span class="n">struct</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">(</span>
<span class="linenos"> 4</span>        <span class="s2">&quot;aoaRole&quot;</span> <span class="o">/</span> <span class="n">Enum</span><span class="p">(</span><span class="n">Int8ul</span><span class="p">,</span> <span class="n">AoaRole</span><span class="p">),</span>  <span class="c1"># AOA_COORDINATOR, AOA_RESPONDER, AOA_PASSIVE</span>
<span class="linenos"> 5</span>        <span class="s2">&quot;aoaResultMode&quot;</span> <span class="o">/</span> <span class="n">Enum</span><span class="p">(</span><span class="n">Int8ul</span><span class="p">,</span> <span class="n">AoaResultMode</span><span class="p">),</span>  <span class="c1"># AOA_MODE_ANGLE, AOA_MODE_PAIR_ANGLES, AOA_MODE_RAW</span>
<span class="linenos"> 6</span>        <span class="s2">&quot;connHandle&quot;</span> <span class="o">/</span> <span class="n">Int16ul</span><span class="p">,</span>
<span class="hll"><span class="linenos"> 7</span>        <span class="s2">&quot;slotDurations&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">,</span>  <span class="c1"># 1us/2us sampling slots</span>
</span><span class="hll"><span class="linenos"> 8</span>        <span class="s2">&quot;sampleRate&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">,</span>  <span class="c1"># 1Mhz (BT5.1 spec), 2Mhz, 3Mhz or 4Mhz - this enables oversampling</span>
</span><span class="hll"><span class="linenos"> 9</span>        <span class="s2">&quot;sampleSize&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">,</span>  <span class="c1"># 8 bit sample (as defined by BT5.1 spec), 16 bit sample (higher accuracy)</span>
</span><span class="hll"><span class="linenos">10</span>        <span class="s2">&quot;sampleCtrl&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">,</span>  <span class="c1"># sample control flags 0x0-default filtering, 0x1-RAW_RF no filtering</span>
</span><span class="linenos">11</span>        <span class="s2">&quot;samplingEnable&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">,</span>
<span class="linenos">12</span>        <span class="c1"># 0 = mask CTE even if enabled, 1 = don&#39;t mask CTE, even if disabled (support Unrequested CTE)</span>
<span class="linenos">13</span>        <span class="s2">&quot;numAnt&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">,</span>  <span class="c1"># Number of antennas in antenna array</span>
<span class="linenos">14</span>        <span class="s2">&quot;antArray&quot;</span> <span class="o">/</span> <span class="n">Int8ul</span><span class="p">[</span><span class="n">this</span><span class="o">.</span><span class="n">numAnt</span><span class="p">],</span>  <span class="c1"># GPIO&#39;s of antennas</span>
<span class="linenos">15</span>    <span class="p">)</span>
</pre></div>
</div>
</div>
<span id="slotdurations-table"></span><table class="docutils align-default" id="id14">
<caption><span class="caption-number">Table 28. </span><span class="caption-text">slotDurations Setting</span><a class="headerlink" href="#id14" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 8%" />
<col style="width: 92%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2</p></td>
<td><p>2us for antenna switching and 2us for I/Q sampling.</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>1us for antenna switching and 1us for I/Q sampling.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<blockquote>
<div><p>For users that choose to have slotDuration = 1 needs to make sure that the RF switches on the custom
board can settle down within 1 us.</p>
</div></blockquote>
<span id="samplerate-table"></span><table class="docutils align-default" id="id15">
<caption><span class="caption-number">Table 29. </span><span class="caption-text">sampleRate Setting</span><a class="headerlink" href="#id15" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 8%" />
<col style="width: 92%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>4</p></td>
<td><p>Process packets with AoA present in the header and sample CTE at 4 MHz.</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>Process packets with AoA present in the header and sample CTE at 3 MHz.</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>Process packets with AoA present in the header and sample CTE at 2 MHz.</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Process packets with AoA present in the header and sample CTE at 1 MHz.</p></td>
</tr>
</tbody>
</table>
<span id="samplesize-table"></span><table class="docutils align-default" id="id16">
<caption><span class="caption-number">Table 30. </span><span class="caption-text">sampleSize Setting</span><a class="headerlink" href="#id16" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 8%" />
<col style="width: 92%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2</p></td>
<td><p>I/Q samples returned with 13 bits resolution.</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>I/Q samples returned with 8 bits resolution.</p></td>
</tr>
</tbody>
</table>
<span id="samplectrl-iq-table"></span><table class="docutils align-default" id="id17">
<caption><span class="caption-number">Table 31. </span><span class="caption-text">sampleCtrl I/Q data Filter Setting</span><a class="headerlink" href="#id17" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 8%" />
<col style="width: 92%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>bit[0]</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>BLE5-Stack returns whole I/Q data to the application.</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>BLE5-Stack filters out the I/Q data from switching period and returns the rest to application.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>rtls_passive only supports the following configuration:
<code class="docutils literal notranslate"><span class="pre">slotDuration</span></code> = 2, <code class="docutils literal notranslate"><span class="pre">sampleRate</span></code> = 4 and <code class="docutils literal notranslate"><span class="pre">sampleSize</span></code> = 2.</p>
</div>
</div>
<div class="section" id="embedded-code-api">
<h5>Embedded code API<a class="headerlink" href="#embedded-code-api" title="Permalink to this headline">¶</a></h5>
<p>The functions covered under this section are all in AOA.c.</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AOA_init</span></code>:
[rtls_passive only] This function takes care of the IO initialization.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AOA_postProcess</span></code>
This function will update the final result report with rssi and channel.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AOA_getRawSamples</span></code>
[rtls_passive only] Returns pointer to raw I/Q samples.</p></li>
</ol>
</div>
</div>
</div>
<div class="section" id="aoa-applications-overview">
<span id="sec-aoa-application-overview"></span><h3>AoA Applications Overview<a class="headerlink" href="#aoa-applications-overview" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The out of the box examples (<code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> and <code class="docutils literal notranslate"><span class="pre">rtls_responder</span></code>)
enable both connection and connectionless AoA. <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code>
only enables connection AoA (connectionless AoA cannot be used
on <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code>).</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Since SDK 5.30, the RTLS Coordinator and RTLS Responder examples are
based on the multi_role example.
This simplifies the process to add broadcaster and peripheral roles support
to the RTLS Coordinator. Similarly, it simplifies the process to add
observer and central roles support to the RTLS Responder.</p>
</div>
<div class="section" id="connection-aoa">
<h4>Connection AoA<a class="headerlink" href="#connection-aoa" title="Permalink to this headline">¶</a></h4>
<div class="section" id="available-tools-for-connection-aoa">
<h5>Available tools for Connection AoA<a class="headerlink" href="#available-tools-for-connection-aoa" title="Permalink to this headline">¶</a></h5>
<p>The Python script <code class="docutils literal notranslate"><span class="pre">rtls_connected.py</span></code> provided in
<code class="docutils literal notranslate"><span class="pre">&lt;SDK&gt;\tools\ble5stack\rtls_agent\examples</span></code> is recommended to get started.</p>
<p>This script requires to attach to the computer one <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> and optionally
one or several <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code> devices. The <code class="docutils literal notranslate"><span class="pre">rtls_responder</span></code> device(s) are not necessarily
attached to the computer.</p>
</div>
<div class="section" id="applications-overview">
<h5>Applications Overview<a class="headerlink" href="#applications-overview" title="Permalink to this headline">¶</a></h5>
<p>In the out of box software, the <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> and <code class="docutils literal notranslate"><span class="pre">rtls_responder</span></code>
will form a Bluetooth LE connection. After
establishing the connection, <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> will send connection information
through UART to PC and then the node manager will pass this piece of
information to <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code> which can then track the connection.</p>
<p>Next, the node manager sets up AoA parameters for <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> and <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code>
and then <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code>  will send a packet over the air to responder
to setup the CTETime.</p>
<p>After that, the <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> will send a start AoA request over the air to
the <code class="docutils literal notranslate"><span class="pre">rtls_responder</span></code> and to <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code> over wire, then <code class="docutils literal notranslate"><span class="pre">rtls_responder</span></code> will
append CTE at the end of every connection packet.</p>
<p><code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code> and <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> can then do I/Q sampling and calculate angles base on the ConnectionCTE packets.</p>
<p>The sequence diagram below illustrates the whole process of how out of box
examples work.</p>
<div class="figure align-center" id="id18">
<p class="plantuml">
<img src="../_images/plantuml-2e8f85b115c8e9ddd61221d1758df9524f2f6704.png" alt="&#64;startuml
participant rtls_passive as passive
participant &quot;Node_Manager \n(Host MCU)&quot; as manager
participant rtls_coordinator as coordinator
participant rtls_responder as responder

manager -&gt; coordinator: RTLS_CMD_IDENTIFY_Req
coordinator -&gt; manager: RTLS_CMD_IDENTIFY_Rsp
manager -&gt; passive: RTLS_CMD_IDENTIFY_Req
passive -&gt; manager: RTLS_CMD_IDENTIFY_Rsp

manager -&gt; coordinator: RTLS_CMD_SCAN_Req

activate coordinator
coordinator -&gt; coordinator: Start scanning \nfor rtls_responder

group rtls_responder not found

    manager -&gt; coordinator: RTLS_CMD_SCAN_STOP
    deactivate coordinator
    manager -&gt; coordinator: RTLS_CMD_SCAN_Req \nrestart scanning

    activate coordinator
    coordinator -&gt; coordinator: Start scanning \nfor rtls_responder
    manager -&gt; coordinator: RTLS_CMD_SCAN_STOP
    deactivate coordinator
    ...
    ... Repeat until device found ...
    ...
end


group rtls_responder found
    coordinator -&gt; manager: RTLS_CMD_SCAN_AsyncReq
    manager -&gt; coordinator: RTLS_CMD_SCAN_STOP
    manager -&gt; coordinator: RTLS_CMD_CONNECT
    coordinator --&gt; responder: Connection request
    == After connection has established ==
    coordinator -&gt; manager: RTLS_CMD_CONN_PARAMS
    manager -&gt; passive: RTLS_CMD_CONN_PARAMS \npass on the connection info \nfor passive to track connection

    group AoA
        manager -&gt; coordinator: RTLS_CMD_AOA_SET_PARAMS
        coordinator --&gt; responder: RTLS_REMOTE_CMD_AOA_SET_PARAMS
        manager -&gt; passive: RTLS_CMD_AOA_SET_PARAMS
        manager -&gt; coordinator: RTLS_CMD_AOA_ENABLE
        coordinator --&gt; responder: Enable sending \npackets with CTE
        manager -&gt; passive: RTLS_CMD_AOA_ENABLE

        activate passive
        passive -&gt; passive: Start following connection \nand waiting for connectionCTE packets
        coordinator--&gt; responder: Empty packet
        responder --&gt; coordinator: ConnectionCTE packet
        coordinator --&gt; coordinator: Received ConnectionCTE packet \nand then calculate angle \nbetween responder and coordinator
        passive -&gt; passive: Received ConnectionCTE packet \nand then calculate angle \nbetween responder and passive
        coordinator -&gt; manager: RTLS_CMD_AOA_RESULT_ANGLE
        passive -&gt; manager: RTLS_CMD_AOA_RESULT_ANGLE

        ...
        ... coordinator and responder stay in connection ...
        ... coordinator captures I/Q samples and calculates angle ...
        ... passive tracks connection, captures I/Q samples and calculates angle ...
        ...
    end
end

&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 136. </span><span class="caption-text">Setting up RTLS AoA network and enable AoA</span><a class="headerlink" href="#id18" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="connectionless-aoa">
<h4>Connectionless AoA<a class="headerlink" href="#connectionless-aoa" title="Permalink to this headline">¶</a></h4>
<p>In order to not flood the advertising channel, connectionless AoA is only
allowed as Auxiliary packets (i.e. on secondary channels - see <a class="reference external" href="https://www.bluetooth.com/specifications/adopted-specifications">Bluetooth Core Specifications Version 5.3</a>
Vol 6, Part B, §2.3 for details on the PDUs allowed to be appended with a CTE).</p>
<p>In our BLE5-Stack, we support connectionless AoA with periodic advertisement
packets. For more information regarding periodic advertisement, please
see <a class="reference internal" href="../ble-stack-5.x/gap-cc13xx_cc26xx.html#gap-periodic-advertising"><span class="std std-ref">Periodic Advertising</span></a>.</p>
<div class="section" id="add-remove-connectionless-aoa-support-in-rtls-coordinator-and-rtls-responder">
<h5>Add / Remove Connectionless AoA support in rtls_coordinator and rtls_responder<a class="headerlink" href="#add-remove-connectionless-aoa-support-in-rtls-coordinator-and-rtls-responder" title="Permalink to this headline">¶</a></h5>
<p>In the <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> project, support for reception and sampling of
connectionless CTEs is enabled by defining the symbols <code class="docutils literal notranslate"><span class="pre">USE_PERIODIC_RTLS</span></code>
and <code class="docutils literal notranslate"><span class="pre">USE_PERIODIC_SCAN</span></code>.
These symbols are defined in the file <code class="docutils literal notranslate"><span class="pre">Tools\Defines\rtls_coordinator_app.opt</span></code>.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">rtls_responder</span></code> project, support of sending of connectionless CTEs is
enabled by defining the symbol <code class="docutils literal notranslate"><span class="pre">USE_PERIODIC_ADV</span></code>. This symbol is defined
in the file <code class="docutils literal notranslate"><span class="pre">Tools\Defines\rtls_responder_app.opt</span></code>.</p>
</div>
<div class="section" id="enable-connectionless-cte-transmission">
<h5>Enable connectionless CTE transmission<a class="headerlink" href="#enable-connectionless-cte-transmission" title="Permalink to this headline">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">rtls_responder</span></code> example project shows how to send periodic
advertisements and append a CTE to them.
First, the periodic advertisement has to be created and enabled
(details are provided in <a class="reference internal" href="../ble-stack-5.x/gap-cc13xx_cc26xx.html#gap-periodic-advertising"><span class="std std-ref">Periodic Advertising</span></a>).
Once the periodic advertisement is enabled (i.e. the event
<code class="docutils literal notranslate"><span class="pre">GAP_ADV_SET_PERIODIC_ADV_ENABLE_EVENT</span></code> is received with status
<code class="docutils literal notranslate"><span class="pre">SUCCESS</span></code>), the CTE can be enabled using the function
<code class="docutils literal notranslate"><span class="pre">RTLSSrv_SetCLCteTransmitParams</span></code>. Using this function, the length
of each CTE and the number of CTEs to send per advertisement interval
can be selected.</p>
</div>
<div class="section" id="enable-connectionless-cte-reception">
<h5>Enable connectionless CTE reception<a class="headerlink" href="#enable-connectionless-cte-reception" title="Permalink to this headline">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> shows how to synchronize with a periodic advertisement
and how to enable the reception of the CTE appended.
The way to synchronize with a periodic advertisement is detailed in the
GAP scanner section.
After this, the function <code class="docutils literal notranslate"><span class="pre">RTLSSrv_setCLCteSamplingEnableCmd</span></code> is used
to sart sampling the CTEs. The parameter <code class="docutils literal notranslate"><span class="pre">maxSampleCte</span></code> of this function
determines how many CTEs the scanner can receive from a specific transmitter
in each periodic advertisement interval.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The predefined symbol <code class="docutils literal notranslate"><span class="pre">MAX_NUM_CTE_BUFS</span></code> sets the maximum value that
can be defined for <code class="docutils literal notranslate"><span class="pre">maxSampleCte</span></code>. By default, <code class="docutils literal notranslate"><span class="pre">MAX_NUM_CTE_BUFS</span></code> is
set to 1 and is defined in the file <code class="docutils literal notranslate"><span class="pre">Tools\Defines\rtls_responder_app.opt</span></code>.
The amount of memory allocated to connectionless CTE sampling is given
by <code class="docutils literal notranslate"><span class="pre">MAX_NUM_CTE_BUFS</span> <span class="pre">*</span> <span class="pre">2500</span></code> bytes.</p>
</div>
</div>
<div class="section" id="available-tools-for-connectionless-aoa">
<h5>Available tools for Connectionless AoA<a class="headerlink" href="#available-tools-for-connectionless-aoa" title="Permalink to this headline">¶</a></h5>
<p>The Python script <code class="docutils literal notranslate"><span class="pre">rtls_connectionless.py</span></code>
provided in <code class="docutils literal notranslate"><span class="pre">&lt;SDK&gt;\tools\ble5stack\rtls_agent\examples</span></code> can be used with
connectionless AoA.
It requires attaching to the computer one <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code>.
The <code class="docutils literal notranslate"><span class="pre">rtls_responder</span></code> device(s) is (are) not required to be attached to
the computer.</p>
</div>
<div class="section" id="id3">
<h5>Applications Overview<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<p>In the out of box software, the <code class="docutils literal notranslate"><span class="pre">rtls_responder</span></code> sends both legacy
and periodic advertisements.
Legacy advertisements are used by the <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> in the case
of connection AoA to establish a connection (this point is not
discussed in this section).
In the case of connectionless AoA, only the periodic advertisements
are used. These periodic advertisements are appended with a CTE.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> device scans to find advertisements. The
<code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> forwards the advertisements found to the host MCU.
Both legacy and periodic advertisements are reported back to the
host MCU. The host MCU selects the type of advertisements to
consider, hence the AoA type to perform.</p>
<p>In the case of connectionless AoA, the host MCU selects the
periodic advertisement the <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> has to synchronize with.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> synchronizes with the periodic advertisements
sent by the <code class="docutils literal notranslate"><span class="pre">rtls_responder</span></code>. The <code class="docutils literal notranslate"><span class="pre">rtls_coordinator</span></code> can then do I/Q
sampling and calculate angles base on the CTE appended to
the periodic advertisements.</p>
<p>As a reminder, the <code class="docutils literal notranslate"><span class="pre">rtls_passive</span></code> is not involved for
connectionless AoA.</p>
<p>The sequence diagram below illustrates the whole process of how out of box
examples work.</p>
<div class="figure align-center" id="id19">
<p class="plantuml">
<img src="../_images/plantuml-22e28e1a22829476c80df9bf907b39090a7f7617.png" alt="&#64;startuml
participant &quot;Node_Manager \n(Host MCU)&quot; as manager
participant &quot;rtls_coordinator \n(receiver)&quot; as coordinator
participant &quot;rtls_responder \n(transmitter)&quot; as responder

activate responder
...
... \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tresponder is sending out \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tperiodic advertisements (with appended CTEs)...
...

manager -&gt; coordinator: RTLS_CMD_IDENTIFY_Req
coordinator -&gt; manager: RTLS_CMD_IDENTIFY_Rsp

manager -&gt; coordinator: RTLS_CMD_SCAN_Req

activate coordinator
coordinator -&gt; coordinator: Start scanning \nfor rtls_responder

group rtls_responder not found

    manager -&gt; coordinator: RTLS_CMD_SCAN_STOP
    deactivate coordinator
    manager -&gt; coordinator: RTLS_CMD_SCAN_Req \nrestart scanning

    activate coordinator
    coordinator -&gt; coordinator: Start scanning \nfor rtls_responder
    manager -&gt; coordinator: RTLS_CMD_SCAN_STOP
    deactivate coordinator
    ...
    ... Repeat until periodic advertisement found ...
    ...
end

group rtls_responder found

    coordinator -&gt; manager: RTLS_CMD_SCAN_AsyncReq
    manager -&gt; coordinator: RTLS_CMD_SCAN_STOP

    group Synchronization
      manager -&gt; coordinator: RTLS_CMD_CREATE_SYNC
      manager -&gt; coordinator: RTLS_CMD_SCAN_Req
      coordinator --&gt; responder: Synchronisation with periodic advertisement
      == After rtls_coordinator is synchronized with rtls_responder periodic advertsiments ==
      coordinator -&gt; manager: RTLS_EVT_SYNC_EST
      coordinator -&gt; manager: RTLS_EVT_PERIODIC_ADV_RPT
      ...
      ... One report is sent by the rtls_coordinator after each advertisement received ...
      ...
    end

    group AoA
        manager -&gt; coordinator: RTLS_CMD_CL_AOA_ENABLE
        coordinator -&gt; manager: RTLS_EVT_CL_AOA_ENABLE

        activate coordinator
        responder --&gt; coordinator: The CTE appended to the periodic advertisments \nis sampled by the rtls_coordinator
        coordinator -&gt; manager: RTLS_CMD_CL_AOA_RESULT_RAW
        ...
        ... rtls_coordinator and rtls_responder stay synchronized \nrtls_coordinator sends reports to host MCU after each periodic advertisement received ...
        ...
    end
end

&#64;enduml"/>
</p>
<p class="caption"><span class="caption-number">Figure 137. </span><span class="caption-text">Setting up RTLS Connectionless AoA and enable AoA</span><a class="headerlink" href="#id19" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../coexistence/coexistence.html" class="btn btn-neutral float-left" title="Coexistence" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../ble-mesh/index.html" class="btn btn-neutral float-right" title="Bluetooth Mesh" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2010-2022, Texas Instruments.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>